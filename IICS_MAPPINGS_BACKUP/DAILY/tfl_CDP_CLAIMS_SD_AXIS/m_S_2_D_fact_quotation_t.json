[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "SELECT distinct ssolicit,\ncusuari,\nfalta,\ncramo,\ncmodali,\nctipseg,\nccolect,\ncactivi,\nsproduc,\ncagente,\na_nombre_sucursal,\nsseguro,\ncrfaage,\nrut_asegurado,\ncmarca,\nsmodelo,\nnanofab,\nc_pdtocom,\nd_ded_00,\nd_ded_03,\nd_ded_05,\nd_ded_10,\ne_nombre_usuario,\ne_cperfil,\ne_desc_perfil_usuario,\ne_descuento_permitido,\nsrc_sys_cd,\ntipo_nego,\ntipo_emission,\nmax_sid,\nquote_source,\ndim_lob_key,\nmdik,\ndim_broker_key,\ndim_branch_office_key,\nemission1,\nseg_policy_item_id,\nb_npoliza_1,\nb_ncertif_1,\nb_sproduc_1,\nb_ipirianuseg_1,\nb_ipritar_1,\nb_pdtocom_1,\nb_ifraquseg_1,\nb_femisio_1,\nb_fefecto_1,\nb_fin_vig_1,\nb_cactivi_1,\nb_fanulac_1,\nb_ttitulo_1,\nb_cagente_1,\nb_tbuscar_1,\nb_sperson_1,\nb_csituac_1,\nemission_web,\nemission_or_web,\npolicy_web,\ndim_prd_pln_hrchy_key,\nbusiness_type_indicator_1_q,\nbusiness_type_indicator_2_q,\nbusiness_type_indicator_3_q,\nfinal_business_type_indicator,\ncnt,\nrobot,\nB_SSEGURO,\nitem_web,  ---Added as part of CISD-21470\nprima_web ---Added as part of CISD-21470\nFROM \n(WITH t as (\nWITH s as (\nWITH ab as (\nWITH a as (\nWITH w1 as (\nSELECT\n            SOLSEG.SSOLICIT SSOLICIT,\n            SOLSEG.CUSUARI CUSUARI,\n            SOLSEG.FALTA FALTA,\n            TO_CHAR(SOLSEG.FALTA,'YYYY')ANYO,\n            TO_CHAR(SOLSEG.FALTA,'MM')MES,\n            TO_CHAR(SOLSEG.FALTA,'DD')DIA,\n            SOLSEG.CRAMO CRAMO,\n            SOLSEG.CMODALI CMODALI,\n            SOLSEG.CTIPSEG CTIPSEG,\n            SOLSEG.CCOLECT CCOLECT,\n            SOLSEG.CACTIVI CACTIVI,\n            SOLSEG.SPRODUC SPRODUC,\n            SOLSEG.CAGENTE CAGENTE,\n            TO_NUMBER(SUBSTRING(SOLSEG.CAGENTE,LENGTH(SOLSEG.CAGENTE)-2,3),'999') A_ID_SUCURSAL,\n            (SELECT P.TAPELLI FROM cdp_ods.SISAXIS_AGENTES  A LEFT JOIN cdp_ods.SISAXIS_PERSONAS  P ON A.SPERSON= P.SPERSON  AND A.CTIPAGE=1 WHERE A.CAGENTE = '00000'|| SUBSTRING(SOLSEG.CAGENTE,LENGTH(SOLSEG.CAGENTE)-2,3) )A_NOMBRE_SUCURSAL,\n            CAST(SOLSEG.SSEGURO AS NUMERIC(25,0)) AS SSEGURO,\n            SOLSEG.CRFAAGE CRFAAGE,\n            SUBSTRING(SOLASEG.NNUMNIF,1,LENGTH(SOLASEG.NNUMNIF)-1)RUT_ASEGURADO,\n            SOLASEG.SPERSON SPERSON,\n            AUTVER.CMARCA CMARCA,\n                    AUTVER.SMODELO SMODELO,\n            SOLAUT.NANOFAB NANOFAB\nFROM cdp_ods.SISAXIS_SOLSEGUROS  SOLSEG \n            INNER JOIN cdp_ods.SISAXIS_SOLASEGURADOS  SOLASEG ON SOLSEG.SSOLICIT = SOLASEG.SSOLICIT AND NORDEN =(SELECT  MAX(NORDEN) FROM cdp_ods.SISAXIS_SOLASEGURADOS  WHERE SSOLICIT=SOLSEG.SSOLICIT)\n            LEFT  JOIN cdp_ods.SISAXIS_PERSONAS  PER ON SOLASEG.SPERSON =PER.SPERSON\n            INNER JOIN cdp_ods.SISAXIS_SOLAUTRIESGOS  SOLAUT ON\n                SOLSEG.SSOLICIT=SOLAUT.SSOLICIT AND\n                SOLAUT.NRIESGO = (SELECT  MAX(NORDEN) FROM cdp_ods.SISAXIS_SOLASEGURADOS  WHERE SSOLICIT=SOLSEG.SSOLICIT)\n            INNER JOIN cdp_ods.SISAXIS_AUTVERSIONES  AUTVER ON SOLAUT.CVERSION = AUTVER.CVERSION\n            INNER JOIN cdp_ods.SISAXIS_AGENTES  AGE ON AGE.CAGENTE = SOLSEG.CAGENTE\nWHERE SOLSEG.CRAMO = 6\nAND SOLSEG.FALTA BETWEEN TO_DATE('01/01/2018', 'dd/MM/yyyy HH24:MI:SS')  AND getdate()\n--AND SOLSEG.SPRODUC IN (760,1190)\n)\n\nselect * from (\nselect a.*, b.cnt, 0 as robot from (\n(SELECT * from w1) a\nleft join\n(select rut_asegurado,mes, count(1) as cnt from w1 group by rut_asegurado, mes) b\non\na.rut_asegurado=b.rut_asegurado and\na.mes=b.mes) )\n\n),\n\nb as (\n\nselect * from\n(\nSELECT  CAST(SEG.SSEGURO as NUMERIC(25,0)) as B_SSEGURO,\n            CAST(SEG.NPOLIZA as NUMERIC(25,0)) as B_NPOLIZA,\n            SEG.NCERTIF as B_NCERTIF,\n            SEG.SPRODUC as B_SPRODUC,\n            SEG.IPRIANUSEG as B_IPIRIANUSEG,\n        GARANSEG.IPRITAR as B_IPRITAR,\n        GARANSEG.PDTOCOM as B_PDTOCOM,\n            GARANSEG.IFRANQUSEG as B_IFRAQUSEG,\n            SEG.FEMISIO as B_FEMISIO,\n            SEG.FEFECTO as B_FEFECTO,\n        DECODE(SEG.cduraci, 3, SEG.fvencim, SEG.fcarpro) B_FIN_VIG,\n            CASE WHEN SEG.CDURACI = 3 THEN SEG.FVENCIM ELSE   SEG.FCARPRO END B_FVENCIM,\n            SEG.CACTIVI as B_CACTIVI,\n            SEG.FANULAC as B_FANULAC,\n            TI.TTITULO as B_TTITULO,\n            SEG.CAGENTE as B_CAGENTE,\n        TO_NUMBER(SUBSTRING(SEG.CAGENTE,LENGTH(SEG.CAGENTE)-2,3),'999') B_ID_SUCURSAL, \n            (SELECT P.TAPELLI FROM cdp_ods.SISAXIS_AGENTES  A LEFT JOIN cdp_ods.SISAXIS_PERSONAS  P ON A.SPERSON= P.SPERSON  AND A.CTIPAGE=1 WHERE A.CAGENTE = '00000'||SUBSTRING(SEG.CAGENTE,LENGTH(SEG.CAGENTE)-2,3) )B_NOMBRE_SUCURSAL,\n            PER.TBUSCAR as B_TBUSCAR,\n        SUBSTRING(PER.NNUMNIF,1,LENGTH(PER.NNUMNIF)-1)B_NNUMNIF,\n            PER.SPERSON as B_SPERSON,\n            AUTVER.CMARCA as B_CMARCA,\n            AUTVER.SMODELO as B_SMODELO,         \n            AUT.NANOFAB as B_NANOFAB,\n            SEG.CSITUAC as B_CSITUAC,                              \n            1 EMISION\nFROM cdp_ods.SISAXIS_SEGUROS  SEG\n                            LEFT JOIN ( SELECT   T1.SSEGURO,\n                            SUM(IPRITAR)IPRITAR,\n                            SUM(IPRIANUSEG)IPRIANUSEG,\n                            MAX(IFRANQUSEG)IFRANQUSEG,\n                            MAX(PDTOCOM) PDTOCOM\n                            FROM cdp_ods.SISAXIS_GARANSEG  T1 INNER JOIN (SELECT SSEGURO,MAX(NMOVIMI)NMOVIMI\n                            FROM cdp_ods.SISAXIS_GARANSEG \n                            GROUP BY SSEGURO) T2 ON T1.SSEGURO = T2.SSEGURO AND T1.NMOVIMI = T2.NMOVIMI\n                            GROUP BY T1.SSEGURO)\n                            GARANSEG ON SEG.SSEGURO = GARANSEG.SSEGURO\n                            INNER JOIN (SELECT  SSEGURO,SPERSON ,MAX(NORDEN)NORDEN FROM cdp_ods.SISAXIS_ASEGURADOS  WHERE FFECFIN IS NULL GROUP BY SSEGURO,SPERSON )ASEG ON SEG.SSEGURO = ASEG.SSEGURO\n                            INNER JOIN (                                                                                          \n                            SELECT A1.CVERSION,A1.SSEGURO,A1.NANOFAB\n                            FROM cdp_ods.SISAXIS_AUTRIESGOS  A1 INNER JOIN   --cdp_ods\n                            (SELECT SSEGURO,MAX(NMOVIMI)NMOVIMI,MAX(NRIESGO)NRIESGO FROM cdp_ods.SISAXIS_AUTRIESGOS  GROUP BY SSEGURO )A2  ON A1.SSEGURO= A2.SSEGURO AND A1.NRIESGO=A2.NRIESGO\n                            GROUP BY A1.CVERSION,A1.SSEGURO,A1.NANOFAB                                                                                                                                       \n                            ) AUT ON SEG.SSEGURO=AUT.SSEGURO \n                            INNER JOIN cdp_ods.SISAXIS_AUTVERSIONES  AUTVER ON AUT.CVERSION = AUTVER.CVERSION\n                            INNER JOIN cdp_ods.SISAXIS_AGENTES  AGE ON AGE.CAGENTE = SEG.CAGENTE\n                            INNER JOIN cdp_ods.SISAXIS_PERSONAS  PER ON PER.SPERSON = ASEG.SPERSON\n                            LEFT JOIN cdp_ods.SISAXIS_TITULOPRO  TI ON TI.CCOLECT = SEG.CCOLECT AND TI.CMODALI= SEG.CMODALI AND TI.CTIPSEG = SEG.CTIPSEG AND TI.CRAMO= SEG.CRAMO                                                                         \nWHERE\n(((FEFECTO BETWEEN TO_DATE('01/01/2018', 'dd/MM/yyyy HH24:MI:SS') AND TO_DATE('31/12/2020', 'dd/MM/yyyy HH24:MI:SS')) AND SPRODUC = 760) OR ((FEFECTO BETWEEN TO_DATE('01/01/2021', 'dd/MM/yyyy HH24:MI:SS') AND getdate()) AND SPRODUC in (760,1190,1006,1209,1228,1050,1248,1265,1024,1244)))\nAND SEG.CRAMO =6 \nAND NCERTIF >0\n--SPRODUC = 760\n)\n)\n\nSELECT a.*,b.*,\ndatediff (day,a.FALTA,b.b_FEFECTO) as diffdays\nFROM a LEFT JOIN b\nON  a.RUT_ASEGURADO = b.B_NNUMNIF\nAND a.CMARCA = b.B_CMARCA\nAND a.SMODELO = b.B_SMODELO\nAND a.NANOFAB = b.B_NANOFAB\nAND a.SPRODUC = b.B_SPRODUC --added this condition for CISD19992\n),\n\nc as (\nSELECT SSOLICIT as C_SSOLICIT, PDTOCOM as C_PDTOCOM from\n(\nSELECT T1.SSOLICIT,nvl(MAX(PDTOCOM)/100,0)PDTOCOM\nFROM cdp_ods.SISAXIS_SOLGARANSEG  T1 INNER JOIN\n(\nSELECT SSOLICIT FROM cdp_ods.SISAXIS_SOLSEGUROS  WHERE\nFALTA >= TO_DATE('01/01/2018', 'dd/MM/yyyy HH24:MI:SS')\n) T2 ON T1.SSOLICIT = T2.SSOLICIT\nGROUP BY T1.SSOLICIT\n)),\n\nd as (\nSELECT T1.SSOLICIT as D_SSOLICIT,\nMAX(CASE WHEN NPROP =1 THEN CRESPUE END) D_DED_00,\nMAX(CASE WHEN NPROP =2 THEN CRESPUE END) D_DED_03,\nMAX(CASE WHEN NPROP =3 THEN CRESPUE END) D_DED_05,\nMAX(CASE WHEN NPROP =4 THEN CRESPUE END) D_DED_10\nFROM cdp_ods.SISAXIS_SOLPREGUNSEGPROP  T1 INNER JOIN \n(SELECT SSOLICIT FROM cdp_ods.SISAXIS_SOLSEGUROS  WHERE FALTA >= TO_DATE('01/01/2018', 'dd/MM/yyyy HH24:MI:SS') )\nT2 ON T1.SSOLICIT = T2.SSOLICIT\nWHERE CPREGUN =1000\nGROUP BY T1.SSOLICIT\n),\n\ne as (\nWITH PAR_V_COND as(\nSELECT pcr.cregla as CREGLA,pcr.scondreg as SCONDREG, cp.cpregun as CPREGUN, pcr.crespue as CRESPUE, pcr.nvalinf as NVALINF,pcr.nvalsup as NVALSUP,p.cidioma as CIDIOMA,\n            (p.tpregun || DECODE(pcr.CRESPUE,NULL,' ' || DECODE(pcr.nvalsup,NULL, (pcr.nvalinf :: varchar), (pcr.nvalinf :: varchar) || ' - ' || ((pcr.nvalsup || ' ') :: varchar)),\n                                                ': ' || (SELECT TRESPUE FROM cdp_ods.sisaxis_RESPUESTAS  WHERE CPREGUN = p.cpregun AND CRESPUE = pcr.crespue AND CIDIOMA = p.cidioma))) as TCONDIC\nFROM cdp_ods.sisaxis_preguntas p ,cdp_ods.sisaxis_codipregun cp,cdp_ods.sisaxis_par_condic_reglas pcr\nWHERE p.cpregun = cp.cpregun\n  AND    pcr.cpregun = p.cpregun\n)\n\nSELECT DISTINCT\n--REPLACE ((SELECT TBUSCAR FROM cdp_ods.SISAXIS_PERSONAS  PER, cdp_ods.SISAXIS_USUARIOS  U WHERE PER.SPERSON=U.SPERSON AND U.CUSUARI=P.CUSUARI), '##', '')  E_NOMBRE_USUARIO, /*commented as part of DID_238*/\ntranslate ((SELECT TBUSCAR FROM cdp_ods.SISAXIS_PERSONAS  PER, cdp_ods.SISAXIS_USUARIOS  U WHERE PER.SPERSON=U.SPERSON AND U.CUSUARI=P.CUSUARI), '#', '')  E_NOMBRE_USUARIO,  /* added as part of DID_238*/\n            P.CUSUARI as E_CUSUARI, P.CPERFIL as E_CPERFIL ,\n            (SELECT TPERFIL FROM cdp_ods.SISAXIS_DESPERFIL  WHERE CPERFIL=P.CPERFIL) E_DESC_PERFIL_USUARIO,\n            (SELECT NVALSUP FROM PAR_V_COND A1, cdp_ods.SISAXIS_DETASOCCOND  B1, cdp_ods.SISAXIS_CODIASOCCOND  C1\n            WHERE A1.CREGLA = 6000\n            AND A1.CPREGUN = 5013\n            AND A1.SCONDREG = B1.SCONDREG\n            AND B1.SASOCIA = C1.SASOCIA\n            AND C1.CPERFEXG = P.CPERFIL ) E_DESCUENTO_PERMITIDO\n   FROM cdp_ods.SISAXIS_PAR_PERFILES_USUARIO  P, cdp_ods.SISAXIS_USU_DATOS  D\n   WHERE  D.CUSUARI=P.CUSUARI\n   AND D.CACTIVO='S' AND  P.CRAMO=6 AND P.ENTORNO=4\n   ORDER BY E_CPERFIL\n\n),\nf as (\nSELECT   A.CAGENTE as F_CAGENTE,  \n            SubString(P.NNUMNIF,1,Length(P.NNUMNIF)-1) +  SubString(P.NNUMNIF,Length(P.NNUMNIF),1)  F_RUT_CORREDOR,\n         REPLACE(TBUSCAR,'#','') F_NOMBRE_CORREDOR\nFROM cdp_ods.SISAXIS_AGENTES  A INNER JOIN cdp_ods.SISAXIS_PERSONAS  P ON A.SPERSON = P.SPERSON\n),\ng as (\nSELECT CAST(CAST(sciclo AS NUMERIC(38,0)) AS VARCHAR) AS sciclo, count(1) as sciclo_count\nfrom cdp_ods.sisaxis_cmi_propuesta  where csistema=1 and ctipdoc=1 and npoliza is not null and npoliza > 0 group by sciclo -- and npoliza > 0\n)\n\n \nselect i.* from (\nselect h.*, lob.dim_lob_key dim_lob_key, ins.mdik mdik, bro.dim_broker_key dim_broker_key, suc.dim_branch_office_key dim_branch_office_key\nfrom (\nselect abcdef.*, g.* from (\nselect abcde.*,f.*, cast('axis' as varchar(12)) as src_sys_cd, cast(0 as INT) as tipo_corredor, cast(0 as INT) as tipo_nego,\ncast(1 as INT) as tipo_emission, max_sid, cast('web' as VARCHAR(8)) as quote_source\nfrom (\nselect abcd.*,e.*\nfrom (\nselect abc.*,d.*\nfrom (\nselect ab1.*,c.*\nfrom (\nselect X.*,Y.B_max_sseguro\nfrom (\n(select * from ab) X\nLEFT JOIN\n(select B_NNUMNIF, B_CMARCA, B_SMODELO, B_NANOFAB, MAX(B_SSEGURO) as B_max_sseguro\nfrom ab where diffdays>=0 AND diffdays<=30 AND CUSUARI <> 'FPIAXIS2' AND CUSUARI <> 'ANIDA1' group by B_NNUMNIF, B_CMARCA, B_SMODELO, B_NANOFAB) Y\nON  X.B_NNUMNIF = Y.B_NNUMNIF\nAND X.B_CMARCA = Y.B_CMARCA\nAND X.B_SMODELO = Y.B_SMODELO\nAND X.B_NANOFAB = Y.B_NANOFAB\nAND X.SPRODUC in (760,1190,1006,1209,1228,1050,1248,1265,1024,1244)\nAND X.diffdays>=0\nAND X.diffdays<=30\nAND X.B_SSEGURO = Y.B_max_sseguro\nAND X.CUSUARI <> 'FPIAXIS2'\nAND X.CUSUARI <> 'ANIDA1'\n)\n) ab1\nleft join c on\nab1.SSOLICIT = c.C_SSOLICIT ) abc\nleft join d on\nabc.SSOLICIT = d.D_SSOLICIT ) abcd\nleft join e on\nabcd.CUSUARI = e.E_CUSUARI) abcde\nleft join f on\nabcde.CAGENTE = f.F_CAGENTE\nleft join\n(select 1 dummy, max(fact_quote_key) max_sid from cdp_dwh.fact_quotation_t )LKP_MAX_KEY\non LKP_MAX_KEY.dummy=1 ) abcdef\nleft join g on\nabcdef.CRFAAGE = g.sciclo\n) h\nleft join (select * from cdp_dwh.dim_lob_t where src_sys_cd = 'axis') lob\non h.cramo = lob.lob_cd AND h.cusuari <> 'FPAXIS2' and h.cusuari <> 'ANIDA1'\nleft join /*(select insured_rut_num, max(dim_insured_key) as mdik  from cdp_dwh.dim_insured_t where src_sys_cd = 'axis' group by insured_rut_num) ins\non h.rut_asegurado = SUBSTRING(ins.insured_rut_num,1,LENGTH(ins.insured_rut_num)-1)*/\n/* Modified as part of DID-234 */\n(select \n    SUBSTRING(insured_rut_num, 1,LENGTH(insured_rut_num)-1) as rut_insured, \n    max( dim_insured_key ) as mdik  \n  from \n    cdp_dwh.dim_insured_t \n  where \n    src_sys_cd = 'axis' \n  group by \n    SUBSTRING(insured_rut_num, 1,LENGTH(insured_rut_num)-1)\n  ) ins\n    on h.rut_asegurado = ins.rut_insured\nleft join (select * from cdp_dwh.dim_broker_t where src_sys_cd = 'axis') bro\non h.f_rut_corredor = bro.broker_id\nleft join (select * from cdp_dwh.dim_branch_office_t where src_sys_cd = 'axis') suc\non h.a_id_sucursal = suc.branch_office_id \n) i\n)\n\nselect * from (select s.*, row_number() over (partition by ssolicit \norder by b_max_sseguro desc nulls last, b_sseguro desc) as rnk from s) where rnk=1                                                                                                                                                                                                                               \n)\n\n------------------------------------------------ADDED FOR CR------------------------------------------\n\nselect m.*,\n\nPLAN_HIRE.dim_prd_pln_hrchy_key dim_prd_pln_hrchy_key,\n\ncnt_key1.cnt_k1 as cnt_k1,\ncnt_key2.cnt_k2 as cnt_k2,\ncnt_key3.cnt_k3 as cnt_k3,\ncase \n            when renewals.key1 is not null then \n                        case \n                                    when act_1.policy_item_id is not null and act_1.cancel = 1 then 'NB'\n                                    when act_1.policy_item_id is not null then 'RB'\n                                    when renewals.key1 is not null and cnt_k1 <= 1 THEN 'NB'\n                                    else 'NB'\n                        end\n            ELSE NULL\nEND as BUSINESS_TYPE_INDICATOR_1_q,\ncase \n            when renewals.key2 is not null then \n                        case \n                                    when act_2.policy_item_id is not null and act_2.cancel = 1 then 'NB'\n                                    when act_2.policy_item_id is not null then 'RB'\n                                    when renewals.key2 is not null and cnt_k2 <= 1 THEN 'NB'\n                                    else 'NB'\n                        end\n            ELSE NULL\nEND as BUSINESS_TYPE_INDICATOR_2_q,\ncase \n            when renewals.key3 is not null then \n                        case \n                                    when act_3.policy_item_id is not null and act_3.cancel = 1 then 'NB'\n                                    when act_3.policy_item_id is not null then 'RB'\n                                    when renewals.key3 is not null and cnt_k3 <= 1 THEN 'NB'\n                                    else 'NB'\n                        end\n            ELSE NULL\nEND as BUSINESS_TYPE_INDICATOR_3_q,\n\nCASE \n            WHEN seg_policy_item_id is null then null\n            WHEN BUSINESS_TYPE_INDICATOR_1_q is null and BUSINESS_TYPE_INDICATOR_2_q is null and BUSINESS_TYPE_INDICATOR_3_q is null THEN null\n            WHEN BUSINESS_TYPE_INDICATOR_1_q = 'RB' OR BUSINESS_TYPE_INDICATOR_2_q = 'RB' OR BUSINESS_TYPE_INDICATOR_3_q = 'RB' THEN 'RB'\n            ELSE 'NB'\nEND AS FINAL_BUSINESS_TYPE_INDICATOR\n-------------------------------------------------------------------------------------------------------\n\nfrom (\n/** added as part of DID_239 **/ \nselect l.*,p.npoliza as policy_web, p.ncertif as item_web, p.iprianuseg as prima_web from   --------Added as part of CISD-21470\n\n(select k.*, case when (emission1=1 or emission_web=1) then 1 else 0 end as emission_or_web\nfrom (\nselect j.*,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_SSEGURO end as seg_policy_item_id,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_NPOLIZA end as B_NPOLIZA_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_NCERTIF end as B_NCERTIF_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_SPRODUC end as B_SPRODUC_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_IPIRIANUSEG end as B_IPIRIANUSEG_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_IPRITAR else B_IPRITAR end as B_IPRITAR_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_PDTOCOM else B_PDTOCOM end as B_PDTOCOM_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_IFRAQUSEG else B_IFRAQUSEG end as B_IFRAQUSEG_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_FEMISIO end as B_FEMISIO_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_FEFECTO end as B_FEFECTO_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_FIN_VIG end as B_FIN_VIG_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_FVENCIM else B_FVENCIM end as B_FVENCIM_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_CACTIVI end as B_CACTIVI_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_FANULAC end as B_FANULAC_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_TTITULO else B_TTITULO end as B_TTITULO_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_CAGENTE end as B_CAGENTE_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_ID_SUCURSAL else B_ID_SUCURSAL end as B_ID_SUCURSAL_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_NOMBRE_SUCURSAL else B_NOMBRE_SUCURSAL end as B_NOMBRE_SUCURSAL_1,\n--case when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_TBUSCAR else B_TBUSCAR end as B_TBUSCAR_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then translate(B_TBUSCAR,'#','') else translate(B_TBUSCAR,'#','') end as B_TBUSCAR_1, --modified as part of DID_238\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_NNUMNIF else B_NNUMNIF end as B_NNUMNIF_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_SPERSON else B_SPERSON end as B_SPERSON_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_CMARCA else B_CMARCA end as B_CMARCA_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_SMODELO else B_SMODELO end as B_SMODELO_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then B_NANOFAB else B_NANOFAB end as B_NANOFAB_1,\ncase when cusuari = 'FPIAXIS2' OR cusuari = 'ANIDA1' or (max_ssolicit is null and emission1 <> 1) then null else B_CSITUAC end as B_CSITUAC_1,\ncase when (sciclo_count>0)   then 1 else 0 end as emission_web\nfrom (\nselect t1.*, t2.*,\ncase when (((max_ssolicit is not null and cnt_ssolicit>=1)) and cusuari <> 'FPIAXIS2' and cusuari <> 'ANIDA1')\nthen 1 else 0 end as emission1\nfrom (\n(select * from t) t1\nleft join (\nselect max(ssolicit) as max_ssolicit, count(ssolicit) as cnt_ssolicit, B_max_sseguro as B_max_sseguro_s3 from t\nwhere B_max_sseguro is not null and cusuari <> 'FPIAXIS2' and cusuari <> 'ANIDA1' group by B_max_sseguro\n) t2\non t1.ssolicit = t2.max_ssolicit)\n) j\n) k\n)l /** added as part of DID_239 **/ \n/** left join cdp_ods.sisaxis_cmi_propuesta p \n   on cast(decode( l.CRFAAGE,'',null,l.CRFAAGE) as numeric)= p.sciclo  and\n           p.csistema=1 and \n           p.ctipdoc=1  and \n          p.npoliza is not null**/ \n--------Added as part of CISD-21470---------------\n\t\t  \n\tleft join (select  cast(m.sciclo as int) sciclo, cast(m.sseguro as int) sseguro, s.npoliza, s.ncertif, s.iprianuseg\n        from    cdp_ods.sisaxis_cmi_propuesta p ,cdp_ods.sisaxis_cmi_movpropuesta m,cdp_ods.sisaxis_cmi_estados e, cdp_ods.sisaxis_seguros s\n            where  m.csistema='1'\n                and p.sciclo=m.sciclo\n                and m.cestado=e.ccodigo\n                and cast(m.sseguro as int) = s.sseguro\n                and p.csistema='1'\n                and m.cestado='AUTORIZA'\n                and m.ctipo='D'\n                and p.ctipdoc='1' ) p on  cast(decode( l.CRFAAGE,'',null,l.CRFAAGE) as numeric)= p.sciclo \n\n)m  \n-----------------------------------------------adding as a part of CR--------------------------------------------\n\nLEFT JOIN(\nSELECT PLAN_HIRE.dim_prd_pln_hrchy_key,SEG.sseguro FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n\nINNER JOIN cdp_dwh.dim_prd_pln_hrchy_t PLAN_HIRE\nON PLAN_HIRE.prd_cd=CAST(CAST(SEG.sproduc AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.lob_cd=CAST(CAST(SEG.cramo AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.pln_cd=CAST(CAST(SEG.cactivi AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.src_sys_cd='axis'\n)PLAN_HIRE\nON PLAN_HIRE.sseguro= m.seg_policy_item_id --SEG.sseguro\n\n\nleft join cdp_dwh.fact_renewals_nofleet_maturity_t renewals\non cast(renewals.policy_item_id as character varying) = cast(m.seg_policy_item_id as character varying)\n\nleft join\n(\nselect key1, count(1) as cnt_k1\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\ngroup by 1\n) cnt_key1 on cnt_key1.key1 = renewals.key1\n\nleft join\n(\nselect key2, count(1) as cnt_k2\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\ngroup by 1\n) cnt_key2 on cnt_key2.key2 = renewals.key2\n\nleft join\n(\nselect key3, count(1) as cnt_k3\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\ngroup by 1\n) cnt_key3 on cnt_key3.key3 = renewals.key3\n\nleft join (\nselect act_1.policy_item_id, act_1.key1, act_1.policy_issue_dt,act_1.policy_act_exp_dt, \nact_1.policy_item_id_match_1,renewal.cancel as cancel, ROWNUM\nfrom(\nselect actual.policy_item_id, actual.key1, actual.policy_issue_dt,rest_1.policy_act_exp_dt, \nrest_1.policy_item_id as policy_item_id_match_1,\nrow_number() over (partition by actual.key1 order by policy_act_exp_dt desc,policy_item_id_match_1 desc) ROWNUM\nfrom \n(\nselect actual.policy_item_id, actual.key1, actual.policy_issue_dt\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t actual\nwhere actual.src_sys_cd = 'axis' --and policy_item_id is not null and key1 is not null\n)actual\ninner join (\nselect distinct policy_act_exp_dt, key1, policy_item_id\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\n)rest_1 on rest_1.key1 = actual.key1\nand actual.policy_issue_dt = rest_1.policy_act_exp_dt\nand actual.policy_item_id <> rest_1.policy_item_id\n\n)act_1\nleft join(\nselect policy_item_id, cancel\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\n)renewal on renewal.policy_item_id = act_1.policy_item_id_match_1\nwhere ROWNUM=1\n)act_1\non act_1.policy_item_id =  m.seg_policy_item_id and m.seg_policy_item_id is not null\n\n\nleft join (\nselect act_2.policy_item_id, act_2.key2, act_2.policy_issue_dt,act_2.policy_act_exp_dt, \nact_2.policy_item_id_match_2,renewal.cancel as cancel, ROWNUM\nfrom(\nselect actual.policy_item_id, actual.key2, actual.policy_issue_dt,rest_2.policy_act_exp_dt, \nrest_2.policy_item_id as policy_item_id_match_2,\nrow_number() over (partition by actual.key2 order by policy_act_exp_dt desc,policy_item_id_match_2 desc) ROWNUM\nfrom \n(\nselect actual.policy_item_id, actual.key2, actual.policy_issue_dt\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t actual\nwhere actual.src_sys_cd = 'axis' --and policy_item_id is not null and key1 is not null\n)actual\ninner join (\nselect distinct policy_act_exp_dt, key2, policy_item_id\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\n)rest_2 on rest_2.key2 = actual.key2\nand actual.policy_issue_dt = rest_2.policy_act_exp_dt\nand actual.policy_item_id <> rest_2.policy_item_id\n\n)act_2\nleft join(\nselect policy_item_id, cancel\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\n)renewal on renewal.policy_item_id = act_2.policy_item_id_match_2\nwhere ROWNUM=1\n)act_2\non act_2.policy_item_id =  m.seg_policy_item_id and m.seg_policy_item_id is not null\n\n\nleft join (\nselect act_3.policy_item_id, act_3.key3, act_3.policy_issue_dt,act_3.policy_act_exp_dt, \nact_3.policy_item_id_match_3,renewal.cancel as cancel, ROWNUM\nfrom(\nselect actual.policy_item_id, actual.key3, actual.policy_issue_dt,rest_3.policy_act_exp_dt, \nrest_3.policy_item_id as policy_item_id_match_3,\nrow_number() over (partition by actual.key3 order by policy_act_exp_dt desc,policy_item_id_match_3 desc) ROWNUM\nfrom \n(\nselect actual.policy_item_id, actual.key3, actual.policy_issue_dt\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t actual\nwhere actual.src_sys_cd = 'axis' --and policy_item_id is not null and key1 is not null\n)actual\ninner join (\nselect distinct policy_act_exp_dt, key3, policy_item_id\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\n)rest_3 on rest_3.key3 = actual.key3\nand actual.policy_issue_dt = rest_3.policy_act_exp_dt\nand actual.policy_item_id <> rest_3.policy_item_id\n\n)act_3\nleft join(\nselect policy_item_id, cancel\nfrom cdp_dwh.fact_renewals_nofleet_maturity_t\n)renewal on renewal.policy_item_id = act_3.policy_item_id_match_3\nwhere ROWNUM=1\n)act_3\non act_3.policy_item_id =  m.seg_policy_item_id and m.seg_policy_item_id is not null)"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.oprRuntimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "TRUNCATE TABLE cdp_dwh.fact_quotation_t;"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "TRUNCATE TABLE cdp_dwh.fact_quotation_t;"
    }
]