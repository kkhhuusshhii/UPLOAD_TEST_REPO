[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "SELECT\nCAST(SRC.policy_num AS VARCHAR(35)),\nCAST(SRC.curr_cd AS VARCHAR(10)),\nCAST(SRC.policy_issue_dt AS DATE),\nCAST(CAST(SRC.policy_item_id AS INTEGER) AS VARCHAR(35)) ,\nCAST(SRC.broker_branch_rlshp_id AS VARCHAR(24)) ,\nCAST(SRC.dim_lob_key AS INTEGER),\nCAST(SRC.dim_policy_key AS INTEGER),\nCAST(SRC.dim_broker_key AS INTEGER),\nCAST(SRC.dim_branch_office_key AS INTEGER),\nCAST(SRC.dim_insured_key AS INTEGER),\nCAST(SRC.dim_policyholder_key AS INTEGER), \nCAST(SRC.dim_prd_pln_hrchy_key AS INTEGER),\nCAST(SRC.dim_risk_key AS INTEGER),\nCAST(SRC.src_sys_cd AS VARCHAR(10)),\nCAST(SRC.policy_eff_dt AS DATE),\nCAST(SRC.policy_exp_dt AS DATE),\nCAST(CAST(SRC.policy_status_cd AS INTEGER) AS VARCHAR(10)) ,\nCAST(SRC.cancel_dt AS VARCHAR(50)),\nCAST(CAST(SRC.cancel_reason_cd AS INTEGER) AS VARCHAR(10)) ,\nCAST(SRC.mv_id AS INTEGER),\nCAST(CAST(SRC.coins_type_cd AS INTEGER) AS VARCHAR(10)) ,\nCAST(SRC.coins_pct AS NUMERIC(8,4)),\nCAST(SRC.cancel_type AS VARCHAR(50)),\nCAST(SRC.facultativo_ind AS CHAR(1)),\nCAST(SRC.fronting_policy_ind AS CHAR(1)),\nCAST(SRC.mv_dt AS DATE),\nCAST(CAST(SRC.mv_reason_cd AS INTEGER) AS VARCHAR(10)) ,\nCAST(SRC.item_eff_dt AS DATE),/**ADDED FOR DID236**/\nCAST(SRC.item_exp_dt AS DATE),/**ADDED FOR DID236**/\nCAST(SRC. policy_status_desc AS VARCHAR(80)),\nCAST(SRC.cancel_reason_desc AS  VARCHAR(80)),\nCAST(SRC.mv_reason_desc AS VARCHAR(80)),\nCAST(SRC.surplus_ceded_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.fecultative_premium_amt AS NUMERIC(25,10)),\nCAST(SRC.retained_premium_amt AS NUMERIC(25,10)),\nCAST(SRC.direct_retained_premium AS NUMERIC(25,10)),\nCAST(SRC.premium_retained_74 AS NUMERIC(25,10)),\nCAST(SRC.remarque_comm_amt AS NUMERIC(25,10)),\nCAST(SRC.retained_share_part_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.ceded_share_part_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.liberty_reins_optional_prem_amt AS NUMERIC(25,10)), \nCAST(SRC.nwp_amt AS NUMERIC(25,10)),\nCAST(SRC.coins_amt AS NUMERIC(25,10)),\nCAST(SRC.cwp_amt AS NUMERIC(25,10)),\nCAST(SRC.gwp_amt AS NUMERIC(25,10)),\nCAST(SRC.endorsement_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.broker_comm_amt AS NUMERIC(25,10)),\nCAST(SRC.surplus_retained_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.policy_item_num AS INTEGER),\nCAST(SRC.acct_yr AS VARCHAR(4)),\nCAST(SRC.acct_mth AS VARCHAR(2)),\nCAST(SRC.acct_dt AS TIMESTAMP), --added for DID-215\nCAST(SRC.agreement AS VARCHAR(10)),\n'Y' AS actv_rec_ind,\nLKP.MAX_SID,\n-- Included for Flota indicator modification request (10/02/2022)\nCASE WHEN SRC.policy_exp_dt >= '2019-01-01' THEN (CASE  WHEN SRC.cflota = 1 THEN 'SI' \n                                                                                                                                                                                                                                ELSE 'NO' END)                                                            \n                 Else (\n                CASE pol_count.pcount \n                when pol_count.pcount>=10 and pol_count.cramo=6 then 'SI' \n                when pol_count.pcount<10 and pol_count.cramo=6 then 'NO'\n        else '-' END) \n                end as flota,       -- included for product Grupo integrado Venta tab\nCAST(SRC.usgaap_yr || SRC.usgaap_mnth AS INTEGER) as usgaap_period, -- Added for Sales by USGAAP\nCAST(SRC.mov_eff_dt AS DATE),/**ADDED FOR DID236**/\nCAST(SRC.mov_acc_dt AS DATE)/**ADDED FOR DID236**/\nFROM\n(\nSELECT\nAA.policy_num ,\nAA.curr_cd ,\nAA.policy_issue_dt,\nAA.policy_item_id ,\nAA.broker_branch_rlshp_id ,\nAA.dim_lob_key ,\nAA.dim_policy_key ,\nAA.dim_broker_key ,\nAA.dim_branch_office_key ,\nAA.dim_insured_key ,\nAA.dim_policyholder_key , \nAA.dim_prd_pln_hrchy_key ,\nAA.dim_risk_key,\nAA.src_sys_cd ,\nAA.policy_eff_dt,\nAA.policy_exp_dt ,\nAA.policy_status_cd ,\nAA.cancel_dt ,\nAA.cancel_reason_cd ,\nAA.mv_id ,\nAA.coins_type_cd ,\nAA.coins_pct ,\nAA.cancel_type ,\nAA.facultativo_ind ,\nAA.fronting_policy_ind ,\nAA.mv_dt ,\nAA.mv_reason_cd ,  \nAA.item_eff_dt ,/**ADDED FOR DID236**/\nAA.item_exp_dt ,/**ADDED FOR DID236**/\nAA.policy_status_desc ,\nAA.cancel_reason_desc ,\nAA.mv_reason_desc ,\nAA.surplus_ceded_prem_amt ,\nAA.fecultative_premium_amt ,\nAA.retained_premium_amt ,\nAA.direct_retained_premium ,\nAA.premium_retained_74 ,\nAA.remarque_comm_amt ,\nAA.retained_share_part_prem_amt ,\nAA.ceded_share_part_prem_amt ,\nAA.liberty_reins_optional_prem_amt ,\nNVL(AA.nwp_amt,0) AS nwp_amt ,\nAA.policy_item_num,\nNVL(AA.coins_amt,0) AS coins_amt,\nAA.cwp_amt,\nAA.gwp_amt,\nNULL AS endorsement_prem_amt,\nAA.broker_comm_amt,\nAA.acct_yr,\n--AA.acct_mth,\nCAST(RIGHT(0 || AA.acct_mth, 2) AS VARCHAR(10)) as acct_mth,\nAA.acct_dt, --added for DID-215\nAA.agreement,\n0 AS surplus_retained_prem_amt,\n1 as DUMMY,\nROW_NUMBER()OVER(PARTITION BY AA.policy_item_id,AA.mv_id,AA.src_sys_cd ORDER BY AA.fmovimi DESC) RNK,\nCAST(EXTRACT(YEAR FROM AA.usgaap_period) AS INTEGER) as usgaap_yr,\nCAST(RIGHT(0 || EXTRACT(MONTH FROM AA.usgaap_period),2) AS VARCHAR(20)) as usgaap_mnth, -- added for Sales by USGAAP\nAA.mov_eff_dt,/**ADDED FOR DID236**/\nAA.mov_acc_dt, /**ADDED FOR DID236**/\nAA.cflota\nFROM\n(SELECT \n--CAST(SEG.npoliza AS INTEGER)AS policy_num,\nTRUNC(SEG.npoliza)AS policy_num,--casting replaced by trunc\n                                                                                                                                                                                                                                   \nSEG.cmonseg AS curr_cd,\nSEG.FEMISIO AS policy_issue_dt,\n--CAST(SEG.sseguro AS INTEGER) AS policy_item_id,\nTRUNC(SEG.sseguro) AS policy_item_id,--casting replaced by trunc\n                                                                                                                                                                                                                                                                \nSEG.cagente AS broker_branch_rlshp_id ,\nNVL(LOB.dim_lob_key,0) AS dim_lob_key,\nNVL(POLICY.dim_policy_key,0) AS dim_policy_key,\nNVL(BRKR_KEY.dim_broker_key,0) AS dim_broker_key,\nNVL(BRANCH_OFFICE.dim_branch_office_key,0) AS dim_branch_office_key,  \nNVL(INSURED.dim_insured_key,0) AS dim_insured_key,\nNVL(POL_HOLD.dim_policyholder_key,0) AS dim_policyholder_key,  \nNVL(PLAN_HIRE.dim_prd_pln_hrchy_key,0) AS dim_prd_pln_hrchy_key,\nPOLICY_RSK.dim_risk_key AS dim_risk_key, \n'axis' AS src_sys_cd,\nSEG.FEFECTO AS policy_eff_dt,\nDECODE(SEG.CDURACI,3, SEG.FVENCIM, SEG.FCARPRO) AS policy_exp_dt,\nSEG.cagrseg AS agreement,\nSEG.CSITUAC  AS policy_status_cd,\nCASE WHEN SEG.CSITUAC=2 AND SEG.fefecto != SEG.FANULAC THEN SEG.fanulac  ----and SEG.cduraci = 3 as part CISD-21532\nWHEN SEG.CSITUAC=2 AND SEG.fefecto  = SEG.FANULAC  THEN SEG.fanulac  --and SEG.cduraci = 0 as part of CISD-21532\nELSE NULL END  AS cancel_dt,\nCASE WHEN SEG.CSITUAC=2 AND SEG.fefecto != SEG.FANULAC  THEN MOVE_SEG.cmotmov  ----and SEG.cduraci = 3 as part CISD-21532\nWHEN SEG.CSITUAC=2 AND SEG.fefecto  = SEG.FANULAC THEN MOVE_SEG.cmotmov   --and SEG.cduraci = 0 as part of CISD-21532\nELSE NULL END AS cancel_reason_cd,\nCAST(MOVE_SEG.NMOVIMI AS INTEGER) AS mv_id,\nSEG.CTIPCOA AS coins_type_cd,\nSEG.PPARCOA AS coins_pct,\nCASE WHEN SEG.CSITUAC=2 AND SEG.fefecto!= SEG.FANULAC THEN 'Cancelaci\u00c3\u00b3n' /*Changed as per scott comments from Cancellacion to Cancelaci\u00c3\u00b3n*/ --and SEG.cduraci = 3 as part CISD-21532\nWHEN SEG.CSITUAC=2 AND SEG.fefecto = SEG.FANULAC THEN 'Anulaci\u00c3\u00b3n' /*Changed as per scott comments from Annualacion to Anulaci\u00c3\u00b3n*/ --and SEG.cduraci = 0 as part of CISD-21532\nELSE NULL END AS cancel_type, \nCASE WHEN FACULATIVE_IND.CNT >= 1 THEN 'Y' ELSE 'N' END AS facultativo_ind,\nCASE WHEN FRONTING_POLICY_IND.CNT >=1  THEN 'Y' ELSE 'N' END AS fronting_policy_ind,\nMOVE_SEG.FMOVIMI AS mv_dt,\nMOVE_SEG.CMOTMOV AS mv_reason_cd,  \nMOVE_SEG.FEMISIO  AS item_eff_dt,/**ADDED FOR DID236**/\nMOVE_SEG.FMOVVTO AS item_exp_dt,/**ADDED FOR DID236**/\nSTG.ref_desc AS policy_status_desc,\n/*CASE WHEN SEG.CSITUAC=2 AND SEG.fefecto != SEG.FANULAC AND SEG.cduraci = 3 THEN STG1.ref_desc\nWHEN SEG.CSITUAC=2 AND SEG.fefecto  = SEG.FANULAC AND SEG.cduraci = 0 THEN STG1.ref_desc\nELSE NULL END AS cancel_reason_desc,*/\nAMT_SRC.tmotmov AS cancel_reason_desc, --as part CISD-21532\nSTG1.ref_desc AS mv_reason_desc,\nNVL(AMT_SRC.surplus_ceded_prem_amt,0) AS surplus_ceded_prem_amt,\nNVL(AMT_SRC_FEC_AMT.fecultative_premium_amt,0) AS fecultative_premium_amt,\nNVL(AMT_SRC.retained_premium_amt,0) AS retained_premium_amt,\nNVL(AMT_SRC.direct_retained_premium,0) AS direct_retained_premium,\nNVL(AMT_SRC.premium_retained_74,0) AS premium_retained_74,\nNVL(AMT_SRC.remarque_comm_amt,0) AS remarque_comm_amt,\nNVL(AMT_SRC.retained_share_part_prem_amt,0) AS retained_share_part_prem_amt,\nNVL(AMT_SRC.ceded_share_part_prem_amt,0) AS ceded_share_part_prem_amt,\nNVL(AMT_SRC.liberty_reins_optional_prem_amt,0) AS  liberty_reins_optional_prem_amt,\nNVL(AMT_SRC_2.broker_comm_amt,0) AS  broker_comm_amt,\nNVL(AMT_SRC_2.gwp_amt,0) AS  gwp_amt,\n(NVL(AMT_SRC.cwp_amt_1,0) + NVL(AMT_SRC_FEC_AMT.cwp_amt_2,0)) AS cwp_amt,\ncase when coins_type_cd='1' then NVL(gwp_amt*((100-coins_pct)/NULLIF(coins_pct,0)),0)\n     else 0 END AS coins_amt,   -----Added as part of CISD-21370\n-----(AMT_SRC_2.gwp_amt*(SEG.PPARCOA/100)) AS coins_amt, /*Added as part of modification in DMS sheet on 5/3/2019*/\n(\nNVL(AMT_SRC.retained_premium_amt,0) + \nNVL(AMT_SRC.direct_retained_premium,0) + \nNVL(AMT_SRC.premium_retained_74,0) + \nNVL(AMT_SRC.retained_share_part_prem_amt,0) + \nNVL(AMT_SRC.remarque_comm_amt,0) + \nNVL(AMT_SRC.liberty_reins_optional_prem_amt,0)) AS nwp_amt,\nMOVE_SEG.fmovimi,\nSEG.ncertif AS policy_item_num,\n--EXTRACT(YEAR FROM CAL.cal_dt) AS acct_yr,\n--EXTRACT(MONTH FROM CAL.cal_dt) AS acct_mth,\nCAL.axis_acct_yr_num as acct_yr,\nCAL.axis_acct_mth_num as acct_mth,\ncoalesce(ACCT.FCONTAB,move_seg.fcontab) AS acct_dt, --CISD-21273 Previous logic for acct_dt ACCT.FCONTAB AS acct_dt\nROW_NUMBER()OVER(PARTITION BY SEG.sseguro,MOVE_SEG.nmovimi ORDER BY POLICY_RSK.mv_id DESC, ACCT.FCONTAB DESC) RNK,\ncase when ACCT.FCONTAB > SEG.FEFECTO then ACCT.FCONTAB\n                     else SEG.FEFECTO\n                                end as usgaap_period, -- Added for Sales by USGAAP\nMOVE_SEG.FEFECTO AS mov_eff_dt,/**ADDED FOR DID236**/\nMOVE_SEG.FCONTAB AS mov_acc_dt,/**ADDED FOR DID236**/\nSEG.CFLOTA -- ADDED FOR FLEET INDICATOR LOGIC MODIFICATION\nFROM \n(\nSELECT SG.sseguro,MV_G.nmovimi FROM cdp_stg_dwh.sisaxis_seguros SG\nINNER JOIN cdp_ods.sisaxis_movseguro MV_G\nON MV_G.sseguro=SG.sseguro\nAND SG.ncertif > 0\n\n\nUNION\nSELECT  sseguro,nmovimi FROM  cdp_stg_dwh.sisaxis_movseguro \nUNION \nSELECT sseguro,nmovima AS nmovimi FROM cdp_stg_dwh.sisaxis_riesgos\nUNION\n\nSELECT CES.sseguro,RIE.nmovima AS nmovimi FROM cdp_stg_dwh.sisaxis_cesionesrea CES\nINNER JOIN cdp_ods.sisaxis_riesgos RIE\nON CES.sseguro=RIE.sseguro\nAND CES.nriesgo=RIE.nriesgo\n\nUNION\n\nSELECT CES.sseguro,RIE.nmovima AS nmovimi FROM cdp_ods.sisaxis_cesionesrea CES\nINNER JOIN cdp_ods.sisaxis_riesgos RIE\nON CES.sseguro=RIE.sseguro\nAND CES.nriesgo=RIE.nriesgo\nINNER JOIN cdp_stg_dwh.sisaxis_cuacesfac CUAC\nON CUAC.sfacult=CES.sfacult\n\nUNION\n\nSELECT SEG.sseguro,MOVE_SEG.nmovimi\nFROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\nINNER JOIN cdp_ods.sisaxis_movrec2movseg M2\nON M2.nmovimi=MOVE_SEG.nmovimi and M2.sseguro = MOVE_SEG.sseguro\nINNER JOIN cdp_ods.sisaxis_movrecibo MV_RECIBO\nON  MV_RECIBO.smovrec=M2.smovrec\nINNER JOIN cdp_ods.sisaxis_recibos RECIBOS\nON RECIBOS.nrecibo=MV_RECIBO.nrecibo\nINNER JOIN cdp_stg_dwh.sisaxis_detrecibos DET_RECIBOS   \nON DET_RECIBOS.nrecibo=RECIBOS.nrecibo\n\n\nUNION\n\nSELECT DISTINCT SEG.sseguro,MOVE_SEG.nmovimi FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0 ) SEG\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\nINNER JOIN cdp_ods.sisaxis_riesgos RSEG \nON MOVE_SEG.sseguro = RSEG.sseguro  \nAND MOVE_SEG.nmovimi = RSEG.nmovima\nINNER JOIN cdp_ods.sisaxis_cesionesrea CESION\nON RSEG.sseguro = CESION.sseguro \nAND RSEG.nriesgo = CESION.nriesgo\nINNER JOIN cdp_stg_dwh.sisaxis_cuadroces CUADROCES  \nON CUADROCES.scontra=CESION.scontra\nAND CUADROCES.ctramo=CESION.ctramo\n\n\n\n\nUNION\n\nSELECT DISTINCT SEG.sseguro,MOVE_SEG.nmovimi FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0 ) SEG\n\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\nINNER JOIN cdp_ods.sisaxis_riesgos RSEG \nON MOVE_SEG.sseguro = RSEG.sseguro  \nAND MOVE_SEG.nmovimi = RSEG.nmovima\nINNER JOIN cdp_ods.sisaxis_cesionesrea CESION\nON RSEG.sseguro = CESION.sseguro \nAND RSEG.nriesgo = CESION.nriesgo\nINNER JOIN cdp_stg_dwh.sisaxis_codicontratos CONDI \nON CONDI.scontra=CESION.scontra\n)DRIVER\nINNER JOIN\n(SELECT DISTINCT sseguro,nmovimi,cmotmov,FMOVIMI,FEMISIO,FMOVVTO,FEFECTO,FCONTAB  FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON DRIVER.sseguro=MOVE_SEG.sseguro\nAND DRIVER.nmovimi=MOVE_SEG.nmovimi\nINNER JOIN (select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0 ) SEG\nON MOVE_SEG.sseguro=SEG.sseguro\n\nLEFT JOIN cdp_ods.sisaxis_riesgos RSEG \nON MOVE_SEG.sseguro = RSEG.sseguro  \nAND MOVE_SEG.nmovimi = RSEG.nmovima\nLEFT JOIN (SELECT DISTINCT sseguro,nriesgo FROM cdp_ods.sisaxis_cesionesrea) CESION\nON RSEG.sseguro = CESION.sseguro \nAND RSEG.nriesgo = CESION.nriesgo\nLEFT JOIN cdp_dwh.dim_policy_t POLICY\n--ON CAST(CAST(SEG.npoliza AS INTEGER) AS VARCHAR(35))=POLICY.policy_num\nON CAST(TRUNC(SEG.npoliza) AS VARCHAR(35))=POLICY.policy_num --casting replaced by trunc\n                                                                                                                                                                                                                                                                                                                                                                \nAND POLICY.src_sys_cd='axis'\nLEFT JOIN cdp_dwh.dim_lob_t LOB \nON CAST(CAST(SEG.CRAMO  AS INTEGER) AS VARCHAR(10)) =LOB.lob_cd  \nAND LOB.src_sys_cd='axis'\nLEFT JOIN \n(SELECT DISTINCT BRKR.dim_broker_key,AA.sseguro FROM\n(SELECT DISTINCT BRKR_RLSHP.entity_rut_num,SEG.sseguro\nFROM (select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n\nINNER JOIN cdp_dwh.broker_branch_rlshp_t BRKR_RLSHP\nON SEG.cagente=BRKR_RLSHP.rlshp_src_id\nAND BRKR_RLSHP.entity_type_cd=4\nAND BRKR_RLSHP.src_sys_cd='axis')AA\nINNER JOIN cdp_dwh.dim_broker_t BRKR   \nON AA.entity_rut_num=BRKR.broker_id\n--AND BRKR.src_sys_cd='axis'\n) BRKR_KEY\nON BRKR_KEY.sseguro=SEG.sseguro\nLEFT JOIN\n(SELECT A.sseguro,A.nmovimi,INSURED.dim_insured_key  FROM\n(select \n tmp2.sseguro,\n  tmp2.nmovimi,\ntmp2.sperson,\ntmp2.cdomici\nfrom \n ( select \n tmp1.sseguro, \n tmp1.nriesgo, \n tase.nmovima, \n tase.sperson, \n tase.cdomici, \n tmp1.nmovimi,\nrow_number() over(\npartition by \n tmp1.sseguro, \n tmp1.nriesgo,\ntmp1.nmovimi\norder by \n tase.norden desc\n) as row_ind \n from ( select \n tmov.sseguro, \n tmov.nmovimi, \n trie.nriesgo, \n trie.sperson, \n trie.cdomici, \n row_number() over(\npartition by \n tmov.sseguro, \n tmov.nmovimi \n order by \n trie.nmovima desc\n) as row_ind \n from \n ( select distinct \n sseguro \n from \n cdp_ods.sisaxis_seguros \n where \n ncertif > 0 \n ) tseg \n inner join cdp_ods.sisaxis_movseguro tmov \n on tseg.sseguro = tmov.sseguro \ninner join cdp_ods.sisaxis_riesgos trie --\non tmov.sseguro = trie.sseguro \n and tmov.nmovimi >= trie.nmovima\n) tmp1 \ninner join cdp_ods.sisaxis_asegurados tase \n on tmp1.sseguro = tase.sseguro \n and tmp1.nriesgo = tase.nriesgo \n and tmp1.nmovimi >= tase.nmovima\nand (tmp1.nmovimi < tase.nmovimb\nor tase.nmovimb is null )\nwhere \n tmp1.row_ind = 1 \n ) tmp2\nwhere \n tmp2.row_ind = 1\ngroup by \n  tmp2.sseguro,\n  tmp2.nmovimi,\ntmp2.sperson,\ntmp2.cdomici\norder by\n  tmp2.sseguro,\n  tmp2.nmovimi,\ntmp2.sperson,\ntmp2.cdomici) A\n\nINNER JOIN cdp_dwh.dim_insured_t INSURED  \nON INSURED.insured_id=CAST(A.sperson AS INTEGER)\nAND INSURED.address_id=CAST(nvl(CAST(A.cdomici AS INTEGER),0) AS INTEGER) /*Added as part of CDP-238 */\nAND INSURED.src_sys_cd='axis')INSURED\nON INSURED.sseguro=SEG.sseguro\nAND INSURED.nmovimi=MOVE_SEG.nmovimi /* Changed the Logic as per scott comments to get the correct insured key which is associated to correct Risk*/\n\nLEFT JOIN\n(select * from cdp_stg_dwh.stg_tref_code_map_variant where src_sys_cd='axis' and ref_type_cd='policy_status_cd') STG\non CAST(CAST(csituac AS INTEGER) as varchar(20))=STG.ref_cd \n\nLEFT JOIN\n(select * from cdp_stg_dwh.stg_tref_code_map_variant where src_sys_cd='axis' and ref_type_cd='movement_cd') STG1\non CAST(CAST(cmotmov AS INTEGER) as varchar(20))=STG1.ref_cd \n\nLEFT JOIN cdp_dwh.dim_branch_office_t BRANCH_OFFICE\nON LTRIM(RIGHT(SEG.cagente,3),0)=LTRIM(BRANCH_OFFICE.branch_office_cd,0)  /*LTRIM has been handled to remove leading zero from both join condition to get a exact match*/ \nAND BRANCH_OFFICE.src_sys_cd='axis'\n\nLEFT JOIN cdp_dwh.dim_region_t REGN\nON RIGHT(SEG.cagente,3)=REGN.region_cd\n\n/*LEFT JOIN(\nSELECT DISTINCT POL_HOLD.dim_policyholder_key,AA.sseguro  from \n(SELECT cast(cast(TOMA.SPERSON as integer)||'-'||cast(nvl(TOMA.CDOMICI,0) as integer) as varchar(35)) AS TOMA_HLD_ID, SEG.sseguro FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n\n\nINNER JOIN cdp_dwh.dim_policy_t POLICY\nON CAST(CAST(SEG.npoliza AS INTEGER) AS VARCHAR(35))=POLICY.policy_num\nAND POLICY.src_sys_cd='axis'\n\nINNER JOIN cdp_ods.sisaxis_tomadores TOMA\nON POLICY.policy_id=CAST(TOMA.sseguro AS INTEGER))AA\n\nINNER JOIN cdp_dwh.dim_policyholder_t POL_HOLD\nON AA.TOMA_HLD_ID=POL_HOLD.policyholder_id\nAND POL_HOLD.src_sys_cd='axis'\n)POL_HOLD  \nON SEG.sseguro=POL_HOLD.sseguro */ --commented as part of CISD-7758\n\nLEFT JOIN\n(SELECT DISTINCT dim.dim_policyholder_key dim_policyholder_key,TOMA.sseguro sseguro\nFROM  cdp_ods.sisaxis_tomadores TOMA\nINNER JOIN cdp_dwh.dim_policyholder_t dim\nON cast(cast(TOMA.SPERSON as integer)||'-'||cast(nvl(TOMA.CDOMICI,0) as integer) as varchar(35))=dim.policyholder_id\nAND dim.src_sys_cd='axis'\n)POL_HOLD\nON SEG.sseguro=POL_HOLD.sseguro --Added as part of CISD-7758\n\n\nLEFT JOIN(SELECT PLAN_HIRE.dim_prd_pln_hrchy_key,SEG.sseguro FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n\nINNER JOIN cdp_dwh.dim_prd_pln_hrchy_t PLAN_HIRE\nON PLAN_HIRE.prd_cd=CAST(CAST(SEG.sproduc AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.lob_cd=CAST(CAST(SEG.cramo AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.pln_cd=CAST(CAST(SEG.cactivi AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.src_sys_cd='axis'\n)PLAN_HIRE\nON PLAN_HIRE.sseguro=SEG.sseguro\n\nLEFT JOIN(\nSELECT COUNT(*) AS CNT,SEG.sseguro,MOVE_SEG.nmovimi FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\n\nLEFT JOIN cdp_ods.sisaxis_riesgos RSEG \nON MOVE_SEG.sseguro = RSEG.sseguro  \nAND MOVE_SEG.nmovimi = RSEG.nmovima\n\nLEFT JOIN cdp_ods.sisaxis_cesionesrea CESION\nON RSEG.sseguro = CESION.sseguro \nAND RSEG.nriesgo = CESION.nriesgo\n\nLEFT JOIN cdp_ods.sisaxis_cuacesfac CUACESFAC\nON CUACESFAC.sfacult=CESION.sfacult\n\nLEFT JOIN cdp_ods.sisaxis_cuadroces CUADROCES                            /*Added as part of mapping sheet modification in sprint 2.5 based on Jeff comment*/\nON CUADROCES.scontra=CESION.scontra                                                                             /*Added as part of mapping sheet modification in sprint 2.5 based on Jeff comment*/\nAND CUADROCES.ctramo=CESION.ctramo                                                                            /*Added as part of mapping sheet modification in sprint 2.5 based on Jeff comment*/\n\nWHERE CAST(CESION.ctramo AS INTEGER) in (4,5) \nAND CAST(CESION.cgenera AS INTEGER)<>2\nGROUP BY SEG.sseguro,MOVE_SEG.nmovimi )FACULATIVE_IND\nON FACULATIVE_IND.sseguro=SEG.sseguro\nAND FACULATIVE_IND.nmovimi=MOVE_SEG.nmovimi\n\nLEFT JOIN(\nSELECT   SEG.sseguro,MOVE_SEG.nmovimi,COUNT(*) AS CNT FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0 ) SEG\n\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\n\nLEFT JOIN cdp_ods.sisaxis_riesgos RSEG \nON MOVE_SEG.sseguro = RSEG.sseguro  \nAND MOVE_SEG.nmovimi = RSEG.nmovima\n\nLEFT JOIN cdp_ods.sisaxis_cesionesrea CESION\nON RSEG.sseguro = CESION.sseguro \nAND RSEG.nriesgo = CESION.nriesgo\n\nLEFT JOIN cdp_ods.sisaxis_cuacesfac CUACESFAC\nON CUACESFAC.sfacult=CESION.sfacult\n\nLEFT JOIN cdp_ods.sisaxis_cuadroces CUADROCES\nON CUADROCES.scontra=CESION.scontra\nAND CUADROCES.ctramo=CESION.ctramo\nWHERE  CUACESFAC.pcesion>=90       /*Added as part of sprint 2.5 */\nGROUP BY SEG.sseguro,MOVE_SEG.nmovimi\n) FRONTING_POLICY_IND\nON FRONTING_POLICY_IND.sseguro=SEG.sseguro\nAND FRONTING_POLICY_IND.nmovimi=MOVE_SEG.nmovimi\n\nLEFT JOIN(\nSELECT SEG.sseguro,MOVE_SEG.nmovimi,NVL(POLICY_RSK.dim_risk_key,0) AS dim_risk_key,POLICY_RSK.mv_id FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0 ) SEG\n\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi,fcontab FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\nLEFT JOIN  cdp_dwh.dim_policy_risk_t POLICY_RSK\nON POLICY_RSK.policy_item_id=CAST(SEG.sseguro AS INTEGER)\n--AND POLICY_RSK.mv_id=CAST(MOVE_SEG.nmovimi AS INTEGER)\nAND CAST(MOVE_SEG.nmovimi AS INTEGER) >= POLICY_RSK.mv_id\nAND POLICY_RSK.src_sys_cd='axis'\n)POLICY_RSK\nON POLICY_RSK.sseguro=SEG.sseguro\nAND POLICY_RSK.nmovimi=MOVE_SEG.nmovimi \n\n--LEFT JOIN cdp_dwh.dim_cal_t CAL\n--ON CAL.cal_dt=CAST(MOVE_SEG.FMOVIMI AS DATE)\n/*Join to populate acct_dt*/\nLEFT OUTER JOIN cdp_ods.sisaxis_movrec2movseg MACCT\nON MACCT.nmovimi=MOVE_SEG.nmovimi and MACCT.sseguro = MOVE_SEG.sseguro\nLEFT OUTER JOIN cdp_ods.sisaxis_movrecibo ACCT\nON  ACCT.smovrec=MACCT.smovrec\nLEFT JOIN cdp_dwh.dim_cal_t CAL\nON CAL.cal_dt=CAST(coalesce(ACCT.FCONTAB,MOVE_SEG.FCONTAB) AS DATE) --*/CISD-21273 previous logic ON CAL.cal_dt=CAST(ACCT.FCONTAB) AS DATE)*/\n\nLEFT JOIN\n(\nSELECT SUM(AMT_SRC.surplus_ceded_prem_amt) AS surplus_ceded_prem_amt,\nSUM(AMT_SRC.retained_premium_amt) AS retained_premium_amt,\nSUM(AMT_SRC.direct_retained_premium) AS direct_retained_premium,\nSUM(AMT_SRC.premium_retained_74) AS premium_retained_74,\nSUM(AMT_SRC.remarque_comm_amt) AS remarque_comm_amt,\nSUM(AMT_SRC.retained_share_part_prem_amt) AS retained_share_part_prem_amt,\nSUM(AMT_SRC.ceded_share_part_prem_amt) AS ceded_share_part_prem_amt,\nSUM(AMT_SRC.liberty_reins_optional_prem_amt) AS liberty_reins_optional_prem_amt,\nSUM(AMT_SRC.cwp_amt_1) AS cwp_amt_1,\nAMT_SRC.sseguro,\nAMT_SRC.NMOVIMI,\nAMT_SRC.tmotmov,  --as part CISD-21532\nAMT_SRC.ncertif  \nfrom\n(\nSELECT\nCC.surplus_ceded_prem_amt,\nCC.retained_premium_amt,\nCC.direct_retained_premium,\nCC.premium_retained_74,\nCC.remarque_comm_amt,\nCC.retained_share_part_prem_amt,\nCC.ceded_share_part_prem_amt,\nCC.liberty_reins_optional_prem_amt,\n/*CASE WHEN CC.cwp_amt_ind='Y' THEN (CC.ceded_share_part_prem_amt + CC.surplus_premium_amt) ELSE NULL END AS cwp_amt_1  , *//*Added as part of sprint 2.5 */ /* Commented as part of cdp-235 sprint 2.8 */\n(CC.ceded_share_part_prem_amt + CC.surplus_ceded_prem_amt)  AS cwp_amt_1  ,\nCC.sseguro,\nCC.ncertif,\nCC.NMOVIMI,\nCC.tmotmov  -- as part CISD-21532\nFROM\n(\nSELECT\n(NVL(AA.surplus_premium_amt_1,0) + NVL(AA.surplus_premium_amt_2,0)) AS surplus_ceded_prem_amt,\nAA.retained_premium_amt,\nAA.direct_retained_premium,\nAA.premium_retained_74,\nAA.remarque_comm_amt,\nAA.retained_share_part_prem_amt,\nNVL(AA.ceded_share_part_prem_amt,0) AS ceded_share_part_prem_amt,\n(NVL(liberty_reins_optional_prem_amt_1,0) + NVL(liberty_reins_optional_prem_amt_2,0)) AS liberty_reins_optional_prem_amt,\n/*AA.cwp_amt_ind,*/  /* Commented as part of cdp-235 sprint 2.8 */\nAA.sseguro,\nAA.ncertif,\nAA.NMOVIMI,\nAA.tmotmov --as part CISD-21532\nFROM\n(SELECT \nCASE WHEN  BB.CESION_CTRAMO=2 AND BB.CESION_cgenera <>2 THEN ((BB.CUADROCES_1_pcesion*BB.icesmon)/100) ELSE 0 END AS surplus_premium_amt_1,              /* Filter Added as part of sprint 2.5 */\nCASE WHEN BB.CESION_CTRAMO=3 AND BB.CESION_cgenera <>2 THEN ((BB.CUADROCES_1_pcesion*BB.icesmon)/100) ELSE 0 END AS surplus_premium_amt_2,               /*Filter Added as part of sprint 2.5 */\nCASE WHEN BB.CESION_CTRAMO=0 AND BB.CESION_cgenera <>2 THEN BB.icesmon ELSE 0 END AS retained_premium_amt,              /*Filter Added as part of sprint 2.5  */\nCASE WHEN BB.CESION_CTRAMO=16 AND BB.CESION_cgenera <>2 THEN BB.icesmon ELSE 0 END AS direct_retained_premium,  /* Filter Added as part of sprint 2.5 */\nCASE WHEN BB.CESION_CTRAMO=17 AND BB.CESION_cgenera <>2 THEN BB.icesmon ELSE 0 END AS premium_retained_74,                 /* Filter Added as part of sprint 2.5 */\nCASE WHEN BB.CESION_CTRAMO=18 AND BB.CESION_cgenera <>2 THEN BB.icesmon ELSE 0 END AS remarque_comm_amt,                  /* Filter Added as part of sprint 2.5 */\nCASE WHEN  BB.CESION_CTRAMO=1 AND BB.CESION_cgenera <>2 AND BB.ctiprea=21 THEN BB.icesmon \nWHEN BB.CESION_CTRAMO=1 AND BB.CESION_cgenera <>2 AND BB.PCUOPAR>0 THEN (((BB.PCUOPAR+NVL(BB.CUADROCES_2_pcesion,0))*BB.icesmon)/100)\nELSE 0 END AS retained_share_part_prem_amt,\nCASE WHEN  BB.CESION_CTRAMO=1 AND BB.CESION_cgenera <>2 AND BB.ctiprea<>21 AND BB.PCUOPAR>=0 \nTHEN ((BB.CUADROCES_1_pcesion*BB.icesmon)/100)\nELSE 0 END AS ceded_share_part_prem_amt,\nCASE WHEN  BB.CESION_CTRAMO=2 AND BB.CESION_cgenera <>2  THEN                 ((BB.CUADROCES_2_pcesion*BB.icesmon)/100) ELSE 0 END AS liberty_reins_optional_prem_amt_1,                                                        /* Filter Added as part of sprint 2.5 */\nCASE WHEN  BB.CESION_CTRAMO=3 AND BB.CESION_cgenera <>2  THEN                 ((BB.CUADROCES_2_pcesion*BB.icesmon)/100) ELSE 0 END AS liberty_reins_optional_prem_amt_2,\n/*CASE WHEN BB.CESION_CTRAMO=1 AND BB.ctiprea<>21 AND BB.CESION_cgenera<>2 THEN 'Y' ELSE 'N' END AS cwp_amt_ind, */    /* Filter Added as part of sprint 2.5 */ /* Commented as part of cdp-235 sprint 2.8 */\nBB.sseguro,\nBB.ncertif,\nBB.NMOVIMI,\nBB.tmotmov,  ---as part CISD-21532\nBB.icesmon,\nBB.pcesion\nFROM\n(\nSELECT  MOT.tmotmov,/*as part CISD-21532*/ CESION.icesmon,CESION.pcesion,CAST(CESION.CTRAMO AS INTEGER) AS CESION_CTRAMO,CESION.PCUOPAR,SEG.sseguro,SEG.ncertif,MOVE_SEG.nmovimi,\nCAST(CESION.cgenera AS INTEGER) AS CESION_cgenera,CUACESFAC.pcesion AS CUACESFAC_pcesion,CUADROCES_1.pcesion AS CUADROCES_1_pcesion,\nCUADROCES_2.pcesion AS CUADROCES_2_pcesion,CAST(CONDI.ctiprea AS INTEGER) AS ctiprea FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0 ) SEG\n\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi, cmotmov FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\nINNER JOIN (Select tmotmov,cmotmov from cdp_ods.sisaxis_motmovseg where cidioma = 3) MOT --as part CISD-21532\nON MOT.cmotmov = MOVE_SEG.cmotmov --as part CISD-21532\nLEFT JOIN cdp_ods.sisaxis_riesgos RSEG \nON MOVE_SEG.sseguro = RSEG.sseguro  \nAND MOVE_SEG.nmovimi = RSEG.nmovima\nLEFT JOIN cdp_ods.sisaxis_cesionesrea CESION\nON MOVE_SEG.sseguro = CESION.sseguro \n--AND RSEG.nriesgo = CESION.nriesgo Commented as a part of DID-223\nAND MOVE_SEG.nmovimi = CESION.nmovigen --DID-223\nLEFT JOIN cdp_ods.sisaxis_cuacesfac CUACESFAC\nON CUACESFAC.sfacult=CESION.sfacult\nLEFT JOIN (SELECT SUM(A.pcesion) AS pcesion,A.scontra,A.ctramo FROM cdp_ods.sisaxis_cuadroces A\nWHERE A.ccompani<>1 GROUP BY A.scontra,A.ctramo)CUADROCES_1\nON CUADROCES_1.scontra=CESION.scontra\nAND CUADROCES_1.ctramo=CESION.ctramo\nLEFT JOIN (SELECT SUM(A.pcesion) AS pcesion,A.scontra,A.ctramo FROM cdp_ods.sisaxis_cuadroces A\nWHERE A.ccompani=1 GROUP BY A.scontra,A.ctramo)CUADROCES_2\nON CUADROCES_2.scontra=CESION.scontra\nAND CUADROCES_2.ctramo=CESION.ctramo\nLEFT JOIN cdp_ods.sisaxis_codicontratos CONDI  /* Added as part of sprint 2.5 */\nON CONDI.scontra=CESION.scontra\n)BB\n)AA\n)CC\n)AMT_SRC\nGROUP BY AMT_SRC.sseguro,AMT_SRC.NMOVIMI,AMT_SRC.ncertif, AMT_SRC.tmotmov --as part CISD-21532\n)AMT_SRC\nON AMT_SRC.sseguro=SEG.sseguro\nAND AMT_SRC.NMOVIMI=MOVE_SEG.NMOVIMI\nLEFT JOIN\n(\nSELECT \nSUM(AMT_SRC_FEC_AMT.fecultative_premium_amt) AS fecultative_premium_amt,\nSUM(AMT_SRC_FEC_AMT.fecultative_premium_amt) AS cwp_amt_2,\nAMT_SRC_FEC_AMT.sseguro,\nAMT_SRC_FEC_AMT.NMOVIMI,\nAMT_SRC_FEC_AMT.ncertif  \nfrom\n(\nSELECT\nNVL(CC.fecultative_premium_amt,0) fecultative_premium_amt,\n/*CASE WHEN CC.cwp_amt_ind='Y' THEN CC.fecultative_premium_amt ELSE NULL END AS cwp_amt_2,*/ /* Commented as part of cdp-235 sprint 2.8 */\nCC.sseguro,\nCC.ncertif,\nCC.NMOVIMI\nfrom\n(SELECT\nAA.fecultative_premium_amt,\nAA.sseguro,\nAA.ncertif,\nAA.NMOVIMI\n/*AA.cwp_amt_ind*/ /* Commented as part of cdp-235 sprint 2.8 */\nFROM\n(SELECT \nCASE WHEN (BB.CESION_CTRAMO=5  OR BB.CESION_CTRAMO=4) AND CESION_cgenera <>2 THEN BB.icesmon ELSE 0 END AS fecultative_premium_amt,   /* Filter Added as part of sprint 2.5 */\n/*CASE WHEN BB.CESION_CTRAMO=1 AND BB.ctiprea<>21 AND BB.CESION_cgenera<>2 THEN 'Y' ELSE 'N' END AS cwp_amt_ind,*/ /* Commented as part of cdp-235 sprint 2.8 */\nBB.sseguro,\nBB.ncertif,\nBB.NMOVIMI,\nBB.icesmon,\nBB.pcesion\nFROM\n(\nSELECT   CESION.icesmon,CESION.pcesion,CAST(CESION.CTRAMO AS INTEGER) AS CESION_CTRAMO,CESION.PCUOPAR,SEG.sseguro,SEG.ncertif,MOVE_SEG.nmovimi,\nCAST(CESION.cgenera AS INTEGER) AS CESION_cgenera,CAST(CONDI.ctiprea AS INTEGER)\nFROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\nLEFT JOIN cdp_ods.sisaxis_riesgos RSEG \nON MOVE_SEG.sseguro = RSEG.sseguro  \nAND MOVE_SEG.nmovimi = RSEG.nmovima\nLEFT JOIN cdp_ods.sisaxis_cesionesrea CESION\nON MOVE_SEG.sseguro = CESION.sseguro \n--AND RSEG.nriesgo = CESION.nriesgo Commented as a part of DID-223\nAND MOVE_SEG.nmovimi = CESION.nmovigen --DID-223\nLEFT JOIN cdp_ods.sisaxis_codicontratos CONDI\nON CONDI.scontra=CESION.scontra\n)BB\n)AA\n)CC\n)AMT_SRC_FEC_AMT\nGROUP BY AMT_SRC_FEC_AMT.sseguro,AMT_SRC_FEC_AMT.NMOVIMI,AMT_SRC_FEC_AMT.ncertif\n)AMT_SRC_FEC_AMT\nON AMT_SRC_FEC_AMT.sseguro=SEG.sseguro\nAND AMT_SRC_FEC_AMT.NMOVIMI=MOVE_SEG.NMOVIMI\nLEFT JOIN\n(\nSELECT SUM(AMT_SRC_2.broker_comm_amt) AS broker_comm_amt,\nSUM(AMT_SRC_2.gwp_amt) AS gwp_amt,\nAMT_SRC_2.sseguro,\nAMT_SRC_2.nmovimi\nFROM\n(SELECT \nCASE WHEN AA.MV_RECIBO_CESTREC=2 AND AA.cconcep=11 THEN (AA.ICONCEP*-1) \nWHEN AA.RECIBOS_CTIPREC=9 AND AA.cconcep=11 THEN (AA.ICONCEP*-1)\nWHEN AA.RECIBOS_CTIPREC=11 AND AA.cconcep=11 THEN (AA.ICONCEP*1)  /*Added as part of modification in DMS sheet on 5/3/2019*/\nELSE NULL END AS broker_comm_amt,\nCASE WHEN AA.MV_RECIBO_CESTREC =0 AND AA.RECIBOS_CTIPREC =9 THEN (AA.ICONCEP * -1) \nWHEN AA.MV_RECIBO_CESTREC =0 AND AA.RECIBOS_CTIPREC =11 THEN (AA.ICONCEP * 1) \nWHEN AA.MV_RECIBO_CESTREC =2 AND AA.RECIBOS_CTIPREC =9 THEN (AA.ICONCEP * 1) \nWHEN AA.MV_RECIBO_CESTREC =2 AND AA.RECIBOS_CTIPREC =11 THEN (AA.ICONCEP * -1)  \nELSE NULL END AS gwp_amt,\n--Proposed change for DID-216 for gwp_amt\nAA.sseguro,\nAA.nmovimi\nFROM\n(SELECT SEG.sseguro,SEG.ncertif,MOVE_SEG.nmovimi,DET_RECIBOS.ICONCEP,CAST(MV_RECIBO.CESTREC AS INTEGER) AS MV_RECIBO_CESTREC ,\nCAST(RECIBOS.CTIPREC AS INTEGER) AS RECIBOS_CTIPREC,MV_RECIBO.nrecibo,CAST(DET_RECIBOS.cconcep AS INTEGER) AS cconcep\nFROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n\nINNER JOIN (SELECT DISTINCT sseguro,nmovimi FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\nON MOVE_SEG.sseguro=SEG.sseguro\nLEFT JOIN cdp_ods.sisaxis_movrec2movseg M2\nON M2.nmovimi=MOVE_SEG.nmovimi and M2.sseguro = MOVE_SEG.sseguro\nLEFT JOIN cdp_ods.sisaxis_movrecibo MV_RECIBO\nON  MV_RECIBO.smovrec=M2.smovrec\nLEFT JOIN cdp_ods.sisaxis_recibos RECIBOS\nON RECIBOS.nrecibo=MV_RECIBO.nrecibo\nLEFT JOIN (select * from cdp_ods.sisaxis_detrecibos where CAST(cconcep AS INTEGER) in (0)) DET_RECIBOS\nON DET_RECIBOS.nrecibo=RECIBOS.nrecibo\n)AA --Proposed change for DID-216\n)AMT_SRC_2\nGROUP BY AMT_SRC_2.sseguro,AMT_SRC_2.NMOVIMI\n)AMT_SRC_2\nON AMT_SRC_2.sseguro=SEG.sseguro\nAND AMT_SRC_2.NMOVIMI=MOVE_SEG.NMOVIMI\n\n)AA\nWHERE AA.RNK=1 \n-- AND AA.agreement is not null\n)SRC\nLEFT OUTER JOIN \n(select npoliza, cramo, count(*) as pcount from cdp_ods.sisaxis_seguros  /* added for groupo integrado */                                                                                                                                                                                            \ngroup by npoliza, cramo) pol_count\non TRUNC(SRC.policy_num )=TRUNC(pol_count.npoliza)--casting replaced by trunc\nLEFT JOIN (SELECT 1 as DUMMY, max(fact_policy_item_mv_key) AS MAX_SID from cdp_dwh.fact_policy_prem_comm_summary_t) LKP\nON LKP.DUMMY=SRC.DUMMY\nWHERE SRC.RNK=1"
    },
    {
        "type": "customQuery",
        "path": "content.transformations[1].dataAdapter.object.customQuery",
        "value": "SELECT\nSTG.fact_policy_item_mv_key,\nSTG.policy_item_id,\nSTG.mv_id,\nSTG.src_sys_cd\nFROM  cdp_dwh.fact_policy_prem_comm_summary_t STG\nWHERE STG.src_sys_cd='axis' --"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[13].dataAdapter.oprRuntimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "update fact_policy_prem_comm_summary_t\nset acct_yr = dim_cal_t.axis_acct_yr_num,\n    acct_mth =  case when ( len(dim_cal_t.axis_acct_mth_num) = 1 ) then concat('0',dim_cal_t.axis_acct_mth_num)\n            else cast(dim_cal_t.axis_acct_mth_num as character(2))\n            end\nfrom dim_cal_t\nwhere\nfact_policy_prem_comm_summary_t.acct_yr is null and fact_policy_prem_comm_summary_t.acct_mth is null and\nfact_policy_prem_comm_summary_t.acct_dt = dim_cal_t.cal_dt\nand fact_policy_prem_comm_summary_t.src_sys_cd  = 'axis' ;"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[13].dataAdapter.runtimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "update fact_policy_prem_comm_summary_t\nset acct_yr = dim_cal_t.axis_acct_yr_num,\n    acct_mth =  case when ( len(dim_cal_t.axis_acct_mth_num) = 1 ) then concat('0',dim_cal_t.axis_acct_mth_num)\n            else cast(dim_cal_t.axis_acct_mth_num as character(2))\n            end\nfrom dim_cal_t\nwhere\nfact_policy_prem_comm_summary_t.acct_yr is null and fact_policy_prem_comm_summary_t.acct_mth is null and\nfact_policy_prem_comm_summary_t.acct_dt = dim_cal_t.cal_dt\nand fact_policy_prem_comm_summary_t.src_sys_cd  = 'axis' ;"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[14].dataAdapter.oprRuntimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "update fact_policy_prem_comm_summary_t\nset acct_yr = dim_cal_t.axis_acct_yr_num,\n    acct_mth =  case when ( len(dim_cal_t.axis_acct_mth_num) = 1 ) then concat('0',dim_cal_t.axis_acct_mth_num)\n            else cast(dim_cal_t.axis_acct_mth_num as character(2))\n            end\nfrom dim_cal_t\nwhere\nfact_policy_prem_comm_summary_t.acct_yr is null and fact_policy_prem_comm_summary_t.acct_mth is null and\nfact_policy_prem_comm_summary_t.acct_dt = dim_cal_t.cal_dt\nand fact_policy_prem_comm_summary_t.src_sys_cd  = 'axis' ;\n\n--CISD-21569--\nupdate cdp_dwh.fact_policy_prem_comm_summary_t a \nset flota = case when s.cflota =1 then 'SI' else 'NO' end\nfrom (select cflota, sseguro, npoliza from cdp_ods.sisaxis_seguros) s\nwhere  s.sseguro = a.policy_item_id \nand src_sys_cd = 'axis';"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[14].dataAdapter.runtimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "update fact_policy_prem_comm_summary_t\nset acct_yr = dim_cal_t.axis_acct_yr_num,\n    acct_mth =  case when ( len(dim_cal_t.axis_acct_mth_num) = 1 ) then concat('0',dim_cal_t.axis_acct_mth_num)\n            else cast(dim_cal_t.axis_acct_mth_num as character(2))\n            end\nfrom dim_cal_t\nwhere\nfact_policy_prem_comm_summary_t.acct_yr is null and fact_policy_prem_comm_summary_t.acct_mth is null and\nfact_policy_prem_comm_summary_t.acct_dt = dim_cal_t.cal_dt\nand fact_policy_prem_comm_summary_t.src_sys_cd  = 'axis' ;\n\n--CISD-21569--\nupdate cdp_dwh.fact_policy_prem_comm_summary_t a \nset flota = case when s.cflota =1 then 'SI' else 'NO' end\nfrom (select cflota, sseguro, npoliza from cdp_ods.sisaxis_seguros) s\nwhere  s.sseguro = a.policy_item_id \nand src_sys_cd = 'axis';"
    }
]