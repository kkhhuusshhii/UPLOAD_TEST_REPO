[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "--Updated query with rolled back transporte changes & item_type changes\nWITH CMI_PROPUESTA_1\nAS (\n\tSELECT PROP.SCICLO\n\t\t,PROP.CRAMO\n\t\t,PROP.CTIPDOC\n\t\t,PROP.NPOLIZA\n\t\t,PROP.NPOLIZAANT\n\t\t,PROP.CRENOVA\n\t\t,PROP.CORIGEN\n\t\t,PROP.CRENOVPE\n\tFROM CDP_ODS.SISAXIS_CMI_PROPUESTA PROP\n\t\t,CDP_ODS.SISAXIS_CMI_MOVPROPUESTA MOV\n\tWHERE PROP.CSISTEMA = '1'\n\t\tAND MOV.CSISTEMA = '15'\n\t\tAND PROP.SCICLO = MOV.SCICLO\n\t\tAND MOV.NMOVIMI = 1\n\t\tAND TO_CHAR(MOV.FEFECTO, 'YYYY') >= 2011\n\t)\n\t,CMI_MOVPROPUESTA_15\nAS (\n\tSELECT SCICLO\n\t\t,NMOVIMI\n\t\t,SNMOVIMI\n\t\t,CESTADO\n\t\t,FEFECTO\n\t\t,CUSUASIG\n\t\t,CUSUMOD\n\t\t,FTERMINO\n\t\t,CTIPO\n\t\t,ROL_EJEC\n\t\t,FINICIO_REAL\n\tFROM CDP_ODS.SISAXIS_CMI_MOVPROPUESTA\n\tWHERE CSISTEMA = '15'\n\t\tAND TO_CHAR(FEFECTO, 'YYYY') >= 2011\n\t)\n\t,DET\nAS (\n\tSELECT NRO_LINEA\n\t\t,ID_PROCESO\n\t\t,ESTADO\n\t\t,DESC_ESTADO\n\t\t,SEC_CAR_MAS\n\t\t,COD_EMPRESA\n\t\t,COD_FORMATO\n\t\t,SSEGURO\n\t\t,COD_PRODUC\n\t\t,NUM_CONVEN\n\t\t,NUM_POLIZA\n\t\t,RUT_CONTRA\n\t\t,RUT_ASE\n\t\t,NU_RECIBO\n\t\t,COD_AGENTE\n\t\t,NU_PROPUESTA\n\t\t,NUM_CICLO\n\t\t,NUM_POLIZA_ANT\n\t\t,NUM_COTIZACION\n\t\t,NUM_MASIVO\n\t\t,FEC_CREA\n\t\t,PRIMA_PROPUESTA\n\t\t,CI_FONO_1\n\t\t,CI_FONO_2\n\tFROM CDP_ODS.SISADMCOM_SISREC_DETCARMAS\n\t)\n\t,PROD\nAS (\n\tSELECT p.cramo\n\t\t,p.sproduc\n\t\t,t.ttitulo\n\t\t,p.cobjase\n\tFROM CDP_ODS.sisaxis_productos p\n\t\t,CDP_ODS.sisaxis_titulopro t\n\tWHERE p.ccolect = t.ccolect\n\t\tAND p.cramo = t.cramo\n\t\tAND p.cmodali = t.cmodali\n\t\tAND p.ctipseg = t.ctipseg\n\t)\n\t,DOC\nAS (\n\tSELECT a.sseguro\n\t\t,a.nmovimis\n\t\t,MAX(a.sciclo) AS sciclo\n\tFROM (\n\t\tSELECT s.csistema\n\t\t\t,s.sciclo\n\t\t\t,nmovimi\n\t\t\t,fefecto\n\t\t\t,snmovimd\n\t\t\t,ftermino\n\t\t\t,cusuasig\n\t\t\t,tipo_endoso\n\t\t\t,ncertif\n\t\t\t,sseguro\n\t\t\t,nmovimis\n\t\t\t,cramo\n\t\t\t,s.npoliza\n\t\t\t,s.csituac\n\t\tFROM (\n\t\t\tSELECT m.csistema\n\t\t\t\t,m.sciclo\n\t\t\t\t,m.nmovimi\n\t\t\t\t,m.fefecto\n\t\t\t\t,snmovimi AS snmovimd\n\t\t\t\t,m.ftermino\n\t\t\t\t,m.cusuasig\n\t\t\t\t,DECODE(m.nmovimir, 1, 'Endoso Inclusion', 'Endoso Otros') tipo_endoso\n\t\t\t\t,s.ncertif\n\t\t\t\t,m.sseguro\n\t\t\t\t,m.nmovimir AS nmovimis\n\t\t\t\t,s.cramo\n\t\t\t\t,s.npoliza\n\t\t\t\t,s.csituac\n\t\t\tFROM cdp_ods.sisaxis_cmi_movpropuesta AS m\n\t\t\tINNER JOIN cdp_ods.sisaxis_seguros s ON m.sseguro = s.sseguro\n\t\t\tWHERE m.ctipo = 'D'\n\t\t\t\tAND m.cestado = 'DIGITADA'\n\t\t\t) s\n\t\tINNER JOIN (\n\t\t\tSELECT p.sciclo\n\t\t\t\t,p.csistema\n\t\t\tFROM cdp_ods.sisaxis_cmi_propuesta p\n\t\t\t\t,cdp_ods.sisaxis_cmi_movpropuesta m1\n\t\t\tWHERE p.csistema = '1'\n\t\t\t\tAND p.sciclo > 300000\n\t\t\t\tAND p.csistema = m1.csistema\n\t\t\t\tAND p.sciclo = m1.sciclo\n\t\t\t\tAND m1.cestado = 'RECEPCIO'\n\t\t\t\tAND m1.ctipo = 'E'\n\t\t\t\tAND m1.fefecto >= to_date('01012011', 'ddmmyyyy')\n\t\t\t) b ON s.sciclo = b.sciclo\n\t\t\tAND s.csistema = b.csistema\n\t\t) a\n\tGROUP BY a.sseguro\n\t\t,a.nmovimis\n\t)\n\t,ITEM_RENO_NOFLOTA\nAS (\n\tSELECT sseguro\n\t\t,id_item2\n\t\t,CASE \n\t\t\tWHEN ISNULL(id_item2, 0) > 0\n\t\t\t\tTHEN 'SI'\n\t\t\tELSE 'NO'\n\t\t\tEND AS ITEM_RENOVACION\n\tFROM (\n\t\t-- START    1st  TEMP TABLE ITEM_RENOVACION_VHNOFLOTA (LOAD * Resident ITEM_VHNF)\n\t\tSELECT seg.SSEGURO\n\t\t\t,seg.CRAMO\n\t\t\t,seg.NPOLIZA\n\t\t\t,seg.NCERTIF\n\t\t\t,seg.FEFECTO\n\t\t\t,DECODE(seg.CDURACI, 3, seg.FVENCIM, 0, seg.FCARPRO) FVENCIM\n\t\t\t,seg.CSITUAC\n\t\t\t,x.NNUMNIF AS RUT_ASEG\n\t\t\t,y.Patente_norm\n\t\t\t,w.Count_Items\n\t\t\t,w.Flota\n\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG\n\t\tLEFT JOIN (\n\t\t\tSELECT a.SSEGURO\n\t\t\t\t,a.SPERSON\n\t\t\t\t,b.NNUMNIF\n\t\t\t\t,a.NRIESGO\n\t\t\t\t,a.NMOVIMA\n\t\t\t\t,a.NMOVIMB\n\t\t\t\t,a.FFECFIN\n\t\t\t\t,a.NORDEN\n\t\t\t\t,a.CDOMICI\n\t\t\tFROM cdp_ods.SISAXIS_ASEGURADOS a\n\t\t\tLEFT JOIN cdp_ods.SISAXIS_PERSONAS b ON (a.SPERSON = b.SPERSON)\n\t\t\tWHERE a.FFECFIN IS NULL\n\t\t\t) x ON (seg.SSEGURO = x.SSEGURO)\n\t\tLEFT JOIN (\n\t\t\tSELECT n.SSEGURO AS Id_item\n\t\t\t\t,n.NMOVIMI AS Numero_movimiento\n\t\t\t\t,n.CMATRIC AS Patente\n\t\t\t\t,n.CVERSION AS Id_version\n\t\t\t\t,n.NRIESGO AS Numero_riesgo\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN len(replace(CMATRIC, '-.', '')) <> 6\n\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 1, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 2, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 5, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 6, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\tOR (\n\t\t\t\t\t\t\tREGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 3, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\tAND REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 4, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tOR (\n\t\t\t\t\t\t\tREGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 3, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\tAND REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 4, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tOR replace(Replace(Replace(CMATRIC, '-', ''), '.', ''), ' ', '') IN (\n\t\t\t\t\t\t\t'XXXX00'\n\t\t\t\t\t\t\t,'XX0000'\n\t\t\t\t\t\t\t,'XXXX01'\n\t\t\t\t\t\t\t,'XX0001'\n\t\t\t\t\t\t\t,'XXXX11'\n\t\t\t\t\t\t\t,'AA0000'\n\t\t\t\t\t\t\t,'SP4444'\n\t\t\t\t\t\t\t,'ET1111'\n\t\t\t\t\t\t\t,'SP0000'\n\t\t\t\t\t\t\t,'XX1111'\n\t\t\t\t\t\t\t,'AAAA00'\n\t\t\t\t\t\t\t,'MY0000'\n\t\t\t\t\t\t\t,'XXXX12'\n\t\t\t\t\t\t\t,'XXXX10'\n\t\t\t\t\t\t\t,'ET0001'\n\t\t\t\t\t\t\t,'EETT00'\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tTHEN ''\n\t\t\t\t\tELSE replace(CMATRIC, '-. ', '')\n\t\t\t\t\tEND AS Patente_norm\n\t\t\tFROM cdp_ods.SISAXIS_AUTRIESGOS n\n\t\t\t) y ON (y.Id_item = seg.SSEGURO)\n\t\tLEFT JOIN (\n\t\t\t-- Begin Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\t\tSELECT k.NPOLIZA\n\t\t\t\t,COUNT(k.SSEGURO) AS Count_Items\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN COUNT(k.SSEGURO) >= 10\n\t\t\t\t\t\tTHEN 'Si'\n\t\t\t\t\tELSE 'No'\n\t\t\t\t\tEND AS Flota\n\t\t\tFROM (\n\t\t\t\tSELECT seg2.SSEGURO\n\t\t\t\t\t,seg2.CRAMO\n\t\t\t\t\t,seg2.CAGENTE\n\t\t\t\t\t,seg2.NPOLIZA\n\t\t\t\t\t,seg2.NCERTIF\n\t\t\t\t\t,seg2.FEFECTO\n\t\t\t\t\t,seg2.COBJASE\n\t\t\t\t\t,seg2.CTIPCOA\n\t\t\t\t\t,SUBSTR(seg2.CAGENTE, - 3, 8) CSUCURSAL\n\t\t\t\t\t,seg2.CTIPCOM\n\t\t\t\t\t,DECODE(seg2.CDURACI, 3, seg2.FVENCIM, 0, seg2.FCARPRO) FVENCIM\n\t\t\t\t\t,seg2.FANULAC\n\t\t\t\t\t,DECODE(seg2.CSITUAC, 0, 'Vigente', 2, 'Anulado/Cancelado', 5, 'Endoso Pendiente', 'Otro') SITUAC\n\t\t\t\t\t,seg2.SCIACOA\n\t\t\t\t\t,seg2.PPARCOA\n\t\t\t\t\t,seg2.SPRODUC\n\t\t\t\t\t,seg2.CMONSEG\n\t\t\t\t\t,seg2.FCAMBIO\n\t\t\t\t\t,seg2.CLINNEG\n\t\t\t\t\t,seg2.CAGRSEG\n\t\t\t\t\t,seg2.CRFAAGE SCICLO\n\t\t\t\t\t,seg2.CFLOTA\n\t\t\t\t\t,seg2.CSITUAC\n\t\t\t\t\t,seg2.NPROPM\n\t\t\t\t\t,DECODE(CAST(SUBSTR(seg2.CAGENTE, 1, 5) AS INTEGER), 7527, 'Retail', 8204, 'Retail', 7723, 'Retail', 3376, 'Retail', 3424, 'Retail', DECODE(CONV.CFLOTA, 1, DECODE(CAST(SUBSTR(seg2.CAGENTE, - 3, 8) AS INTEGER), 24, 'Banca', 25, 'Banca', 'Flota'), 'Individual')) CANAL\n\t\t\t\t\t,\n\t\t\t\t\t--sisaxis.f_clasificacion_fecu(seg2.sseguro) clasificacion_fecu\n\t\t\t\t\t-- ,\n\t\t\t\t\tseg2.CMODALI\n\t\t\t\t\t,seg2.CTIPSEG\n\t\t\t\t\t,seg2.CCOLECT\n\t\t\t\t\t,seg2.CACTIVI\n\t\t\t\t\t,seg2.CRESERVA\n\t\t\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG2\n\t\t\t\t\t,cdp_ods.SISAXIS_CTR_DESAGRUPASEG CONV\n\t\t\t\tWHERE seg2.cagrseg = conv.cagrseg(+)\n\t\t\t\t\tAND ncertif > 0\n\t\t\t\t) k\n\t\t\tWHERE k.NCERTIF > 0\n\t\t\tGROUP BY k.NPOLIZA\n\t\t\t) w ON (w.NPOLIZA = seg.NPOLIZA)\n\t\t-- End Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\tWHERE --seg.SSEGURO IN (900327438,900250970,900327424,900372586,900327400,900334130\n\t\t\t-- ,900331236,900332401,900373592,900367654,900331218,900332365)\n\t\t\t--and\n\t\t\tncertif > 0\n\t\t\tAND CRAMO = 6\n\t\t\tAND w.Flota = 'No'\n\t\t) ST1\n\t-- END      1st  TEMP TABLE ITEM_RENOVACION_VHNOFLOTA (LOAD * Resident ITEM_VHNF)\n\t-- START  2nd TEMP TABLE ITEM_RENOVACION_VHNOFLOTA (LOAD * Resident ITEM_VHNF Where\n\t-- Id.Situacion= 0)\n\tLEFT JOIN (\n\t\tSELECT ST2.SSEGURO AS ID_ITEM2\n\t\t\t,ST2.NPOLIZA AS NPOLIZA2\n\t\t\t,ST2.NCERTIF AS NCERTIF2\n\t\t\t,ST2.Patente_norm AS Patente_norm2\n\t\t\t,ST2.RUT_ASEG AS RUT_ASEG2\n\t\t\t,ST2.FVENCIM AS INI_VIGENCIA2\n\t\tFROM (\n\t\t\tSELECT seg.SSEGURO\n\t\t\t\t,seg.CRAMO\n\t\t\t\t,seg.NPOLIZA\n\t\t\t\t,seg.NCERTIF\n\t\t\t\t,seg.FEFECTO\n\t\t\t\t,DECODE(seg.CDURACI, 3, seg.FVENCIM, 0, seg.FCARPRO) FVENCIM\n\t\t\t\t,seg.CSITUAC\n\t\t\t\t,x.NNUMNIF AS RUT_ASEG\n\t\t\t\t,y.Patente_norm\n\t\t\t\t,w.Count_Items\n\t\t\t\t,w.Flota\n\t\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT a.SSEGURO\n\t\t\t\t\t,a.SPERSON\n\t\t\t\t\t,b.NNUMNIF\n\t\t\t\t\t,a.NRIESGO\n\t\t\t\t\t,a.NMOVIMA\n\t\t\t\t\t,a.NMOVIMB\n\t\t\t\t\t,a.FFECFIN\n\t\t\t\t\t,a.NORDEN\n\t\t\t\t\t,a.CDOMICI\n\t\t\t\tFROM cdp_ods.SISAXIS_ASEGURADOS a\n\t\t\t\tLEFT JOIN cdp_ods.SISAXIS_PERSONAS b ON (a.SPERSON = b.SPERSON)\n\t\t\t\tWHERE a.FFECFIN IS NULL\n\t\t\t\t) x ON (seg.SSEGURO = x.SSEGURO)\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT n.SSEGURO AS Id_item\n\t\t\t\t\t,n.NMOVIMI AS Numero_movimiento\n\t\t\t\t\t,n.CMATRIC AS Patente\n\t\t\t\t\t,n.CVERSION AS Id_version\n\t\t\t\t\t,n.NRIESGO AS Numero_riesgo\n\t\t\t\t\t,CASE \n\t\t\t\t\t\tWHEN len(replace(CMATRIC, '-.', '')) <> 6\n\t\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 1, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 2, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 5, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 6, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\tOR (\n\t\t\t\t\t\t\t\tREGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 3, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\t\tAND REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 4, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tOR (\n\t\t\t\t\t\t\t\tREGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 3, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\t\tAND REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 4, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tOR replace(Replace(Replace(CMATRIC, '-', ''), '.', ''), ' ', '') IN (\n\t\t\t\t\t\t\t\t'XXXX00'\n\t\t\t\t\t\t\t\t,'XX0000'\n\t\t\t\t\t\t\t\t,'XXXX01'\n\t\t\t\t\t\t\t\t,'XX0001'\n\t\t\t\t\t\t\t\t,'XXXX11'\n\t\t\t\t\t\t\t\t,'AA0000'\n\t\t\t\t\t\t\t\t,'SP4444'\n\t\t\t\t\t\t\t\t,'ET1111'\n\t\t\t\t\t\t\t\t,'SP0000'\n\t\t\t\t\t\t\t\t,'XX1111'\n\t\t\t\t\t\t\t\t,'AAAA00'\n\t\t\t\t\t\t\t\t,'MY0000'\n\t\t\t\t\t\t\t\t,'XXXX12'\n\t\t\t\t\t\t\t\t,'XXXX10'\n\t\t\t\t\t\t\t\t,'ET0001'\n\t\t\t\t\t\t\t\t,'EETT00'\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tTHEN ''\n\t\t\t\t\t\tELSE replace(CMATRIC, '-. ', '')\n\t\t\t\t\t\tEND AS Patente_norm\n\t\t\t\tFROM cdp_ods.SISAXIS_AUTRIESGOS n\n\t\t\t\t) y ON (y.Id_item = seg.SSEGURO)\n\t\t\tLEFT JOIN (\n\t\t\t\t-- Begin Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\t\t\tSELECT k.NPOLIZA\n\t\t\t\t\t,COUNT(k.SSEGURO) AS Count_Items\n\t\t\t\t\t,CASE \n\t\t\t\t\t\tWHEN COUNT(k.SSEGURO) >= 10\n\t\t\t\t\t\t\tTHEN 'Si'\n\t\t\t\t\t\tELSE 'No'\n\t\t\t\t\t\tEND AS Flota\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT seg2.SSEGURO\n\t\t\t\t\t\t,seg2.CRAMO\n\t\t\t\t\t\t,seg2.CAGENTE\n\t\t\t\t\t\t,seg2.NPOLIZA\n\t\t\t\t\t\t,seg2.NCERTIF\n\t\t\t\t\t\t,seg2.FEFECTO\n\t\t\t\t\t\t,seg2.COBJASE\n\t\t\t\t\t\t,seg2.CTIPCOA\n\t\t\t\t\t\t,SUBSTR(seg2.CAGENTE, - 3, 8) CSUCURSAL\n\t\t\t\t\t\t,seg2.CTIPCOM\n\t\t\t\t\t\t,DECODE(seg2.CDURACI, 3, seg2.FVENCIM, 0, seg2.FCARPRO) FVENCIM\n\t\t\t\t\t\t,seg2.FANULAC\n\t\t\t\t\t\t,DECODE(seg2.CSITUAC, 0, 'Vigente', 2, 'Anulado/Cancelado', 5, 'Endoso Pendiente', 'Otro') SITUAC\n\t\t\t\t\t\t,seg2.SCIACOA\n\t\t\t\t\t\t,seg2.PPARCOA\n\t\t\t\t\t\t,seg2.SPRODUC\n\t\t\t\t\t\t,seg2.CMONSEG\n\t\t\t\t\t\t,seg2.FCAMBIO\n\t\t\t\t\t\t,seg2.CLINNEG\n\t\t\t\t\t\t,seg2.CAGRSEG\n\t\t\t\t\t\t,seg2.CRFAAGE SCICLO\n\t\t\t\t\t\t,seg2.CFLOTA\n\t\t\t\t\t\t,seg2.CSITUAC\n\t\t\t\t\t\t,seg2.NPROPM\n\t\t\t\t\t\t,DECODE(CAST(SUBSTR(seg2.CAGENTE, 1, 5) AS INTEGER), 7527, 'Retail', 8204, 'Retail', 7723, 'Retail', 3376, 'Retail', 3424, 'Retail', DECODE(CONV.CFLOTA, 1, DECODE(CAST(SUBSTR(seg2.CAGENTE, - 3, 8) AS INTEGER), 24, 'Banca', 25, 'Banca', 'Flota'), 'Individual')) CANAL\n\t\t\t\t\t\t,\n\t\t\t\t\t\t--sisaxis.f_clasificacion_fecu(seg2.sseguro)\n\t\t\t\t\t\t-- clasificacion_fecu ,\n\t\t\t\t\t\tseg2.CMODALI\n\t\t\t\t\t\t,seg2.CTIPSEG\n\t\t\t\t\t\t,seg2.CCOLECT\n\t\t\t\t\t\t,seg2.CACTIVI\n\t\t\t\t\t\t,seg2.CRESERVA\n\t\t\t\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG2\n\t\t\t\t\t\t,cdp_ods.SISAXIS_CTR_DESAGRUPASEG CONV\n\t\t\t\t\tWHERE seg2.cagrseg = conv.cagrseg(+)\n\t\t\t\t\t\tAND ncertif > 0\n\t\t\t\t\t) k\n\t\t\t\tWHERE k.NCERTIF > 0\n\t\t\t\tGROUP BY k.NPOLIZA\n\t\t\t\t) w ON (w.NPOLIZA = seg.NPOLIZA)\n\t\t\t-- End Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\t\tWHERE --seg.SSEGURO IN (900327438,900250970,900327424,900372586,900327400,\n\t\t\t\t-- 900334130,900331236,900332401,900373592,900367654,900331218,\n\t\t\t\t-- 900332365)\n\t\t\t\t--and\n\t\t\t\tseg.ncertif > 0\n\t\t\t\tAND seg.CRAMO = 6\n\t\t\t\tAND seg.CSITUAC = 0\n\t\t\t\tAND w.Flota = 'No'\n\t\t\t) ST2\n\t\t) RENO\n\t\t-- END  2nd TEMP TABLE ITEM_RENOVACION_VHNOFLOTA (LOAD * Resident ITEM_VHNF Where\n\t\t-- Id.Situacion= 0)\n\t\tON (\n\t\t\tRENO.Patente_norm2 = ST1.Patente_norm\n\t\t\tAND RENO.RUT_ASEG2 = ST1.RUT_ASEG\n\t\t\tAND RENO.INI_VIGENCIA2 = ST1.FEFECTO\n\t\t\t)\n\t)\n\t,ITEM_OTROS\nAS (\n\tSELECT seg.SSEGURO\n\t\t,seg.CRAMO\n\t\t,seg.NPOLIZA\n\t\t,seg.NCERTIF\n\t\t,seg.FEFECTO\n\t\t,DECODE(seg.CDURACI, 3, seg.FVENCIM, 0, seg.FCARPRO) FVENCIM\n\t\t,seg.CSITUAC\n\t\t,x.NNUMNIF AS Rut_Contratante\n\t\t,w.Count_Items\n\t\t,w.Flota\n\tFROM cdp_ods.SISAXIS_SEGUROS SEG\n\tLEFT JOIN (\n\t\tSELECT s.sseguro\n\t\t\t,p.NNUMNIF\n\t\tFROM cdp_ods.sisaxis_tomadores t\n\t\tINNER JOIN cdp_ods.sisaxis_seguros s ON t.sseguro = s.sseguro\n\t\t\tAND s.ncertif > 0\n\t\tLEFT JOIN cdp_ods.sisaxis_personas p ON t.sperson = p.sperson\n\t\t) x ON (seg.SSEGURO = x.SSEGURO)\n\tLEFT JOIN (\n\t\t-- Begin Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\tSELECT k.NPOLIZA\n\t\t\t,Count(k.SSEGURO) AS Count_Items\n\t\t\t,CASE \n\t\t\t\tWHEN Count(k.SSEGURO) >= 10\n\t\t\t\t\tTHEN 'Si'\n\t\t\t\tELSE 'No'\n\t\t\t\tEND AS Flota\n\t\tFROM (\n\t\t\tSELECT seg2.SSEGURO\n\t\t\t\t,seg2.CRAMO\n\t\t\t\t,seg2.CAGENTE\n\t\t\t\t,seg2.NPOLIZA\n\t\t\t\t,seg2.NCERTIF\n\t\t\t\t,seg2.FEFECTO\n\t\t\t\t,seg2.COBJASE\n\t\t\t\t,seg2.CTIPCOA\n\t\t\t\t,substr(seg2.CAGENTE, - 3, 8) CSUCURSAL\n\t\t\t\t,seg2.CTIPCOM\n\t\t\t\t,DECODE(seg2.CDURACI, 3, seg2.FVENCIM, 0, seg2.FCARPRO) FVENCIM\n\t\t\t\t,seg2.FANULAC\n\t\t\t\t,DECODE(seg2.CSITUAC, 0, 'Vigente', 2, 'Anulado/Cancelado', 5, 'Endoso Pendiente', 'Otro') SITUAC\n\t\t\t\t,seg2.SCIACOA\n\t\t\t\t,seg2.PPARCOA\n\t\t\t\t,seg2.SPRODUC\n\t\t\t\t,seg2.CMONSEG\n\t\t\t\t,seg2.FCAMBIO\n\t\t\t\t,seg2.CLINNEG\n\t\t\t\t,seg2.CAGRSEG\n\t\t\t\t,seg2.CRFAAGE SCICLO\n\t\t\t\t,seg2.CFLOTA\n\t\t\t\t,seg2.CSITUAC\n\t\t\t\t,seg2.NPROPM\n\t\t\t\t,DECODE(cast(SUBSTR(seg2.CAGENTE, 1, 5) AS INTEGER), 7527, 'Retail', 8204, 'Retail', 7723, 'Retail', 3376, 'Retail', 3424, 'Retail', DECODE(CONV.CFLOTA, 1, DECODE(cast(SUBSTR(seg2.CAGENTE, - 3, 8) AS INTEGER), 24, 'Banca', 25, 'Banca', 'Flota'), 'Individual')) CANAL\n\t\t\t\t,\n\t\t\t\t--sisaxis.f_clasificacion_fecu(seg2.sseguro) clasificacion_fecu ,\n\t\t\t\tseg2.CMODALI\n\t\t\t\t,seg2.CTIPSEG\n\t\t\t\t,seg2.CCOLECT\n\t\t\t\t,seg2.CACTIVI\n\t\t\t\t,seg2.CRESERVA\n\t\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG2\n\t\t\t\t,cdp_ods.SISAXIS_CTR_DESAGRUPASEG CONV\n\t\t\tWHERE seg2.cagrseg = conv.cagrseg(+)\n\t\t\t\tAND ncertif > 0\n\t\t\t) k\n\t\tWHERE k.NCERTIF > 0\n\t\tGROUP BY k.NPOLIZA\n\t\t) w ON (w.NPOLIZA = seg.NPOLIZA)\n\t-- End Query from Temp Table FLOTA in VENTA_LIBERTY\n\tWHERE --seg.SSEGURO IN (900327438,900250970,900327424,900372586,900327400,900334130,900331236,900332401,900373592,900367654,900331218,900332365)\n\t\t--and \n\t\tseg.ncertif > 0\n\t\tAND (\n\t\t\t(\n\t\t\t\tSEG.CRAMO = 6\n\t\t\t\tAND w.Count_Items >= 10\n\t\t\t\t)\n\t\t\tOR SEG.CRAMO <> 6\n\t\t\t)\n\t\tAND SEG.CRAMO <> 16\n\t\tAND SEG.SPRODUC NOT IN (\n\t\t\t452\n\t\t\t,500\n\t\t\t,686\n\t\t\t,842\n\t\t\t,861\n\t\t\t,438\n\t\t\t,439\n\t\t\t,820\n\t\t\t,822\n\t\t\t,856\n\t\t\t)\n\t)\n\t,ITEM_OTROS_1\nAS (\n\tSELECT a.CRAMO\n\t\t,a.CSITUAC\n\t\t,a.SSEGURO\n\t\t,CASE \n\t\t\tWHEN isnull(b.sseguro, 0) > 0\n\t\t\t\tTHEN 'SI'\n\t\t\tELSE 'NO'\n\t\t\tEND AS ITEM_RENOVACION\n\tFROM ITEM_OTROS a\n\tLEFT JOIN ITEM_OTROS b ON a.CRAMO = b.CRAMO\n\t\tAND a.Rut_Contratante = b.Rut_Contratante\n\t\tAND a.fefecto = b.fvencim\n\t\tAND b.CSITUAC = 0\n\t)\n\t,ITEM_RENO_NR\nAS (\n\tSELECT sseguro\n\t\t,SSEGURO AS [ID_ITEM]\n\t\t,CRAMO AS [ID_RAMO]\n\t\t,seg.NPOLIZA\n\t\t,NCERTIF AS ITEM\n\t\t,CSITUAC AS [ID_SITUACION]\n\tFROM CDP_ODS.sisaxis_seguros seg\n\tWHERE seg.NCERTIF > 0\n\t\tAND (\n\t\t\tseg.CRAMO = 16\n\t\t\tOR SEG.SPRODUC IN (\n\t\t\t\t452\n\t\t\t\t,500\n\t\t\t\t,686\n\t\t\t\t,842\n\t\t\t\t,861\n\t\t\t\t,438\n\t\t\t\t,439\n\t\t\t\t,820\n\t\t\t\t,822\n\t\t\t\t,856\n\t\t\t\t)\n\t\t\t)\n\t)\nSELECT\n\t--fact_renovaciones_integrado_key,\n\tMAX_SID\n\t,src_sys_cd\n\t,policy_item_id\n\t,policy_num\n\t,policy_exp_dt\n\t,policy_status_desc\n\t,facultativo_ind\n\t,coins_type_cd\n\t,curr_cd\n\t,fecultative_premium_amt\n\t,broker_comm_amt\n\t,dim_lob_key\n\t,dim_broker_key\n\t,dim_branch_office_key\n\t,dim_policyholder_key\n\t,policyholder_rut_num\n\t,dim_prd_pln_hrchy_key\n\t,dim_insured_key\n\t,insured_rut_num\n\t,\n\t--rec_crt_dtm,\n\t--rec_updt_dtm,\n\t--actv_rec_ind,\n\tetl_audit_id\n\t,policy_item_num\n\t,policy_issue_dt\n\t,policy_eff_dt\n\t,acct_yr\n\t,acct_mth\n\t,agreement\n\t,flota\n\t,valid_ind\n\t,NVL(document_type, 'Endoso') AS document_type\n\t,item_renovated_ind\n\t,sales_type\n\t,cycle_number\n\t,cycle_state\n\t,renovation_type\n\t,item_type\n\t,Lob_mkt_ref_code\n\t,PATENTE\n\t,gwp_amt\n\t,affects_direct_premium_amt\n\t,exempt_direct_premium_amt\n\t,CAST(new_direct_premium_amt AS NUMERIC(25, 10))\n\t,CAST(renewal_direct_premium_amt AS NUMERIC(25, 10))\n\t,CAST(endorsement_direct_premium_amt AS NUMERIC(25, 10))\n\t,mv_id\n\t,mv_reason_cd\n\t,mv_reason_desc\nFROM (\n\tSELECT DISTINCT\n\t\t--CAST(nvl(LKP.MAX_SID,0)+ num AS INTEGER) as fact_renovaciones_integrado_key,\n\t\tLKP.MAX_SID\n\t\t,CAST(SRC.src_sys_cd AS VARCHAR(10))\n\t\t,CAST(CAST(SRC.policy_item_id AS INTEGER) AS VARCHAR(35))\n\t\t,CAST(SRC.policy_num AS VARCHAR(35))\n\t\t,CAST(SRC.policy_exp_dt AS DATE)\n\t\t,CAST(SRC.policy_status_desc AS VARCHAR(80))\n\t\t,CAST(SRC.facultativo_ind AS CHAR(1))\n\t\t,CAST(CAST(SRC.coins_type_cd AS INTEGER) AS VARCHAR(10))\n\t\t,CAST(SRC.curr_cd AS VARCHAR(10))\n\t\t,CAST(SRC.fecultative_premium_amt AS NUMERIC(25, 10))\n\t\t,CAST(SRC.broker_comm_amt AS NUMERIC(25, 10))\n\t\t,\n\t\t--CAST(SRC.dim_policy_key AS INTEGER),\n\t\tCAST(SRC.dim_lob_key AS INTEGER)\n\t\t,CAST(SRC.dim_broker_key AS INTEGER)\n\t\t,CAST(SRC.dim_branch_office_key AS INTEGER)\n\t\t,CAST(SRC.dim_policyholder_key AS INTEGER)\n\t\t,CAST(SRC.policyholder_rut_num AS VARCHAR(80))\n\t\t,CAST(SRC.dim_prd_pln_hrchy_key AS INTEGER)\n\t\t,CAST(SRC.dim_insured_key AS INTEGER)\n\t\t,CAST(SRC.insured_rut_num AS VARCHAR(80))\n\t\t,SYSDATE AS rec_crt_dtm\n\t\t,SYSDATE AS rec_updt_dtm\n\t\t,'Y' AS actv_rec_ind\n\t\t,CAST(SRC.etl_audit_id AS INTEGER)\n\t\t,CAST(SRC.policy_item_num AS INTEGER)\n\t\t,CAST(SRC.policy_issue_dt AS DATE)\n\t\t,CAST(SRC.policy_eff_dt AS DATE)\n\t\t,CAST(isnull(SRC.acct_yr, (\n\t\t\t\t\tSELECT cast(to_char(add_months(max(fcierre), 1), 'yyyy') AS INTEGER)\n\t\t\t\t\tFROM cdp_ods.sisaxis_cierres\n\t\t\t\t\tWHERE cestado = 1\n\t\t\t\t\t\tAND ctipo = 7\n\t\t\t\t\t)) AS VARCHAR(4)) AS acct_yr\n\t\t,CAST(isnull(SRC.acct_mth, (\n\t\t\t\t\tSELECT RIGHT(0 || cast(to_char(add_months(max(fcierre), 1), 'mm') AS INTEGER), 2)\n\t\t\t\t\tFROM cdp_ods.sisaxis_cierres\n\t\t\t\t\tWHERE cestado = 1\n\t\t\t\t\t\tAND ctipo = 7\n\t\t\t\t\t)) AS VARCHAR(2)) AS acct_mth\n\t\t,CAST(SRC.agreement AS VARCHAR(10))\n\t\t,\n\t\t--LKP.MAX_SID,\n\t\tCASE \n\t\t\tWHEN SRC.policy_exp_dt >= '2019-01-01'\n\t\t\t\tTHEN (\n\t\t\t\t\t\tCASE \n\t\t\t\t\t\t\tWHEN SRC.cflota = 1\n\t\t\t\t\t\t\t\tTHEN 'SI'\n\t\t\t\t\t\t\tELSE 'NO'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t)\n\t\t\tELSE (\n\t\t\t\t\tCASE pol_count.pcount\n\t\t\t\t\t\tWHEN pol_count.pcount >= 10\n\t\t\t\t\t\t\tAND SRC.cramo = 6\n\t\t\t\t\t\t\tTHEN 'SI'\n\t\t\t\t\t\tWHEN pol_count.pcount < 10\n\t\t\t\t\t\t\tAND SRC.cramo = 6\n\t\t\t\t\t\t\tTHEN 'NO'\n\t\t\t\t\t\tELSE '-'\n\t\t\t\t\t\tEND\n\t\t\t\t\t)\n\t\t\tEND AS flota\n\t\t\t,CASE \n\t\t\tWHEN SRC.PDATE >= SYSDATE\n\t\t\t\tTHEN 'SI'\n\t\t\tELSE 'NO'\n\t\t\tEND AS valid_ind\n\t\t,\n\t\t--CICLO.document_type as document_type,\n\t\tCASE \n\t\t\tWHEN CAST(SRC.mv_id AS INTEGER) = 1\n\t\t\t\tTHEN 'Propuesta'\n\t\t\tWHEN DOC_TYPE.doc_type IS NULL\n\t\t\t\tTHEN 'Endoso'\n\t\t\tELSE DOC_TYPE.doc_type\n\t\t\tEND AS document_type\n\t\t,\n\t\t--CASE pol_count.item_count when pol_count.item_count>0 then 'SI' else 'NO' end as\n\t\t-- item_renovated_ind,\n\t\tNVL(ITEM_RENO_IND.ITEM_RENOVACION, 'NO') AS item_renovated_ind\n\t\t,CASE \n\t\t\tWHEN document_type = 'Propuesta'\n\t\t\t\tTHEN CASE \n\t\t\t\t\t\tWHEN item_renovated_ind = 'SI'\n\t\t\t\t\t\t\tTHEN 'Renovacion'\n\t\t\t\t\t\tELSE 'Venta Nueva'\n\t\t\t\t\t\tEND\n\t\t\tELSE 'Endoso'\n\t\t\tEND AS sales_type\n\t\t,TRUNC(CICLO.cycle_number) AS cycle_number\n\t\t,CICLO.cycle_state AS cycle_state\n\t\t,CICLO.RENOVATION_TYPE AS renovation_type\n\t\t,SRC.item_type AS item_type\n\t\t,SRC.Lob_mkt_ref_code AS Lob_mkt_ref_code\n\t\t,SRC.PATENTE AS PATENTE\n\t\t,CAST(SRC.gwp_amt AS NUMERIC(25, 10))\n\t\t,CAST(SRC.affects_direct_premium_amt AS NUMERIC(25, 10))\n\t\t,CAST(SRC.exempt_direct_premium_amt AS NUMERIC(25, 10))\n\t\t,\n\t\t--NVL(dir_amt.PRIMA_DIR,0) as gwp_amt,\n\t\t--NVL(dir_amt.PRIMA_AFE_DIR,0) AS affects_direct_premium_amt,\n\t\t--NVL(dir_amt.PRIMA_EXE_DIR,0) AS exempt_direct_premium_amt,\n\t\tCASE \n\t\t\tWHEN sales_type = 'Venta Nueva'\n\t\t\t\tTHEN gwp_amt\n\t\t\tELSE 0\n\t\t\tEND AS new_direct_premium_amt\n\t\t,CASE \n\t\t\tWHEN sales_type = 'Renovacion'\n\t\t\t\tTHEN gwp_amt\n\t\t\tELSE 0\n\t\t\tEND AS renewal_direct_premium_amt\n\t\t,CASE \n\t\t\tWHEN sales_type = 'Endoso'\n\t\t\t\tTHEN gwp_amt\n\t\t\tELSE 0\n\t\t\tEND AS endorsement_direct_premium_amt\n\t\t,SRC.mv_id\n\t\t,SRC.mv_reason_cd\n\t\t,SRC.mv_reason_desc\n\tFROM (\n\t\tSELECT MAX(num) AS num\n\t\t\t,MAX(AA.policy_num) policy_num\n\t\t\t,MAX(AA.curr_cd) curr_cd\n\t\t\t,MAX(AA.policy_issue_dt) policy_issue_dt\n\t\t\t,AA.policy_item_id\n\t\t\t,MAX(AA.dim_lob_key) dim_lob_key\n\t\t\t,MAX(AA.dim_policy_key) dim_policy_key\n\t\t\t,MAX(AA.dim_broker_key) dim_broker_key\n\t\t\t,MAX(AA.dim_branch_office_key) dim_branch_office_key\n\t\t\t,MAX(AA.dim_insured_key) dim_insured_key\n\t\t\t,MAX(AA.insured_rut_num) insured_rut_num\n\t\t\t,MAX(AA.dim_policyholder_key) dim_policyholder_key\n\t\t\t,MAX(AA.policyholder_rut_num) policyholder_rut_num\n\t\t\t,MAX(AA.dim_prd_pln_hrchy_key) dim_prd_pln_hrchy_key\n\t\t\t,MAX(AA.src_sys_cd) src_sys_cd\n\t\t\t,MAX(AA.policy_eff_dt) policy_eff_dt\n\t\t\t,MAX(AA.policy_exp_dt) policy_exp_dt\n\t\t\t,1 AS etl_audit_id\n\t\t\t,MAX(AA.coins_type_cd) coins_type_cd\n\t\t\t,MAX(AA.facultativo_ind) facultativo_ind\n\t\t\t,MAX(AA.policy_status_desc) policy_status_desc\n\t\t\t,SUM(AA.fecultative_premium_amt) fecultative_premium_amt\n\t\t\t,MAX(AA.policy_item_num) policy_item_num\n\t\t\t,SUM(NVL(AA.coins_amt, 0)) AS coins_amt\n\t\t\t,SUM(AA.gwp_amt) gwp_amt\n\t\t\t,SUM(AA.afecta_amt) AS affects_direct_premium_amt\n\t\t\t,SUM(AA.exenta_amt) AS exempt_direct_premium_amt\n\t\t\t,SUM(AA.broker_comm_amt) broker_comm_amt\n\t\t\t,AA.acct_yr\n\t\t\t,AA.acct_mth\n\t\t\t,MAX(AA.agreement) agreement\n\t\t\t,1 AS DUMMY\n\t\t\t,MAX(AA.PDATE) PDATE\n\t\t\t,MAX(AA.item_type) item_type\n\t\t\t,MAX(AA.Lob_mkt_ref_code) Lob_mkt_ref_code\n\t\t\t,MAX(AA.PATENTE) PATENTE\n\t\t\t,MAX(AA.cramo) AS cramo\n\t\t\t,AA.mv_id\n\t\t\t,MAX(AA.mv_reason_cd) AS mv_reason_cd\n\t\t\t,MAX(AA.mv_reason_desc) AS mv_reason_desc\n\t\t\t,MAX(AA.cflota) AS cflota\n\t\t--ROW_NUMBER()OVER(PARTITION BY AA.policy_item_id,AA.src_sys_cdORDER BY\n\t\t-- AA.fmovimi DESC) RNK\n\t\tFROM (\n\t\t\tSELECT row_number() OVER (\n\t\t\t\t\tORDER BY SEG.npoliza\n\t\t\t\t\t\t,SEG.sseguro\n\t\t\t\t\t) AS num\n\t\t\t\t--,CAST(SEG.npoliza AS INTEGER) AS policy_num\n\t\t\t\t,TRUNC(SEG.npoliza ) AS policy_num --casting changed to trunc\n\t\t\t\t,SEG.cmonseg AS curr_cd\n\t\t\t\t,SEG.FEMISIO AS policy_issue_dt\n\t\t\t\t--CAST(SEG.sseguro AS INTEGER) AS policy_item_id\n\t\t\t\t,TRUNC(SEG.sseguro) AS policy_item_id --casting changed to trunc\n\t\t\t\t,NVL(LOB.dim_lob_key, 0) AS dim_lob_key\n\t\t\t\t,NVL(POLICY.dim_policy_key, 0) AS dim_policy_key\n\t\t\t\t,NVL(BRKR_KEY.dim_broker_key, 0) AS dim_broker_key\n\t\t\t\t,NVL(BRANCH_OFFICE.dim_branch_office_key, 0) AS dim_branch_office_key\n\t\t\t\t,NVL(INSURED.dim_insured_key, 0) AS dim_insured_key\n\t\t\t\t,NVL(INSURED.insured_rut_num, '0') AS insured_rut_num\n\t\t\t\t,NVL(POL_HOLD.dim_policyholder_key, 0) AS dim_policyholder_key\n\t\t\t\t,NVL(POL_HOLD.policyholder_rut_num, '0') AS policyholder_rut_num\n\t\t\t\t,NVL(PLAN_HIRE.dim_prd_pln_hrchy_key, 0) AS dim_prd_pln_hrchy_key\n\t\t\t\t,'axis' AS src_sys_cd\n\t\t\t\t,SEG.FEFECTO AS policy_eff_dt\n\t\t\t\t,DECODE(SEG.CDURACI, 3, SEG.FVENCIM, SEG.FCARPRO) AS policy_exp_dt\n\t\t\t\t,SEG.cagrseg AS agreement\n\t\t\t\t,SEG.CTIPCOA AS coins_type_cd\n\t\t\t\t,\n\t\t\t\t--CASE WHEN FACULATIVE_IND.CNT >= 1 THEN 'Y' ELSE 'N' END AS\n\t\t\t\t-- facultativo_ind,\n\t\t\t\t/*CASE\n                                WHEN NVL(AMT_SRC_FEC_AMT.fecultative_premium_amt,0) <> 0\n                                THEN 'Y'\n                                ELSE 'N'\n                            END                                         AS facultativo_ind,*/\n\t\t\t\tfec_indicator.facultativo_indicator AS facultativo_ind\n\t\t\t\t,STG.ref_desc AS policy_status_desc\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN fec_indicator.facultativo_indicator = 'Y'\n\t\t\t\t\t\tTHEN NVL(AMT_SRC_FEC_AMT.fecultative_premium_amt, 0)\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND AS fecultative_premium_amt\n\t\t\t\t,NVL(AMT_SRC_2.broker_comm_amt, 0) AS broker_comm_amt\n\t\t\t\t,NVL(AMT_SRC_2.gwp_amt, 0) AS gwp_amt\n\t\t\t\t,NVL(AMT_SRC_2.afecta_amt, 0) AS afecta_amt\n\t\t\t\t,NVL(AMT_SRC_2.exenta_amt, 0) AS exenta_amt\n\t\t\t\t,(AMT_SRC_2.gwp_amt * (SEG.PPARCOA / 100)) AS coins_amt\n\t\t\t\t,MOVE_SEG.fmovimi\n\t\t\t\t,SEG.ncertif AS policy_item_num\n\t\t\t\t,CAL.axis_acct_yr_num AS acct_yr\n\t\t\t\t,RIGHT(0 || CAL.axis_acct_mth_num, 2) AS acct_mth\n\t\t\t\t,\n\t\t\t\t--SUBSTRING(ACCT.FCONTAB,1,4) AS acct_yr,\n\t\t\t\t--case when ACCT.FCONTAB > (select max(fconta) from\n\t\t\t\t-- cdp_ods.SISAXIS_HIS_CUADRE02_daily) THEN '12' ELSE SUBSTRING(ACCT.FCONTAB,\n\t\t\t\t-- 6,2)END as acct_mth,\n\t\t\t\t--SUBSTRING(ACCT.FCONTAB,6,2) AS acct_mth,\n\t\t\t\tACCT.FCONTAB\n\t\t\t\t,--added for DID-215\n\t\t\t\tCASE \n\t\t\t\t\tWHEN SEG.FANULAC IS NULL\n\t\t\t\t\t\tTHEN SEG.FVENCIM\n\t\t\t\t\tELSE SEG.FANULAC\n\t\t\t\t\tEND AS PDATE\n\t\t\t\t,item.cnt_sseg AS cnt_sseg\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN item.cnt_sseg < 10\n\t\t\t\t\t\tAND SEG.cramo = 6\n\t\t\t\t\t\tTHEN 'No Flota'\n\t\t\t\t\tWHEN SEG.cramo = 16\n\t\t\t\t\t\tOR SEG.sproduc IN (\n\t\t\t\t\t\t\t452\n\t\t\t\t\t\t\t,500\n\t\t\t\t\t\t\t,686\n\t\t\t\t\t\t\t,842\n\t\t\t\t\t\t\t,861\n\t\t\t\t\t\t\t,438\n\t\t\t\t\t\t\t,439\n\t\t\t\t\t\t\t,820\n\t\t\t\t\t\t\t,822\n\t\t\t\t\t\t\t,856\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t--OR  SEG.csituac <> 0\n\t\t\t\t\t\tOR SEG.ncertif = 0\n\t\t\t\t\t\tTHEN 'No Renovables'\n\t\t\t\t\tELSE 'Otros'\n\t\t\t\t\tEND AS item_type\n\t\t\t\t,mktrefcd.Lob_mkt_ref_code AS Lob_mkt_ref_code\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN SEG.CRAMO = 6\n\t\t\t\t\t\tTHEN T2.CMATRIC\n\t\t\t\t\tELSE NULL\n\t\t\t\t\tEND AS PATENTE\n\t\t\t\t,SEG.cramo\n\t\t\t\t,CAST(MOVE_SEG.NMOVIMI AS INTEGER) AS mv_id\n\t\t\t\t,MOVE_SEG.CMOTMOV AS mv_reason_cd\n\t\t\t\t,STG1.ref_desc AS mv_reason_desc\n\t\t\t\t,ROW_NUMBER() OVER (\n\t\t\t\t\tPARTITION BY SEG.sseguro\n\t\t\t\t\t,MOVE_SEG.nmovimi ORDER BY ACCT.FCONTAB DESC\n\t\t\t\t\t) RNK\n\t\t\t\t,SEG.cflota\n\t\t\tFROM (\n\t\t\t\tSELECT SG.sseguro\n\t\t\t\t\t,MV_G.nmovimi\n\t\t\t\tFROM cdp_stg_dwh.sisaxis_seguros SG\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_movseguro MV_G ON MV_G.sseguro = SG.sseguro\n\t\t\t\t\tAND SG.ncertif > 0\n\t\t\t\t\n\t\t\t\tUNION\n\t\t\t\t\n\t\t\t\tSELECT sseguro\n\t\t\t\t\t,nmovimi\n\t\t\t\tFROM cdp_stg_dwh.sisaxis_movseguro\n\t\t\t\t\n\t\t\t\tUNION\n\t\t\t\t\n\t\t\t\tSELECT sseguro\n\t\t\t\t\t,nmovima AS nmovimi\n\t\t\t\tFROM cdp_stg_dwh.sisaxis_riesgos\n\t\t\t\t\n\t\t\t\tUNION\n\t\t\t\t\n\t\t\t\tSELECT CES.sseguro\n\t\t\t\t\t,RIE.nmovima AS nmovimi\n\t\t\t\tFROM cdp_stg_dwh.sisaxis_cesionesrea CES\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_riesgos RIE ON CES.sseguro = RIE.sseguro\n\t\t\t\t\tAND CES.nriesgo = RIE.nriesgo\n\t\t\t\t\n\t\t\t\tUNION\n\t\t\t\t\n\t\t\t\tSELECT CES.sseguro\n\t\t\t\t\t,RIE.nmovima AS nmovimi\n\t\t\t\tFROM cdp_ods.sisaxis_cesionesrea CES\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_riesgos RIE ON CES.sseguro = RIE.sseguro\n\t\t\t\t\tAND CES.nriesgo = RIE.nriesgo\n\t\t\t\tINNER JOIN cdp_stg_dwh.sisaxis_cuacesfac CUAC ON CUAC.sfacult = CES.sfacult\n\t\t\t\t\n\t\t\t\tUNION\n\t\t\t\t\n\t\t\t\tSELECT SEG.sseguro\n\t\t\t\t\t,MOVE_SEG.nmovimi\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT *\n\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t) SEG\n\t\t\t\tINNER JOIN (\n\t\t\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t\t\t,nmovimi\n\t\t\t\t\tFROM cdp_ods.sisaxis_movseguro\n\t\t\t\t\t) MOVE_SEG ON MOVE_SEG.sseguro = SEG.sseguro\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_movrec2movseg M2 ON M2.nmovimi = MOVE_SEG.nmovimi\n\t\t\t\t\tAND M2.sseguro = MOVE_SEG.sseguro\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_movrecibo MV_RECIBO ON MV_RECIBO.smovrec = M2.smovrec\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_recibos RECIBOS ON RECIBOS.nrecibo = MV_RECIBO.nrecibo\n\t\t\t\tINNER JOIN cdp_stg_dwh.sisaxis_detrecibos DET_RECIBOS ON DET_RECIBOS.nrecibo = RECIBOS.nrecibo\n\t\t\t\t\n\t\t\t\tUNION\n\t\t\t\t\n\t\t\t\tSELECT DISTINCT SEG.sseguro\n\t\t\t\t\t,MOVE_SEG.nmovimi\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT *\n\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t) SEG\n\t\t\t\tINNER JOIN (\n\t\t\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t\t\t,nmovimi\n\t\t\t\t\tFROM cdp_ods.sisaxis_movseguro\n\t\t\t\t\t) MOVE_SEG ON MOVE_SEG.sseguro = SEG.sseguro\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_riesgos RSEG ON MOVE_SEG.sseguro = RSEG.sseguro\n\t\t\t\t\tAND MOVE_SEG.nmovimi = RSEG.nmovima\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_cesionesrea CESION ON RSEG.sseguro = CESION.sseguro\n\t\t\t\t\tAND RSEG.nriesgo = CESION.nriesgo\n\t\t\t\tINNER JOIN cdp_stg_dwh.sisaxis_cuadroces CUADROCES ON CUADROCES.scontra = CESION.scontra\n\t\t\t\t\tAND CUADROCES.ctramo = CESION.ctramo\n\t\t\t\t\n\t\t\t\tUNION\n\t\t\t\t\n\t\t\t\tSELECT DISTINCT SEG.sseguro\n\t\t\t\t\t,MOVE_SEG.nmovimi\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT *\n\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t) SEG\n\t\t\t\tINNER JOIN (\n\t\t\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t\t\t,nmovimi\n\t\t\t\t\tFROM cdp_ods.sisaxis_movseguro\n\t\t\t\t\t) MOVE_SEG ON MOVE_SEG.sseguro = SEG.sseguro\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_riesgos RSEG ON MOVE_SEG.sseguro = RSEG.sseguro\n\t\t\t\t\tAND MOVE_SEG.nmovimi = RSEG.nmovima\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_cesionesrea CESION ON RSEG.sseguro = CESION.sseguro\n\t\t\t\t\tAND RSEG.nriesgo = CESION.nriesgo\n\t\t\t\tINNER JOIN cdp_stg_dwh.sisaxis_codicontratos CONDI ON CONDI.scontra = CESION.scontra\n\t\t\t\t) DRIVER\n\t\t\tINNER JOIN (\n\t\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t\t,nmovimi\n\t\t\t\t\t,cmotmov\n\t\t\t\t\t,FMOVIMI\n\t\t\t\t\t,FEMISIO\n\t\t\t\t\t,FMOVVTO\n\t\t\t\t\t,FEFECTO\n\t\t\t\t\t,FCONTAB\n\t\t\t\tFROM cdp_ods.sisaxis_movseguro\n\t\t\t\t) MOVE_SEG ON DRIVER.sseguro = MOVE_SEG.sseguro\n\t\t\t\tAND DRIVER.nmovimi = MOVE_SEG.nmovimi\n\t\t\tINNER JOIN (\n\t\t\t\tSELECT npoliza\n\t\t\t\t\t,cmonseg\n\t\t\t\t\t,sseguro\n\t\t\t\t\t,CRAMO\n\t\t\t\t\t,cagente\n\t\t\t\t\t,FEFECTO\n\t\t\t\t\t,CDURACI\n\t\t\t\t\t,csituac\n\t\t\t\t\t,FVENCIM\n\t\t\t\t\t,FEMISIO\n\t\t\t\t\t,FCARPRO\n\t\t\t\t\t,cagrseg\n\t\t\t\t\t,CTIPCOA\n\t\t\t\t\t,PPARCOA\n\t\t\t\t\t,ncertif\n\t\t\t\t\t,FANULAC\n\t\t\t\t\t,sproduc\n\t\t\t\t\t,cflota\n\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\tWHERE ncertif > 0\n\t\t\t\t) SEG ON MOVE_SEG.sseguro = SEG.sseguro\n\t\t\tLEFT OUTER JOIN (\n\t\t\t\tSELECT npoliza\n\t\t\t\t\t,COUNT(sseguro) AS cnt_sseg\n\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\tGROUP BY npoliza\n\t\t\t\t) item ON SEG.npoliza = item.npoliza\n\t\t\tLEFT JOIN (\n\t\t\t\t--CISD-18742\n\t\t\t\tSELECT A1.*\n\t\t\t\tFROM CDP_ODS.SISAXIS_AUTRIESGOS A1\n\t\t\t\tINNER JOIN (\n\t\t\t\t\tSELECT SSEGURO\n\t\t\t\t\t\t,MAX(NMOVIMI) AS NMOVIMI\n\t\t\t\t\t\t,MAX(NRIESGO) AS NRIESGO\n\t\t\t\t\tFROM CDP_ODS.SISAXIS_AUTRIESGOS\n\t\t\t\t\tGROUP BY SSEGURO\n\t\t\t\t\t) A2 ON A1.SSEGURO = A2.SSEGURO\n\t\t\t\t\tAND A1.NMOVIMI = A2.NMOVIMI\n\t\t\t\t\tAND A1.NRIESGO = A2.NRIESGO\n\t\t\t\t) T2 ON DRIVER.SSEGURO = T2.SSEGURO\n\t\t\t-- AND DRIVER.nmovimi=T2.nmovimi\n\t\t\t--And  DRIVER.CRAMO  = 6\n\t\t\tLEFT JOIN cdp_ods.sisaxis_riesgos RSEG ON MOVE_SEG.sseguro = RSEG.sseguro\n\t\t\t\tAND MOVE_SEG.nmovimi = RSEG.nmovima\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t\t,nriesgo\n\t\t\t\tFROM cdp_ods.sisaxis_cesionesrea\n\t\t\t\t) CESION ON RSEG.sseguro = CESION.sseguro\n\t\t\t\tAND RSEG.nriesgo = CESION.nriesgo\n\t\t\tLEFT JOIN cdp_dwh.dim_policy_t POLICY \n\t\t\t--ON CAST(CAST(SEG.npoliza AS INTEGER) AS VARCHAR(35)) = POLICY.policy_num\n\t\t\tON CAST(TRUNC(SEG.npoliza) AS VARCHAR(35)) = POLICY.policy_num --casting changed to trunc\n\t\t\t\tAND POLICY.src_sys_cd = 'axis'\n\t\t\tLEFT JOIN cdp_dwh.dim_lob_t LOB ON CAST(CAST(SEG.CRAMO AS INTEGER) AS VARCHAR(10)) = LOB.lob_cd\n\t\t\t\tAND LOB.src_sys_cd = 'axis'\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT DISTINCT BRKR.dim_broker_key\n\t\t\t\t\t,AA.sseguro\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT DISTINCT BRKR_RLSHP.entity_rut_num\n\t\t\t\t\t\t,SEG.sseguro\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT cagente\n\t\t\t\t\t\t\t,sseguro\n\t\t\t\t\t\t\t,npoliza\n\t\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t\t) SEG\n\t\t\t\t\tINNER JOIN cdp_dwh.broker_branch_rlshp_t BRKR_RLSHP ON SEG.cagente = BRKR_RLSHP.rlshp_src_id\n\t\t\t\t\t\tAND BRKR_RLSHP.entity_type_cd = 4\n\t\t\t\t\t\tAND BRKR_RLSHP.src_sys_cd = 'axis'\n\t\t\t\t\t) AA\n\t\t\t\tINNER JOIN cdp_dwh.dim_broker_t BRKR ON AA.entity_rut_num = BRKR.broker_id\n\t\t\t\t) BRKR_KEY ON BRKR_KEY.sseguro = SEG.sseguro\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT A.sseguro\n\t\t\t\t\t,A.nmovimi\n\t\t\t\t\t,INSURED.dim_insured_key\n\t\t\t\t\t,INSURED.insured_rut_num\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT tmp2.sseguro\n\t\t\t\t\t\t,tmp2.nmovimi\n\t\t\t\t\t\t,tmp2.sperson\n\t\t\t\t\t\t,tmp2.cdomici\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT tmp1.sseguro\n\t\t\t\t\t\t\t,tmp1.nriesgo\n\t\t\t\t\t\t\t,tase.nmovima\n\t\t\t\t\t\t\t,tase.sperson\n\t\t\t\t\t\t\t,tase.cdomici\n\t\t\t\t\t\t\t,tmp1.nmovimi\n\t\t\t\t\t\t\t,row_number() OVER (\n\t\t\t\t\t\t\t\tPARTITION BY tmp1.sseguro\n\t\t\t\t\t\t\t\t,tmp1.nriesgo\n\t\t\t\t\t\t\t\t,tmp1.nmovimi ORDER BY tase.norden DESC\n\t\t\t\t\t\t\t\t) AS row_ind\n\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\tSELECT tmov.sseguro\n\t\t\t\t\t\t\t\t,tmov.nmovimi\n\t\t\t\t\t\t\t\t,trie.nriesgo\n\t\t\t\t\t\t\t\t,trie.sperson\n\t\t\t\t\t\t\t\t,trie.cdomici\n\t\t\t\t\t\t\t\t,row_number() OVER (\n\t\t\t\t\t\t\t\t\tPARTITION BY tmov.sseguro\n\t\t\t\t\t\t\t\t\t,tmov.nmovimi ORDER BY trie.nmovima DESC\n\t\t\t\t\t\t\t\t\t) AS row_ind\n\t\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t\t\t\t) tseg\n\t\t\t\t\t\t\tINNER JOIN cdp_ods.sisaxis_movseguro tmov ON tseg.sseguro = tmov.sseguro\n\t\t\t\t\t\t\tINNER JOIN cdp_ods.sisaxis_riesgos trie --\n\t\t\t\t\t\t\t\tON tmov.sseguro = trie.sseguro\n\t\t\t\t\t\t\t\tAND tmov.nmovimi >= trie.nmovima\n\t\t\t\t\t\t\t) tmp1\n\t\t\t\t\t\tINNER JOIN cdp_ods.sisaxis_asegurados tase ON tmp1.sseguro = tase.sseguro\n\t\t\t\t\t\t\tAND tmp1.nriesgo = tase.nriesgo\n\t\t\t\t\t\t\tAND tmp1.nmovimi >= tase.nmovima\n\t\t\t\t\t\t\tAND (\n\t\t\t\t\t\t\t\ttmp1.nmovimi < tase.nmovimb\n\t\t\t\t\t\t\t\tOR tase.nmovimb IS NULL\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\tWHERE tmp1.row_ind = 1\n\t\t\t\t\t\t) tmp2\n\t\t\t\t\tWHERE tmp2.row_ind = 1\n\t\t\t\t\tGROUP BY tmp2.sseguro\n\t\t\t\t\t\t,tmp2.nmovimi\n\t\t\t\t\t\t,tmp2.sperson\n\t\t\t\t\t\t,tmp2.cdomici\n\t\t\t\t\tORDER BY tmp2.sseguro\n\t\t\t\t\t\t,tmp2.nmovimi\n\t\t\t\t\t\t,tmp2.sperson\n\t\t\t\t\t\t,tmp2.cdomici\n\t\t\t\t\t) A\n\t\t\t\tINNER JOIN cdp_dwh.dim_insured_t INSURED ON INSURED.insured_id = CAST(A.sperson AS INTEGER)\n\t\t\t\t\tAND INSURED.address_id = CAST(NVL(cast(A.cdomici AS INTEGER), 0) AS INTEGER)--casting for datatype issue handling\n\t\t\t\t\t/*Added as part of CDP-238 */\n\t\t\t\t\tAND INSURED.src_sys_cd = 'axis'\n\t\t\t\t) INSURED ON INSURED.sseguro = SEG.sseguro\n\t\t\t\tAND INSURED.nmovimi = MOVE_SEG.nmovimi\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT ref_cd\n\t\t\t\t\t,ref_desc\n\t\t\t\tFROM cdp_stg_dwh.stg_tref_code_map_variant\n\t\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t\t\tAND ref_type_cd = 'policy_status_cd'\n\t\t\t\t) STG ON CAST(CAST(csituac AS INTEGER) AS VARCHAR(20)) = STG.ref_cd\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT *\n\t\t\t\tFROM cdp_stg_dwh.stg_tref_code_map_variant\n\t\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t\t\tAND ref_type_cd = 'movement_cd'\n\t\t\t\t) STG1 ON CAST(CAST(MOVE_SEG.cmotmov AS INTEGER) AS VARCHAR(20)) = STG1.ref_cd\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT ref_cd\n\t\t\t\t\t,mkt_ref_code AS Lob_mkt_ref_code\n\t\t\t\tFROM cdp_stg_dwh.stg_tref_code_map_variant\n\t\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t\t\tAND ref_type_cd = 'lob'\n\t\t\t\t) mktrefcd ON SEG.CRAMO = mktrefcd.ref_cd\n\t\t\tLEFT JOIN cdp_dwh.dim_branch_office_t BRANCH_OFFICE ON LTRIM(RIGHT(SEG.cagente, 3), 0) = LTRIM(BRANCH_OFFICE.branch_office_cd, 0)\n\t\t\t\tAND BRANCH_OFFICE.src_sys_cd = 'axis'\n\t\t\tLEFT JOIN cdp_dwh.dim_region_t REGN ON RIGHT(SEG.cagente, 3) = REGN.region_cd\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT DISTINCT POL_HOLD.dim_policyholder_key\n\t\t\t\t\t,POL_HOLD.policyholder_rut_num\n\t\t\t\t\t,AA.sseguro\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT CAST(CAST(TOMA.SPERSON AS INTEGER) || '-' || CAST(NVL(TOMA.CDOMICI, 0) AS INTEGER) AS VARCHAR(35)) AS TOMA_HLD_ID\n\t\t\t\t\t\t,SEG.sseguro\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT sseguro\n\t\t\t\t\t\t\t,npoliza\n\t\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t\t) SEG\n\t\t\t\t\t--INNER JOIN cdp_dwh.dim_policy_t POLICY\n\t\t\t\t\t--ON CAST(CAST(SEG.npoliza AS INTEGER) AS VARCHAR(35))=\n\t\t\t\t\t-- POLICY.policy_num\n\t\t\t\t\t--AND POLICY.src_sys_cd='axis'\n\t\t\t\t\tINNER JOIN cdp_ods.sisaxis_tomadores TOMA ON SEG.SSEGURO = CAST(TOMA.sseguro AS INTEGER)\n\t\t\t\t\t) AA\n\t\t\t\tINNER JOIN cdp_dwh.dim_policyholder_t POL_HOLD ON AA.TOMA_HLD_ID = POL_HOLD.policyholder_id\n\t\t\t\t\tAND POL_HOLD.src_sys_cd = 'axis'\n\t\t\t\t) POL_HOLD ON SEG.sseguro = POL_HOLD.sseguro\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT PLAN_HIRE.dim_prd_pln_hrchy_key\n\t\t\t\t\t,SEG.sseguro\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT sseguro\n\t\t\t\t\t\t,sproduc\n\t\t\t\t\t\t,cramo\n\t\t\t\t\t\t,cactivi\n\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t) SEG\n\t\t\t\tINNER JOIN cdp_dwh.dim_prd_pln_hrchy_t PLAN_HIRE ON PLAN_HIRE.prd_cd = CAST(CAST(SEG.sproduc AS INTEGER) AS VARCHAR(10))\n\t\t\t\t\tAND PLAN_HIRE.lob_cd = CAST(CAST(SEG.cramo AS INTEGER) AS VARCHAR(10))\n\t\t\t\t\tAND PLAN_HIRE.pln_cd = CAST(CAST(SEG.cactivi AS INTEGER) AS VARCHAR(10))\n\t\t\t\t\tAND PLAN_HIRE.src_sys_cd = 'axis'\n\t\t\t\t) PLAN_HIRE ON PLAN_HIRE.sseguro = SEG.sseguro\n\t\t\t/*\n                            LEFT JOIN(\n                            SELECT COUNT(*) AS CNT,SEG.sseguro\n                            FROM\n                            (select sseguro from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n                            INNER JOIN (SELECT DISTINCT sseguro\n                            FROM  cdp_ods.sisaxis_movseguro) MOVE_SEG\n                            ON MOVE_SEG.sseguro=SEG.sseguro\n                            LEFT JOIN cdp_ods.sisaxis_riesgos RSEG\n                            ON MOVE_SEG.sseguro = RSEG.sseguro\n                            LEFT JOIN cdp_ods.sisaxis_cesionesrea CESION\n                            ON RSEG.sseguro = CESION.sseguro\n                            AND RSEG.nriesgo = CESION.nriesgo\n                            LEFT JOIN cdp_ods.sisaxis_cuacesfac CUACESFAC\n                            ON CUACESFAC.sfacult=CESION.sfacult\n                            LEFT JOIN cdp_ods.sisaxis_cuadroces CUADROCES\n                            ON CUADROCES.scontra=CESION.scontra\n                            AND CUADROCES.ctramo=CESION.ctramo\n                            WHERE CAST(CESION.ctramo AS INTEGER) in (4,5)\n                            AND CAST(CESION.cgenera AS INTEGER)<>2\n                            GROUP BY SEG.sseguro\n                            )FACULATIVE_IND\n                            ON FACULATIVE_IND.sseguro=SEG.sseguro\n                            */\n\t\t\tLEFT OUTER JOIN cdp_ods.sisaxis_movrec2movseg MACCT ON MACCT.nmovimi = MOVE_SEG.nmovimi\n\t\t\t\tAND MACCT.sseguro = MOVE_SEG.sseguro\n\t\t\tLEFT OUTER JOIN cdp_ods.sisaxis_movrecibo ACCT ON ACCT.smovrec = MACCT.smovrec\n\t\t\tLEFT JOIN cdp_dwh.dim_cal_t CAL ON CAL.cal_dt = CAST(ACCT.FCONTAB AS DATE)\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT SUM(AMT_SRC_FEC_AMT.fecultative_premium_amt) AS fecultative_premium_amt\n\t\t\t\t\t,SUM(AMT_SRC_FEC_AMT.fecultative_premium_amt) AS cwp_amt_2\n\t\t\t\t\t,AMT_SRC_FEC_AMT.sseguro\n\t\t\t\t\t,AMT_SRC_FEC_AMT.ncertif\n\t\t\t\t\t,AMT_SRC_FEC_AMT.nmovimi\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT NVL(CC.fecultative_premium_amt, 0) fecultative_premium_amt\n\t\t\t\t\t\t,CC.sseguro\n\t\t\t\t\t\t,CC.ncertif\n\t\t\t\t\t\t,CC.nmovimi\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT AA.fecultative_premium_amt\n\t\t\t\t\t\t\t,AA.sseguro\n\t\t\t\t\t\t\t,AA.ncertif\n\t\t\t\t\t\t\t,AA.nmovimi\n\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\tSELECT CASE \n\t\t\t\t\t\t\t\t\tWHEN (\n\t\t\t\t\t\t\t\t\t\t\tBB.CESION_CTRAMO = 5\n\t\t\t\t\t\t\t\t\t\t\tOR BB.CESION_CTRAMO = 4\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\tAND CESION_cgenera <> 2\n\t\t\t\t\t\t\t\t\t\tTHEN BB.icesmon\n\t\t\t\t\t\t\t\t\tELSE 0\n\t\t\t\t\t\t\t\t\tEND AS fecultative_premium_amt\n\t\t\t\t\t\t\t\t,BB.sseguro\n\t\t\t\t\t\t\t\t,BB.ncertif\n\t\t\t\t\t\t\t\t,BB.icesmon\n\t\t\t\t\t\t\t\t,BB.pcesion\n\t\t\t\t\t\t\t\t,BB.nmovimi\n\t\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\t\tSELECT CESION.icesmon\n\t\t\t\t\t\t\t\t\t,CESION.pcesion\n\t\t\t\t\t\t\t\t\t,CAST(CESION.CTRAMO AS INTEGER) AS CESION_CTRAMO\n\t\t\t\t\t\t\t\t\t,CESION.PCUOPAR\n\t\t\t\t\t\t\t\t\t,SEG.sseguro\n\t\t\t\t\t\t\t\t\t,SEG.ncertif\n\t\t\t\t\t\t\t\t\t,CAST(CESION.cgenera AS INTEGER) AS CESION_cgenera\n\t\t\t\t\t\t\t\t\t,CAST(CONDI.ctiprea AS INTEGER)\n\t\t\t\t\t\t\t\t\t,MOVE_SEG.nmovimi\n\t\t\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\t\t\tSELECT sseguro\n\t\t\t\t\t\t\t\t\t\t,ncertif\n\t\t\t\t\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t\t\t\t\t) SEG\n\t\t\t\t\t\t\t\tINNER JOIN (\n\t\t\t\t\t\t\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t\t\t\t\t\t\t,nmovimi\n\t\t\t\t\t\t\t\t\tFROM cdp_ods.sisaxis_movseguro\n\t\t\t\t\t\t\t\t\t) MOVE_SEG ON MOVE_SEG.sseguro = SEG.sseguro\n\t\t\t\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_riesgos RSEG ON MOVE_SEG.sseguro = RSEG.sseguro\n\t\t\t\t\t\t\t\t\tAND MOVE_SEG.nmovimi = RSEG.nmovima\n\t\t\t\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_cesionesrea CESION ON RSEG.sseguro = CESION.sseguro\n\t\t\t\t\t\t\t\t\tAND MOVE_SEG.nmovimi = CESION.nmovigen\n\t\t\t\t\t\t\t\t--AND RSEG.nriesgo =\n\t\t\t\t\t\t\t\t-- CESION.nriesgo\n\t\t\t\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_codicontratos CONDI ON CONDI.scontra = CESION.scontra\n\t\t\t\t\t\t\t\t) BB\n\t\t\t\t\t\t\t) AA\n\t\t\t\t\t\t) CC\n\t\t\t\t\t) AMT_SRC_FEC_AMT\n\t\t\t\tGROUP BY AMT_SRC_FEC_AMT.sseguro\n\t\t\t\t\t,AMT_SRC_FEC_AMT.ncertif\n\t\t\t\t\t,AMT_SRC_FEC_AMT.nmovimi\n\t\t\t\t) AMT_SRC_FEC_AMT ON AMT_SRC_FEC_AMT.sseguro = MOVE_SEG.sseguro\n\t\t\t\tAND AMT_SRC_FEC_AMT.nmovimi = MOVE_SEG.nmovimi\n\t\t\t--Added as part of CISD-16919\n\t\t\tLEFT OUTER JOIN (\n\t\t\t\tSELECT a.sseguro\n\t\t\t\t\t,a.npoliza\n\t\t\t\t\t,a.ncertif\n\t\t\t\t\t,x.prima_facultativo\n\t\t\t\t\t,CASE \n\t\t\t\t\t\tWHEN x.prima_facultativo IS NULL\n\t\t\t\t\t\t\tTHEN 'N'\n\t\t\t\t\t\tWHEN x.prima_facultativo <= 0\n\t\t\t\t\t\t\tTHEN 'N'\n\t\t\t\t\t\tELSE 'Y'\n\t\t\t\t\t\tEND AS facultativo_indicator\n\t\t\t\tFROM cdp_ods.sisaxis_seguros a\n\t\t\t\tLEFT JOIN (\n\t\t\t\t\tSELECT ces.sseguro\n\t\t\t\t\t\t,sum(ces.icesmon) AS prima_facultativo\n\t\t\t\t\tFROM (\n\t\t\t\t\t\t--CESIONES.qvd\n\t\t\t\t\t\tSELECT scesrea\n\t\t\t\t\t\t\t,ncesion\n\t\t\t\t\t\t\t,icesion\n\t\t\t\t\t\t\t,icapces\n\t\t\t\t\t\t\t,sseguro\n\t\t\t\t\t\t\t,nversio\n\t\t\t\t\t\t\t,scontra\n\t\t\t\t\t\t\t,ctramo\n\t\t\t\t\t\t\t,sfacult\n\t\t\t\t\t\t\t,nriesgo\n\t\t\t\t\t\t\t,fefecto\n\t\t\t\t\t\t\t,fvencim\n\t\t\t\t\t\t\t,fcontab\n\t\t\t\t\t\t\t,pcesion\n\t\t\t\t\t\t\t,sproces\n\t\t\t\t\t\t\t,cgenera\n\t\t\t\t\t\t\t,fgenera\n\t\t\t\t\t\t\t,fanulac\n\t\t\t\t\t\t\t,nmovimi\n\t\t\t\t\t\t\t,nmovigen\n\t\t\t\t\t\t\t,cmonrea\n\t\t\t\t\t\t\t,cmonseg\n\t\t\t\t\t\t\t,icesmon\n\t\t\t\t\t\t\t,icapmon\n\t\t\t\t\t\t\t,fcambio\n\t\t\t\t\t\t\t,pcespol\n\t\t\t\t\t\t\t,pcuopar\n\t\t\t\t\t\tFROM cdp_ods.sisaxis_cesionesrea c\n\t\t\t\t\t\tWHERE cgenera <> 2\n\t\t\t\t\t\t\t-- end CESIONES-qvd\n\t\t\t\t\t\t) ces\n\t\t\t\t\tWHERE ces.ctramo IN (\n\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t,5\n\t\t\t\t\t\t\t)\n\t\t\t\t\tGROUP BY ces.SSEGURO\n\t\t\t\t\tORDER BY ces.sseguro\n\t\t\t\t\t) x ON a.sseguro = x.sseguro\n\t\t\t\tORDER BY a.sseguro\n\t\t\t\t) fec_indicator ON fec_indicator.sseguro = MOVE_SEG.sseguro\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT SUM(AMT_SRC_2.broker_comm_amt) AS broker_comm_amt\n\t\t\t\t\t,SUM(AMT_SRC_2.dir_mo) AS gwp_amt\n\t\t\t\t\t,SUM(AMT_SRC_2.aff_mo) AS afecta_amt\n\t\t\t\t\t,SUM(AMT_SRC_2.exe_mo) AS exenta_amt\n\t\t\t\t\t,AMT_SRC_2.sseguro\n\t\t\t\t\t,AMT_SRC_2.nmovimi\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT CASE \n\t\t\t\t\t\t\tWHEN m.cestrec = 2\n\t\t\t\t\t\t\t\tAND d.cconcep = 11\n\t\t\t\t\t\t\t\tTHEN (d.ICONCEP * - 1)\n\t\t\t\t\t\t\tWHEN r.ctiprec = 9\n\t\t\t\t\t\t\t\tAND d.cconcep = 11\n\t\t\t\t\t\t\t\tTHEN (d.ICONCEP * - 1)\n\t\t\t\t\t\t\tWHEN r.ctiprec = 11\n\t\t\t\t\t\t\t\tAND d.cconcep = 11\n\t\t\t\t\t\t\t\tTHEN (d.ICONCEP * 1)\n\t\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\t\tEND AS broker_comm_amt\n\t\t\t\t\t\t,x.smovrec\n\t\t\t\t\t\t,x.sseguro\n\t\t\t\t\t\t,x.nrecibo\n\t\t\t\t\t\t,x.nmovimi\n\t\t\t\t\t\t,m.fcontab\n\t\t\t\t\t\t,(\n\t\t\t\t\t\t\tSELECT max(r2.cmonseg)\n\t\t\t\t\t\t\tFROM cdp_ods.sisaxis_recibos r2\n\t\t\t\t\t\t\tWHERE x.sseguro = r2.sseguro\n\t\t\t\t\t\t\t) AS ccy\n\t\t\t\t\t\t,m.cestrec\n\t\t\t\t\t\t,r.ctiprec\n\t\t\t\t\t\t,d.cconcep\n\t\t\t\t\t\t,d.cgarant\n\t\t\t\t\t\t,d.iconcep\n\t\t\t\t\t\t,decode(m.cestrec, 2, - 1, 1) AS cestrec_check\n\t\t\t\t\t\t,decode(r.ctiprec, 9, - 1, 1) AS ctiprec_check\n\t\t\t\t\t\t,s.sproduc\n\t\t\t\t\t\t,p.cramo\n\t\t\t\t\t\t,p.cmodali\n\t\t\t\t\t\t,p.ctipseg\n\t\t\t\t\t\t,p.ccolect\n\t\t\t\t\t\t,z.cvalpar\n\t\t\t\t\t\t,decode(z.cvalpar, 1, 'A', 'exe') AS Aff_Exe_Check\n\t\t\t\t\t\t,decode(m.cestrec, 2, - 1, 1) * decode(r.ctiprec, 9, - 1, 1) * d.iconcep AS dir_mo\n\t\t\t\t\t\t,decode(z.cvalpar, 1, (decode(m.cestrec, 2, - 1, 1) * decode(r.ctiprec, 9, - 1, 1) * d.iconcep), 0) AS aff_mo\n\t\t\t\t\t\t,decode(decode(z.cvalpar, 1, 'A', 'exe'), 'exe', (decode(m.cestrec, 2, - 1, 1) * decode(r.ctiprec, 9, - 1, 1) * d.iconcep), 0) AS exe_mo\n\t\t\t\t\tFROM cdp_ods.sisaxis_movrec2movseg x\n\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_seguros s ON (s.sseguro = x.sseguro)\n\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_movrecibo m ON (\n\t\t\t\t\t\t\tx.nrecibo = m.nrecibo\n\t\t\t\t\t\t\tAND x.smovrec = m.smovrec\n\t\t\t\t\t\t\t)\n\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_recibos r ON (x.nrecibo = r.nrecibo)\n\t\t\t\t\t--x.sseguro = r.sseguro and   x.nmovimi = r.nmovimi)\n\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_detrecibos d ON (\n\t\t\t\t\t\t\tx.nrecibo = d.nrecibo\n\t\t\t\t\t\t\tAND d.cconcep = 0\n\t\t\t\t\t\t\tAND d.iconcep <> 0\n\t\t\t\t\t\t\t)\n\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_productos p ON (p.sproduc = s.sproduc)\n\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_pargaranpro z ON (\n\t\t\t\t\t\t\tz.cactivi = s.cactivi\n\t\t\t\t\t\t\tAND z.cgarant = d.cgarant\n\t\t\t\t\t\t\tAND z.cramo = p.cramo\n\t\t\t\t\t\t\tAND z.cmodali = p.cmodali\n\t\t\t\t\t\t\tAND z.ctipseg = p.ctipseg\n\t\t\t\t\t\t\tAND z.ccolect = p.ccolect\n\t\t\t\t\t\t\tAND z.cpargar = 'IND_IVA'\n\t\t\t\t\t\t\t)\n\t\t\t\t\tWHERE m.fcontab > (\n\t\t\t\t\t\t\tSELECT MAX(fconta)\n\t\t\t\t\t\t\tFROM cdp_ods.SISAXIS_HIS_CUADRE02_daily\n\t\t\t\t\t\t\t)\n\t\t\t\t\tORDER BY x.smovrec\n\t\t\t\t\t\t,x.sseguro\n\t\t\t\t\t\t,x.nrecibo\n\t\t\t\t\t\t,x.nmovimi\n\t\t\t\t\t\t,d.cgarant\n\t\t\t\t\t) AMT_SRC_2\n\t\t\t\tGROUP BY AMT_SRC_2.sseguro\n\t\t\t\t\t,AMT_SRC_2.nmovimi\n\t\t\t\t) AMT_SRC_2 ON AMT_SRC_2.sseguro = SEG.sseguro\n\t\t\t\tAND AMT_SRC_2.nmovimi = MOVE_SEG.nmovimi\n\t\t\t) AA\n\t\tWHERE AA.RNK = 1\n\t\t\tAND fcontab > (\n\t\t\t\tSELECT MAX(fconta)\n\t\t\t\tFROM cdp_ods.SISAXIS_HIS_CUADRE02_daily\n\t\t\t\t)\n\t\tGROUP BY policy_item_id\n\t\t\t,acct_yr\n\t\t\t,acct_mth\n\t\t\t,mv_id\n\t\t) SRC\n\tLEFT OUTER JOIN (\n\t\tSELECT npoliza\n\t\t\t,COUNT(ncertif) AS pcount\n\t\tFROM cdp_ods.sisaxis_seguros\n\t\tWHERE ncertif > 0\n\t\tGROUP BY npoliza\n\t\t) pol_count --ON CAST(SRC.policy_num AS INTEGER) = CAST(pol_count.npoliza AS INTEGER) --casting changed to trunc\n\t\tON TRUNC(SRC.policy_num ) = TRUNC(pol_count.npoliza)\n\t/*LEFT OUTER JOIN\n            (\n            select FCONTA,sseguro,\n            sum(PRIMA_DIR) as PRIMA_DIR, sum(PRIMA_AFE_DIR) as PRIMA_AFE_DIR,\n            sum(PRIMA_EXE_DIR) as PRIMA_EXE_DIR from (\n            SELECT  FCONTA,\n            SSEGURO, NCERTIF, NPOLIZA, PRIMA_TARIFA PRIMA_DIR, IPRIAFE_DIR PRIMA_AFE_DIR,\n            IPRIEXE_DIR PRIMA_EXE_DIR\n            FROM cdp_ods.SISAXIS_HIS_CUADRE02_daily\n            )\n            group by FCONTA,sseguro\n            ) dir_amt\n            on src.policy_item_id=dir_amt.sseguro\n            LEFT OUTER JOIN\n            (\n            select a.[ID_ITEM],case when isnull(b.[ID_ITEM],0)>0 then 'SI' else 'NO'  end as\n            ITEM_RENOVADO  from ITEM_RENO a\n            left join ITEM_RENO as b\n            on a.[ID_ITEM]=b.[ID_ITEM] and b.[ID_SITUACION]=0\n            ) ITEM_RENO_IND\n            ON SRC.policy_item_id=ITEM_RENO_IND.[ID_ITEM]*/\n\tLEFT JOIN (\n\t\tSELECT sseguro AS [ID_ITEM]\n\t\t\t,sseguro\n\t\t\t,ITEM_RENOVACION\n\t\tFROM ITEM_RENO_NOFLOTA\n\t\tWHERE ITEM_RENOVACION = 'SI'\n\t\t\n\t\tUNION\n\t\t\n\t\tSELECT sseguro AS [ID_ITEM]\n\t\t\t,sseguro\n\t\t\t,ITEM_RENOVACION\n\t\tFROM ITEM_OTROS_1\n\t\tWHERE ITEM_RENOVACION = 'SI'\n\t\t\n\t\tUNION\n\t\t\n\t\tSELECT sseguro AS [ID_ITEM]\n\t\t\t,sseguro\n\t\t\t,'NO' AS ITEM_RENOVACION\n\t\tFROM ITEM_RENO_NR\n\t\t) ITEM_RENO_IND ON SRC.policy_item_id = ITEM_RENO_IND.[ID_ITEM]\n\tLEFT OUTER JOIN (\n\t\tSELECT NPOLIZA\n\t\t\t,CYCLE_NUMBER\n\t\t\t,CYCLE_STATE\n\t\t\t,CASE \n\t\t\t\tWHEN CYCLE_STATE = 'Rechazado'\n\t\t\t\t\tOR CYCLE_STATE = 'Eliminado'\n\t\t\t\t\tTHEN 'X'\n\t\t\t\tWHEN CORIGEN = 7\n\t\t\t\t\tTHEN 'M'\n\t\t\t\tWHEN COBJASE = 5\n\t\t\t\t\tTHEN 'A'\n\t\t\t\tWHEN CRENOVA_PRO = 1\n\t\t\t\t\tTHEN 'A'\n\t\t\t\tELSE 'S'\n\t\t\t\tEND AS RENOVATION_TYPE\n\t\t\t,NMOVIMI\n\t\tFROM (\n\t\t\tSELECT M.SCICLO AS CYCLE_NUMBER\n\t\t\t\t,M.NPOLIZAANT AS NPOLIZA\n\t\t\t\t,M.CORIGEN\n\t\t\t\t,M.CRENOVA\n\t\t\t\t,M.CRENOVPE\n\t\t\t\t,N.NMOVIMI\n\t\t\t\t,O.testado AS CYCLE_STATE\n\t\t\t\t,P.NRO_LINEA\n\t\t\t\t,P.ID_PROCESO\n\t\t\t\t,P.COD_PRODUC\n\t\t\t\t,P.DESC_ESTADO\n\t\t\t\t,P.ESTADO_PROC\n\t\t\t\t,Q.COBJASE\n\t\t\t\t,R.CRENOVA_PRO\n\t\t\tFROM (\n\t\t\t\tSELECT y.SCICLO\n\t\t\t\t\t,y.NPOLIZAANT\n\t\t\t\t\t,y.CORIGEN\n\t\t\t\t\t,y.CRENOVA\n\t\t\t\t\t,y.CRENOVPE\n\t\t\t\tFROM CMI_PROPUESTA_1 Y\n\t\t\t\tINNER JOIN (\n\t\t\t\t\tSELECT m1.NPOLIZAANT\n\t\t\t\t\t\t,MAX(m1.SCICLO) AS SCICLO\n\t\t\t\t\tFROM CMI_PROPUESTA_1 m1\n\t\t\t\t\tWHERE m1.CORIGEN IN (\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t\t,7\n\t\t\t\t\t\t\t)\n\t\t\t\t\tGROUP BY m1.NPOLIZAANT\n\t\t\t\t\t) X ON Y.NPOLIZAANT = X.NPOLIZAANT\n\t\t\t\t\tAND Y.SCICLO = X.SCICLO\n\t\t\t\t) M\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT SCICLO\n\t\t\t\t\t,CESTADO\n\t\t\t\t\t,NMOVIMI\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT SCICLO\n\t\t\t\t\t\t,CESTADO\n\t\t\t\t\t\t,NMOVIMI\n\t\t\t\t\t\t,ROW_NUMBER() OVER (\n\t\t\t\t\t\t\tPARTITION BY SCICLO ORDER BY NMOVIMI DESC\n\t\t\t\t\t\t\t) rnk\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT SCICLO\n\t\t\t\t\t\t\t,CESTADO\n\t\t\t\t\t\t\t,NMOVIMI\n\t\t\t\t\t\tFROM CMI_MOVPROPUESTA_15\n\t\t\t\t\t\tGROUP BY SCICLO\n\t\t\t\t\t\t\t,CESTADO\n\t\t\t\t\t\t\t,NMOVIMI\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\tWHERE RNK = 1\n\t\t\t\t) N ON M.SCICLO = N.SCICLO\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT csistema\n\t\t\t\t\t,ccodigo\n\t\t\t\t\t,tdescripcion AS testado --,'1' as orden\n\t\t\t\tFROM CDP_ODS.sisaxis_cmi_estados\n\t\t\t\tWHERE csistema = 15\n\t\t\t\t) O ON N.CESTADO = O.CCODIGO\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT SCICLO\n\t\t\t\t\t,COD_PRODUC\n\t\t\t\t\t,DESC_ESTADO\n\t\t\t\t\t,ESTADO_PROC\n\t\t\t\t\t,NRO_LINEA\n\t\t\t\t\t,ID_PROCESO\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT SCICLO\n\t\t\t\t\t\t,COD_PRODUC\n\t\t\t\t\t\t,DESC_ESTADO\n\t\t\t\t\t\t,ESTADO_PROC\n\t\t\t\t\t\t,NRO_LINEA\n\t\t\t\t\t\t,ID_PROCESO\n\t\t\t\t\t\t,ROW_NUMBER() OVER (\n\t\t\t\t\t\t\tPARTITION BY SCICLO ORDER BY NRO_LINEA DESC\n\t\t\t\t\t\t\t\t,ID_PROCESO DESC\n\t\t\t\t\t\t\t) rnk\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT NUM_CICLO AS SCICLO\n\t\t\t\t\t\t\t,COD_PRODUC\n\t\t\t\t\t\t\t,DESC_ESTADO\n\t\t\t\t\t\t\t,ESTADO AS ESTADO_PROC\n\t\t\t\t\t\t\t,MAX(NRO_LINEA) AS NRO_LINEA\n\t\t\t\t\t\t\t,MAX(ID_PROCESO) AS ID_PROCESO\n\t\t\t\t\t\tFROM DET\n\t\t\t\t\t\tWHERE COD_EMPRESA = 'LIBERTY'\n\t\t\t\t\t\t\tAND COD_FORMATO = 'RENOVACION'\n\t\t\t\t\t\t\tAND ESTADO <> 'E'\n\t\t\t\t\t\t\tAND ESTADO <> 'E_CEL'\n\t\t\t\t\t\tGROUP BY SCICLO\n\t\t\t\t\t\t\t,COD_PRODUC\n\t\t\t\t\t\t\t,DESC_ESTADO\n\t\t\t\t\t\t\t,ESTADO_PROC\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\tWHERE RNK = 1\n\t\t\t\t) P ON M.SCICLO = P.SCICLO\n\t\t\tLEFT OUTER JOIN (\n\t\t\t\tSELECT SPRODUC AS COD_PRODUC\n\t\t\t\t\t,COBJASE\n\t\t\t\tFROM PROD\n\t\t\t\t) Q ON P.COD_PRODUC = Q.COD_PRODUC\n\t\t\tLEFT OUTER JOIN (\n\t\t\t\tSELECT DISTINCT SPRODUCN AS COD_PRODUC\n\t\t\t\t\t,CRENOVA AS CRENOVA_PRO\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT SPRODUCA\n\t\t\t\t\t\t,SPRODUCN\n\t\t\t\t\t\t,CRENOVA\n\t\t\t\t\tFROM CDP_ODS.SISAXIS_HOMOLOGA_PRODUCTOS\n\t\t\t\t\t)\n\t\t\t\t) R ON P.COD_PRODUC = R.COD_PRODUC\n\t\t\t)\n\t\t) CICLO ON SRC.policy_num = CICLO.npoliza\n\tLEFT OUTER JOIN (\n\t\tSELECT x.sseguro AS sseguro\n\t\t\t,x.nmovimis AS nmovimis\n\t\t\t,CASE \n\t\t\t\tWHEN CMI_PROPUESTA_1.ctipdoc = 1\n\t\t\t\t\tTHEN 'Propuesta'\n\t\t\t\tELSE 'Endoso'\n\t\t\t\tEND AS doc_type\n\t\tFROM (\n\t\t\tSELECT sseguro\n\t\t\t\t,nmovimis\n\t\t\t\t,sciclo\n\t\t\tFROM DOC\n\t\t\t) x\n\t\tLEFT JOIN CMI_PROPUESTA_1 ON x.sciclo = CMI_PROPUESTA_1.sciclo\n\t\t) DOC_TYPE ON SRC.policy_item_id = DOC_TYPE.sseguro\n\t\tAND SRC.mv_id = DOC_TYPE.nmovimis\n\t/*LEFT OUTER JOIN\n            (select sseguro, count(nsinies) as claim_count from cdp_ods.sisaxis_siniestros group by\n            sseguro) SNSTRS\n            ON SRC.policy_item_id=SNSTRS.sseguro */\n\tLEFT JOIN (\n\t\tSELECT 1 AS DUMMY\n\t\t\t,MAX(fact_renovaciones_integrado_key) AS MAX_SID\n\t\tFROM cdp_dwh.temp_fact_renovaciones_integrado_t\n\t\t) LKP ON LKP.DUMMY = SRC.DUMMY\n\t)"
    },
    {
        "type": "customQuery",
        "path": "content.transformations[1].dataAdapter.object.customQuery",
        "value": "SELECT\nSTG.fact_renovaciones_integrado_key,\nSTG.policy_item_id,\nSTG.src_sys_cd,\nSTG.acct_yr,\nSTG.acct_mth,\nSTG.mv_id\nFROM  cdp_dwh.temp_fact_renovaciones_integrado_t STG\nWHERE STG.src_sys_cd='axis' --"
    }
]