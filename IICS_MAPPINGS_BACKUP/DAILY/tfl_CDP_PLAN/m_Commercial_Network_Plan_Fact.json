[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "--Final query for fact_sales_pln_t\n----------------------\n--10369931\tANTOFAGASTA\n\n\nselect \nfact_pln_key,\nrut_ejecutivo,\nejecutivo,\ncase when sucursal is null then 'Sin Asignar' else sucursal end as sucursal,\ncase when gerencia is null then 'Sin Asignar' else gerencia end as gerencia,\ncase when regional is null then 'Sin Asignar' else regional end as regional\nfrom (\nselect * from\n(\nselect \nbase.fact_pln_key,\ncor.sales_exec_rut as rut_ejecutivo, \ncor.sales_exec_name as ejecutivo, \ncor.branch_office_name_2 as sucursal, \ncor.management_name as gerencia, \ncor.regional_name as regional\nfrom\n(\nselect \nfact_pln_key,\nbroker_rut_num,\nbranch_office_name,\ncast(pln_yr as int) as pln_year,\ncast(pln_mth as int) as pln_month\nfrom \ncdp_dwh.fact_sales_pln_t \nwhere pln_year>=2018 and pln_month>=1) base\n\nleft join\n\n(select year as year_curr,\nmonth as month_curr,\ncase when year=mx.mx_year then 2999 else mx.mx_year end as year_nxt,\ncase when month=mx.mx_month then 13 else mx.mx_month end as month_nxt,\ncompany_name,\nbase.broker_rut_num,\nbranch_office_cd_1,\nsales_exec_rut,\nsales_exec_name,\nbase.branch_office_name_1,\nbranch_office_name_2,\nmanagement_name,\nregional_name \nfrom \n(select * from cdp_dwh.dim_pln_broker_t\nwhere rec_crt_dtm=(select max(rec_crt_dtm) from cdp_dwh.dim_pln_broker_t))base\nleft join\n(select broker_rut_num, branch_office_name_1, max(year) as mx_year,max(month) as mx_month \nfrom cdp_dwh.dim_pln_broker_t group by broker_rut_num, branch_office_name_1) mx on \nbase.broker_rut_num=mx.broker_rut_num and base.branch_office_name_1=mx.branch_office_name_1 ) cor\n\non \nbase.broker_rut_num=cor.broker_rut_num and\nUPPER(base.branch_office_name)=UPPER(cor.branch_office_name_1) and\n(base.pln_year >= cor.year_curr and\nbase.pln_month >= cor.month_curr and\nbase.pln_year <=  cor.year_nxt and\nbase.pln_month < cor.month_nxt)    )\nwhere \n(  (sucursal is not null and gerencia is not null and regional is not null)\nor ( gerencia not like 'Sin Asignar' and regional not like 'Sin Asignar' and sucursal not like 'Sin Asignar' )\nor ( gerencia not like '' and regional not like '' and sucursal not like '' ))\n\nunion \n(\nselect fact_pln_key,\n'Sin Asignar' as rut_ejecutivo, \n'Sin Asignar' as ejecutivo , \nbranch_office_name_2 as sucursal,\nmanagement_name as gerencia, \nregional_name as regional\n\nfrom \n(\nselect \nbase1.fact_pln_key ,\nbase1.broker_rut_num,\nbase1.branch_office_name,\nbase1.pln_year,\nbase1.pln_month,\nsuc.branch_office_name_2,\nsuc.management_name,\nsuc.regional_name\nfrom (\n        select fact_pln_key, broker_rut_num, branch_office_name,pln_year,pln_month,sucursal,gerencia,regional from (\n        select  \n        base.fact_pln_key, base.broker_rut_num,\n        base.branch_office_name, base.pln_year,\n        base.pln_month, cor.sales_exec_rut as rut_ejecutivo1, \n        cor.sales_exec_name as ejecutivo1, \n        cor.branch_office_name_2 as sucursal, \n        cor.management_name as gerencia, \n        cor.regional_name as regional\n        from\n        (\n        select \n        fact_pln_key,\n        branch_office_name,\n        broker_rut_num,\n        cast(pln_yr as int) as pln_year,\n        cast(pln_mth as int) as pln_month\n        from \n        cdp_dwh.fact_sales_pln_t \n        where pln_year>=2018 and pln_month>=1) base\n\n        left join\n\n        (select year as year_curr,\n        month as month_curr,\n        case when year=mx.mx_year then 2999 else mx.mx_year end as year_nxt,\n        case when month=mx.mx_month then 13 else mx.mx_month end as month_nxt,\n        company_name,\n        base.broker_rut_num,\n        branch_office_cd_1,\n        sales_exec_rut,\n        sales_exec_name,\n        base.branch_office_name_1,\n        branch_office_name_2,\n        management_name,\n        regional_name \n        from \n        (select * from cdp_dwh.dim_pln_broker_t\n        where rec_crt_dtm=(select max(rec_crt_dtm) from cdp_dwh.dim_pln_broker_t))base\n        left join\n        (select broker_rut_num, branch_office_name_1, max(year) as mx_year,max(month) as mx_month \n        from cdp_dwh.dim_pln_broker_t group by broker_rut_num, branch_office_name_1) mx on \n        base.broker_rut_num=mx.broker_rut_num and base.branch_office_name_1=mx.branch_office_name_1 ) cor\n        \n        on \n        base.broker_rut_num=cor.broker_rut_num and\n        UPPER(base.branch_office_name)=UPPER(cor.branch_office_name_1) and\n        (base.pln_year >= cor.year_curr and\n        base.pln_month >= cor.month_curr and\n        base.pln_year <=  cor.year_nxt and\n        base.pln_month < cor.month_nxt) ) \n        where (sucursal is null and gerencia is null and regional is null) or \n              (sucursal LIKE '' and gerencia LIKE '' and regional LIKE '') or\n              (gerencia LIKE 'Sin Asignar' and regional LIKE 'Sin Asignar' and sucursal LIKE 'Sin Asignar') \n        ) base1\n\nleft join \n\n    (\n        select year as year_curr,\n        month as month_curr,\n        case when year=mx.mx_year then 2999 else mx.mx_year end as year_nxt,\n        case when month=mx.mx_month then 12 else mx.mx_month end as month_nxt,\n        company_name,\n        branch_office_cd_1,\n        base.branch_office_name_1,\n        branch_office_name_2,\n        management_name,\n        regional_name \n        from \n        (select * from cdp_dwh.dim_pln_branch_office_t\n        where -- company_name like 'axis'and \n        rec_crt_dtm=(select max(rec_crt_dtm) from cdp_dwh.dim_pln_branch_office_t))base\n        left join\n        (select branch_office_name_1, max(year) as mx_year,max(month) as mx_month \n        from cdp_dwh.dim_pln_branch_office_t group by branch_office_name_1) mx \n        on base.branch_office_name_1=mx.branch_office_name_1\n    \n    )   suc\n\n        on \n        base1.branch_office_name = suc.branch_office_name_1 and\n        (base1.pln_year >= suc.year_curr and\n        base1.pln_month >= suc.month_curr and\n        base1.pln_year <= suc.year_nxt and\n        base1.pln_month <= suc.month_nxt)))\n)"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "update cdp_dwh.fact_sales_pln_t set sales_exec_rut='Sin Asignar', sales_exec_name='Sin Asignar', branch_office_name_2='Sin Asignar', management_name='Sin Asignar', regional_name='Sin Asignar'"
    }
]