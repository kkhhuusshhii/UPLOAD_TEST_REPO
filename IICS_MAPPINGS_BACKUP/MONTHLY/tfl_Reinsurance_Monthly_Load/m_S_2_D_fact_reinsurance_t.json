[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "--Added profile_description and subprofile_description for profiles 23,24,25,26,27,28,29,30,31,32,33,34,35 as of 21/09/2021\n--Added profile_description and subprofile_description for profiles 21,22 as of 16/04/2021\n--Added the profile_description and subprofile description columns as a part of CR CDP-3856\n--Updated dim_insured ,added condition insured_rut_num as of 30/03/2020\n--updated the subprofile_description logic as part of CISD-21310\n\nSELECT \nLKP_MAX_KEY.MAX_SID AS FACT_REINSURANCE_KEY,\nSRC.src_sys_cd,\nSRC.dim_reinsurer_contract_key,\nSRC.policy_number,\nSRC.item_number,\nSRC.mortgage_portfolio,\nSRC.sseguro,\nSRC.policy_start_date,\nSRC.policy_end_date,\nSRC.account_date,\nSRC.cagente,\nSRC.dim_broker_key,\nSRC.rlshp_key,\nSRC.dim_policyholder_key,\nSRC.dim_insured_key,\nSRC.insured_type,\nSRC.risk_address,\nSRC.construction_type,\nSRC.number_risk_floors,\nSRC.construction_year,\nSRC.dim_region_key,\nSRC.comuna_name ,\nSRC.seismic_zone_number ,\nSRC.product_activity ,\nSRC.dim_lob_key,\nSRC.curr_code ,\nSRC.retained_premium_amount,\nSRC.exempt_premium_oc ,\nSRC.affected_premium_oc,\nSRC.total_insured_amount,\nSRC.insured_amount_building_oc,\nSRC.insured_amount_content_oc,\nSRC.insured_amount_PxP_oc,\nSRC.total_premium_contract_oc,\nSRC.coinsurance_type,\nSRC.percentage_coinsurance_retained,\nSRC.percentage_coinsurance_ceded,\nSRC.percentage_cuotaparte_retained,\nSRC.percentage_cuotaparte_ceded,\nSRC.percentage_surplus1,\nSRC.percentage_surplus2,\nSRC.percentage_facultativo,\nSRC.percentage_own_retention,\nSRC.percentage_direct_retention,\nSRC.percentage_retention_74,\nSRC.percentage_retention_remarque,\nSRC.pclase_abc,\nSRC.pcod_activid,\nSRC.pdes_activid,\nSRC.risk_category,\nSRC.agreement,\nSRC.authorizer,\nSRC.dim_branch_office_key,\nSRC.branch_office_code,\nSRC.risk_usage,\nSRC.product_code,\nSRC.product_name ,\nSRC.contract_amount,\nSRC.total_contract_insured_amt,\nSRC.period_file_extraction,\nSRC.broker_commission,\n--REINSURANCE_MASTER.comision_reasegurador AS reinsurance_commission\n--REINSURER.dim_reinsurer_key\n'Y' AS actv_rec_ind,\nSRC.profile_cd,\n-------ADDING AS A PART OF CR-3856--------\nSRC.profile_description,\nSRC.subprofile_description\n------------------------------------------\nFROM\n(\nSELECT DISTINCT\n'axis' AS src_sys_cd,\nREINSURANCE_CONTRACT.dim_reinsurer_contract_key,\nREINSURANCE_MASTER.npoliza AS policy_number,\nREINSURANCE_MASTER.ncertif AS item_number,\nREINSURANCE_MASTER.mortgage_portfolio,\nREINSURANCE_MASTER.sseguro,\nREINSURANCE_MASTER.fecha_inicio AS policy_start_date,\nREINSURANCE_MASTER.fecha_termino AS policy_end_date,\nREINSURANCE_MASTER.fecha_contable AS account_date,\nREINSURANCE_MASTER.cagente,\nBROKER.dim_broker_key,\nREINSURANCE_MASTER.rlshp_key,\nPOL_HOLD.dim_policyholder_key,\nINSURED.dim_insured_key,\nREINSURANCE_MASTER.tipo_asegurado AS insured_type,\nREPLACE(TRANSLATE(REINSURANCE_MASTER.direccion,'\\\u001f',''),CHR(10),'') AS risk_address,\nREINSURANCE_MASTER.tipo_construccion AS construction_type,\nCAST(REINSURANCE_MASTER.cantidad_pisos AS VARCHAR(20)) AS number_risk_floors,\nREINSURANCE_MASTER.antiguedad AS construction_year,\nCASE WHEN REINSURANCE_MASTER.region is NOT NULL\nTHEN REGION1.dim_region_key\nELSE BRANCH_OFFICE.dim_region_key\nEND AS dim_region_key,\nREINSURANCE_MASTER.ciudad AS comuna_name ,\nCAST(CASE WHEN REINSURANCE_MASTER.region is NOT NULL\nTHEN REGION1.zona_sismica\nELSE REGION2.zona_sismica\nEND AS INTEGER) AS seismic_zone_number,\n--REINSURANCE_MASTER.zona_sismica AS seismic_zone_number ,\nREINSURANCE_MASTER.ttitulo AS product_activity ,\nLOB.dim_lob_key,\nREINSURANCE_MASTER.moneda AS curr_code ,\nREINSURANCE_MASTER.prima_neta_mo AS retained_premium_amount,\nREINSURANCE_MASTER.prima_excenta_mo AS exempt_premium_oc ,\nREINSURANCE_MASTER.prima_afecta_mo AS affected_premium_oc,\nREINSURANCE_MASTER.mto_aseg_cob_mo AS total_insured_amount,\n--(REINSURANCE_MASTER.mto_aseg_edif_mo + REINSURANCE_MASTER.mto_aseg_cont_mo + REINSURANCE_MASTER.mto_aseg_dano_mo) as total_insured_amount,\nREINSURANCE_MASTER.mto_aseg_edif_mo AS insured_amount_building_oc,\nREINSURANCE_MASTER.mto_aseg_cont_mo AS insured_amount_content_oc,\nREINSURANCE_MASTER.mto_aseg_dano_mo AS insured_amount_PxP_oc,\nREINSURANCE_MASTER.tot_x_contrato_mo AS total_premium_contract_oc,\nREINSURANCE_MASTER.ctipcoa AS coinsurance_type,\nREINSURANCE_MASTER.porc_coaseg_ret AS percentage_coinsurance_retained,\nREINSURANCE_MASTER.porc_coaseg_ced AS percentage_coinsurance_ceded,\nREINSURANCE_MASTER.porc_retctr AS percentage_cuotaparte_retained,\nREINSURANCE_MASTER.porc_cedctr AS percentage_cuotaparte_ceded,\nREINSURANCE_MASTER.porc_exc1 AS percentage_surplus1,\nREINSURANCE_MASTER.porc_exc2 AS percentage_surplus2,\nREINSURANCE_MASTER.porc_fac AS percentage_facultativo,\nREINSURANCE_MASTER.porc_retpro AS percentage_own_retention,\nREINSURANCE_MASTER.porc_retdir AS percentage_direct_retention,\nREINSURANCE_MASTER.porc_ret74 AS percentage_retention_74,\nREINSURANCE_MASTER.porc_rem AS percentage_retention_remarque,\nREINSURANCE_MASTER.pclase_abc,\nREINSURANCE_MASTER.pcod_activid,\nREINSURANCE_MASTER.pdes_activid,\nREINSURANCE_MASTER.categoria AS risk_category,\nREINSURANCE_MASTER.agreement AS agreement,\nREINSURANCE_MASTER.autorizador AS authorizer,\nBRANCH_OFFICE.dim_branch_office_key AS dim_branch_office_key,\nBRANCH_OFFICE.branch_office_cd AS branch_office_code,\nREINSURANCE_MASTER.uso AS risk_usage,\nREINSURANCE_MASTER.producto AS product_code,\nREINSURANCE_MASTER.ttitulo_2 AS product_name ,\nREINSURANCE_MASTER.total_mo AS contract_amount,\nREINSURANCE_MASTER.mto_aseg_cont_mo_2 AS total_contract_insured_amt,\nREINSURANCE_MASTER.percon AS period_file_extraction,\nREINSURANCE_MASTER.comision_corredor AS broker_commission,\nREINSURANCE_MASTER.profile_cd,\n--------------ADDING AS A PART OF CR CDP-3856-------------------------------------------------------\ncase    \n\twhen REINSURANCE_MASTER.profile_cd in (3,10,17,18,19) then 'Ingenier\u00c3\u00ada' \n\twhen REINSURANCE_MASTER.profile_cd = 4 then 'Accidentes Personales' \n\twhen REINSURANCE_MASTER.profile_cd = 5 then 'Responsabilidad Civil'\n    when REINSURANCE_MASTER.profile_cd in (6,7) then 'Miscelaneo' \n\twhen REINSURANCE_MASTER.profile_cd = 8 then 'Transporte' \n\twhen REINSURANCE_MASTER.profile_cd = 12 then 'Terrorismo' \n\twhen REINSURANCE_MASTER.profile_cd = 13 then 'Casco'\n    when REINSURANCE_MASTER.profile_cd = 15 then 'Incendio' \n\twhen REINSURANCE_MASTER.profile_cd = 16 then 'Sismo' \n\twhen REINSURANCE_MASTER.profile_cd = 20 then 'Piscicultura' \n\twhen REINSURANCE_MASTER.profile_cd = 21 then 'Fianza Garant\u00c3\u00ada'\n    when REINSURANCE_MASTER.profile_cd = 22 then 'Fianza Garant\u00c3\u00ada IRE'\n  when REINSURANCE_MASTER.profile_cd = 23 then 'Accidentes Personales Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 24 then 'Averia Maquinarias Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 25 then 'Equipo Movil Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 26 then 'Incendio Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 27 then 'Instalaciones Electricas Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 28 then 'Miscelaneo Robo Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 29 then 'Miscelaneo Otros Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 30 then 'Responsabilidad Civil Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 31 then 'Sismo Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 32 then 'Todo Riesgo Construccion Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 33 then 'Todo Riesgo Montaje Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 34 then 'Transportes Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 35 then 'Terrorismo Lineas Especiales'\n  when REINSURANCE_MASTER.profile_cd = 36 then 'Cascos Lineas Especiales' --CISD-21398\n\telse 'Otro' \nend as profile_description,\n--------------- updated the subprofile_description logic as part of CISD-21310 ---------------------------------\ncase \n\twhen (REINSURANCE_MASTER.profile_cd = 8 and REINSURANCE_MASTER.ttitulo in ('A\u00c3\u00a9reo Internacional','RMX A\u00c3\u00a9reo','Multitransporte Internacional')) then 'A\u00c3\u00a9reo'\n    when (REINSURANCE_MASTER.profile_cd = 8 and REINSURANCE_MASTER.ttitulo  in ('Terrestre Cabotaje','Transporte RMX','RMX Terrestre','Cotizador RMX Terrestre','Terrestre Internacional','FLAT','Viaje Espec\u00c3\u00adfico Terrestre','DMV Terrestre','Terrestre Nacional', 'Miscelaneo','Oficinas')) then 'Terrestre'\n    when (REINSURANCE_MASTER.profile_cd = 8 and REINSURANCE_MASTER.ttitulo  in ('Mar\u00c3\u00adtimo Internacional', 'RMX Mar\u00c3\u00adtimo','Viaje Espec\u00c3\u00adfico Mar\u00c3\u00adtimo Internacional')) then 'Mar\u00c3\u00adtimo'\n\twhen (REINSURANCE_MASTER.profile_cd = 8 and REINSURANCE_MASTER.ttitulo not in ('A\u00c3\u00a9reo Internacional','RMX A\u00c3\u00a9reo','Multitransporte Internacional')    \n    and REINSURANCE_MASTER.ttitulo  not  in ('Terrestre Cabotaje','Transporte RMX','RMX Terrestre','Cotizador RMX Terrestre','Terrestre Internacional','FLAT','Viaje Espec\u00c3\u00adfico Terrestre','DMV Terrestre','Terrestre Nacional', 'Miscelaneo','Oficinas')  \n    and REINSURANCE_MASTER.ttitulo  not  in ('Mar\u00c3\u00adtimo Internacional', 'RMX Mar\u00c3\u00adtimo','Viaje Espec\u00c3\u00adfico Mar\u00c3\u00adtimo Internacional')) then 'Transporte' --subprofile_description logic as part of CISD-21310\n\twhen (REINSURANCE_MASTER.profile_cd in (6,7) and REINSURANCE_MASTER.desc_ramo in ('CRISTALES')) then 'Cristales' \n    when (REINSURANCE_MASTER.profile_cd in (6,7) and REINSURANCE_MASTER.desc_ramo  in ('ROBO')) then 'Robo'\n    when (REINSURANCE_MASTER.profile_cd in (6,7) and REINSURANCE_MASTER.desc_ramo  in ('INCENDIO')) then 'Incendio' --subprofile_description logic as part of CISD-21310\n    when (REINSURANCE_MASTER.profile_cd in (6,7) and REINSURANCE_MASTER.desc_ramo  in ('MISCELANEO')) then 'Miscelaneo' --subprofile_description logic as part of CISD-21310\n    when (REINSURANCE_MASTER.profile_cd in (3,10,17,18,19) and (lower(REINSURANCE_MASTER.tcontra) like ('%todo riesgo ingenieria%') or lower(REINSURANCE_MASTER.ttitulo_2) like ('%todo riesgo construccion%'))) then 'Todo Riesgo Construcci\u00c3\u00b3n'\n    when (REINSURANCE_MASTER.profile_cd in (3,10,17,18,19) and lower(REINSURANCE_MASTER.tcontra) like ('%equipo electronico%'))  then 'Equipo Electr\u00c3\u00b3nico'\n    when (REINSURANCE_MASTER.profile_cd in (3,10,17,18,19) and (lower(REINSURANCE_MASTER.tcontra) like ('%equipo movil%') or lower(REINSURANCE_MASTER.ttitulo_2) like ('%eq.movil%') ))  then 'Equipo M\u00c3\u00b3vil'\n    when (REINSURANCE_MASTER.profile_cd in (3,10,17,18,19) and lower(REINSURANCE_MASTER.tcontra) like ('%todo riesgo montaje%'))  then 'Todo Riesgo Montaje'\n    when (REINSURANCE_MASTER.profile_cd in (3,10,17,18,19) and lower(REINSURANCE_MASTER.tcontra) like ('%averia maquinaria%'))  then 'Aver\u00c3\u00ada Maquinaria'\n\twhen REINSURANCE_MASTER.profile_cd in (4,5,12,13,15,16,20) then LOB.lob_desc --Added this line for Change in CR\n\twhen (REINSURANCE_MASTER.profile_cd in (21,22) and REINSURANCE_MASTER.desc_ramo in ('FIANZA / GARANTIA')) then 'Fianza / Garantia'\n\twhen (REINSURANCE_MASTER.profile_cd in (23,24,25,26,27,28,29,30,31,32,33,34,35)) then REINSURANCE_MASTER.desc_ramo\n    --subprofile_description logic as part of CISD-21398\n    when (REINSURANCE_MASTER.profile_cd = 36 and REINSURANCE_MASTER.desc_ramo in ('CASCOS')) then 'Cascos' \n\telse REINSURANCE_MASTER.uso  \nend as subprofile_description,\n---------------------------------------------------------------------------------------------\n--REINSURANCE_MASTER.comision_reasegurador AS reinsurance_commission\n--REINSURER.dim_reinsurer_key\n1 AS DUMMY\nFROM\n(\n\nselect scontra,\ntcontra,\nano_contrato,\nnpoliza,\nncertif,\nfcierre,\nmortgage_portfolio,\nsseguro,\nfecha_inicio,\nfecha_termino,\nfecha_contable,\ncagente,\nrut_corredor,\nrlshp_key,\ncod_ejecutivo,\nejecutivo,\nrut_contratante,\ntipo_tomador,\nrut_asegurado,\ntipo_asegurado,\ndireccion,\ntipo_construccion,\ncantidad_pisos,\nantiguedad,\nregion,\nprovincia,\nciudad,\nzona_sismica,\nttitulo,\nramo,\ndesc_ramo,\nmoneda,\nprima_neta_mo,\nprima_excenta_mo,\nprima_afecta_mo,\nmto_aseg_cob_mo,\nmto_aseg_edif_mo,\nmto_aseg_cont_mo,\nmto_aseg_dano_mo,\ntot_x_contrato_mo,\nctipcoa,\nporc_coaseg_ret,\nporc_coaseg_ced,\nporc_retctr,\nporc_cedctr,\nporc_exc1,\nporc_exc2,\nporc_fac,\nporc_retpro,\nporc_retdir,\nporc_ret74,\nporc_rem,\npclase_abc,\npcod_activid,\npdes_activid,\ncategoria,\nagreement,\nautorizador,\nuso,\nproducto,\nttitulo_2,\ntotal_mo,\nmto_aseg_cont_mo_2,\npercon,\ncomision_corredor,\ncramo,\nprofile_cd\nFROM cdp_dwh.reinsurance_master\n)REINSURANCE_MASTER\n\n----JOINING DIMENSIONS FOR DIM_KEYS-----\n--DIM REINSURANCE CONTRACT \nLEFT JOIN cdp_dwh.dim_reinsurer_contract_t REINSURANCE_CONTRACT\nON CAST(REINSURANCE_MASTER.scontra AS INTEGER) = REINSURANCE_CONTRACT.reinsurance_contract_number\n\n--DIM BROKER AND BROKER_BRANCH_RELATIONSHIP \nLEFT JOIN \n(SELECT DISTINCT BRKR.dim_broker_key,AA.sseguro,AA.broker_branch_rlshp_key FROM\n(SELECT DISTINCT BRKR_RLSHP.entity_rut_num,BRKR_RLSHP.broker_branch_rlshp_key, SEG.sseguro\nFROM (select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\nINNER JOIN cdp_dwh.broker_branch_rlshp_t BRKR_RLSHP\nON SEG.cagente=BRKR_RLSHP.rlshp_src_id\nAND BRKR_RLSHP.entity_type_cd=4\nAND BRKR_RLSHP.src_sys_cd='axis')AA\nINNER JOIN cdp_dwh.dim_broker_t BRKR   \nON AA.entity_rut_num=BRKR.broker_id\nAND BRKR.src_sys_cd='axis'\n) BROKER\nON BROKER.sseguro = REINSURANCE_MASTER.sseguro\n\n--DIM POLICY HOLDER\nLEFT JOIN(\nSELECT DISTINCT POL_HOLD.dim_policyholder_key,AA.sseguro  from \n(SELECT cast(cast(TOMA.SPERSON as integer)||'-'||cast(nvl(TOMA.CDOMICI,0) as integer) as varchar(35)) AS TOMA_HLD_ID, SEG.sseguro FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\nINNER JOIN cdp_dwh.dim_policy_t POLICY\nON CAST(TRUNC(SEG.npoliza) AS VARCHAR(35))=POLICY.policy_num --casting changed to trunc\nAND POLICY.src_sys_cd='axis'\nINNER JOIN cdp_ods.sisaxis_tomadores TOMA\nON POLICY.policy_id=CAST(TOMA.sseguro AS INTEGER))AA\nINNER JOIN cdp_dwh.dim_policyholder_t POL_HOLD\nON AA.TOMA_HLD_ID=POL_HOLD.policyholder_id\nAND POL_HOLD.src_sys_cd='axis'\n)POL_HOLD  \nON REINSURANCE_MASTER.sseguro=POL_HOLD.sseguro\n\n--DIM INSURED\nleft join (SELECT DISTINCT dins.dim_insured_key,AA.sseguro, dins.region_cd,dins.insured_rut_num from \n(select \n    sseguro, \n    sperson,\n    coalesce(CAST(cdomici AS INTEGER),0) as cdomici,\n    row_number() over( partition by sseguro order by nmovima,nriesgo desc,norden desc ) rowindex\n  from \n    cdp_ods.sisaxis_asegurados tase \n  where \n    ffecfin is null \n)AA\n\nleft outer join cdp_dwh.dim_insured_t dins\n      on AA.sperson = dins.insured_id\n      and AA.cdomici = dins.address_id\n      and dins.src_sys_cd = 'axis'\n) INSURED\nON INSURED.sseguro=REINSURANCE_MASTER.sseguro\nand INSURED.insured_rut_num=REINSURANCE_MASTER.rut_asegurado\n\n--DIM LOB \nLEFT JOIN (\nSELECT DISTINCT dim_lob_key,lob_cd,lob_desc, src_sys_cd  \nfrom cdp_dwh.dim_lob_t) LOB \nON CAST(CAST (REINSURANCE_MASTER.CRAMO  AS INTEGER) AS VARCHAR(10)) =LOB.lob_cd  --CRAMO TO BE ADDED IN 'A' \nAND LOB.src_sys_cd='axis'\n\n--DIM BRANCH OFFICE (FETCH DIM_REGION_KEY ALSO, WHEN MASTER'SREGION_CD IS NULL)\nLEFT JOIN (\nSELECT DISTINCT dim_branch_office_key,branch_office_cd, branch_office_name, dim_region_key, src_sys_cd \nfrom cdp_dwh.dim_branch_office_t) BRANCH_OFFICE\nON LTRIM(RIGHT(REINSURANCE_MASTER.cagente,3),0)=LTRIM(BRANCH_OFFICE.branch_office_cd,0)  /*LTRIM has been handled to remove leading zero from both join condition to get a exact match*/ \nAND BRANCH_OFFICE.src_sys_cd='axis' \n\n--DIM REGION1 (WHEN REGION_CD IS NOT NULL IN MASTER)\nLEFT JOIN cdp_dwh.dim_region_t REGION1\nON REINSURANCE_MASTER.region = REGION1.region_cd\n\n--DIM REGION 2 (WHEN REGION_CD IS NULL- FOR FETCHING ZONA SISMICA)\nLEFT JOIN cdp_dwh.dim_region_t REGION2\nON BRANCH_OFFICE.dim_region_key = REGION2.dim_region_key\n\n) SRC\nLEFT JOIN \n(SELECT 1 AS DUMMY, MAX(FACT_PROFILES_REINSURANCE_KEY) AS MAX_SID FROM CDP_DWH.FACT_PROFILES_REINSURANCE_T ) LKP_MAX_KEY\nON SRC.DUMMY = LKP_MAX_KEY.DUMMY"
    }
]