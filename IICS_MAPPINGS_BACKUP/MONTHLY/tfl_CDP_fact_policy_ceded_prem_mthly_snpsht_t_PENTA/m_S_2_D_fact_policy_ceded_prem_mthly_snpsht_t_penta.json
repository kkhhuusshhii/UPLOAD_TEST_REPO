[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select src.src_sys_cd,\nsrc.contract_num,\ncase \nwhen src.curr_cd=1  then 'USD'\nwhen src.curr_cd=2  then 'UD' \nwhen src.curr_cd=3  then 'CLF'\nwhen src.curr_cd=4  then 'CLP'\nwhen src.curr_cd=5  then 'UDA'\nwhen src.curr_cd=7  then 'EUR' end curr_cd,\nsrc.company_cd,\nsrc.lob_cd,\nto_date(src.accountability_dt,'YYYYMMDD') as accountability_dt,\n'Y' as actv_rec_ind,\ncast(src.dim_insured_key as integer),\ncast(src.dim_policyholder_key as integer),\ncast(src.dim_policy_key as integer),\ncast(src.dim_prd_pln_hrchy_key as integer),\ncast(src.dim_branch_office_key as integer),\ncast(src.dim_lob_key as integer),\ncast(src.dim_broker_key as integer),\nsrc.policy_num,\nsrc.policy_eff_dt,\nsrc.policy_exp_dt,\nsrc.policy_status_cd,\nsrc.policy_item_num,\nsrc.policy_item_id,\nsrc.accountability_yr,\nsrc.accountability_mth,\nSUM(src.cwp_amt) as cwp_amt,\nsrc.reinsurance_discount,\nLKP.max_sid\nfrom\n(select distinct \n'penta' as src_sys_cd,\nNULL as contract_num,\ntrunc(cast(src.CODIGO_MONEDA as varchar)) as curr_cd,\nNULL as company_cd,\ntrunc(cast(src.CODIGO_RAMO as varchar)) as lob_cd,\nconcat (src.MES_CONTABLE ,'01') as accountability_dt,\nNVL(i.dim_insured_key,0) as dim_insured_key,\nNVL(h.dim_policyholder_key,0) as dim_policyholder_key,\nNVL(po.dim_policy_key,0) as dim_policy_key,\nNVL(PLN.dim_prd_pln_hrchy_key,0) as dim_prd_pln_hrchy_key,\nNVL(bo.dim_branch_office_key,0) as dim_branch_office_key,\nNVL(l.dim_lob_key,0) as dim_lob_key,\nNVL(dim_broker.dim_broker_key,0) as dim_broker_key,\ntrunc(cast(src.POLIZA as varchar)) as policy_num,\nto_date(src.INICIO_VIGENCIA,'DD-MM-YYYY') as policy_eff_dt,\nto_date(src.TERMINO_VIGENCIA,'DD-MM-YYYY') as policy_exp_dt,\nNULL as policy_issue_dt,\nNULL as policy_status_cd,\ntrunc(cast(src.ITEM as varchar)) policy_item_num,\ntrunc(cast(src.POLIZA as varchar))||'-'||trunc(cast(src.ITEM as varchar)) policy_item_id,\ncast(SUBSTRING(src.MES_CONTABLE,1,4) as varchar) as accountability_yr,\nCAST(SUBSTRING(src.MES_CONTABLE,5,6) AS VARCHAR(2)) as accountability_mth,\nsrc.PRIMA_CEDIDA_MO as cwp_amt,\nNULL as reinsurance_discount,\nsrc.PRIMA_CEDIDA_uf,\nsrc.prima_directa_mo,\nsrc.prima_directa_uf,\nsrc.prima_retenida_mo,\nsrc.prima_retenida_uf,\n1 as DUMMY                              \nfrom\ncdp_stg_dwh.stg_InformeVentas src\nleft outer join\ncdp_ods.bd_produ_x_pro_prodmes pr on \ntrunc(src.POLIZA) = pr.pro_int_poliza\nAND trunc(src.ITEM) = pr.pro_sma_item\n/*-----------------------------------dim_insured_key---------------------------------------------------*/\nLEFT OUTER join cdp_dwh.dim_insured_t i\non trunc(cast(src.POLIZA as varchar))||'-'||trunc(cast(src.ITEM as varchar)) =i.insured_id and i.src_sys_cd='penta'\n--cast((pr.pro_int_poliza||'-'||pr.pro_sma_item) as varchar(35)) =i.insured_id and i.src_sys_cd='penta'\n/*----------------------------------dim_policyholder_key------------------------------------------------*/\nLEFT OUTER join cdp_dwh.dim_policyholder_t h\non h.policyholder_id=pr.pro_int_poliza and h.src_sys_cd='penta'\n/*----------------------------------dim_policy_key------------------------------------------------------*/\nLEFT OUTER join cdp_dwh.dim_policy_t po \non pr.pro_int_poliza = po.policy_id and po.src_sys_cd='penta'\n/*----------------------------------dim_prd_pln_hrchy_key-----------------------------------------------*/\nleft outer join\n(SELECT pph.dim_prd_pln_hrchy_key,pr1.pro_int_poliza pro_int_poliza,pr1.pro_sma_item pro_sma_item,pph.prd_cd prd_cd \nfrom cdp_dwh.dim_prd_pln_hrchy_t pph,cdp_ods.bd_produ_x_pro_prodmes pr1 WHERE pr1.pro_sma_subramo=pph.prd_cd \nand pr1.pro_int_ProdPlan=pph.pln_cd and pr1.pro_tin_ramo=pph.lob_cd and pph.src_sys_cd='penta') PLN\nON PLN.pro_int_poliza = TRUNC(src.POLIZA)\nAND PLN.pro_sma_item = trunc(SRC.item)\nAND PLN.prd_cd = trim(src.codigo_producto)\n/*----------------------------------dim_branch_office_key-----------------------------------------------*/\nLEFT OUTER join\n(select distinct ref_cd,pro_int_poliza,pro_sma_item from (select * from\n(select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) pr1 left outer join cdp_stg_dwh.stg_tref_code_map_variant mv\non ref_type_cd='branch_office' and src_sys_cd = 'penta' and pr1.pro_tin_oficin=mv.ref_cd ) br \non br.pro_int_poliza=pr.pro_int_poliza and br.pro_sma_item=pr.pro_sma_item\nleft outer join cdp_dwh.dim_branch_office_t bo on br.ref_cd = bo.branch_office_id and bo.src_sys_cd='penta'\n/*----------------------------------dim_lob_key----------------------------------------------------------*/\nLEFT OUTER join cdp_dwh.dim_lob_t l\non pr.pro_tin_ramo = l.lob_cd and l.src_sys_cd='penta'\n/*----------------------------------dim_broker_key-------------------------------------------------------*/\nLEFT OUTER join cdp_ods.bd_produ_x_pro_poliza  p \n--on t.ite_int_poliza = p.pol_int_poliza -- Changed as per CDP 460\non pr.pro_int_poliza = p.pol_int_poliza\nLEFT OUTER join\n(SELECT brkr.dim_broker_key,brkr.pol_int_poliza as pol_int_poliza,brkr.rowindex\nfrom \n( \nSELECT broker.dim_broker_key as dim_broker_key,p.pol_int_poliza as pol_int_poliza, \nrow_number()over(partition by broker.dim_broker_key,p.pol_int_poliza  order by broker.src_sys_cd asc) as rowindex /* Added as part of CISD-4661 */\nfrom cdp_ods.bd_produ_x_pro_poliza p \ninner join cdp_ods.AgtMst_GrlAgt_Agentes a on a.Agt_Rut = p.pol_int_rutcor \nleft join cdp_dwh.dim_broker_t broker ON (a.Agt_Rut || a.Agt_DigVer) = broker.broker_rut_num\nwhere broker.src_sys_cd in ('axis','penta') /* Modified as part of CISD-4661 */\n)brkr where brkr.rowindex=1 )dim_broker\nON p.pol_int_poliza=dim_broker.pol_int_poliza\n) SRC\nLEFT JOIN (SELECT 1 as DUMMY, max(fact_policy_ceded_prem_mthly_snpsht_key) AS MAX_SID from cdp_dwh.fact_policy_ceded_prem_mthly_snpsht_t) LKP\nON LKP.DUMMY=SRC.DUMMY\nGROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,24,25"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.fact_policy_ceded_prem_mthly_snpsht_t where src_sys_cd='penta'"
    }
]