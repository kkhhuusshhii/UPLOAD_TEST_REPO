[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select \nsrc.src_sys_cd,\nsrc.policy_item_id,\nsrc.contract_num,\nsrc.curr_cd,\nsrc.company_cd,\nsrc.lob_cd,\nsrc.accountability_dt,\n'Y' as actv_rec_ind,\ncast(src.dim_insured_key as integer),\ncast(src.dim_policyholder_key as integer),\ncast(src.dim_policy_key as integer),\ncast(src.dim_prd_pln_hrchy_key as integer),\ncast(src.dim_branch_office_key as integer),\ncast(src.dim_lob_key as integer),\ncast(src.dim_broker_key as integer),\nsrc.policy_num,\nsrc.policy_eff_dt,\nsrc.policy_exp_dt,\nsrc.policy_issue_dt,\nsrc.policy_status_cd,\nsrc.policy_item_num,\nsrc.accountability_yr,\nsrc.accountability_mth,\nsrc.cwp_amt,\nsrc.reinsurance_discount,\nLKP.max_sid\nfrom\n(select \n'axis' as src_sys_cd,\ncast(src.PRD_NRO_SOL as varchar) as policy_item_id,  \ncast(src.PRD_NRO_CON as varchar) as contract_num,\ncast(SEG.CMONSEG as varchar) as curr_cd,\ncast(src.PRD_COD_CIA as varchar) as company_cd,\ncast(src.PRD_RAM_CON as varchar) as lob_cd,\nto_date(prd_fec_con,'yyyymmdd') as accountability_dt,\nNVL(INSURED.dim_insured_key,0) as dim_insured_key, \nNVL(POL_HOLD.dim_policyholder_key,0) as dim_policyholder_key, \nNVL(DIM_POLICY_T.dim_policy_key,0) as dim_policy_key, \nNVL(PLAN_HIRE.dim_prd_pln_hrchy_key,0) as dim_prd_pln_hrchy_key, \nNVL(BRANCH_OFFICE.dim_branch_office_key,0) as dim_branch_office_key, \nNVL(LOB.dim_lob_key,0) as dim_lob_key, \nNVL(BRKR_KEY.dim_broker_key,0) as dim_broker_key, \ncast(src.PRD_NRO_POL as varchar) as policy_num,\ncast(SEG.FEFECTO as date) as policy_eff_dt,\ncast(SEG.FVENCIM as date) as policy_exp_dt,\ncast(SEG.FEMISIO as date) as policy_issue_dt,\ncast(SEG.CSITUAC as varchar) as policy_status_cd,\ncast(SEG.NCERTIF as varchar) policy_item_num,\ncast(cal.yr_num as varchar) as accountability_yr,\nCAST(RIGHT(0 || cal.mth_num, 2) AS VARCHAR(2)) as accountability_mth,\nsum(src.PRD_MTO_PRI_CED_DIR) as cwp_amt,\nsum(src.PRD_MTO_DES_RES_DIR) as reinsurance_discount,\n--src.prd_tip_con as prd_tip_con,\n1 as DUMMY                              \nfrom cdp_ods.sisfin11_ifa_reaseguro src inner join\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0 ) SEG\n on src.PRD_NRO_SOL = SEG.sseguro\n \n/*-------------------------------------------------dim_insured_key--------------------------------------------------*/\nLEFT JOIN\n(SELECT A.sseguro,INSURED.dim_insured_key  FROM -- A.nmovimi,\n(select tmp2.sseguro,tmp2.sperson,tmp2.cdomici --tmp2.nmovimi,\n from \n  (select tmp1.sseguro,tmp1.nriesgo,tase.nmovima,tase.sperson,tase.cdomici,tmp1.nmovimi,\n          row_number() over(partition by tmp1.sseguro,tmp1.nriesgo order by tase.norden desc) as row_ind --,tmp1.nmovimi\n   from \n        (select tmov.sseguro,tmov.nmovimi,trie.nriesgo,trie.sperson,trie.cdomici, \n         row_number() over(partition by tmov.sseguro order by trie.nmovima desc) as row_ind --,tmov.nmovimi\n         from \n                (select distinct sseguro from cdp_ods.sisaxis_seguros where ncertif > 0 ) tseg \n                inner join cdp_ods.sisaxis_movseguro tmov \n                on tseg.sseguro = tmov.sseguro \n                inner join cdp_ods.sisaxis_riesgos trie --\n                on tmov.sseguro = trie.sseguro \n                and tmov.nmovimi >= trie.nmovima\n        )tmp1 \n   inner join cdp_ods.sisaxis_asegurados tase \n   on tmp1.sseguro = tase.sseguro \n   and tmp1.nriesgo = tase.nriesgo \n   and tmp1.nmovimi >= tase.nmovima\n   and (tmp1.nmovimi < tase.nmovimb or tase.nmovimb is null)\n   where tmp1.row_ind = 1 ) tmp2\n where tmp2.row_ind = 1\n group by tmp2.sseguro,tmp2.sperson,tmp2.cdomici -- tmp2.nmovimi,\n order by tmp2.sseguro,tmp2.sperson,tmp2.cdomici) A -- tmp2.nmovimi,\nINNER JOIN cdp_dwh.dim_insured_t INSURED  \nON INSURED.insured_id=CAST(A.sperson AS INTEGER)\nAND INSURED.address_id=CAST(nvl(CAST(A.cdomici AS INTEGER),0) AS INTEGER) \nAND INSURED.src_sys_cd='axis')INSURED\nON INSURED.sseguro=SEG.sseguro\n--AND INSURED.nmovimi=MOVE_SEG.nmovimi\n\n/*---------dim_policyholder_key----------------------------------*/\nLEFT JOIN(\nSELECT DISTINCT POL_HOLD.dim_policyholder_key,AA.sseguro  from \n(SELECT cast(cast(TOMA.SPERSON as integer)||'-'||cast(nvl(TOMA.CDOMICI,0) as integer) as varchar(35)) AS TOMA_HLD_ID, SEG.sseguro FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n INNER JOIN cdp_dwh.dim_policy_t POLICY\n ON CAST(trunc(SEG.npoliza ) AS VARCHAR(35))=POLICY.policy_num\n AND POLICY.src_sys_cd='axis'\n INNER JOIN cdp_ods.sisaxis_tomadores TOMA\n ON POLICY.policy_id=CAST(TOMA.sseguro AS INTEGER))AA\n INNER JOIN cdp_dwh.dim_policyholder_t POL_HOLD\n ON AA.TOMA_HLD_ID=POL_HOLD.policyholder_id\n AND POL_HOLD.src_sys_cd='axis'\n)POL_HOLD  \nON SEG.sseguro=POL_HOLD.sseguro\n/*---------------------------------------------------------dim_policy_key--------------------------------------------------------------*/\n/*LEFT JOIN cdp_dwh.dim_policy_t POLICY\nON CAST(CAST(SEG.npoliza AS INTEGER) AS VARCHAR(35))=POLICY.policy_num\nand SEG.sseguro = POLICY.policy_id and SEG.ncertif > 0\nAND POLICY.src_sys_cd='axis'*/ \n\nLEFT JOIN \n(select dim_policy_key,policy_num,row_number() over(partition by policy_num order by dim_policy_key desc) as row_ind \nfrom cdp_dwh.dim_policy_t POLICY\nWHERE POLICY.src_sys_cd='axis' ) DIM_POLICY_T \nON  CAST(trunc(SEG.npoliza ) AS VARCHAR(35))=DIM_POLICY_T.policy_num \nAND DIM_POLICY_T.row_ind = 1 --modified as part of CISD-6172\n\n/*--------------------------------------------------------------------dim_prd_pln_hrchy_key----------------------------------------------------------------*/\nLEFT JOIN(SELECT PLAN_HIRE.dim_prd_pln_hrchy_key,SEG.sseguro FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n INNER JOIN cdp_dwh.dim_prd_pln_hrchy_t PLAN_HIRE\n ON PLAN_HIRE.prd_cd=CAST(CAST(SEG.sproduc AS INTEGER) AS VARCHAR(10))\n AND PLAN_HIRE.lob_cd=CAST(CAST(SEG.cramo AS INTEGER) AS VARCHAR(10))\n AND PLAN_HIRE.pln_cd=CAST(CAST(SEG.cactivi AS INTEGER) AS VARCHAR(10))\n AND PLAN_HIRE.src_sys_cd='axis'\n)PLAN_HIRE\nON PLAN_HIRE.sseguro=SEG.sseguro\n/*-----------------------------------------------------------------------dim_branch_office_key-------------------------------------------------------------------------------*/\nLEFT JOIN cdp_dwh.dim_branch_office_t BRANCH_OFFICE\nON LTRIM(RIGHT(SEG.cagente,3),0)=LTRIM(BRANCH_OFFICE.branch_office_cd,0)  /*LTRIM has been handled to remove leading zero from both join condition to get a exact match*/ \nAND BRANCH_OFFICE.src_sys_cd='axis'\n/*----------------------------------------------------------------------------------dim_lob_key--------------------------------------------------------------------------------------------------------------------*/\nLEFT JOIN cdp_dwh.dim_lob_t LOB \nON CAST(CAST(SEG.CRAMO  AS INTEGER) AS VARCHAR(10)) =LOB.lob_cd  \nAND LOB.src_sys_cd='axis'\n\n\n\n/*--------------------------------------------------------------------------------dim_broker_key-----------------------------------------------------------------------------------------*/\nLEFT JOIN \n(SELECT DISTINCT BRKR.dim_broker_key,AA.sseguro FROM\n(SELECT DISTINCT BRKR_RLSHP.entity_rut_num,SEG.sseguro\nFROM (select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\n\nINNER JOIN cdp_dwh.broker_branch_rlshp_t BRKR_RLSHP\nON SEG.cagente=BRKR_RLSHP.rlshp_src_id\nAND BRKR_RLSHP.entity_type_cd=4\nAND BRKR_RLSHP.src_sys_cd='axis')AA\nINNER JOIN cdp_dwh.dim_broker_t BRKR   \nON AA.entity_rut_num=BRKR.broker_id\nAND BRKR.src_sys_cd='axis'\n) BRKR_KEY\nON BRKR_KEY.sseguro=SEG.sseguro\n/*---------------------------------------------------------------------accountability year and month---------------------------------------------------------------------*/\nleft join\ncdp_dwh.dim_cal_t cal\non to_char(cal_dt,'YYYYMMDD') = to_char(to_date(prd_fec_con,'yyyymmdd'),'yyyyMMDD')\nGROUP BY 2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22\n) SRC\nLEFT JOIN (SELECT 1 as DUMMY, max(fact_policy_ceded_prem_mthly_snpsht_key) AS MAX_SID from cdp_dwh.fact_policy_ceded_prem_mthly_snpsht_t) LKP\nON LKP.DUMMY=SRC.DUMMY;"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.fact_policy_ceded_prem_mthly_snpsht_t where src_sys_cd='axis'"
    }
]