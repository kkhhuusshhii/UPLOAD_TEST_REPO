[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "--Updated query with rolled back transporte changes & next prev improvement of item_type\nWITH CMI_PROPUESTA_1\nAS (\n\tSELECT PROP.SCICLO\n\t\t,PROP.CRAMO\n\t\t,PROP.CTIPDOC\n\t\t,PROP.NPOLIZA\n\t\t,PROP.NPOLIZAANT\n\t\t,PROP.CRENOVA\n\t\t,PROP.CORIGEN\n\t\t,PROP.CRENOVPE\n\tFROM CDP_ODS.SISAXIS_CMI_PROPUESTA PROP\n\t\t,CDP_ODS.SISAXIS_CMI_MOVPROPUESTA MOV\n\tWHERE PROP.CSISTEMA = '1'\n\t\tAND MOV.CSISTEMA = '15'\n\t\tAND PROP.SCICLO = MOV.SCICLO\n\t\tAND MOV.NMOVIMI = 1\n\t\tAND TO_CHAR(MOV.FEFECTO, 'YYYY') >= 2011\n\t)\n\t,CMI_MOVPROPUESTA_15\nAS (\n\tSELECT SCICLO\n\t\t,NMOVIMI\n\t\t,SNMOVIMI\n\t\t,CESTADO\n\t\t,FEFECTO\n\t\t,CUSUASIG\n\t\t,CUSUMOD\n\t\t,FTERMINO\n\t\t,CTIPO\n\t\t,ROL_EJEC\n\t\t,FINICIO_REAL\n\tFROM CDP_ODS.SISAXIS_CMI_MOVPROPUESTA\n\tWHERE CSISTEMA = '15'\n\t\tAND TO_CHAR(FEFECTO, 'YYYY') >= 2011\n\t)\n\t,DET\nAS (\n\tSELECT NRO_LINEA\n\t\t,ID_PROCESO\n\t\t,ESTADO\n\t\t,DESC_ESTADO\n\t\t,SEC_CAR_MAS\n\t\t,COD_EMPRESA\n\t\t,COD_FORMATO\n\t\t,SSEGURO\n\t\t,COD_PRODUC\n\t\t,NUM_CONVEN\n\t\t,NUM_POLIZA\n\t\t,RUT_CONTRA\n\t\t,RUT_ASE\n\t\t,NU_RECIBO\n\t\t,COD_AGENTE\n\t\t,NU_PROPUESTA\n\t\t,NUM_CICLO\n\t\t,NUM_POLIZA_ANT\n\t\t,NUM_COTIZACION\n\t\t,NUM_MASIVO\n\t\t,FEC_CREA\n\t\t,PRIMA_PROPUESTA\n\t\t,CI_FONO_1\n\t\t,CI_FONO_2\n\tFROM CDP_ODS.SISADMCOM_SISREC_DETCARMAS\n\t)\n\t,PROD\nAS (\n\tSELECT p.cramo\n\t\t,p.sproduc\n\t\t,t.ttitulo\n\t\t,p.cobjase\n\tFROM CDP_ODS.sisaxis_productos p\n\t\t,CDP_ODS.sisaxis_titulopro t\n\tWHERE p.ccolect = t.ccolect\n\t\tAND p.cramo = t.cramo\n\t\tAND p.cmodali = t.cmodali\n\t\tAND p.ctipseg = t.ctipseg\n\t)\n\t,DOC\nAS (\n\tSELECT a.sseguro\n\t\t,a.nmovimis\n\t\t,MAX(a.sciclo) AS sciclo\n\tFROM (\n\t\tSELECT s.csistema\n\t\t\t,s.sciclo\n\t\t\t,nmovimi\n\t\t\t,fefecto\n\t\t\t,snmovimd\n\t\t\t,ftermino\n\t\t\t,cusuasig\n\t\t\t,tipo_endoso\n\t\t\t,ncertif\n\t\t\t,sseguro\n\t\t\t,nmovimis\n\t\t\t,cramo\n\t\t\t,s.npoliza\n\t\t\t,s.csituac\n\t\tFROM (\n\t\t\tSELECT m.csistema\n\t\t\t\t,m.sciclo\n\t\t\t\t,m.nmovimi\n\t\t\t\t,m.fefecto\n\t\t\t\t,snmovimi AS snmovimd\n\t\t\t\t,m.ftermino\n\t\t\t\t,m.cusuasig\n\t\t\t\t,DECODE(m.nmovimir, 1, 'Endoso Inclusion', 'Endoso Otros') tipo_endoso\n\t\t\t\t,s.ncertif\n\t\t\t\t,m.sseguro\n\t\t\t\t,m.nmovimir AS nmovimis\n\t\t\t\t,s.cramo\n\t\t\t\t,s.npoliza\n\t\t\t\t,s.csituac\n\t\t\tFROM cdp_ods.sisaxis_cmi_movpropuesta AS m\n\t\t\tINNER JOIN cdp_ods.sisaxis_seguros s ON m.sseguro = s.sseguro\n\t\t\tWHERE m.ctipo = 'D'\n\t\t\t\tAND m.cestado = 'DIGITADA'\n\t\t\t) s\n\t\tINNER JOIN (\n\t\t\tSELECT p.sciclo\n\t\t\t\t,p.csistema\n\t\t\tFROM cdp_ods.sisaxis_cmi_propuesta p\n\t\t\t\t,cdp_ods.sisaxis_cmi_movpropuesta m1\n\t\t\tWHERE p.csistema = '1'\n\t\t\t\tAND p.sciclo > 300000\n\t\t\t\tAND p.csistema = m1.csistema\n\t\t\t\tAND p.sciclo = m1.sciclo\n\t\t\t\tAND m1.cestado = 'RECEPCIO'\n\t\t\t\tAND m1.ctipo = 'E'\n\t\t\t\tAND m1.fefecto >= to_date('01012011', 'ddmmyyyy')\n\t\t\t) b ON s.sciclo = b.sciclo\n\t\t\tAND s.csistema = b.csistema\n\t\t) a\n\tGROUP BY a.sseguro\n\t\t,a.nmovimis\n\t)\n\t,ITEM_RENO_NOFLOTA\nAS (\n\tSELECT sseguro\n\t\t,id_item2\n\t\t,CASE \n\t\t\tWHEN isnull(id_item2, 0) > 0\n\t\t\t\tTHEN 'SI'\n\t\t\tELSE 'NO'\n\t\t\tEND AS ITEM_RENOVACION\n\tFROM (\n\t\t-- START    1st  TEMP TABLE ITEM_RENOVACION_VHNOFLOTA (LOAD * Resident ITEM_VHNF)\n\t\tSELECT seg.SSEGURO\n\t\t\t,seg.CRAMO\n\t\t\t,seg.NPOLIZA\n\t\t\t,seg.NCERTIF\n\t\t\t,seg.FEFECTO\n\t\t\t,DECODE(seg.CDURACI, 3, seg.FVENCIM, 0, seg.FCARPRO) FVENCIM\n\t\t\t,seg.CSITUAC\n\t\t\t,x.NNUMNIF AS RUT_ASEG\n\t\t\t,y.Patente_norm\n\t\t\t,w.Count_Items\n\t\t\t,w.Flota\n\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG\n\t\tLEFT JOIN (\n\t\t\tSELECT a.SSEGURO\n\t\t\t\t,a.SPERSON\n\t\t\t\t,b.NNUMNIF\n\t\t\t\t,a.NRIESGO\n\t\t\t\t,a.NMOVIMA\n\t\t\t\t,a.NMOVIMB\n\t\t\t\t,a.FFECFIN\n\t\t\t\t,a.NORDEN\n\t\t\t\t,a.CDOMICI\n\t\t\tFROM cdp_ods.SISAXIS_ASEGURADOS a\n\t\t\tLEFT JOIN cdp_ods.SISAXIS_PERSONAS b ON (a.SPERSON = b.SPERSON)\n\t\t\tWHERE a.FFECFIN IS NULL\n\t\t\t) x ON (seg.SSEGURO = x.SSEGURO)\n\t\tLEFT JOIN (\n\t\t\tSELECT n.SSEGURO AS Id_item\n\t\t\t\t,n.NMOVIMI AS Numero_movimiento\n\t\t\t\t,n.CMATRIC AS Patente\n\t\t\t\t,n.CVERSION AS Id_version\n\t\t\t\t,n.NRIESGO AS Numero_riesgo\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN len(replace(CMATRIC, '-.', '')) <> 6\n\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 1, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 2, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 5, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 6, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\tOR (\n\t\t\t\t\t\t\tREGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 3, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\tAND REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 4, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tOR (\n\t\t\t\t\t\t\tREGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 3, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\tAND REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 4, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tOR replace(Replace(Replace(CMATRIC, '-', ''), '.', ''), ' ', '') IN (\n\t\t\t\t\t\t\t'XXXX00'\n\t\t\t\t\t\t\t,'XX0000'\n\t\t\t\t\t\t\t,'XXXX01'\n\t\t\t\t\t\t\t,'XX0001'\n\t\t\t\t\t\t\t,'XXXX11'\n\t\t\t\t\t\t\t,'AA0000'\n\t\t\t\t\t\t\t,'SP4444'\n\t\t\t\t\t\t\t,'ET1111'\n\t\t\t\t\t\t\t,'SP0000'\n\t\t\t\t\t\t\t,'XX1111'\n\t\t\t\t\t\t\t,'AAAA00'\n\t\t\t\t\t\t\t,'MY0000'\n\t\t\t\t\t\t\t,'XXXX12'\n\t\t\t\t\t\t\t,'XXXX10'\n\t\t\t\t\t\t\t,'ET0001'\n\t\t\t\t\t\t\t,'EETT00'\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\tTHEN ''\n\t\t\t\t\tELSE replace(CMATRIC, '-. ', '')\n\t\t\t\t\tEND AS Patente_norm\n\t\t\tFROM cdp_ods.SISAXIS_AUTRIESGOS n\n\t\t\t) y ON (y.Id_item = seg.SSEGURO)\n\t\tLEFT JOIN (\n\t\t\t-- Begin Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\t\tSELECT k.NPOLIZA\n\t\t\t\t,Count(k.SSEGURO) AS Count_Items\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN Count(k.SSEGURO) >= 10\n\t\t\t\t\t\tTHEN 'Si'\n\t\t\t\t\tELSE 'No'\n\t\t\t\t\tEND AS Flota\n\t\t\tFROM (\n\t\t\t\tSELECT seg2.SSEGURO\n\t\t\t\t\t,seg2.CRAMO\n\t\t\t\t\t,seg2.CAGENTE\n\t\t\t\t\t,seg2.NPOLIZA\n\t\t\t\t\t,seg2.NCERTIF\n\t\t\t\t\t,seg2.FEFECTO\n\t\t\t\t\t,seg2.COBJASE\n\t\t\t\t\t,seg2.CTIPCOA\n\t\t\t\t\t,substr(seg2.CAGENTE, - 3, 8) CSUCURSAL\n\t\t\t\t\t,seg2.CTIPCOM\n\t\t\t\t\t,DECODE(seg2.CDURACI, 3, seg2.FVENCIM, 0, seg2.FCARPRO) FVENCIM\n\t\t\t\t\t,seg2.FANULAC\n\t\t\t\t\t,DECODE(seg2.CSITUAC, 0, 'Vigente', 2, 'Anulado/Cancelado', 5, 'Endoso Pendiente', 'Otro') SITUAC\n\t\t\t\t\t,seg2.SCIACOA\n\t\t\t\t\t,seg2.PPARCOA\n\t\t\t\t\t,seg2.SPRODUC\n\t\t\t\t\t,seg2.CMONSEG\n\t\t\t\t\t,seg2.FCAMBIO\n\t\t\t\t\t,seg2.CLINNEG\n\t\t\t\t\t,seg2.CAGRSEG\n\t\t\t\t\t,seg2.CRFAAGE SCICLO\n\t\t\t\t\t,seg2.CFLOTA\n\t\t\t\t\t,seg2.CSITUAC\n\t\t\t\t\t,seg2.NPROPM\n\t\t\t\t\t,DECODE(cast(SUBSTR(seg2.CAGENTE, 1, 5) AS INTEGER), 7527, 'Retail', 8204, 'Retail', 7723, 'Retail', 3376, 'Retail', 3424, 'Retail', DECODE(CONV.CFLOTA, 1, DECODE(cast(SUBSTR(seg2.CAGENTE, - 3, 8) AS INTEGER), 24, 'Banca', 25, 'Banca', 'Flota'), 'Individual')) CANAL\n\t\t\t\t\t,\n\t\t\t\t\t--sisaxis.f_clasificacion_fecu(seg2.sseguro) clasificacion_fecu ,\n\t\t\t\t\tseg2.CMODALI\n\t\t\t\t\t,seg2.CTIPSEG\n\t\t\t\t\t,seg2.CCOLECT\n\t\t\t\t\t,seg2.CACTIVI\n\t\t\t\t\t,seg2.CRESERVA\n\t\t\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG2\n\t\t\t\t\t,cdp_ods.SISAXIS_CTR_DESAGRUPASEG CONV\n\t\t\t\tWHERE seg2.cagrseg = conv.cagrseg(+)\n\t\t\t\t\tAND ncertif > 0\n\t\t\t\t) k\n\t\t\tWHERE k.NCERTIF > 0\n\t\t\tGROUP BY k.NPOLIZA\n\t\t\t) w ON (w.NPOLIZA = seg.NPOLIZA)\n\t\t-- End Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\tWHERE --seg.SSEGURO IN (900327438,900250970,900327424,900372586,900327400,900334130,900331236,900332401,900373592,900367654,900331218,900332365)\n\t\t\t--and \n\t\t\tncertif > 0\n\t\t\tAND CRAMO = 6\n\t\t\tAND w.Flota = 'No'\n\t\t) ST1\n\t-- END      1st  TEMP TABLE ITEM_RENOVACION_VHNOFLOTA (LOAD * Resident ITEM_VHNF)\n\t-- START  2nd TEMP TABLE ITEM_RENOVACION_VHNOFLOTA (LOAD * Resident ITEM_VHNF Where Id.Situacion= 0)\n\tLEFT JOIN (\n\t\tSELECT ST2.SSEGURO AS ID_ITEM2\n\t\t\t,ST2.NPOLIZA AS NPOLIZA2\n\t\t\t,ST2.NCERTIF AS NCERTIF2\n\t\t\t,ST2.Patente_norm AS Patente_norm2\n\t\t\t,ST2.RUT_ASEG AS RUT_ASEG2\n\t\t\t,ST2.FVENCIM AS INI_VIGENCIA2\n\t\tFROM (\n\t\t\tSELECT seg.SSEGURO\n\t\t\t\t,seg.CRAMO\n\t\t\t\t,seg.NPOLIZA\n\t\t\t\t,seg.NCERTIF\n\t\t\t\t,seg.FEFECTO\n\t\t\t\t,DECODE(seg.CDURACI, 3, seg.FVENCIM, 0, seg.FCARPRO) FVENCIM\n\t\t\t\t,seg.CSITUAC\n\t\t\t\t,x.NNUMNIF AS RUT_ASEG\n\t\t\t\t,y.Patente_norm\n\t\t\t\t,w.Count_Items\n\t\t\t\t,w.Flota\n\t\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT a.SSEGURO\n\t\t\t\t\t,a.SPERSON\n\t\t\t\t\t,b.NNUMNIF\n\t\t\t\t\t,a.NRIESGO\n\t\t\t\t\t,a.NMOVIMA\n\t\t\t\t\t,a.NMOVIMB\n\t\t\t\t\t,a.FFECFIN\n\t\t\t\t\t,a.NORDEN\n\t\t\t\t\t,a.CDOMICI\n\t\t\t\tFROM cdp_ods.SISAXIS_ASEGURADOS a\n\t\t\t\tLEFT JOIN cdp_ods.SISAXIS_PERSONAS b ON (a.SPERSON = b.SPERSON)\n\t\t\t\tWHERE a.FFECFIN IS NULL\n\t\t\t\t) x ON (seg.SSEGURO = x.SSEGURO)\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT n.SSEGURO AS Id_item\n\t\t\t\t\t,n.NMOVIMI AS Numero_movimiento\n\t\t\t\t\t,n.CMATRIC AS Patente\n\t\t\t\t\t,n.CVERSION AS Id_version\n\t\t\t\t\t,n.NRIESGO AS Numero_riesgo\n\t\t\t\t\t,CASE \n\t\t\t\t\t\tWHEN len(replace(CMATRIC, '-.', '')) <> 6\n\t\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 1, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 2, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 5, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\tOR REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 6, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\tOR (\n\t\t\t\t\t\t\t\tREGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 3, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\t\tAND REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 4, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tOR (\n\t\t\t\t\t\t\t\tREGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 3, 1), '^[0-9]+$') > 0\n\t\t\t\t\t\t\t\tAND REGEXP_COUNT(substring(replace(CMATRIC, '-.', ''), 4, 1), '^[0-9]+$') = 0\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tOR replace(Replace(Replace(CMATRIC, '-', ''), '.', ''), ' ', '') IN (\n\t\t\t\t\t\t\t\t'XXXX00'\n\t\t\t\t\t\t\t\t,'XX0000'\n\t\t\t\t\t\t\t\t,'XXXX01'\n\t\t\t\t\t\t\t\t,'XX0001'\n\t\t\t\t\t\t\t\t,'XXXX11'\n\t\t\t\t\t\t\t\t,'AA0000'\n\t\t\t\t\t\t\t\t,'SP4444'\n\t\t\t\t\t\t\t\t,'ET1111'\n\t\t\t\t\t\t\t\t,'SP0000'\n\t\t\t\t\t\t\t\t,'XX1111'\n\t\t\t\t\t\t\t\t,'AAAA00'\n\t\t\t\t\t\t\t\t,'MY0000'\n\t\t\t\t\t\t\t\t,'XXXX12'\n\t\t\t\t\t\t\t\t,'XXXX10'\n\t\t\t\t\t\t\t\t,'ET0001'\n\t\t\t\t\t\t\t\t,'EETT00'\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tTHEN ''\n\t\t\t\t\t\tELSE replace(CMATRIC, '-. ', '')\n\t\t\t\t\t\tEND AS Patente_norm\n\t\t\t\tFROM cdp_ods.SISAXIS_AUTRIESGOS n\n\t\t\t\t) y ON (y.Id_item = seg.SSEGURO)\n\t\t\tLEFT JOIN (\n\t\t\t\t-- Begin Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\t\t\tSELECT k.NPOLIZA\n\t\t\t\t\t,Count(k.SSEGURO) AS Count_Items\n\t\t\t\t\t,CASE \n\t\t\t\t\t\tWHEN Count(k.SSEGURO) >= 10\n\t\t\t\t\t\t\tTHEN 'Si'\n\t\t\t\t\t\tELSE 'No'\n\t\t\t\t\t\tEND AS Flota\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT seg2.SSEGURO\n\t\t\t\t\t\t,seg2.CRAMO\n\t\t\t\t\t\t,seg2.CAGENTE\n\t\t\t\t\t\t,seg2.NPOLIZA\n\t\t\t\t\t\t,seg2.NCERTIF\n\t\t\t\t\t\t,seg2.FEFECTO\n\t\t\t\t\t\t,seg2.COBJASE\n\t\t\t\t\t\t,seg2.CTIPCOA\n\t\t\t\t\t\t,substr(seg2.CAGENTE, - 3, 8) CSUCURSAL\n\t\t\t\t\t\t,seg2.CTIPCOM\n\t\t\t\t\t\t,DECODE(seg2.CDURACI, 3, seg2.FVENCIM, 0, seg2.FCARPRO) FVENCIM\n\t\t\t\t\t\t,seg2.FANULAC\n\t\t\t\t\t\t,DECODE(seg2.CSITUAC, 0, 'Vigente', 2, 'Anulado/Cancelado', 5, 'Endoso Pendiente', 'Otro') SITUAC\n\t\t\t\t\t\t,seg2.SCIACOA\n\t\t\t\t\t\t,seg2.PPARCOA\n\t\t\t\t\t\t,seg2.SPRODUC\n\t\t\t\t\t\t,seg2.CMONSEG\n\t\t\t\t\t\t,seg2.FCAMBIO\n\t\t\t\t\t\t,seg2.CLINNEG\n\t\t\t\t\t\t,seg2.CAGRSEG\n\t\t\t\t\t\t,seg2.CRFAAGE SCICLO\n\t\t\t\t\t\t,seg2.CFLOTA\n\t\t\t\t\t\t,seg2.CSITUAC\n\t\t\t\t\t\t,seg2.NPROPM\n\t\t\t\t\t\t,DECODE(cast(SUBSTR(seg2.CAGENTE, 1, 5) AS INTEGER), 7527, 'Retail', 8204, 'Retail', 7723, 'Retail', 3376, 'Retail', 3424, 'Retail', DECODE(CONV.CFLOTA, 1, DECODE(cast(SUBSTR(seg2.CAGENTE, - 3, 8) AS INTEGER), 24, 'Banca', 25, 'Banca', 'Flota'), 'Individual')) CANAL\n\t\t\t\t\t\t,\n\t\t\t\t\t\t--sisaxis.f_clasificacion_fecu(seg2.sseguro) clasificacion_fecu ,\n\t\t\t\t\t\tseg2.CMODALI\n\t\t\t\t\t\t,seg2.CTIPSEG\n\t\t\t\t\t\t,seg2.CCOLECT\n\t\t\t\t\t\t,seg2.CACTIVI\n\t\t\t\t\t\t,seg2.CRESERVA\n\t\t\t\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG2\n\t\t\t\t\t\t,cdp_ods.SISAXIS_CTR_DESAGRUPASEG CONV\n\t\t\t\t\tWHERE seg2.cagrseg = conv.cagrseg(+)\n\t\t\t\t\t\tAND ncertif > 0\n\t\t\t\t\t) k\n\t\t\t\tWHERE k.NCERTIF > 0\n\t\t\t\tGROUP BY k.NPOLIZA\n\t\t\t\t) w ON (w.NPOLIZA = seg.NPOLIZA)\n\t\t\t-- End Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\t\tWHERE --seg.SSEGURO IN (900327438,900250970,900327424,900372586,900327400,900334130,900331236,900332401,900373592,900367654,900331218,900332365)\n\t\t\t\t--and \n\t\t\t\tseg.ncertif > 0\n\t\t\t\tAND seg.CRAMO = 6\n\t\t\t\tAND seg.CSITUAC = 0\n\t\t\t\tAND w.Flota = 'No'\n\t\t\t) ST2\n\t\t) RENO\n\t\t-- END  2nd TEMP TABLE ITEM_RENOVACION_VHNOFLOTA (LOAD * Resident ITEM_VHNF Where Id.Situacion= 0)\n\t\tON (\n\t\t\tRENO.Patente_norm2 = ST1.Patente_norm\n\t\t\tAND RENO.RUT_ASEG2 = ST1.RUT_ASEG\n\t\t\tAND RENO.INI_VIGENCIA2 = ST1.FEFECTO\n\t\t\t)\n\t)\n\t,ITEM_OTROS\nAS (\n\tSELECT seg.SSEGURO\n\t\t,seg.CRAMO\n\t\t,seg.NPOLIZA\n\t\t,seg.NCERTIF\n\t\t,seg.FEFECTO\n\t\t,DECODE(seg.CDURACI, 3, seg.FVENCIM, 0, seg.FCARPRO) FVENCIM\n\t\t,seg.CSITUAC\n\t\t,x.NNUMNIF AS Rut_Contratante\n\t\t,w.Count_Items\n\t\t,w.Flota\n\tFROM cdp_ods.SISAXIS_SEGUROS SEG\n\tLEFT JOIN (\n\t\tSELECT s.sseguro\n\t\t\t,p.NNUMNIF\n\t\tFROM cdp_ods.sisaxis_tomadores t\n\t\tINNER JOIN cdp_ods.sisaxis_seguros s ON t.sseguro = s.sseguro\n\t\t\tAND s.ncertif > 0\n\t\tLEFT JOIN cdp_ods.sisaxis_personas p ON t.sperson = p.sperson\n\t\t) x ON (seg.SSEGURO = x.SSEGURO)\n\tLEFT JOIN (\n\t\t-- Begin Query from Temp Table FLOTA in VENTA_LIBERTY\n\t\tSELECT k.NPOLIZA\n\t\t\t,Count(k.SSEGURO) AS Count_Items\n\t\t\t,CASE \n\t\t\t\tWHEN Count(k.SSEGURO) >= 10\n\t\t\t\t\tTHEN 'Si'\n\t\t\t\tELSE 'No'\n\t\t\t\tEND AS Flota\n\t\tFROM (\n\t\t\tSELECT seg2.SSEGURO\n\t\t\t\t,seg2.CRAMO\n\t\t\t\t,seg2.CAGENTE\n\t\t\t\t,seg2.NPOLIZA\n\t\t\t\t,seg2.NCERTIF\n\t\t\t\t,seg2.FEFECTO\n\t\t\t\t,seg2.COBJASE\n\t\t\t\t,seg2.CTIPCOA\n\t\t\t\t,substr(seg2.CAGENTE, - 3, 8) CSUCURSAL\n\t\t\t\t,seg2.CTIPCOM\n\t\t\t\t,DECODE(seg2.CDURACI, 3, seg2.FVENCIM, 0, seg2.FCARPRO) FVENCIM\n\t\t\t\t,seg2.FANULAC\n\t\t\t\t,DECODE(seg2.CSITUAC, 0, 'Vigente', 2, 'Anulado/Cancelado', 5, 'Endoso Pendiente', 'Otro') SITUAC\n\t\t\t\t,seg2.SCIACOA\n\t\t\t\t,seg2.PPARCOA\n\t\t\t\t,seg2.SPRODUC\n\t\t\t\t,seg2.CMONSEG\n\t\t\t\t,seg2.FCAMBIO\n\t\t\t\t,seg2.CLINNEG\n\t\t\t\t,seg2.CAGRSEG\n\t\t\t\t,seg2.CRFAAGE SCICLO\n\t\t\t\t,seg2.CFLOTA\n\t\t\t\t,seg2.CSITUAC\n\t\t\t\t,seg2.NPROPM\n\t\t\t\t,DECODE(cast(SUBSTR(seg2.CAGENTE, 1, 5) AS INTEGER), 7527, 'Retail', 8204, 'Retail', 7723, 'Retail', 3376, 'Retail', 3424, 'Retail', DECODE(CONV.CFLOTA, 1, DECODE(cast(SUBSTR(seg2.CAGENTE, - 3, 8) AS INTEGER), 24, 'Banca', 25, 'Banca', 'Flota'), 'Individual')) CANAL\n\t\t\t\t,\n\t\t\t\t--sisaxis.f_clasificacion_fecu(seg2.sseguro) clasificacion_fecu ,\n\t\t\t\tseg2.CMODALI\n\t\t\t\t,seg2.CTIPSEG\n\t\t\t\t,seg2.CCOLECT\n\t\t\t\t,seg2.CACTIVI\n\t\t\t\t,seg2.CRESERVA\n\t\t\tFROM cdp_ods.SISAXIS_SEGUROS SEG2\n\t\t\t\t,cdp_ods.SISAXIS_CTR_DESAGRUPASEG CONV\n\t\t\tWHERE seg2.cagrseg = conv.cagrseg(+)\n\t\t\t\tAND ncertif > 0\n\t\t\t) k\n\t\tWHERE k.NCERTIF > 0\n\t\tGROUP BY k.NPOLIZA\n\t\t) w ON (w.NPOLIZA = seg.NPOLIZA)\n\t-- End Query from Temp Table FLOTA in VENTA_LIBERTY\n\tWHERE --seg.SSEGURO IN (900327438,900250970,900327424,900372586,900327400,900334130,900331236,900332401,900373592,900367654,900331218,900332365)\n\t\t--and \n\t\tseg.ncertif > 0\n\t\tAND (\n\t\t\t(\n\t\t\t\tSEG.CRAMO = 6\n\t\t\t\tAND w.Count_Items >= 10\n\t\t\t\t)\n\t\t\tOR SEG.CRAMO <> 6\n\t\t\t)\n\t\tAND SEG.CRAMO <> 16\n\t\tAND SEG.SPRODUC NOT IN (\n\t\t\t452\n\t\t\t,500\n\t\t\t,686\n\t\t\t,842\n\t\t\t,861\n\t\t\t,438\n\t\t\t,439\n\t\t\t,820\n\t\t\t,822\n\t\t\t,856\n\t\t\t)\n\t)\n\t,ITEM_OTROS_1\nAS (\n\tSELECT a.CRAMO\n\t\t,a.CSITUAC\n\t\t,a.SSEGURO\n\t\t,CASE \n\t\t\tWHEN isnull(b.sseguro, 0) > 0\n\t\t\t\tTHEN 'SI'\n\t\t\tELSE 'NO'\n\t\t\tEND AS ITEM_RENOVACION\n\tFROM ITEM_OTROS a\n\tLEFT JOIN ITEM_OTROS b ON a.CRAMO = b.CRAMO\n\t\tAND a.Rut_Contratante = b.Rut_Contratante\n\t\tAND a.fefecto = b.fvencim\n\t\tAND b.CSITUAC = 0\n\t)\n\t,ITEM_RENO_NR\nAS (\n\tSELECT sseguro\n\t\t,SSEGURO AS [ID_ITEM]\n\t\t,CRAMO AS [ID_RAMO]\n\t\t,seg.NPOLIZA\n\t\t,NCERTIF AS ITEM\n\t\t,CSITUAC AS [ID_SITUACION]\n\tFROM CDP_ODS.sisaxis_seguros seg\n\tWHERE seg.NCERTIF > 0\n\t\tAND (\n\t\t\tseg.CRAMO = 16\n\t\t\tOR SEG.SPRODUC IN (\n\t\t\t\t452\n\t\t\t\t,500\n\t\t\t\t,686\n\t\t\t\t,842\n\t\t\t\t,861\n\t\t\t\t,438\n\t\t\t\t,439\n\t\t\t\t,820\n\t\t\t\t,822\n\t\t\t\t,856\n\t\t\t\t)\n\t\t\t)\n\t)\nSELECT CAST(NVL(LKP.MAX_SID, 0) + num AS INTEGER) AS fact_renovaciones_integrado_key\n\t,SRC1.src_sys_cd\n\t,SRC1.policy_item_id\n\t,SRC1.curr_cd\n\t,SRC1.actv_rec_ind\n\t,SRC1.dim_insured_key\n\t,SRC1.dim_policyholder_key\n\t,\n\t--SRC1.dim_policy_key,\n\tSRC1.dim_prd_pln_hrchy_key\n\t,SRC1.dim_branch_office_key\n\t,SRC1.dim_lob_key\n\t,SRC1.dim_broker_key\n\t,SRC1.policy_num\n\t,SRC1.policy_eff_dt\n\t,SRC1.policy_exp_dt\n\t,SRC1.policy_issue_dt\n\t,SRC1.policy_status_desc\n\t,SRC1.policy_item_num\n\t,SRC1.acct_yr\n\t,SRC1.acct_mth\n\t,SRC1.facultativo_ind\n\t,SRC1.facult_premium_amt\n\t,SRC1.broker_comm_amt\n\t,SRC1.coins_type_cd\n\t,SRC1.policyholder_rut_num\n\t,SRC1.insured_rut_num\n\t,SYSDATE AS rec_crt_dtm\n\t,SYSDATE AS rec_updt_dtm\n\t,0 AS etl_audit_id\n\t,SRC1.agreement\n\t,SRC1.flota\n\t,SRC1.valid_ind\n\t,SRC1.PATENTE\n\t,SRC1.Lob_mkt_ref_code\n\t,SRC1.item_type\n\t,SRC1.item_renovated_ind\n\t,SRC1.document_type\n\t,SRC1.cycle_number\n\t,SRC1.cycle_state\n\t,SRC1.renovation_type\n\t,SRC1.sales_type\n\t,SRC1.net_direct_prem_amt\n\t,SRC1.affects_prem_direct_amt\n\t,SRC1.exempt_prem_direct_amt\n\t,SRC1.new_direct_premium_amt\n\t,SRC1.renewal_direct_premium_amt\n\t,SRC1.endorsement_direct_premium_amt\n\t,SRC1.mv_id\n\t,SRC1.mv_reason_cd\n\t,SRC1.mv_reason_desc\n--LKP.MAX_SID\nFROM (\n\tSELECT row_number() OVER (\n\t\t\tORDER BY SRC.policy_num\n\t\t\t\t,SRC.policy_item_num\n\t\t\t) AS num\n\t\t,SRC.src_sys_cd\n\t\t,SRC.policy_item_id\n\t\t,SRC.curr_cd\n\t\t,SRC.actv_rec_ind\n\t\t,NVL(SRC.dim_insured_key, 0) AS dim_insured_key\n\t\t,NVL(SRC.dim_policyholder_key, 0) AS dim_policyholder_key\n\t\t,\n\t\t--nvl(SRC.dim_policy_key,0) as dim_policy_key,\n\t\tNVL(SRC.dim_prd_pln_hrchy_key, 0) AS dim_prd_pln_hrchy_key\n\t\t,NVL(SRC.dim_branch_office_key, 0) AS dim_branch_office_key\n\t\t,NVL(SRC.dim_lob_key, 0) AS dim_lob_key\n\t\t,NVL(SRC.dim_broker_key, 0) AS dim_broker_key\n\t\t,SRC.policy_num\n\t\t,SRC.policy_eff_dt\n\t\t,SRC.policy_exp_dt\n\t\t,SRC.policy_issue_dt\n\t\t,SRC.policy_status_desc\n\t\t,CAST(SRC.policy_item_num AS INTEGER) AS policy_item_num\n\t\t,trim(SRC.acct_yr) AS acct_yr\n\t\t,trim(SRC.acct_mth) AS acct_mth\n\t\t,SRC.facultativo_ind\n\t\t,SRC.facult_premium_amt\n\t\t,SRC.broker_comm_amt\n\t\t,SRC.coins_type_cd\n\t\t,SRC.policyholder_rut_num\n\t\t,SRC.insured_rut_num\n\t\t,SRC.agreement\n\t\t,SRC.flota\n\t\t,CASE \n\t\t\tWHEN SRC.PDATE >= SYSDATE\n\t\t\t\tTHEN 'SI'\n\t\t\tELSE 'NO'\n\t\t\tEND AS valid_ind\n\t\t,SRC.PATENTE\n\t\t,SRC.Lob_mkt_ref_code\n\t\t,SRC.item_type\n\t\t,SRC.item_renovated_ind\n\t\t,NVL(SRC.document_type, 'Endoso') AS document_type\n\t\t,SRC.cycle_number\n\t\t,SRC.cycle_state\n\t\t,SRC.renovation_type\n\t\t,SRC.sales_type\n\t\t,SRC.net_direct_prem_amt\n\t\t,SRC.affects_prem_direct_amt\n\t\t,SRC.exempt_prem_direct_amt\n\t\t,CAST(SRC.new_direct_premium_amt AS NUMERIC(25, 10))\n\t\t,CAST(SRC.renewal_direct_premium_amt AS NUMERIC(25, 10))\n\t\t,CAST(SRC.endorsement_direct_premium_amt AS NUMERIC(25, 10))\n\t\t,SRC.mv_id\n\t\t,SRC.mv_reason_cd\n\t\t,SRC.mv_reason_desc\n\t\t,ROW_NUMBER() OVER (\n\t\t\tPARTITION BY SRC.policy_item_id\n\t\t\t,SRC.acct_yr\n\t\t\t,SRC.acct_mth\n\t\t\t,SRC.mv_id\n\t\t\t,SRC.source ORDER BY SRC.policy_eff_dt\n\t\t\t) rnk\n\tFROM (\n\t\tSELECT CAST('axis' AS VARCHAR(10)) src_sys_cd\n\t\t\t,CAST(TRUNC(a.sseguro) AS VARCHAR(35)) AS policy_item_id\n\t\t\t,--changed\n\t\t\t-- alias\n\t\t\tCAST(cuadre02.cmonseg AS VARCHAR(10)) AS curr_cd\n\t\t\t,'Y' AS actv_rec_ind\n\t\t\t,CAST(INSURED.dim_insured_key AS INTEGER) AS dim_insured_key\n\t\t\t,CAST(POL_HOLD.dim_policyholder_key AS INTEGER) AS dim_policyholder_key\n\t\t\t,\n\t\t\t--cast(dim_policy.dim_policy_key as integer) as dim_policy_key,\n\t\t\tCAST(dim_prd_pln.dim_prd_pln_hrchy_key AS INTEGER) AS dim_prd_pln_hrchy_key\n\t\t\t,CAST(dim_branch_office.dim_branch_office_key AS INTEGER) AS dim_branch_office_key\n\t\t\t,CAST(dim_lob.dim_lob_key AS INTEGER) AS dim_lob_key\n\t\t\t,CAST(dim_broker.dim_broker_key AS INTEGER) AS dim_broker_key\n\t\t\t,CAST(TRUNC(a.npoliza) AS VARCHAR(35)) AS policy_num\n\t\t\t,--changed alias\n\t\t\tCAST(seguros.FEFECTO AS DATE) AS policy_eff_dt\n\t\t\t,DECODE(seguros.CDURACI, 3, seguros.FVENCIM, seguros.FCARPRO) AS policy_exp_dt\n\t\t\t,CAST(seguros.FEMISIO AS DATE) AS policy_issue_dt\n\t\t\t,CAST(policy_status.REF_DESC AS VARCHAR(80)) AS policy_status_desc\n\t\t\t,CAST(CAST(cuadre02.ncertif AS INTEGER) AS VARCHAR(35)) AS policy_item_num\n\t\t\t,CAST(dir_amt.PRIMA_DIR AS NUMERIC(25, 10)) AS net_direct_prem_amt\n\t\t\t,CAST(dir_amt.PRIMA_AFE_DIR AS NUMERIC(25, 10)) AS affects_prem_direct_amt\n\t\t\t,CAST(dir_amt.PRIMA_EXE_DIR AS NUMERIC(25, 10)) AS exempt_prem_direct_amt\n\t\t\t,a.acct_yr AS acct_yr\n\t\t\t,--changed alias\n\t\t\ta.acct_mth AS acct_mth\n\t\t\t,--changed alias\n\t\t\t--CASE WHEN FACULATIVE_IND.CNT >= 1 THEN 'Y' ELSE 'N' END AS facultativo_ind,\n\t\t\t-- Modified as part of CISD-16919\n\t\t\t/*CASE\n                        WHEN NVL(AMT_SRC_FEC_AMT.fecultative_premium_amt,0) <> 0\n                        THEN 'Y'\n                        ELSE 'N'\n                    END                                            AS facultativo_ind,*/\n\t\t\tfec_indicator.facultativo_indicator AS facultativo_ind\n\t\t\t,\n\t\t\t--NVL(AMT_SRC_FEC_AMT.fecultative_premium_amt,0) AS facult_premium_amt,\n\t\t\tCASE \n\t\t\t\tWHEN fec_indicator.facultativo_indicator = 'Y'\n\t\t\t\t\tTHEN NVL(AMT_SRC_FEC_AMT.fecultative_premium_amt, 0)\n\t\t\t\tELSE 0\n\t\t\t\tEND AS facult_premium_amt\n\t\t\t,NVL(CAST(a.comision AS NUMERIC(25,10)), 0) AS broker_comm_amt\n\t\t\t,CAST(CAST(cuadre02.CTIPCOA AS INTEGER) AS VARCHAR(10)) AS coins_type_cd\n\t\t\t,\n\t\t\t/*changed to varchar*/\n\t\t\tNVL(POL_HOLD.policyholder_rut_num, '0') AS policyholder_rut_num\n\t\t\t,NVL(INSURED.insured_rut_num, '0') AS insured_rut_num\n\t\t\t,seguros.cagrseg AS agreement\n\t\t\t,CASE \n\t\t\t\tWHEN policy_exp_dt >= '2019-01-01'\n\t\t\t\t\tTHEN (\n\t\t\t\t\t\t\tCASE \n\t\t\t\t\t\t\t\tWHEN seguros.cflota = 1\n\t\t\t\t\t\t\t\t\tTHEN 'SI'\n\t\t\t\t\t\t\t\tELSE 'NO'\n\t\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t\t)\n\t\t\t\tELSE (\n\t\t\t\t\t\tCASE pol_count.pcount\n\t\t\t\t\t\t\tWHEN pol_count.pcount >= 10\n\t\t\t\t\t\t\t\tAND seguros.cramo = 6\n\t\t\t\t\t\t\t\tTHEN 'SI'\n\t\t\t\t\t\t\tWHEN pol_count.pcount < 10\n\t\t\t\t\t\t\t\tAND seguros.cramo = 6\n\t\t\t\t\t\t\t\tTHEN 'NO'\n\t\t\t\t\t\t\tELSE '-'\n\t\t\t\t\t\t\tEND\n\t\t\t\t\t\t)\n\t\t\t\tEND AS flota\n\t\t\t,CASE \n\t\t\t\tWHEN seguros.FANULAC IS NULL\n\t\t\t\t\tTHEN seguros.FVENCIM\n\t\t\t\tELSE seguros.FANULAC\n\t\t\t\tEND AS PDATE\n\t\t\t,CASE \n\t\t\t\tWHEN cuadre02.CRAMO = 6\n\t\t\t\t\tTHEN T2.CMATRIC\n\t\t\t\tELSE NULL\n\t\t\t\tEND AS PATENTE\n\t\t\t,mktrefcd.Lob_mkt_ref_code AS Lob_mkt_ref_code\n\t\t\t,item.cnt_sseg AS cnt_sseg\n\t\t\t,CASE \n\t\t\t\tWHEN item.cnt_sseg < 10\n\t\t\t\t\tAND cuadre02.cramo = 6\n\t\t\t\t\tTHEN 'No Flota'\n\t\t\t\tWHEN cuadre02.cramo = 16\n\t\t\t\t\tOR cuadre02.sproduc IN (\n\t\t\t\t\t\t452\n\t\t\t\t\t\t,500\n\t\t\t\t\t\t,686\n\t\t\t\t\t\t,842\n\t\t\t\t\t\t,861\n\t\t\t\t\t\t,438\n\t\t\t\t\t\t,439\n\t\t\t\t\t\t,820\n\t\t\t\t\t\t,822\n\t\t\t\t\t\t,856\n\t\t\t\t\t\t)\n\t\t\t\t\t--OR  seguros.csituac <> 0\n\t\t\t\t\tOR cuadre02.ncertif = 0\n\t\t\t\t\tTHEN 'No Renovables'\n\t\t\t\tELSE 'Otros'\n\t\t\t\tEND AS item_type\n\t\t\t,\n\t\t\t--NVL(ITEM_RENO_IND.ITEM_RENOVADO,'NO') AS item_renovated_ind,\n\t\t\t--case when ITEM_RENO_IND.ITEM_RENOVADO='SI' or ITEM_RENO_IND_OTROS.ITEM_RENOVADO='SI' then 'SI' else'NO' end as item_renovated_ind,\n\t\t\t--CICLO.document_type as document_type,\n\t\t\tNVL(ITEM_RENO_IND.ITEM_RENOVACION, 'NO') AS item_renovated_ind\n\t\t\t,CASE \n\t\t\t\tWHEN cast(a.nmovimi AS INTEGER) = 1\n\t\t\t\t\tAND a.source = 'cuadre'\n\t\t\t\t\tTHEN 'Propuesta'\n\t\t\t\tWHEN DOC_TYPE.doc_type IS NULL\n\t\t\t\t\tTHEN 'Endoso'\n\t\t\t\tELSE DOC_TYPE.doc_type\n\t\t\t\tEND AS document_type\n\t\t\t,TRUNC(CICLO.cycle_number) AS cycle_number\n\t\t\t,CICLO.cycle_state AS cycle_state\n\t\t\t,CICLO.RENOVATION_TYPE AS renovation_type\n\t\t\t,CASE \n\t\t\t\tWHEN document_type = 'Propuesta'\n\t\t\t\t\tTHEN CASE \n\t\t\t\t\t\t\tWHEN item_renovated_ind = 'SI'\n\t\t\t\t\t\t\t\tTHEN 'Renovacion'\n\t\t\t\t\t\t\tELSE 'Venta Nueva'\n\t\t\t\t\t\t\tEND\n\t\t\t\tELSE 'Endoso'\n\t\t\t\tEND AS sales_type\n\t\t\t,CASE \n\t\t\t\tWHEN sales_type = 'Venta Nueva'\n\t\t\t\t\tTHEN net_direct_prem_amt\n\t\t\t\tELSE 0\n\t\t\t\tEND AS new_direct_premium_amt\n\t\t\t,CASE \n\t\t\t\tWHEN sales_type = 'Renovacion'\n\t\t\t\t\tTHEN net_direct_prem_amt\n\t\t\t\tELSE 0\n\t\t\t\tEND AS renewal_direct_premium_amt\n\t\t\t,CASE \n\t\t\t\tWHEN sales_type = 'Endoso'\n\t\t\t\t\tTHEN net_direct_prem_amt\n\t\t\t\tELSE 0\n\t\t\t\tEND AS endorsement_direct_premium_amt\n\t\t\t,CAST(ISNULL(MOVE_SEG.NMOVIMI, MOVE_SEGUROS.nmovimi) AS INTEGER) AS mv_id\n\t\t\t,ISNULL(MOVE_SEG.CMOTMOV, MOVE_SEGUROS.cmotmov) AS mv_reason_cd\n\t\t\t,\n\t\t\t--MOVE_SEG.CMOTMOV AS mv_reason_cd,\n\t\t\tSTG1.ref_desc AS mv_reason_desc\n\t\t\t,a.source\n\t\tFROM (\n\t\t\tSELECT sseguro\n\t\t\t\t,acct_yr\n\t\t\t\t,acct_mth\n\t\t\t\t,MAX(npoliza) AS npoliza\n\t\t\t\t,SUM(comision) AS comision\n\t\t\t\t,nmovimi\n\t\t\t\t,source\n\t\t\tFROM (\n\t\t\t\tSELECT CAST(sseguro AS INT) AS sseguro\n\t\t\t\t\t,substring(FCONTA, 1, 4) AS acct_yr\n\t\t\t\t\t,substring(FCONTA, 6, 2) AS acct_mth\n\t\t\t\t\t,MAX(CAST(npoliza AS INTEGER)) AS Npoliza\n\t\t\t\t\t,SUM(NVL(CAST(comision AS NUMERIC(25,10)), 0)) AS comision\n\t\t\t\t\t,nmovimi\n\t\t\t\t\t,'cuadre' AS source\n\t\t\t\tFROM cdp_ods.sisaxis_his_cuadre02\n\t\t\t\tGROUP BY acct_yr\n\t\t\t\t\t,acct_mth\n\t\t\t\t\t,sseguro\n\t\t\t\t\t,nmovimi\n\t\t\t\t)\n\t\t\t/*UNION\n                                SELECT\n                                    PRD_NRO_SOL               AS sseguro ,\n                                    substring(prd_fec_con,1,4)AS acct_yr,\n                                    substring(prd_fec_con,5,2)AS acct_mth,\n                                    MAX(PRD_NRO_POL)          AS npoliza,\n                                    0                         AS comision,\n                                    0                         AS nmovimi,\n                                    'reaseguro'               AS source\n                                FROM\n                                    cdp_ods.sisfin11_ifa_reaseguro\n                                WHERE\n                                    prd_fec_con<=\n                                    (\n                                        SELECT\n                                            substring(REPLACE(MAX(fconta),'-',''),1,8)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \n                                        FROM\n                                            cdp_ods.sisaxis_his_cuadre02)\n                                GROUP BY\n                                    acct_yr,\n                                    acct_mth,\n                                    sseguro */\n\t\t\tGROUP BY sseguro\n\t\t\t\t,acct_yr\n\t\t\t\t,acct_mth\n\t\t\t\t,nmovimi\n\t\t\t\t,source\n\t\t\t) a -- ADDED this section to get data from sisfin11_ifa_reaseguro\n\t\tLEFT JOIN (\n\t\t\tSELECT DISTINCT cmonseg\n\t\t\t\t,ncertif\n\t\t\t\t,CTIPCOA\n\t\t\t\t,cramo\n\t\t\t\t,sproduc\n\t\t\t\t,sseguro\n\t\t\t\t,npoliza\n\t\t\t\t,cagente\n\t\t\t\t,nmovimi\n\t\t\t\t,substring(FCONTA, 1, 4) AS acct_yr\n\t\t\t\t,substring(FCONTA, 6, 2) AS acct_mth\n\t\t\tFROM cdp_ods.sisaxis_his_cuadre02\n\t\t\t) cuadre02 ON a.sseguro = cuadre02.sseguro\n\t\t\tAND a.nmovimi = cuadre02.nmovimi\n\t\t\tAND a.acct_yr = cuadre02.acct_yr\n\t\t\tAND a.acct_mth = cuadre02.acct_mth\n\t\tLEFT OUTER JOIN cdp_ods.sisaxis_seguros seguros ON a.sseguro = seguros.sseguro\n\t\t\tAND seguros.ncertif > 0\n\t\tLEFT JOIN (\n\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t,nmovimi\n\t\t\t\t,cmotmov\n\t\t\t\t,FMOVIMI\n\t\t\t\t,FEMISIO\n\t\t\t\t,FMOVVTO\n\t\t\t\t,FEFECTO\n\t\t\t\t,FCONTAB\n\t\t\tFROM cdp_ods.sisaxis_movseguro\n\t\t\t) MOVE_SEG ON a.sseguro = MOVE_SEG.sseguro\n\t\t\tAND a.nmovimi = MOVE_SEG.nmovimi\n\t\tLEFT JOIN (\n\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t,nmovimi\n\t\t\t\t,cmotmov\n\t\t\t\t,FMOVIMI\n\t\t\t\t,FEMISIO\n\t\t\t\t,FMOVVTO\n\t\t\t\t,FEFECTO\n\t\t\t\t,FCONTAB\n\t\t\tFROM cdp_ods.sisaxis_movseguro\n\t\t\t) MOVE_SEGUROS ON a.sseguro = MOVE_SEGUROS.sseguro\n\t\t\tAND a.acct_yr = substring(MOVE_SEGUROS.FCONTAB, 1, 4)\n\t\t\tAND a.acct_mth = substring(MOVE_SEGUROS.FCONTAB, 6, 2)\n\t\t\tAND a.nmovimi = 0\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT\n\t\t\t\t--dim_policy_key,\n\t\t\t\tpolicy_id\n\t\t\t\t,policy_num\n\t\t\t\t,ROW_NUMBER() OVER (\n\t\t\t\t\tPARTITION BY policy_num ORDER BY policy_id DESC\n\t\t\t\t\t) RNK\n\t\t\tFROM cdp_dwh.dim_policy_t\n\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t) dim_policy ON CAST(CAST(cuadre02.npoliza AS INTEGER) AS VARCHAR(35)) = dim_policy.policy_num\n\t\t\tAND dim_policy.RNK = 1\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT sperson\n\t\t\t\t,cdomici\n\t\t\t\t,sseguro\n\t\t\tFROM cdp_ods.sisaxis_tomadores\n\t\t\t) tomadores ON dim_policy.policy_id = CAST(tomadores.sseguro AS INTEGER)\n\t\tLEFT JOIN (\n\t\t\tSELECT DISTINCT POL_HOLD.dim_policyholder_key\n\t\t\t\t,POL_HOLD.policyholder_rut_num\n\t\t\t\t,AA.sseguro\n\t\t\tFROM (\n\t\t\t\tSELECT CAST(CAST(TOMA.SPERSON AS INTEGER) || '-' || CAST(NVL(TOMA.CDOMICI, 0) AS INTEGER) AS VARCHAR(35)) AS TOMA_HLD_ID\n\t\t\t\t\t,SEG.sseguro\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT sseguro\n\t\t\t\t\t\t,npoliza\n\t\t\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t) SEG\n\t\t\t\tINNER JOIN cdp_ods.sisaxis_tomadores TOMA ON SEG.SSEGURO = CAST(TOMA.sseguro AS INTEGER)\n\t\t\t\t) AA\n\t\t\tINNER JOIN cdp_dwh.dim_policyholder_t POL_HOLD ON AA.TOMA_HLD_ID = POL_HOLD.policyholder_id\n\t\t\t\tAND POL_HOLD.src_sys_cd = 'axis'\n\t\t\t) POL_HOLD ON cuadre02.sseguro = POL_HOLD.sseguro\n\t\t--left outer join (select dim_policyholder_key,policyholder_rut_num,\n\t\t-- policyholder_id from cdp_dwh.dim_policyholder_t where src_sys_cd='axis')\n\t\t-- dim_policyholder\n\t\t--on cast(cast(tomadores.sperson as integer)||'-'||nvl(cast(tomadores.cdomici\n\t\t-- as integer)) as varchar(35))=dim_policyholder.policyholder_id\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT dim_prd_pln_hrchy_key\n\t\t\t\t,lob_cd\n\t\t\t\t,prd_cd\n\t\t\t\t,pln_cd\n\t\t\tFROM cdp_dwh.dim_prd_pln_hrchy_t\n\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t) dim_prd_pln ON CAST(CAST(seguros.sproduc AS INTEGER) AS VARCHAR(10)) = dim_prd_pln.prd_cd\n\t\t\tAND CAST(CAST(seguros.cactivi AS INTEGER) AS VARCHAR(10)) = dim_prd_pln.pln_cd\n\t\t\tAND CAST(CAST(seguros.cramo AS INTEGER) AS VARCHAR(10)) = dim_prd_pln.lob_cd\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT dim_branch_office_key\n\t\t\t\t,branch_office_cd\n\t\t\tFROM cdp_dwh.dim_branch_office_t\n\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t) dim_branch_office ON LTRIM(RIGHT(cuadre02.cagente, 3), 0) = LTRIM(dim_branch_office.branch_office_cd, 0)\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT dim_lob_key\n\t\t\t\t,lob_cd\n\t\t\tFROM cdp_dwh.dim_lob_t\n\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t) dim_lob ON CAST(CAST(seguros.cramo AS INTEGER) AS VARCHAR(10)) = dim_lob.lob_cd\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT DISTINCT broker.dim_broker_key\n\t\t\t\t,broker_branch.rlshp_src_id\n\t\t\tFROM (\n\t\t\t\t(\n\t\t\t\t\tSELECT rlshp_src_id\n\t\t\t\t\t\t,entity_rut_num\n\t\t\t\t\tFROM cdp_dwh.broker_branch_rlshp_t\n\t\t\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t\t\t\tAND entity_type_cd = 4\n\t\t\t\t\t) broker_branch INNER JOIN (\n\t\t\t\t\tSELECT dim_broker_key\n\t\t\t\t\t\t,broker_id\n\t\t\t\t\tFROM cdp_dwh.dim_broker_t\n\t\t\t\t\t\t--where src_sys_cd='axis'\n\t\t\t\t\t) broker ON broker_branch.entity_rut_num = broker.broker_id\n\t\t\t\t)\n\t\t\t) dim_broker ON cuadre02.cagente = dim_broker.rlshp_src_id\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT REF_CD\n\t\t\t\t,REF_DESC\n\t\t\tFROM cdp_stg_dwh.stg_tref_code_map_variant\n\t\t\tWHERE ref_type_cd = 'policy_status_cd'\n\t\t\t\tAND src_sys_cd = 'axis'\n\t\t\t) policy_status ON CAST(CAST(seguros.csituac AS INTEGER) AS VARCHAR(10)) = policy_status.REF_CD\n\t\tLEFT JOIN (\n\t\t\tSELECT --ref_cd\n\t\t\tCAST(ref_cd AS INT) AS ref_cd\n\t\t\t\t,mkt_ref_code AS Lob_mkt_ref_code\n\t\t\tFROM cdp_stg_dwh.stg_tref_code_map_variant\n\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t\tAND ref_type_cd = 'lob'\n\t\t\t) --mktrefcd ON cuadre02.CRAMO = mktrefcd.ref_cd\n\t\t\tmktrefcd ON CAST(cuadre02.CRAMO AS INT) = mktrefcd.ref_cd\n\t\tLEFT JOIN (\n\t\t\tSELECT *\n\t\t\tFROM cdp_stg_dwh.stg_tref_code_map_variant\n\t\t\tWHERE src_sys_cd = 'axis'\n\t\t\t\tAND ref_type_cd = 'movement_cd'\n\t\t\t) STG1 ON CAST(CAST(ISNULL(MOVE_SEG.cmotmov, MOVE_SEGUROS.cmotmov) AS INTEGER) AS VARCHAR(20)) = STG1.ref_cd\n\t\tLEFT JOIN (\n\t\t\tSELECT DISTINCT A.sseguro\n\t\t\t\t,INSURED.dim_insured_key\n\t\t\t\t,INSURED.insured_rut_num\n\t\t\tFROM (\n\t\t\t\tSELECT tmp2.sseguro\n\t\t\t\t\t,tmp2.sperson\n\t\t\t\t\t,tmp2.cdomici\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT tmp1.sseguro\n\t\t\t\t\t\t,tmp1.nriesgo\n\t\t\t\t\t\t,tase.nmovima\n\t\t\t\t\t\t,tase.sperson\n\t\t\t\t\t\t,tase.cdomici\n\t\t\t\t\t\t,row_number() OVER (\n\t\t\t\t\t\t\tPARTITION BY tmp1.sseguro\n\t\t\t\t\t\t\t,tmp1.nriesgo ORDER BY tase.norden DESC\n\t\t\t\t\t\t\t) AS row_ind\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT tmov.sseguro\n\t\t\t\t\t\t\t,trie.nriesgo\n\t\t\t\t\t\t\t,trie.sperson\n\t\t\t\t\t\t\t,trie.cdomici\n\t\t\t\t\t\t\t,row_number() OVER (\n\t\t\t\t\t\t\t\tPARTITION BY tmov.sseguro ORDER BY trie.nmovima DESC\n\t\t\t\t\t\t\t\t) AS row_ind\n\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\tSELECT DISTINCT sseguro\n\t\t\t\t\t\t\tFROM cdp_ods.sisaxis_his_cuadre02\n\t\t\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t\t\t) tseg\n\t\t\t\t\t\tINNER JOIN cdp_ods.sisaxis_movseguro tmov ON tseg.sseguro = tmov.sseguro\n\t\t\t\t\t\tINNER JOIN cdp_ods.sisaxis_riesgos trie ON tmov.sseguro = trie.sseguro\n\t\t\t\t\t\t) tmp1\n\t\t\t\t\tINNER JOIN cdp_ods.sisaxis_asegurados tase ON tmp1.sseguro = tase.sseguro\n\t\t\t\t\t\tAND tmp1.nriesgo = tase.nriesgo\n\t\t\t\t\tWHERE tmp1.row_ind = 1\n\t\t\t\t\t) tmp2\n\t\t\t\tWHERE tmp2.row_ind = 1\n\t\t\t\tGROUP BY tmp2.sseguro\n\t\t\t\t\t,tmp2.sperson\n\t\t\t\t\t,tmp2.cdomici\n\t\t\t\tORDER BY tmp2.sseguro\n\t\t\t\t\t,tmp2.sperson\n\t\t\t\t\t,tmp2.cdomici\n\t\t\t\t) A\n\t\t\tINNER JOIN cdp_dwh.dim_insured_t INSURED ON INSURED.insured_id = A.sperson\n\t\t\t\tAND INSURED.address_id = NVL(CAST(A.cdomici AS INTEGER), '0')\n\t\t\t\tAND INSURED.src_sys_cd = 'axis'\n\t\t\t) INSURED ON INSURED.sseguro = a.sseguro\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT acct_yr\n\t\t\t\t,acct_mth\n\t\t\t\t,sseguro\n\t\t\t\t,SUM(PRIMA_DIR) AS PRIMA_DIR\n\t\t\t\t,SUM(PRIMA_AFE_DIR) AS PRIMA_AFE_DIR\n\t\t\t\t,SUM(PRIMA_EXE_DIR) AS PRIMA_EXE_DIR\n\t\t\t\t,nmovimi\n\t\t\tFROM (\n\t\t\t\tSELECT substring(FCONTA, 1, 4) AS acct_yr\n\t\t\t\t\t,substring(FCONTA, 6, 2) AS acct_mth\n\t\t\t\t\t,SSEGURO\n\t\t\t\t\t,NPOLIZA\n\t\t\t\t\t,PRIMA_TARIFA PRIMA_DIR\n\t\t\t\t\t,IPRIAFE_DIR PRIMA_AFE_DIR\n\t\t\t\t\t,IPRIEXE_DIR PRIMA_EXE_DIR\n\t\t\t\t\t,nmovimi\n\t\t\t\tFROM cdp_ods.SISAXIS_HIS_CUADRE02\n\t\t\t\tWHERE NCERTIF > 0\n\t\t\t\t)\n\t\t\t/*UNION ALL\n\t\t\t\t\t\t  \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \n\t\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t \n                                SELECT\n                                    substring(prd_fec_con,1,4) AS acct_yr,\n                                    substring(prd_fec_con,5,2) AS acct_mth,\n                                    prd_nro_sol                AS SSEGURO,\n                                    prd_nro_pol                AS NPOLIZA,\n                                    0                          AS PRIMA_DIR,\n                                    0                          AS PRIMA_AFE_DIR,\n                                    0                          AS PRIMA_EXE_DIR,\n                                    0                          AS nmovimi\n                                FROM\n                                    cdp_ods.sisfin11_ifa_reaseguro */\n\t\t\tGROUP BY sseguro\n\t\t\t\t,acct_yr\n\t\t\t\t,acct_mth\n\t\t\t\t,nmovimi\n\t\t\t) dir_amt ON a.sseguro = dir_amt.sseguro\n\t\t\tAND a.acct_yr = dir_amt.acct_yr\n\t\t\tAND a.acct_mth = dir_amt.acct_mth\n\t\t\tAND a.nmovimi = dir_amt.nmovimi\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT SUM(AMT_SRC_FEC_AMT.fecultative_premium_amt) AS fecultative_premium_amt\n\t\t\t\t,AMT_SRC_FEC_AMT.sseguro AS sseguro\n\t\t\t\t,AMT_SRC_FEC_AMT.acct_yr AS acct_yr\n\t\t\t\t,AMT_SRC_FEC_AMT.acct_mth AS acct_mth\n\t\t\t\t,AMT_SRC_FEC_AMT.nmovimi AS nmovimi\n\t\t\tFROM (\n\t\t\t\tSELECT NVL(CC.fecultative_premium_amt, 0) fecultative_premium_amt\n\t\t\t\t\t,CC.sseguro\n\t\t\t\t\t,CC.acct_yr\n\t\t\t\t\t,CC.acct_mth\n\t\t\t\t\t,CC.nmovimi\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT CASE \n\t\t\t\t\t\t\tWHEN (\n\t\t\t\t\t\t\t\t\tBB.CESION_CTRAMO = 5\n\t\t\t\t\t\t\t\t\tOR BB.CESION_CTRAMO = 4\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\tAND CESION_cgenera <> 2\n\t\t\t\t\t\t\t\tTHEN BB.icesmon\n\t\t\t\t\t\t\tELSE 0\n\t\t\t\t\t\t\tEND AS fecultative_premium_amt\n\t\t\t\t\t\t,BB.sseguro\n\t\t\t\t\t\t,BB.icesmon\n\t\t\t\t\t\t,BB.pcesion\n\t\t\t\t\t\t,BB.acct_yr\n\t\t\t\t\t\t,BB.acct_mth\n\t\t\t\t\t\t,BB.nmovimi\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT CESION.icesmon\n\t\t\t\t\t\t\t,CESION.pcesion\n\t\t\t\t\t\t\t,CAST(CESION.CTRAMO AS INTEGER) AS CESION_CTRAMO\n\t\t\t\t\t\t\t,CESION.PCUOPAR\n\t\t\t\t\t\t\t,SEG.sseguro\n\t\t\t\t\t\t\t,seg.acct_yr\n\t\t\t\t\t\t\t,seg.acct_mth\n\t\t\t\t\t\t\t,CAST(CESION.cgenera AS INTEGER) AS CESION_cgenera\n\t\t\t\t\t\t\t,SEG.nmovimi\n\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\t--Modified as part of CISD-16919\n\t\t\t\t\t\t\t/* SELECT\n                                                            sseguro,\n                                                            substring(FCONTA,1,4) AS acct_yr,\n                                                            substring(FCONTA,6,2) AS acct_mth,\n                                                            nmovimi\n                                                        FROM\n                                                            cdp_ods.sisaxis_his_cuadre02\n                                                        WHERE\n                                                            ncertif > 0 */\n\t\t\t\t\t\t\tSELECT sseguro\n\t\t\t\t\t\t\t\t,to_char(fconta, 'YYYY') AS acct_yr\n\t\t\t\t\t\t\t\t,to_char(fconta, 'MM') AS acct_mth\n\t\t\t\t\t\t\t\t,nmovimi\n\t\t\t\t\t\t\t\t,npoliza\n\t\t\t\t\t\t\t\t,ncertif\n\t\t\t\t\t\t\t\t,fconta\n\t\t\t\t\t\t\t\t,cmonseg\n\t\t\t\t\t\t\t\t,sum(prima_tarifa) AS GWP\n\t\t\t\t\t\t\tFROM cdp_ods.sisaxis_his_cuadre02\n\t\t\t\t\t\t\tWHERE ncertif > 0\n\t\t\t\t\t\t\tGROUP BY fconta\n\t\t\t\t\t\t\t\t,to_char(fconta, 'YYYY')\n\t\t\t\t\t\t\t\t,to_char(fconta, 'MM')\n\t\t\t\t\t\t\t\t,sseguro\n\t\t\t\t\t\t\t\t,npoliza\n\t\t\t\t\t\t\t\t,ncertif\n\t\t\t\t\t\t\t\t,nmovimi\n\t\t\t\t\t\t\t\t,cmonseg\n\t\t\t\t\t\t\tORDER BY fconta\n\t\t\t\t\t\t\t\t/*  UNION\n                                                        SELECT\n                                                            prd_nro_sol                AS sseguro,\n                                                            substring(prd_fec_con,1,4) AS acct_yr,\n                                                            substring(prd_fec_con,5,2) AS acct_mth,\n                                                            0                          AS nmovimi\n                                                        FROM\n                                                            cdp_ods.sisfin11_ifa_reaseguro\n                                                        GROUP BY\n                                                            sseguro,\n                                                            acct_yr,\n                                                            acct_mth */\n\t\t\t\t\t\t\t) SEG\n\t\t\t\t\t\tLEFT JOIN cdp_ods.sisaxis_cesionesrea CESION ON SEG.sseguro = CESION.sseguro\n\t\t\t\t\t\t\tAND SEG.acct_yr = substring(CESION.FCONTAB, 1, 4)\n\t\t\t\t\t\t\tAND SEG.acct_mth = substring(CESION.FCONTAB, 6, 2)\n\t\t\t\t\t\t\tAND SEG.nmovimi = CESION.nmovigen\n\t\t\t\t\t\t) BB\n\t\t\t\t\t) CC\n\t\t\t\t) AMT_SRC_FEC_AMT\n\t\t\tGROUP BY AMT_SRC_FEC_AMT.sseguro\n\t\t\t\t,AMT_SRC_FEC_AMT.acct_yr\n\t\t\t\t,AMT_SRC_FEC_AMT.acct_mth\n\t\t\t\t,AMT_SRC_FEC_AMT.nmovimi\n\t\t\t) AMT_SRC_FEC_AMT ON a.sseguro = AMT_SRC_FEC_AMT.sseguro\n\t\t\tAND a.acct_yr = AMT_SRC_FEC_AMT.acct_yr\n\t\t\tAND a.acct_mth = AMT_SRC_FEC_AMT.acct_mth\n\t\t\tAND a.nmovimi = AMT_SRC_FEC_AMT.nmovimi\n\t\t--Added as part of CISD-16919\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT a.sseguro\n\t\t\t\t,a.npoliza\n\t\t\t\t,a.ncertif\n\t\t\t\t,x.prima_facultativo\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN x.prima_facultativo IS NULL\n\t\t\t\t\t\tTHEN 'N'\n\t\t\t\t\tWHEN x.prima_facultativo <= 0\n\t\t\t\t\t\tTHEN 'N'\n\t\t\t\t\tELSE 'Y'\n\t\t\t\t\tEND AS facultativo_indicator\n\t\t\tFROM cdp_ods.sisaxis_seguros a\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT ces.sseguro\n\t\t\t\t\t,sum(ces.icesmon) AS prima_facultativo\n\t\t\t\tFROM (\n\t\t\t\t\t--CESIONES.qvd\n\t\t\t\t\tSELECT scesrea\n\t\t\t\t\t\t,ncesion\n\t\t\t\t\t\t,icesion\n\t\t\t\t\t\t,icapces\n\t\t\t\t\t\t,sseguro\n\t\t\t\t\t\t,nversio\n\t\t\t\t\t\t,scontra\n\t\t\t\t\t\t,ctramo\n\t\t\t\t\t\t,sfacult\n\t\t\t\t\t\t,nriesgo\n\t\t\t\t\t\t,fefecto\n\t\t\t\t\t\t,fvencim\n\t\t\t\t\t\t,fcontab\n\t\t\t\t\t\t,pcesion\n\t\t\t\t\t\t,sproces\n\t\t\t\t\t\t,cgenera\n\t\t\t\t\t\t,fgenera\n\t\t\t\t\t\t,fanulac\n\t\t\t\t\t\t,nmovimi\n\t\t\t\t\t\t,nmovigen\n\t\t\t\t\t\t,cmonrea\n\t\t\t\t\t\t,cmonseg\n\t\t\t\t\t\t,icesmon\n\t\t\t\t\t\t,icapmon\n\t\t\t\t\t\t,fcambio\n\t\t\t\t\t\t,pcespol\n\t\t\t\t\t\t,pcuopar\n\t\t\t\t\tFROM cdp_ods.sisaxis_cesionesrea c\n\t\t\t\t\tWHERE cgenera <> 2\n\t\t\t\t\t\t-- end CESIONES-qvd\n\t\t\t\t\t) ces\n\t\t\t\tWHERE ces.ctramo IN (\n\t\t\t\t\t\t4\n\t\t\t\t\t\t,5\n\t\t\t\t\t\t)\n\t\t\t\tGROUP BY ces.SSEGURO\n\t\t\t\tORDER BY ces.sseguro\n\t\t\t\t) x ON a.sseguro = x.sseguro\n\t\t\tORDER BY a.sseguro\n\t\t\t) fec_indicator ON fec_indicator.sseguro = a.sseguro\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT npoliza\n\t\t\t\t,COUNT(ncertif) AS pcount\n\t\t\tFROM cdp_ods.sisaxis_seguros\n\t\t\tWHERE ncertif > 0\n\t\t\tGROUP BY npoliza\n\t\t\t) pol_count \n\t\t\t\n\t\t\t--ON CAST(a.npoliza AS INTEGER) = CAST(pol_count.npoliza AS INTEGER)\n\t\t\tON TRUNC(a.npoliza) = TRUNC(pol_count.npoliza)\n\t\tLEFT JOIN (\n\t\t\t--CISD-18742\n\t\t\tSELECT A1.CMATRIC\n\t\t\t\t,A1.SSEGURO\n\t\t\tFROM CDP_ODS.SISAXIS_AUTRIESGOS A1\n\t\t\tINNER JOIN (\n\t\t\t\tSELECT SSEGURO\n\t\t\t\t\t,--NMOVIMI,\n\t\t\t\t\tMAX(NMOVIMI) AS NMOVIMI\n\t\t\t\t\t,MAX(NRIESGO) AS NRIESGO\n\t\t\t\tFROM CDP_ODS.SISAXIS_AUTRIESGOS\n\t\t\t\tGROUP BY SSEGURO\n\t\t\t\t) A2 ON A1.SSEGURO = A2.SSEGURO\n\t\t\t\tAND A1.NMOVIMI = A2.NMOVIMI\n\t\t\t\tAND A1.NRIESGO = A2.NRIESGO\n\t\t\t) T2 ON a.SSEGURO = T2.SSEGURO\n\t\t--AND a.nmovimi=T2.nmovimi\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT npoliza\n\t\t\t\t,COUNT(sseguro) AS cnt_sseg\n\t\t\tFROM CDP_ODS.sisaxis_seguros\n\t\t\tWHERE NCERTIF > 0\n\t\t\t--FROM cdp_ods.sisaxis_his_cuadre02\n\t\t\tGROUP BY npoliza\n\t\t\t) item ON a.npoliza = item.npoliza\n\t\tLEFT JOIN (\n\t\t\tSELECT sseguro AS [ID_ITEM]\n\t\t\t\t,sseguro\n\t\t\t\t,ITEM_RENOVACION\n\t\t\tFROM ITEM_RENO_NOFLOTA\n\t\t\tWHERE ITEM_RENOVACION = 'SI'\n\t\t\t\n\t\t\tUNION\n\t\t\t\n\t\t\tSELECT sseguro AS [ID_ITEM]\n\t\t\t\t,sseguro\n\t\t\t\t,ITEM_RENOVACION\n\t\t\tFROM ITEM_OTROS_1\n\t\t\tWHERE ITEM_RENOVACION = 'SI'\n\t\t\t\n\t\t\tUNION\n\t\t\t\n\t\t\tSELECT sseguro AS [ID_ITEM]\n\t\t\t\t,sseguro\n\t\t\t\t,'NO' AS ITEM_RENOVACION\n\t\t\tFROM ITEM_RENO_NR\n\t\t\t) ITEM_RENO_IND ON a.sseguro = ITEM_RENO_IND.[ID_ITEM]\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT NPOLIZA\n\t\t\t\t,CYCLE_NUMBER\n\t\t\t\t,CYCLE_STATE\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN CYCLE_STATE = 'Rechazado'\n\t\t\t\t\t\tOR CYCLE_STATE = 'Eliminado'\n\t\t\t\t\t\tTHEN 'X'\n\t\t\t\t\tWHEN CORIGEN = 7\n\t\t\t\t\t\tTHEN 'M'\n\t\t\t\t\tWHEN COBJASE = 5\n\t\t\t\t\t\tTHEN 'A'\n\t\t\t\t\tWHEN CRENOVA_PRO = 1\n\t\t\t\t\t\tTHEN 'A'\n\t\t\t\t\tELSE 'S'\n\t\t\t\t\tEND AS RENOVATION_TYPE\n\t\t\tFROM (\n\t\t\t\tSELECT M.SCICLO AS CYCLE_NUMBER\n\t\t\t\t\t,M.NPOLIZAANT AS NPOLIZA\n\t\t\t\t\t,M.CORIGEN\n\t\t\t\t\t,M.CRENOVA\n\t\t\t\t\t,M.CRENOVPE\n\t\t\t\t\t,N.NMOVIMI\n\t\t\t\t\t,O.testado AS CYCLE_STATE\n\t\t\t\t\t,P.NRO_LINEA\n\t\t\t\t\t,P.ID_PROCESO\n\t\t\t\t\t,P.COD_PRODUC\n\t\t\t\t\t,P.DESC_ESTADO\n\t\t\t\t\t,P.ESTADO_PROC\n\t\t\t\t\t,Q.COBJASE\n\t\t\t\t\t,R.CRENOVA_PRO\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT y.SCICLO\n\t\t\t\t\t\t,y.NPOLIZAANT\n\t\t\t\t\t\t,y.CORIGEN\n\t\t\t\t\t\t,y.CRENOVA\n\t\t\t\t\t\t,y.CRENOVPE\n\t\t\t\t\tFROM CMI_PROPUESTA_1 Y\n\t\t\t\t\tINNER JOIN (\n\t\t\t\t\t\tSELECT m1.NPOLIZAANT\n\t\t\t\t\t\t\t,MAX(m1.SCICLO) AS SCICLO\n\t\t\t\t\t\tFROM CMI_PROPUESTA_1 m1\n\t\t\t\t\t\tWHERE m1.CORIGEN IN (\n\t\t\t\t\t\t\t\t5\n\t\t\t\t\t\t\t\t,7\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\tGROUP BY m1.NPOLIZAANT\n\t\t\t\t\t\t) X ON Y.NPOLIZAANT = X.NPOLIZAANT\n\t\t\t\t\t\tAND Y.SCICLO = X.SCICLO\n\t\t\t\t\t) M\n\t\t\t\tLEFT JOIN (\n\t\t\t\t\tSELECT SCICLO\n\t\t\t\t\t\t,CESTADO\n\t\t\t\t\t\t,NMOVIMI\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT SCICLO\n\t\t\t\t\t\t\t,CESTADO\n\t\t\t\t\t\t\t,NMOVIMI\n\t\t\t\t\t\t\t,ROW_NUMBER() OVER (\n\t\t\t\t\t\t\t\tPARTITION BY SCICLO ORDER BY NMOVIMI DESC\n\t\t\t\t\t\t\t\t) rnk\n\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\tSELECT SCICLO\n\t\t\t\t\t\t\t\t,CESTADO\n\t\t\t\t\t\t\t\t,NMOVIMI\n\t\t\t\t\t\t\tFROM CMI_MOVPROPUESTA_15\n\t\t\t\t\t\t\tGROUP BY SCICLO\n\t\t\t\t\t\t\t\t,CESTADO\n\t\t\t\t\t\t\t\t,NMOVIMI\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t\tWHERE RNK = 1\n\t\t\t\t\t) N ON M.SCICLO = N.SCICLO\n\t\t\t\tLEFT JOIN (\n\t\t\t\t\tSELECT csistema\n\t\t\t\t\t\t,ccodigo\n\t\t\t\t\t\t,tdescripcion AS testado --,'1' as orden\n\t\t\t\t\tFROM CDP_ODS.sisaxis_cmi_estados\n\t\t\t\t\tWHERE csistema = 15\n\t\t\t\t\t) O ON N.CESTADO = O.CCODIGO\n\t\t\t\tLEFT JOIN (\n\t\t\t\t\tSELECT SCICLO\n\t\t\t\t\t\t,COD_PRODUC\n\t\t\t\t\t\t,DESC_ESTADO\n\t\t\t\t\t\t,ESTADO_PROC\n\t\t\t\t\t\t,NRO_LINEA\n\t\t\t\t\t\t,ID_PROCESO\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT SCICLO\n\t\t\t\t\t\t\t,COD_PRODUC\n\t\t\t\t\t\t\t,DESC_ESTADO\n\t\t\t\t\t\t\t,ESTADO_PROC\n\t\t\t\t\t\t\t,NRO_LINEA\n\t\t\t\t\t\t\t,ID_PROCESO\n\t\t\t\t\t\t\t,ROW_NUMBER() OVER (\n\t\t\t\t\t\t\t\tPARTITION BY SCICLO ORDER BY NRO_LINEA DESC\n\t\t\t\t\t\t\t\t\t,ID_PROCESO DESC\n\t\t\t\t\t\t\t\t) rnk\n\t\t\t\t\t\tFROM (\n\t\t\t\t\t\t\tSELECT NUM_CICLO AS SCICLO\n\t\t\t\t\t\t\t\t,COD_PRODUC\n\t\t\t\t\t\t\t\t,DESC_ESTADO\n\t\t\t\t\t\t\t\t,ESTADO AS ESTADO_PROC\n\t\t\t\t\t\t\t\t,MAX(NRO_LINEA) AS NRO_LINEA\n\t\t\t\t\t\t\t\t,MAX(ID_PROCESO) AS ID_PROCESO\n\t\t\t\t\t\t\tFROM DET\n\t\t\t\t\t\t\tWHERE COD_EMPRESA = 'LIBERTY'\n\t\t\t\t\t\t\t\tAND COD_FORMATO = 'RENOVACION'\n\t\t\t\t\t\t\t\tAND ESTADO <> 'E'\n\t\t\t\t\t\t\t\tAND ESTADO <> 'E_CEL'\n\t\t\t\t\t\t\tGROUP BY SCICLO\n\t\t\t\t\t\t\t\t,COD_PRODUC\n\t\t\t\t\t\t\t\t,DESC_ESTADO\n\t\t\t\t\t\t\t\t,ESTADO_PROC\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t\tWHERE RNK = 1\n\t\t\t\t\t) P ON M.SCICLO = P.SCICLO\n\t\t\t\tLEFT OUTER JOIN (\n\t\t\t\t\tSELECT SPRODUC AS COD_PRODUC\n\t\t\t\t\t\t,COBJASE\n\t\t\t\t\tFROM PROD\n\t\t\t\t\t) Q ON P.COD_PRODUC = Q.COD_PRODUC\n\t\t\t\tLEFT OUTER JOIN (\n\t\t\t\t\tSELECT DISTINCT SPRODUCN AS COD_PRODUC\n\t\t\t\t\t\t,CRENOVA AS CRENOVA_PRO\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT SPRODUCA\n\t\t\t\t\t\t\t,SPRODUCN\n\t\t\t\t\t\t\t,CRENOVA\n\t\t\t\t\t\tFROM CDP_ODS.SISAXIS_HOMOLOGA_PRODUCTOS\n\t\t\t\t\t\t)\n\t\t\t\t\t) R ON P.COD_PRODUC = R.COD_PRODUC\n\t\t\t\t)\n\t\t\t) CICLO ON a.npoliza = CICLO.npoliza\n\t\tLEFT OUTER JOIN (\n\t\t\tSELECT x.sseguro AS sseguro\n\t\t\t\t,x.nmovimis AS nmovimis\n\t\t\t\t,CASE \n\t\t\t\t\tWHEN CMI_PROPUESTA_1.ctipdoc = 1\n\t\t\t\t\t\tTHEN 'Propuesta'\n\t\t\t\t\tELSE 'Endoso'\n\t\t\t\t\tEND AS doc_type\n\t\t\tFROM (\n\t\t\t\tSELECT sseguro\n\t\t\t\t\t,nmovimis\n\t\t\t\t\t,sciclo\n\t\t\t\tFROM DOC\n\t\t\t\t) x\n\t\t\tLEFT JOIN CMI_PROPUESTA_1 ON x.sciclo = CMI_PROPUESTA_1.sciclo\n\t\t\t\tAND CRAMO IN (\n\t\t\t\t\t1\n\t\t\t\t\t,6\n\t\t\t\t\t,11\n\t\t\t\t\t,12\n\t\t\t\t\t,13\n\t\t\t\t\t,14\n\t\t\t\t\t,16\n\t\t\t\t\t,17\n\t\t\t\t\t,20\n\t\t\t\t\t,22\n\t\t\t\t\t,23\n\t\t\t\t\t,24\n\t\t\t\t\t)\n\t\t\t) DOC_TYPE ON a.sseguro = DOC_TYPE.sseguro\n\t\t\tAND a.nmovimi = DOC_TYPE.nmovimis\n\t\t\tAND a.source = 'cuadre'\n\t\t) SRC\n\t) SRC1\nLEFT JOIN (\n\tSELECT 1 AS DUMMY\n\t\t,MAX(fact_renovaciones_integrado_key) AS MAX_SID\n\tFROM cdp_dwh.fact_renovaciones_integrado_t\n\t) LKP ON LKP.DUMMY = 1\nWHERE rnk = 1"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.temp_fact_renovaciones_integrado_t where src_sys_cd='axis';\ndelete from cdp_dwh.fact_renovaciones_integrado_t where src_sys_cd='axis';"
    }
]