[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "with br_con as (\nselect * from (\nselect * from (\nselect \nbr.fact_policy_item_mv_key, \nbr.year, \nbr.month, \nbr.company_name, \nbr.convenio_id, \nbr.broker_rut_no, \nbr.branch_office_cd_1, \nbr.ramo_plan,\ncon.sales_exec_rut as rut_ejecutivo,\ncon.sales_exec_name as ejecutivo,\ncon.branch_office_name_2 as sucursal,\ncon.management_name as gerencia,\ncon.regional_name as regional\nfrom \ncdp_dwh.base_ramo br\nleft join cdp_dwh.con \non \nbr.convenio_id=con.convenio_id and\nbr.company_name=con.company_name and\nbr.broker_rut_no=con.broker_rut_num and\nbr.branch_office_cd_1=con.branch_office_cd_1 and\nbr.year  >= con.year_curr and\nbr.month >= con.month_curr and\nbr.year  <= con.year_nxt and\nbr.month <  con.month_nxt )\n\nwhere  \n(  ( sucursal is not null and gerencia is not null and regional is not null)\nor ( sucursal <> '' and gerencia <> '' and regional <> '') \nor ( gerencia not like 'Sin Asignar' and regional not like 'Sin Asignar' and sucursal not like 'Sin Asignar' )\nor ( gerencia not like '' and regional not like '' and sucursal not like '' ))\n)\n),\n\nbr_con_cor as (\nselect \nbrc.fact_policy_item_mv_key, \nbrc.year, \nbrc.month, \nbrc.company_name, \nbrc.convenio_id, \nbrc.broker_rut_no, \nbrc.branch_office_cd_1, \nbrc.ramo_plan,\ncor.sales_exec_rut as rut_ejecutivo,\ncor.sales_exec_name as ejecutivo,\ncor.branch_office_name_2 as sucursal,\ncor.management_name as gerencia,\ncor.regional_name as regional\nfrom (\nselect * from (\nselect \nbr.fact_policy_item_mv_key, \nbr.year, \nbr.month, \nbr.company_name, \nbr.convenio_id, \nbr.broker_rut_no, \nbr.branch_office_cd_1, \nbr.ramo_plan,\ncon.sales_exec_rut as rut_ejecutivo,\ncon.sales_exec_name as ejecutivo,\ncon.branch_office_name_2 as sucursal,\ncon.management_name as gerencia,\ncon.regional_name as regional\nfrom \ncdp_dwh.base_ramo br\nleft join cdp_dwh.con \non \nbr.convenio_id=con.convenio_id and\nbr.company_name=con.company_name and\nbr.broker_rut_no=con.broker_rut_num and\nbr.branch_office_cd_1=con.branch_office_cd_1 and\nbr.year  >= con.year_curr and\nbr.month >= con.month_curr and\nbr.year  <= con.year_nxt and\nbr.month <  con.month_nxt )\nwhere (sucursal is null and gerencia is null and regional is null) or\n      (sucursal = '' and gerencia = '' and regional = '') or \n      (sucursal LIKE '' and gerencia LIKE '' and regional LIKE '') or\n      (gerencia LIKE 'Sin Asignar' and regional LIKE 'Sin Asignar' and sucursal LIKE 'Sin Asignar')\n) brc left join\n      cdp_dwh.cor on\nbrc.company_name=cor.company_name and\nbrc.broker_rut_no=cor.broker_rut_num and\nbrc.branch_office_cd_1=cor.branch_office_cd_1 and\nbrc.year  >= cor.year_curr and\nbrc.month >= cor.month_curr and\nbrc.year  <= cor.year_nxt and\nbrc.month <  cor.month_nxt\n)\n\nselect\nfact_policy_item_mv_key,  \ncase when (ramo_plan is null or ramo_plan = '') then 'Sin Asignar' else ramo_plan end as ramo_plan,\ncase when (rut_ejecutivo is null or rut_ejecutivo = '') then 'Sin Asignar' else rut_ejecutivo end as rut_ejecutivo,\ncase when (ejecutivo is null or ejecutivo = '') then 'Sin Asignar' else ejecutivo end as ejecutivo,\ncase when (sucursal is null or  sucursal  = '') then 'Sin Asignar' else sucursal end as sucursal,\ncase when (gerencia is null or  gerencia  = '') then 'Sin Asignar' else gerencia end as gerencia,\ncase when (regional is null or  regional  = '') then 'Sin Asignar' else regional end as regional \nfrom (\nselect * from br_con\nunion\nselect * from br_con_cor\nwhere \n      (sucursal is not null and gerencia is not null and regional is not null) or \n      (sucursal not LIKE '' and gerencia not LIKE '' and regional not LIKE '') or\n      (sucursal not LIKE '' and gerencia not LIKE '' and regional not LIKE '')\nunion\n\nselect * from (\n        select \n        brcc.fact_policy_item_mv_key, \n        brcc.year, \n        brcc.month, \n        brcc.company_name, \n        brcc.convenio_id, \n        brcc.broker_rut_no, \n        brcc.branch_office_cd_1, \n        brcc.ramo_plan,\n        '' as rut_ejecutivo,\n        '' as ejecutivo,\n        suc.branch_office_name_2 as sucursal,\n        suc.management_name as gerencia,\n        suc.regional_name as regional \n        from\n        (\n        select * from br_con_cor\n        where\n              (sucursal is null and gerencia is null and regional is null) or \n              (sucursal = '' and gerencia = '' and regional = '') or\n              (sucursal LIKE '' and gerencia LIKE '' and regional LIKE '') or\n              (gerencia LIKE 'Sin Asignar' and regional LIKE 'Sin Asignar' and sucursal LIKE 'Sin Asignar')) brcc\n        left join \n        cdp_dwh.suc on\n        brcc.company_name = suc.company_name and\n        brcc.branch_office_cd_1 = suc.branch_office_cd_1 and\n        brcc.year  >= suc.year_curr and\n        brcc.month >= suc.month_curr and\n        brcc.year  <= suc.year_nxt and\n        brcc.month <  suc.month_nxt )\n);"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "drop table if exists cdp_dwh.base_ramo;\nselect * into cdp_dwh.base_ramo from (\nselect \nbase.fact_policy_item_mv_key,\nbase.year,\nbase.month,\nbase.company_name,\nbase.convenio_id,\nbase.broker_rut_no,\nbase.branch_office_cd_1,\nramo.ramo_plan\nfrom\n(select \nv.fact_policy_item_mv_key,\nsubstring(b.broker_id,1,length(b.broker_id)-1) as broker_rut_no,\nv.src_sys_cd as company_name,\ncast(v.acct_mth as int) as month, \ncast(v.acct_yr as int) as year, \nv.agreement as convenio_id,\ns.branch_office_cd as branch_office_cd_1,\nr.lob_cd as codigo_ramo,\nsales_exec_rut,\nsales_exec_name,\nbranch_office_name_2,\nmanagement_name,\nregional_name\nfrom \ncdp_dwh.fact_policy_prem_comm_summary_t v \nleft join cdp_dwh.dim_broker_t b on v.dim_broker_key = b.dim_broker_key  and b.broker_id <>''\nleft join cdp_dwh.dim_branch_office_t s on v.dim_branch_office_key  = s.dim_branch_office_key\nleft join cdp_dwh.dim_lob_t r on v.dim_lob_key = r.dim_lob_key and v.acct_yr>=2018 and v.acct_mth>=1) base\n\nleft join\n(\nselect year as year_curr,\nmonth as month_curr,\ncase when year=mx.mx_year then 2999 else mx.mx_year end as year_nxt,\ncase when month=mx.mx_month then 13 else mx.mx_month end as month_nxt,\nbase.company,\nbase.codigo_ramo,\nbase.ramo_plan\nfrom \n(select * from cdp_dwh.dim_pln_ramo_plan_t\nwhere rec_crt_dtm=(select max(rec_crt_dtm) from cdp_dwh.dim_pln_ramo_plan_t))base\nleft join\n(select codigo_ramo, company, max(year) as mx_year,max(month) as mx_month \nfrom cdp_dwh.dim_pln_ramo_plan_t group by codigo_ramo, company) mx \non base.codigo_ramo=mx.codigo_ramo and base.company=mx.company\n) ramo\n\non base.codigo_ramo = ramo.codigo_ramo and\nbase.company_name = ramo.company and\n(base.year >= ramo.year_curr and\nbase.month >=ramo.month_curr and\nbase.year <= ramo.year_nxt and\nbase.month < ramo.month_nxt));\ndrop table if exists cdp_dwh.con;\nselect * into cdp_dwh.con from\n(\nselect year as year_curr,\nmonth as month_curr,\ncase when year=mx.mx_year then 2999 else mx.mx_year end as year_nxt,\ncase when month=mx.mx_month then 13 else mx.mx_month end as month_nxt,\nbase.convenio_id,\nbase.company_name,\nbase.broker_rut_num,\nbase.branch_office_cd_1,\nsales_exec_rut,\nsales_exec_name,\nbranch_office_name_2,\nmanagement_name,\nregional_name \nfrom \n(select * from cdp_dwh.dim_pln_convenio_t\nwhere rec_crt_dtm=(select max(rec_crt_dtm) from cdp_dwh.dim_pln_convenio_t))base\nleft join\n(select convenio_id, company_name, broker_rut_num, branch_office_cd_1, max(year) as mx_year, max(month) as mx_month \nfrom cdp_dwh.dim_pln_convenio_t group by convenio_id, company_name, broker_rut_num, branch_office_cd_1) mx \non \nbase.convenio_id = mx.convenio_id and\nbase.company_name = mx.company_name and\nbase.broker_rut_num = mx.broker_rut_num and\nbase.branch_office_cd_1 = mx.branch_office_cd_1\n);\ndrop table if exists cdp_dwh.cor;\nselect * into cdp_dwh.cor from \n(select year as year_curr,\nmonth as month_curr,\ncase when year=mx.mx_year then 2999 else mx.mx_year end as year_nxt,\ncase when month=mx.mx_month then 13 else mx.mx_month end as month_nxt,\nbase.company_name,\nbase.broker_rut_num,\nbase.branch_office_cd_1,\nsales_exec_rut,\nsales_exec_name,\nbranch_office_name_2,\nmanagement_name,\nregional_name \nfrom \n(select * from cdp_dwh.dim_pln_broker_t\nwhere rec_crt_dtm=(select max(rec_crt_dtm) from cdp_dwh.dim_pln_broker_t))base\nleft join\n(select company_name, broker_rut_num, branch_office_cd_1, max(year) as mx_year,max(month) as mx_month \nfrom cdp_dwh.dim_pln_broker_t group by company_name, broker_rut_num, branch_office_cd_1) mx \non base.company_name = mx.company_name and\nbase.broker_rut_num = mx.broker_rut_num and\nbase.branch_office_cd_1 = mx.branch_office_cd_1\n);\ndrop table if exists cdp_dwh.suc;\nselect * into cdp_dwh.suc from (\nselect year as year_curr,\nmonth as month_curr,\ncase when year=mx.mx_year then 2999 else mx.mx_year end as year_nxt,\ncase when month=mx.mx_month then 13 else mx.mx_month end as month_nxt,\nbase.company_name,\nbase.branch_office_cd_1,\nbase.branch_office_name_1,\nbranch_office_name_2,\nmanagement_name,\nregional_name \nfrom \n(select * from cdp_dwh.dim_pln_branch_office_t\nwhere rec_crt_dtm=(select max(rec_crt_dtm) from cdp_dwh.dim_pln_branch_office_t)) base\nleft join\n(select company_name, branch_office_cd_1, max(year) as mx_year, max(month) as mx_month \nfrom cdp_dwh.dim_pln_branch_office_t group by company_name, branch_office_cd_1) mx \non base.company_name = mx.company_name and\nbase.branch_office_cd_1 = mx.branch_office_cd_1\n);"
    }
]