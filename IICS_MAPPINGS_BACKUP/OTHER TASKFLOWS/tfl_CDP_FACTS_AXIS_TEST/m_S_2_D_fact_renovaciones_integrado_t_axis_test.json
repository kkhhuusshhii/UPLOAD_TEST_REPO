[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "--updated main fact query\n\nWITH T AS (\nSELECT policy_num,policy_item_id,policy_item_num,policy_eff_dt,policy_exp_dt,\npolicyholder_rut_num,insured_rut_num,plate_number,Lob_mkt_ref_code \nFROM CDP_DWH.TEMP_FACT_RENOVACIONES_INTEGRADO_T_TEST \nwhere src_sys_cd='axis'\n),\n\nPREV_POL AS (\nselect policy_num,previous_policy,policy_item_id from(\nselect x1.policy_num,x2.policy_num AS previous_policy,\nx1.policy_item_id, x1.policy_item_num, x1.policy_eff_dt, x1.policy_exp_dt,\nx2.policy_item_id as policy_item_id2, x2.policy_item_num as policy_item_num2,\nx2.policy_eff_dt, x2.policy_exp_dt,\nROW_NUMBER() OVER (PARTITION BY x1.policy_item_id order by x1.policy_num desc, x2.policy_num desc) as R1\nfrom \n(SELECT * FROM T) X1\nleft join\n(select * FROM T) X2\nON\nX1.policyholder_rut_num=X2.policyholder_rut_num AND\nX1.plate_number=X2.plate_number AND\nX1.Lob_mkt_ref_code=X2.Lob_mkt_ref_code AND\nX1.policy_eff_dt = X2.policy_exp_dt\n)where R1=1\n),\n\n\nINS_PREV_POL AS (\nselect policy_num,ins_previous_policy,policy_item_id from(\nselect x1.policy_num,x3.policy_num as ins_previous_policy,\nx1.policy_item_id, x1.policy_item_num, x1.policy_eff_dt, x1.policy_exp_dt,\nx3.policy_item_id as policy_item_id2, x3.policy_item_num as policy_item_num2,\nx3.policy_eff_dt, x3.policy_exp_dt,\nROW_NUMBER() OVER (PARTITION BY x1.policy_item_id order by x1.policy_num desc, x3.policy_num desc) as R1\nfrom \n(SELECT * FROM T) X1\nleft join\n(select * from T) X3\nON\nX1.insured_rut_num=X3.insured_rut_num AND\nX1.plate_number=X3.plate_number AND\nX1.Lob_mkt_ref_code=X3.Lob_mkt_ref_code AND\nX1.policy_eff_dt = X3.policy_exp_dt\n)where R1=1\n),\n\nNEXT_POL AS (\nselect policy_num,next_policy,policy_item_id from(\nselect x1.policy_num,x2.policy_num AS next_policy,\nx1.policy_item_id, x1.policy_item_num, x1.policy_eff_dt, x1.policy_exp_dt,\nx2.policy_item_id as policy_item_id2, x2.policy_item_num as policy_item_num2,\nx2.policy_eff_dt, x2.policy_exp_dt,\nROW_NUMBER() OVER (PARTITION BY x1.policy_item_id order by x1.policy_num desc, x2.policy_num desc) as R1\nfrom \n(SELECT * FROM T) X1\nleft join\n(select * FROM T) X2\nON\nX1.policyholder_rut_num=X2.policyholder_rut_num AND\nX1.plate_number=X2.plate_number AND\nX1.Lob_mkt_ref_code=X2.Lob_mkt_ref_code AND\nX1.policy_exp_dt = X2.policy_eff_dt\n)where R1=1\n),\n\nINS_NEXT_POL AS (\nselect policy_num,ins_next_policy,policy_item_id from(\nselect x1.policy_num,x3.policy_num as ins_next_policy,\nx1.policy_item_id, x1.policy_item_num, x1.policy_eff_dt, x1.policy_exp_dt,\nx3.policy_item_id as policy_item_id2, x3.policy_item_num as policy_item_num2,\nx3.policy_eff_dt, x3.policy_exp_dt,\nROW_NUMBER() OVER (PARTITION BY x1.policy_item_id order by x1.policy_num desc, x3.policy_num desc) as R1\nfrom \n(SELECT * FROM T) X1\nleft join\n(select * from T) X3\nON\nX1.insured_rut_num=X3.insured_rut_num AND\nX1.plate_number=X3.plate_number AND\nX1.Lob_mkt_ref_code=X3.Lob_mkt_ref_code AND\nX1.policy_exp_dt = X3.policy_eff_dt\n)where R1=1\n)\nSELECT \nfact_renovaciones_integrado_key,\nsrc_sys_cd, \npolicy_item_id,\npolicy_item_num,\npolicy_num, \ncase when policy_num <> previous_policy then previous_policy else null end as previous_policy,\ncase when policy_num <> next_policy then next_policy else null end as next_policy,\npolicy_issue_dt,\npolicy_exp_dt, \npolicy_status_desc, \nfacult_ind,\ncoins_type_cd,\npolicy_curr_cd,\nfacult_prem_amt,\nbroker_comm_amt,\ndim_lob_key,\ndim_broker_key,\ndim_branch_office_key,\ndim_policyholder_key,\npolicyholder_rut_num,\ndim_prd_pln_hrchy_key,\ndim_insured_key,\ninsured_rut_num,\nrec_crt_dtm,\nrec_updt_dtm,\nactv_rec_ind,\netl_audit_id,\npolicy_eff_dt,\nacct_yr,\nacct_mth,\nagreement,\nfleet_ind,\nvalid_ind,\ndocument_type,\nitem_renovated_ind,\nsales_type,\ncycle_number,\ncycle_state,\nrenovation_type,\n--item_type,\nLob_mkt_ref_code,\nplate_number,\ngwp_amt,\naffects_direct_premium_amt,\nexempt_direct_premium_amt,\nnew_direct_premium_amt,\nrenewal_direct_premium_amt,\nendorsement_direct_premium_amt,\nmv_id,\nmv_reason_cd,\nmv_reason_desc\nFROM \n(\nSELECT \nfact.fact_renovaciones_integrado_key,\nfact.src_sys_cd, \nfact.policy_item_id,\nfact.policy_item_num,\nfact.policy_num, \ncase when fact.item_type='No Renovables' then '0'\nwhen fact.item_type='No Flota' then ipp.ins_previous_policy\nwhen fact.item_type='Otros' then pp.previous_policy\nend as previous_policy,\ncase when fact.item_type='No Renovables' then '0'\nwhen fact.item_type='No Flota' then inp.ins_next_policy\nwhen fact.item_type='Otros' then np.next_policy\nend as next_policy,\nfact.policy_issue_dt,\nfact.policy_exp_dt, \nfact.policy_status_desc, \nfact.facult_ind,\nfact.coins_type_cd,\nfact.policy_curr_cd,\nfact.facult_prem_amt,\nfact.broker_comm_amt,\n--fact.dim_policy_key,\nfact.dim_lob_key,\nfact.dim_broker_key,\nfact.dim_branch_office_key,\nfact.dim_policyholder_key,\nfact.policyholder_rut_num,\nfact.dim_prd_pln_hrchy_key,\nfact.dim_insured_key,\nfact.insured_rut_num,\nfact.rec_crt_dtm,\nfact.rec_updt_dtm,\nfact.actv_rec_ind,\nfact.etl_audit_id,\nfact.policy_eff_dt,\nfact.acct_yr,\nfact.acct_mth,\nfact.agreement,\nfact.fleet_ind,\nfact.valid_ind,\nfact.document_type,\nfact.item_renovated_ind,\nfact.sales_type,\nfact.cycle_number,\nfact.cycle_state,\nfact.renovation_type,\n--fact.item_type,\nfact.Lob_mkt_ref_code,\nfact.plate_number,\nfact.gwp_amt,\nfact.affects_direct_premium_amt,\nfact.exempt_direct_premium_amt,\nfact.new_direct_premium_amt,\nfact.renewal_direct_premium_amt,\nfact.endorsement_direct_premium_amt,\nfact.mv_id,\nfact.mv_reason_cd,\nfact.mv_reason_desc\nfrom cdp_dwh.temp_fact_renovaciones_integrado_t_test fact\nleft join  PREV_POL pp\non pp.policy_item_id=fact.policy_item_id\nleft join  INS_PREV_POL ipp\non ipp.policy_item_id=fact.policy_item_id\nleft join  NEXT_POL np\non np.policy_item_id=fact.policy_item_id\nleft join  INS_NEXT_POL inp\non inp.policy_item_id=fact.policy_item_id\nwhere fact.src_sys_cd='axis'\nand fact.acct_yr >= '2015'\n)"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.oprRuntimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.fact_renovaciones_integrado_t_test where src_sys_cd='axis'; "
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.fact_renovaciones_integrado_t_test where src_sys_cd='axis'; "
    }
]