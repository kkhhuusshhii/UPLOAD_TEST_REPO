[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select \n(nvl(LKP_MAXSID.MAX_SID,0)+p.rnm) dim_broker_key,\nbroker_id,\nbroker_rut_num,\nbroker_name,\ncontact_name,\ncontact_email,\ncontact_phone,\nactive_recd_ind,\nba.etl_audit_id,\n rec_crt_dtm ,\nrec_updt_dtm\nfrom(select \nbroker_id,\nbroker_rut_num,\nbroker_name,\ncontact_name,\ncontact_email,\ncontact_phone,\n'Y' active_recd_ind,\ncurrent_date as rec_crt_dtm ,\ncurrent_date as rec_updt_dtm,\n1 dummy,\n row_number() over(order by  broker_id) rnm \nfrom \n (SELECT distinct null contact_email,\n null contact_phone,\n a.Agt_Nombre broker_name,\n a.Agt_Rut||'-'||a.Agt_DigVer broker_rut_num,\n a.Agt_Rut||'-'||a.Agt_DigVer broker_id,\n null contact_name,\n a.Agt_Estado broker_status\n from cdp_ods.bd_produ_x_pro_poliza p inner join cdp_ods.agtmst_grlagt_agentes a \n on a.Agt_Rut = p.pol_int_rutcor) src) p\nleft join\n(select 1 as dummy, max(dim_broker_key) as MAX_SID from cdp_dwh.dim_broker_t) LKP_MAXSID\non p.dummy = LKP_MAXSID.dummy\nleft join \n  (select distinct etl_audit_id,1 as dummy from cdp_dwh.dim_insured_t where src_sys_cd ='penta') ba \n  on p.dummy =ba.dummy\nwhere 1=2"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.dim_broker_t where src_sys_cd='penta';\ncommit;\n\ninsert into cdp_dwh.dim_broker_t(dim_broker_key,\nbroker_id,\nbroker_rut_num,\nbroker_name,\ncontact_name,\ncontact_email,\ncontact_phone,\nbroker_status,\nbroker_person_type_cd,\nbroker_person_type_cd_desc,\nsrc_sys_cd,\nactv_rec_ind,\netl_audit_id,\nrec_crt_dtm ,\nrec_updt_dtm)\nselect distinct (nvl(LKP_MAXSID.MAX_SID,0)+src.rnm) dim_broker_key,\nbroker_id,\nbroker_rut_num,\nbroker_name,\ncontact_name,\ncontact_email,\ncontact_phone,\nbroker_status,\nbroker_person_type_cd,\nbroker_person_type_cd_desc,\nsrc_sys_cd,\nactive_recd_ind,\nba.etl_audit_id,\nrec_crt_dtm ,\nrec_updt_dtm from(\nselect  distinct\nbroker_id,\np.broker_rut_num,\nbroker_name,\ncontact_name,\ncontact_email,\ncontact_phone,\nbroker_status,\nbroker_person_type_cd,\nbroker_person_type_cd_desc,\nsrc_sys_cd,\nactive_recd_ind,\nrec_crt_dtm ,\nrec_updt_dtm,\n1 dummy,\nrnm\n from(select distinct\nbroker_id,\nbroker_rut_num,\nbroker_name,\ncontact_name,\ncontact_email,\ncontact_phone,\nbroker_status,\nnull broker_person_type_cd,\nnull broker_person_type_cd_desc,\n'Y' active_recd_ind,\ncurrent_date as rec_crt_dtm ,\ncurrent_date as rec_updt_dtm,\n'penta' src_sys_cd,\n1 dummy,\n row_number() over(order by  broker_id) rnm \nfrom \n (SELECT distinct null contact_email,\n null contact_phone,\n a.Agt_Nombre broker_name,\n a.Agt_Rut||a.Agt_DigVer broker_rut_num,\n a.Agt_Rut||a.Agt_DigVer broker_id,\n null contact_name,\n a.Agt_Estado broker_status\n from cdp_ods.bd_produ_x_pro_poliza p inner join cdp_ods.agtmst_grlagt_agentes a \n on a.Agt_Rut = p.pol_int_rutcor)) p\n left join\n (select distinct broker_rut_num from cdp_dwh.dim_broker_t\n where src_sys_cd='axis') bro_axis\n on bro_axis.broker_rut_num=p.broker_rut_num\n where bro_axis.broker_rut_num is null) src\nleft join\n(select 1 as dummy, max(dim_broker_key) as MAX_SID from cdp_dwh.dim_broker_t) LKP_MAXSID\non src.dummy = LKP_MAXSID.dummy\nleft join \n  (select distinct etl_audit_id,1 as dummy from cdp_dwh.dim_insured_t where src_sys_cd ='penta') ba \n  on src.dummy =ba.dummy\n  "
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "update cdp_dwh.dim_claim_t\nset dim_broker_key = BROKER_KEY_UPD.dim_broker_key\nfrom \n  (\n    select \n      distinct dbkr.dim_broker_key,broker_rut_num,cast(tper.per_int_poliza as integer) as policy_id,\n            cast(tper.per_int_poliza as varchar(35)) as policy_num, cast(tper.per_int_sinies as varchar(35)) as claim_num  \n    from\n      cdp_dwh.dim_claim_t dclm\n      left outer join cdp_ods.bd_sinie_x_sin_perfil tper\n        on dclm.claim_num = tper.per_int_sinies\n      left outer join cdp_ods.bd_produ_x_pro_poliza tpol\n        on tper.per_int_poliza = tpol.pol_int_poliza\n      left outer join cdp_dwh.dim_broker_t dbkr\n        on tpol.pol_int_rutcor = substring(dbkr.broker_rut_num, 1, length(dbkr.broker_rut_num)-1)\n        and dbkr.src_sys_cd in ('axis', 'penta') \n    where\n      dclm.src_sys_cd='penta'\n  )BROKER_KEY_UPD JOIN\nCDP_DWH.DIM_CLAIM_T CLAIM\nON CLAIM.CLAIM_NUM = BROKER_KEY_UPD.claim_num\nAND CLAIM.policy_id = BROKER_KEY_UPD.policy_id\nAND CLAIM.policy_num = BROKER_KEY_UPD.policy_num\nAND src_sys_cd='penta' ; /*Added as part of DID-229.*/\n \nCOMMIT; "
    }
]