[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select \ndistinct cast('penta' as varchar(10)) src_sys_cd,\ncast(driver.claim_num as varchar(35)) claim_num,\ncast(driver.claimant_num as integer) claimant_num,\ncast(driver.loss_item_num as integer) loss_item_num,\ncast(driver.curr_code as varchar(10)) curr_code,\ncast(nvl(dim_claim.dim_claim_key,0) as integer) dim_claim_key,\ncast(nvl(dim_claim_analyst.dim_claim_analyst_key,0) as integer) dim_claim_Analyst_key,\n--cast(nvl(dim_branch_office_1.dim_branch_office_key,dim_branch_office_2.dim_branch_office_key,0) as integer) dim_branch_office_key,\ncast(nvl(dim_branch_office.dim_branch_office_key,0) as integer) dim_branch_office_key,   --DID222\ncast(nvl(dim_claim_adjuster_1.dim_claim_adjuster_key,dim_claim_adjuster_2.dim_claim_adjuster_key,0) as integer) dim_claim_adjuster_key,\n--cast(nvl(dim_claim_type_1.dim_claim_type_key,dim_claim_type_2.dim_claim_type_key,0) as integer) dim_claim_type_key,\ncast(nvl(dim_claim_type.dim_claim_type_key,0) as integer) dim_claim_type_key,   --DID222\ncast(nvl(lob1.dim_lob_key,0)as integer) dim_line_of_business_key,\t\t\t--DID-199\ncast(nvl(dim_claimant.dim_claimant_key,0) as integer) dim_claimant_key,\ncast(nvl(dim_loss_item.dim_loss_item_key,0) as integer) dim_loss_item_key,\ncast(0 as integer) dim_bodyshop_location_key,\ncast((case when driver.claimant_num=1 then nvl(dim_bdshp_1.dim_bdshp_key,0) else nvl(dim_bdshp_2.dim_bdshp_key,0) end ) as integer) dim_bodyshop_key,\ncast((case when driver.claimant_num=1 then first_order_creation_date_insured.order_creation_dt else first_order_creation_date_thirdparty.order_creation_dt end) as date) first_order_dt,\ncast((case when driver.claimant_num=1 then claim_open_1.fechaestado else claim_open_2.fechaestado end) as date) claim_open_date,\ncast((case when driver.claimant_num=1 then  claim_close_1.fechaestado  else  claim_close_2.fechaestado end) as date) claim_cls_dt,\ncast((case when driver.claimant_num=1 then  claim_rejection_1.fechaestado  else  claim_rejection_2.fechaestado  end) as date) claim_rejection_dt,\ncast((case when driver.claimant_num=1 then  claim_cancelation_1.fechaestado  else  claim_cancelation_2.fechaestado  end) as date) claim_cancel_dt,\ncast(NULL as date) claim_reopen_dt,\ncast(0 as smallint) tasks_count,\ncast((case when driver.claimant_num=1 then tot_oc_insured.total_order_count else tot_oc_third.total_order_count end) as smallint) total_order_count,\ncast(0 as smallint) as total_adj_count,\ncast(0 as smallint) as total_awarded_adj_count,\n--cast((case when driver.claimant_num=1 then nvl(D1.dim_claim_status_key,0) else nvl(dim_claim_status_2.dim_claim_status_key,0) \ncast(nvl(D1.dim_claim_status_key,0) as integer) dim_claim_status_key,\t\t--DID-198\ncast(total_dis_amt.total_discount_amt as numeric(25,10)) total_discount_amt,\ncast(tot_order_cost_amt.total_order_cost_amt as numeric(25,10)) total_order_cost_amt,\ncast(0 as numeric(25,10)) total_other_income_amt,\ncast((case when loss_paymant_amt.total_loss_payment_amt>0 then loss_paymant_amt.total_loss_payment_amt else est_loss_payment_amt.total_est_loss_payment_amt end ) as numeric(25,10)) total_estimated_loss_amt,\ncast(tot_reserv_amt.total_reserve_amt as numeric(25,10)) total_claim_reserve_amt, \ncast(loss_paymant_amt.total_loss_payment_amt as numeric(25,10)) total_loss_payment_amt,\ncast(0 as numeric(25,10)) total_legal_fees_amt,\ncast(spare_parts_cost_amt.total_spare_parts_amt as numeric(25,10)) total_spare_parts_cost_amt,\ncast(access_cost_amt.total_accessory_cost_amt as numeric(25,10)) total_accessory_cost_amt,\ncast(total_dudct_amt.total_deductible_amt as numeric(25,10)) total_deductible_amt,\ncast(0 as numeric(25,10)) total_other_expense_amt,\ncast(0 as numeric(25,10)) total_recov_expense_amt,\ncast(tot_recv_amt.total_recov_amt as numeric(25,10)) total_recov_amt,\ncast(0 as numeric(25,10)) total_labor_cost_amt,\ncast(driver.record_eff_dtm as timestamp) record_eff_dtm,\n--cast('9999-12-31 23:59:59' as timestamp) record_exp_dtm,\ncast(null as char(1)) latest_record_ind,\ncast(LKP.MAX_SID as integer) as MAX_SID  \nfrom (select distinct claim_num, claimant_num, loss_item_num, curr_code, record_eff_dtm,path_ind,party_ind from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) driver \n\n/******DIM_Claim_Key*********/\nleft outer join\n(select claim_num,dim_claim_key from cdp_dwh.dim_claim_t where src_sys_cd = 'penta')dim_claim\non driver.claim_num=dim_claim.claim_num\n\n\n/******Dim_Claim_Analyst_Key*********/\nleft outer join\n(select --RutUsuario --Analista \ndim_claim_analyst.dim_claim_analyst_key, d.claim_num,record_eff_dtm,analyst_rut_num,\nrow_number() over(partition by d.claim_num,d.record_eff_dtm order by a.fecbolfac desc, dim_claim_analyst.dim_claim_analyst_key desc) as row_num\n--select * \nfrom cdp_ods.SnsMst_SinPag_AprPagDet a\ninner join cdp_stg_dwh.stg_fact_loss_history_t_penta_driver d\non a.siniestro = d.claim_num\nand d.record_eff_dtm >= a.fecbolfac\ninner join cdp_dwh.dim_claim_analyst_t dim_claim_analyst\non dim_claim_analyst.analyst_rut_num = a.RutUsuario\nand dim_claim_analyst.src_sys_cd = 'penta'\n--and d.claim_num = '34190'\n) dim_claim_analyst\non driver.claim_num = dim_claim_analyst.claim_num\nand driver.record_eff_dtm=dim_claim_analyst.record_eff_dtm\nand row_num = '1'\n\n/*********Dim_Branch_Office_Key******/\n--DID222\nleft outer join\n(\nselect distinct per_int_sinies,dim_branch_office_key from cdp_dwh.dim_branch_office_t d\ninner join cdp_ods.bd_sinie_x_sin_perfil s\non s.per_tin_oficin = d.branch_office_id\nand d.src_sys_cd = 'penta'\n) dim_branch_office\non driver.claim_num = dim_branch_office.per_int_sinies\n\n--DID222 end\n\n/*********Dim_Claim_Adjuster******/\n/****Insured*****/\nleft outer join\n(\nselect distinct dap_int_sinies,dim_claim_adjuster_key\nfrom cdp_ods.bd_sinie_x_sin_danos_propios p\ninner join cdp_dwh.dim_claim_adjuster_t d\non p.dap_int_rutliq = d.adjuster_id\nwhere d.src_sys_cd = 'penta'\n)dim_claim_adjuster_1\non driver.claim_num = dim_claim_adjuster_1.dap_int_sinies\n/*****Third party*****/\nleft outer join\n(\nselect distinct dat_int_sinies,dim_claim_adjuster_key\nfrom cdp_ods.bd_sinie_x_sin_danos_tercero t\ninner join cdp_dwh.dim_claim_adjuster_t d\non t.dat_int_rutabo = d.adjuster_id\nwhere d.src_sys_cd = 'penta'\n)dim_claim_adjuster_2\non driver.claim_num = dim_claim_adjuster_2.dat_int_sinies\n\n\n\n/******Dim_Claim_Type_Key*****/\n--DID222 \nleft outer join\n(\nselect distinct per_int_sinies,dim_claim_type_key from cdp_dwh.dim_claim_type_t d\ninner join cdp_ods.bd_sinie_x_sin_perfil s\non s.per_tin_tiposiniestro = d.claim_type_cd\nwhere d.src_sys_cd = 'penta'\n) dim_claim_type\non driver.claim_num = dim_claim_type.per_int_sinies\n\n--DID222 end\n/******Dim_Line_Of_Business--Insured*****/ \t--DID-199\n\nleft outer join \n(\nselect distinct tper.per_int_sinies, dlob.dim_lob_key \nfrom cdp_ods.bd_sinie_x_sin_perfil tper\ninner join cdp_dwh.dim_lob_t dlob\non tper.per_tin_ramo = dlob.lob_cd\nand dlob.src_sys_cd = 'penta'\n) lob1\non driver.claim_num = lob1.per_int_sinies\n\n\n/******dim_Claimant_key***********/\nleft outer join\n(select distinct claim_num,claimant_num,dim_claimant_key from cdp_dwh.dim_claimant_t\nwhere src_sys_cd = 'penta') dim_claimant\non driver.claim_num = dim_claimant.claim_num\nand driver.claimant_num=dim_claimant.claimant_num\n\n\n/******dim_loss_item_key***********/\nleft outer join\n(select distinct claim_num,loss_item_num,dim_loss_item_key from cdp_dwh.dim_loss_item_t\nwhere src_sys_cd = 'penta') dim_loss_item\non driver.claim_num = dim_loss_item.claim_num\nand driver.loss_item_num = dim_loss_item.loss_item_num\n\n\n/******dim_Body_shop_key--Insured***********/\nleft outer join\n(select distinct md.nro_siniestro, dim_bdshp_key,\nrow_number() over(partition by md.nro_siniestro order by dim_bdshp_key desc) as row_num\nfrom  \n cdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_sin_perfil p,\ncdp_ods.bd_sinie_x_rsin_sucursal_taller d, \n cdp_dwh.dim_bdshp_t dim\nwhere\nmdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand p.per_int_sinies = md.nro_siniestro  \n and mdet.cod_suc_taller_reparac=d.sucursal_taller\nand mdet.rut_taller_reparac=d.rut_suc_taller\nand dim.bdshp_id = d.rut_suc_taller\nand md.id_tercero=0\nand d.tipo in(1,2)\n)  dim_bdshp_1\non dim_bdshp_1.nro_siniestro=driver.claim_num\nand driver.claimant_num =1\nand dim_bdshp_1.row_num  =1\n\n/******dim_Body_shop_key--Third_Party***********/\nleft outer join\n(select distinct md.nro_siniestro, dim_bdshp_key,\nrow_number() over(partition by md.nro_siniestro order by dim_bdshp_key desc) as row_num\nfrom  \n cdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_sin_perfil p,\ncdp_ods.bd_sinie_x_rsin_sucursal_taller d, \n cdp_dwh.dim_bdshp_t dim\nwhere\nmdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand p.per_int_sinies = md.nro_siniestro  \n and mdet.cod_suc_taller_reparac=d.sucursal_taller\nand mdet.rut_taller_reparac=d.rut_suc_taller\nand dim.bdshp_id = d.rut_suc_taller\nand md.id_tercero>0\nand d.tipo in(1,2)\n)  dim_bdshp_2\non dim_bdshp_2.nro_siniestro=driver.claim_num\nand driver.claimant_num>1\nand dim_bdshp_2.row_num = 1\n\n/******Dim_Claim_StatusKey_Insured*****/\t--DID-198\n\nleft outer join (\n  select\n    a.claim_num claim_num,\n    a.claimant_num claimant_num,\n    a.loss_item_num loss_item_num,\n    a.curr_code curr_code,\n    a.record_eff_dtm record_eff_dtm,\n    a.path_ind path_ind,\n    a.party_ind party_ind,\n    b.codigoestado,\n\tc.dim_claim_status_key dim_claim_status_key,\n    row_number() over(\n      partition by \n        a.claim_num,\n        a.claimant_num,\n        a.loss_item_num,\n        a.curr_code,\n        a.record_eff_dtm,\n        a.path_ind,\n        a.party_ind\n      order by \n        b.correlativo desc, \n        b.fechaestado desc\n    ) as row_num\n  from \n    cdp_stg_dwh.stg_fact_loss_history_t_penta_driver a\n    left outer join (\n      select \n        siniestro as claim_num,\n        case \n          when tipodano = 2 then 'Insured'\n          when tipodano = 1 then 'Thirdparty'\n          else 'Other'\n        end as party_ind,\n        correlativo,\n        fechaestado,\n        codigoestado \n      from \n        cdp_ods.bd_sinie_x_sin_estadoshissiniestro \n      where \n        tipodano in (1,2)\n    ) b\n      on  a.claim_num = b.claim_num\n      and a.party_ind = b.party_ind\n      and a.record_eff_dtm >= trunc(b.fechaestado)\n    left outer join cdp_dwh.dim_claim_status_t c\n      on b.codigoestado = c.claim_status_cd\n      and c.src_sys_cd = 'penta'\n) D1\non driver.claim_num = D1.claim_num\nand driver.claimant_num = D1.claimant_num\nand driver.loss_item_num = D1.loss_item_num\nand driver.curr_code = D1.curr_code\nand driver.record_eff_dtm = D1.record_eff_dtm\nand driver.path_ind = D1.path_ind\nand driver.party_ind = D1.party_ind\nand D1.row_num = 1\n  \n--------Dates--------------\n\nleft outer join\n/******Dim_Claim_open_Date_insured*****/\n(\nselect distinct\nd.claim_num, min(fechaestado) as fechaestado\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro e\ninner join \n(select distinct claim_num from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) d\non e.Siniestro = d.claim_num\nand e.CodigoEstado in ('0','1','2','3','21','22','23') --Abierto\nand tipodano = '2'\ngroup by 1\n)claim_open_1\non driver.claim_num = claim_open_1.claim_num\nand  driver.claimant_num =1 \nleft join\n/******Dim_Claim_open_Date_Third_party*****/\n(\nselect distinct\nd.claim_num, min(fechaestado) as fechaestado\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro e\ninner join \n(select distinct claim_num from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) d\non e.Siniestro = d.claim_num\nand e.CodigoEstado in('0','1','2','3','21','22','23') --Abierto\nand tipodano = '1'\ngroup by 1\n)claim_open_2\non driver.claim_num = claim_open_2.claim_num\nand driver.claimant_num >1 \n \n  left outer join\n/******Claim_Close_Date_Insured*****/\n(\nselect distinct\nd.claim_num, max(fechaestado) as fechaestado\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro e\ninner join \n(select distinct claim_num from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) d\non e.Siniestro = d.claim_num\nand e.CodigoEstado in('4','9','11','12') --Cerrado\nand tipodano = '2'\ngroup by 1\n)claim_close_1\non driver.claim_num = claim_close_1.claim_num\nand driver.claimant_num =1 \n\n  left outer join\n/******Claim_Close_Date_Third_party*****/\n(\nselect distinct\nd.claim_num, max(fechaestado) as fechaestado\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro e\ninner join \n(select distinct claim_num from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) d\non e.Siniestro = d.claim_num\nand e.CodigoEstado in('4','9','11','12') --Cerrado\nand tipodano = '1'\ngroup by 1\n)claim_close_2\non driver.claim_num = claim_close_2.claim_num\nand driver.claimant_num >1 \n\n  left outer join\n/******Claim_Rejection_Insured*****/\n(\nselect distinct\nd.claim_num, max(fechaestado) as fechaestado\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro e\ninner join \n(select distinct claim_num from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) d\non e.Siniestro = d.claim_num\nand e.CodigoEstado in('8','10') --Cerrado\n  and tipodano = '2'\ngroup by 1\n)claim_rejection_1\non driver.claim_num = claim_rejection_1.claim_num\nand driver.claimant_num =1 \n\n  left outer join\n/******Claim_Rejection_Third_party*****/\n(\nselect distinct\nd.claim_num, max(fechaestado) as fechaestado\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro e\ninner join \n(select distinct claim_num from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) d\non e.Siniestro = d.claim_num\nand e.CodigoEstado in('8','10') --Cerrado\n  and tipodano = '1'\ngroup by 1\n)claim_rejection_2\non driver.claim_num = claim_rejection_2.claim_num\nand driver.claimant_num >1 \n\n  left outer join\n/******Claim_Cancelation_insured*****/\n(\nselect distinct\nd.claim_num, max(fechaestado) as fechaestado\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro e\ninner join \n(select distinct claim_num from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) d\non e.Siniestro = d.claim_num\nand e.CodigoEstado in('20') --Cerrado\nand tipodano = '2'\ngroup by 1\n)claim_cancelation_1\non driver.claim_num = claim_cancelation_1.claim_num\nand  driver.claimant_num =1\n\n  left outer join\n/******Claim_Cancelation_third_party*****/\n(\nselect distinct\nd.claim_num, max(fechaestado) as fechaestado\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro e\ninner join \n(select distinct claim_num from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) d\non e.Siniestro = d.claim_num\nand e.CodigoEstado in('20') --Cerrado\nand tipodano = '1'\ngroup by 1\n)claim_cancelation_2\non driver.claim_num = claim_cancelation_2.claim_num\nand driver.claimant_num >1 \n\n\n/******First_Order_date--insured*******/\nleft join\n(\nselect claim_num,order_creation_dt,\nrow_number() over(partition by claim_num order by order_creation_dt) as row_num \nfrom\n(\nSelect distinct\nmd.nro_siniestro as claim_num,\n'1' as insured,\nmin (cast(ov.fecha_creacion_orden as date)) as order_creation_dt\nfrom \ncdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\nwhere ov.codigo_orden_valorizada = mdet.num_orden_valorizada\nand ov.nro_solicitud_pago = sp.nro_solicitud_pago\nand ov.situacion='V'\nand ov.id_mat_dano=mdet.id_mat_danos\nand ov.codigo_oficina=mdet.codigo_oficina\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand  md.id_tercero=0 \n group by 1,2\nunion\nSelect distinct\nmd.nro_siniestro as claim_num,\n'1' as insured,\nmin(cast(oc.fecha as date)) as order_creation_dt\nfrom \ncdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp,\ncdp_ods.bd_sinie_x_rsin_matriz_danos    md\nwhere\noc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \nand oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\nand sc.nro_item_mat_danos=mdet.nro_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor \nand sp.nro_solicitud_pago = oc.nro_solicitud_pago\nand md.id_mat_dano=mdet.id_mat_danos\nand md.codigo_oficina=mdet.codigo_oficina\nand oc.fecha<>''\nand  md.id_tercero=0 \ngroup by 1,2\n) a\n) first_order_creation_date_insured\non driver.claim_num = first_order_creation_date_insured.claim_num\nand driver.claimant_num =1\nand first_order_creation_date_insured.row_num = 1\n\n/******First_Order_date-Thirdparty*******/\nleft join\n(\nselect claim_num,order_creation_dt,\nrow_number() over(partition by claim_num order by order_creation_dt) as row_num \nfrom\n(\nSelect distinct\nmd.nro_siniestro as claim_num,\n'3' as insured,\nmin (cast(ov.fecha_creacion_orden as date)) as order_creation_dt\nfrom \ncdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\nwhere ov.codigo_orden_valorizada = mdet.num_orden_valorizada\nand ov.nro_solicitud_pago = sp.nro_solicitud_pago\nand ov.situacion='V'\nand ov.id_mat_dano=mdet.id_mat_danos\nand ov.codigo_oficina=mdet.codigo_oficina\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand  md.id_tercero>0 \n group by 1,2\nunion\nSelect distinct\nmd.nro_siniestro as claim_num,\n'3' as insured,\nmin(cast(oc.fecha as date))  as order_creation_dt\nfrom \ncdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp,\ncdp_ods.bd_sinie_x_rsin_matriz_danos    md\nwhere\noc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \nand oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\nand sc.nro_item_mat_danos=mdet.nro_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor \nand sp.nro_solicitud_pago = oc.nro_solicitud_pago\nand md.id_mat_dano=mdet.id_mat_danos\nand md.codigo_oficina=mdet.codigo_oficina\nand oc.fecha<>''\nand  md.id_tercero>0\ngroup by 1,2 \n)b\n) first_order_creation_date_thirdparty\non driver.claim_num = first_order_creation_date_thirdparty.claim_num\nand driver.claimant_num >1\nand first_order_creation_date_thirdparty.row_num = 1\n\nleft outer join \n( ------------------------total_order_count insured-----------------------------\n\nselect sum(a.total_order_count) total_order_count,a.nro_siniestro from\n(Select count(distinct  ov.codigo_orden_valorizada) total_order_count,md.nro_siniestro nro_siniestro\nfrom cdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\n--cdp_ods.bd_sinie_x_sin_perfil p,\n--cdp_ods.bd_sinie_x_sin_danos_propios d\nwhere\nov.nro_solicitud_pago = sp.nro_solicitud_pago\nand ov.situacion='V' \nand  ov.codigo_orden_valorizada = mdet.num_orden_valorizada\n  and ov.id_mat_dano=mdet.id_mat_danos\n  and ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  --and mdet.rut_taller_reparac=mdet.codigo_proveedor \n  --and mdet.tipo_detalle_rsd=2\n  --and md.nro_siniestro=p.per_int_sinies\n---and md.nro_siniestro=d. dap_int_sinies\n  and md.id_tercero=0\n  group by md.nro_siniestro\n  \n  union\n--Oc Externa, Insured\nSelect count(distinct oc.num_oc_mg) total_order_count,oc.nro_siniestro nro_siniestro\nfrom cdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp\n--cdp_ods.bd_sinie_x_sin_perfil p,\n--cdp_ods.bd_sinie_x_sin_danos_propios d\nwhere\noc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\n--and sc.numero_item=mdet.nro_item \nand sc.nro_item_mat_danos=mdet.nro_item  -- reempplaza a sc.numero_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago \n --and  oc.nro_siniestro=p.per_int_sinies\n--and oc.nro_siniestro=d. dap_int_sinies\nand md.id_tercero=0\ngroup by oc.nro_siniestro)a \ngroup by nro_siniestro)tot_oc_insured\non driver.claim_num=tot_oc_insured.nro_siniestro \nand driver.claimant_num=1\n  \nleft outer join \n( ------------------------total_order_count thirdparty-----------------------------\nselect sum(b.total_order_count) total_order_count,b.nro_siniestro from\n(Select count(distinct  ov.codigo_orden_valorizada) total_order_count,md.nro_siniestro nro_siniestro\nfrom cdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\n--cdp_ods.bd_sinie_x_sin_perfil p,\n--cdp_ods.bd_sinie_x_sin_danos_tercero te\nwhere\nov.nro_solicitud_pago = sp.nro_solicitud_pago\nand ov.situacion='V' \nand  ov.codigo_orden_valorizada = mdet.num_orden_valorizada\n  and ov.id_mat_dano=mdet.id_mat_danos\nand ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  --and mdet.rut_taller_reparac=mdet.codigo_proveedor --orden_valorizada\n  --and mdet.tipo_detalle_rsd=2\n  --and md.nro_siniestro=p.per_int_sinies\n  --and md.nro_siniestro=te.dat_int_sinies\n  and md.id_tercero>0\n  group by md.nro_siniestro\n\nunion\n--Third Party\nSelect  count(distinct oc.num_oc_mg) total_order_count,oc.nro_siniestro nro_siniestro\nfrom cdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp\n--cdp_ods.bd_sinie_x_sin_perfil p,\n--cdp_ods.bd_sinie_x_sin_danos_tercero te\nwhere\n  oc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\n--and sc.numero_item=mdet.nro_item \nand sc.nro_item_mat_danos=mdet.nro_item  -- reempplaza a sc.numero_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago \n-- and oc.nro_siniestro=p.per_int_sinies\n--and oc.nro_siniestro=te.dat_int_sinies\nand md.id_tercero>0\ngroup by oc.nro_siniestro\n)b\ngroup by nro_siniestro)tot_oc_third\non driver.claim_num=tot_oc_third.nro_siniestro \nand driver.claimant_num>1\n\n\n\n-----total_discount_amt---\n\nleft outer join\n(\nselect distinct \ncast(driver_sub1.claim_num as integer)  claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.cumulative_signups,0) total_discount_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.fecha,\n--row_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code  order by driver_sub1.record_eff_dtm DESC,task_sub1.fecha DESC) as row_num1---testing\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,cast(driver_sub1.record_eff_dtm as date)  order by task_sub1.fecha DESC  ) as row_num1\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(SELECT  total_discount_amt,claim_num,claimant_num,loss_item_num,curr_cd,fecha,cumulative_signups,\n  row_number() over(partition by claim_num,claimant_num,loss_item_num,curr_cd,fecha  order by ROW_NUMS DESC) as row_num\nFROM(\nselect sum(src.total_descuentos) total_discount_amt, \nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.curr_cd,\ncast(src.fecha as date) fecha,\nsum(sum(src.total_descuentos)) over (partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd order by src.fecha,total_discount_amt rows unbounded preceding) as cumulative_signups,\nrow_number() over(partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date) order by src.fecha desc) as row_nums\nfrom\n(\nselect b2.total_descuentos,b2.claim_num,b2.claimant_num,b2.loss_item_num,b2.fecha,b2.curr_cd from\n(select sum(b1.total_descuentos) total_descuentos,b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.fecha,b1.curr_cd from\n(select \nsr.total_descuentos as total_descuentos,\ncast(sr.claim_num as varchar(35)) claim_num,\nnvl(cast((case when sr.id_tercero=0 then c1.claimant_num when sr.id_tercero>0 then c3.claimant_num end) as integer),0) claimant_num,\nnvl(cast((case when sr.id_tercero=0 then l1.loss_item_num when sr.id_tercero>0 then l3.loss_item_num end) as integer),0) loss_item_num,\ncast(x.curr_cd as varchar(10)) curr_cd,\ncast(nvl(sr.recd_dt,'2000-01-01 00:00:00') as date) fecha\nfrom \n(Select  \nov.total_descuentos,\nmd.nro_siniestro claim_num,\nmd.id_tercero,\nmd.patente,\nmdet.id_mat_danos,\nmdet.codigo_oficina,\nov.fecha_creacion_orden recd_dt\nfrom \n cdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\n--cdp_ods.bd_sinie_x_sin_perfil a\nwhere\nov.nro_solicitud_pago = sp.nro_solicitud_pago\n  and ov.situacion='V'\n  and  ov.codigo_orden_valorizada = mdet.num_orden_valorizada\n  and ov.id_mat_dano=mdet.id_mat_danos\n  and ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n-- and mdet.rut_taller_reparac=mdet.codigo_proveedor --orden_valorizada\n  --and mdet.tipo_detalle_rsd=2\n  --and md.nro_siniestro=a.per_int_sinies\n  and md.id_tercero=0\n  --and md.nro_siniestro=@ClaimNumber\nunion\n\nSelect  \nov.total_descuentos,\nmd.nro_siniestro claim_num,\nmd.id_tercero,\nmd.patente,\nmdet.id_mat_danos,\nmdet.codigo_oficina,\nov.fecha_creacion_orden recd_dt\nfrom \n cdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\n--cdp_ods.bd_sinie_x_sin_perfil a\nwhere\nov.nro_solicitud_pago = sp.nro_solicitud_pago\n  and ov.situacion='V' \n  and ov.codigo_orden_valorizada = mdet.num_orden_valorizada\n  and ov.id_mat_dano=mdet.id_mat_danos\n  and ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  --and mdet.rut_taller_reparac=mdet.codigo_proveedor --orden_valorizada\n  ---and mdet.tipo_detalle_rsd=2\n  --and md.nro_siniestro=a.per_int_sinies\n  and md.id_tercero>0\n)sr  \nleft outer join\n/***Insured loss item***/\n(select distinct l4.claim_num,p.per_int_sinies,loss_item_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_loss_item_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.loss_item_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.loss_item_num=1\n)l1\non sr.claim_num = l1.claim_num \n--and sr.per_int_rutase = l1.loss_item_id \nand sr.id_tercero = l1.id_tercero\nand sr.id_mat_danos=l1.id_mat_dano\nand sr.codigo_oficina =l1.codigo_oficina\nand sr.patente = l1.patente\nand sr.id_tercero = 0 \n\n\n--select * from cdp_dwh.dim_loss_item_t\n\n/***3rd party loss item**/\nleft outer join cdp_dwh.dim_loss_item_t l3\non sr.claim_num = l3.claim_num \nand sr.patente = l3.lic_plate_num\nand l3.src_sys_cd ='penta' \nand sr.id_tercero > 0\nand l3.loss_item_num >1\n\n\nleft outer join\n/***Insured Claimant number***/\n(select distinct l4.claim_num,p.per_int_sinies,claimant_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_claimant_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.claimant_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.claimant_num = 1\n)c1\non c1.claim_num = sr.claim_num \n--and l2.per_int_rutase = l4.claimant_id \nand sr.id_tercero = 0\nand sr.id_tercero = c1.id_tercero\nand sr.id_mat_danos=c1.id_mat_dano\nand sr.codigo_oficina =c1.codigo_oficina\nand sr.patente = c1.patente\n\n/***3rd party claimant number**/\nleft outer join \n(select claim_num, split_part(claimant_id,'-',3) as patente ,claimant_num\n,row_number() over(partition by claim_num,split_part(claimant_id,'-',3) order by claimant_num asc) as row_num\nfrom \ncdp_dwh.dim_claimant_t \nwhere src_sys_cd ='penta' \n)c3\non sr.claim_num = c3.claim_num \nand sr.patente = c3.patente \nand sr.id_tercero > 0\nand c3.claimant_num >1\nand c3.row_num = 1\nleft outer join\n(SELECT mkt_ref_code_desc as curr_cd,ref_cd from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='currency_type' and src_sys_cd='penta')X\non 4=X.ref_cd\n)b1\ngroup by b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.fecha,b1.curr_cd)b2\ninner join\n(select distinct claim_num,claimant_num,loss_item_num,curr_code from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) driver\non b2.claim_num=driver.claim_num \nand nvl(b2.claimant_num,0)=driver.claimant_num \nand nvl(b2.loss_item_num,0)=driver.loss_item_num \nand b2.curr_cd=driver.curr_code) src\ngroup by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date),total_descuentos\norder by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date)\n)) task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num \nand task_sub1.curr_cd=driver_sub1.curr_code\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.fecha\nand row_num =1) total_dis_amt\non total_dis_amt.claim_num=driver.claim_num\nand total_dis_amt.claimant_num=driver.claimant_num\nand total_dis_amt.loss_item_num=driver.loss_item_num\nand total_dis_amt.curr_code=driver.curr_code\nand total_dis_amt.record_eff_dtm=driver.record_eff_dtm\nand total_dis_amt.row_num1=1\n\n------------------total_order_cost_amt-------\n\nLeft outer join\n(\nselect distinct \ncast(driver_sub1.claim_num as integer)  claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.cumulative_signups,0) total_order_cost_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.fecha,\n--row_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code  order by driver_sub1.record_eff_dtm DESC,task_sub1.fecha DESC) as row_num1---testing\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,cast(driver_sub1.record_eff_dtm as date)  order by task_sub1.fecha DESC  ) as row_num1\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(SELECT  total_order_cost_amt,claim_num,claimant_num,loss_item_num,curr_cd,fecha,cumulative_signups,\n  row_number() over(partition by claim_num,claimant_num,loss_item_num,curr_cd,fecha  order by ROW_NUMS DESC) as row_num\nFROM(\nselect sum(src.total_order_cost) total_order_cost_amt, \nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.curr_cd,\ncast(src.fecha as date) fecha,\nsum(sum(src.total_order_cost)) over (partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd order by src.fecha,total_order_cost_amt rows unbounded preceding) as cumulative_signups,\nrow_number() over(partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date) order by src.fecha desc) as row_nums\nfrom\n(\nselect sum(b2.total_order_cost) total_order_cost,b2.claim_num,b2.claimant_num,b2.loss_item_num,b2.fecha,b2.curr_cd from\n(select sum(b1.total_order_cost) total_order_cost,b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.fecha,b1.curr_cd,b1.order_num,\nrow_number() over(partition by b1.claim_num ,b1.claimant_num,b1.order_num,b1.fecha order by b1.loss_item_num desc) as row_num  \nfrom\n(select \nsr.total_pago as total_order_cost,\ncast(sr.claim_num as varchar(35)) claim_num,\nnvl(cast((case when sr.id_tercero=0 then c1.claimant_num when sr.id_tercero>0 then c3.claimant_num end) as integer),0) claimant_num,\nnvl(cast((case when sr.id_tercero=0 then l1.loss_item_num when sr.id_tercero>0 then l3.loss_item_num end) as integer),0) loss_item_num,\ncast(x.curr_cd as varchar(10)) curr_cd,\ncast(nvl(sr.recd_dt,'2000-01-01 00:00:00') as date) fecha,\nsr.order_num as  order_num\nfrom \n(Select \nov.total_pago,\nmd.nro_siniestro claim_num,\nmd.id_tercero,\nmd.patente,\nmdet.id_mat_danos,\nmdet.codigo_oficina,\nov.fecha_creacion_orden recd_dt,\ncodigo_orden_valorizada as order_num\nfrom \ncdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\n--cdp_ods.bd_sinie_x_sin_perfil p,\n--cdp_ods.bd_sinie_x_sin_danos_propios d\nwhere\n  ov.nro_solicitud_pago = sp.nro_solicitud_pago\n  and ov.situacion='V'\n  and ov.id_mat_dano=mdet.id_mat_danos\n  and  ov.codigo_orden_valorizada = mdet.num_orden_valorizada \n  and ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  --and mdet.rut_taller_reparac=mdet.codigo_proveedor --orden_valorizada\n  --and mdet.tipo_detalle_rsd=2\n  --and md.nro_siniestro=p.per_int_sinies\n  --and md.nro_siniestro=d. dap_int_sinies\n  and md.id_tercero=0\n--  and md.nro_siniestro=@ClaimNumber\nunion\n\nSelect \nov.total_pago,\nmd.nro_siniestro claim_num,\nmd.id_tercero,\nmd.patente,\nmdet.id_mat_danos,\nmdet.codigo_oficina,\nov.fecha_creacion_orden recd_dt,\ncodigo_orden_valorizada as order_num\nfrom \ncdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\n--cdp_ods.bd_sinie_x_sin_perfil p,\n--cdp_ods.bd_sinie_x_sin_danos_tercero te\nwhere\n  ov.nro_solicitud_pago = sp.nro_solicitud_pago\n  and ov.situacion='V'\n  and ov.id_mat_dano=mdet.id_mat_danos\n  and ov.codigo_oficina=mdet.codigo_oficina\n  and  ov.codigo_orden_valorizada = mdet.num_orden_valorizada \n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  --and mdet.rut_taller_reparac=mdet.codigo_proveedor --orden_valorizada\n  --and mdet.tipo_detalle_rsd=2\n  --and md.nro_siniestro=p.per_int_sinies\n  --and md.nro_siniestro=te.dat_int_sinies\n  and md.id_tercero>0\n  \n  union\n  \n  Select \noc.total,\nmd.nro_siniestro claim_num,\nmd.id_tercero,\nmd.patente,\nmdet.id_mat_danos,\nmdet.codigo_oficina,\noc.fecha_comprobante_conformidad recd_dt,\noc.num_oc_mg as order_num\nfrom \ncdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp\n--cdp_ods.bd_sinie_x_sin_perfil a,\n--cdp_ods.bd_sinie_x_sin_danos_propios d\nwhere\n--oc.nro_siniestro in(@ClaimNumber) and\noc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\n--and sc.numero_item=mdet.nro_item\nand sc.nro_item_mat_danos=mdet.nro_item  -- reempplaza a sc.numero_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago \n --and oc.nro_siniestro=a.per_int_sinies\n--and oc.nro_siniestro=d. dap_int_sinies\nand md.id_tercero=0\n\nunion\n\nSelect \noc.total,\nmd.nro_siniestro claim_num,\nmd.id_tercero,\nmd.patente,\nmdet.id_mat_danos,\nmdet.codigo_oficina,\noc.fecha_comprobante_conformidad recd_dt,\noc.num_oc_mg as order_num\nfrom \ncdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp\n--cdp_ods.bd_sinie_x_sin_perfil a,\n--cdp_ods.bd_sinie_x_sin_danos_tercero te\nwhere\n--oc.nro_siniestro in(@ClaimNumber) and\noc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\n--and sc.numero_item=mdet.nro_item\nand sc.nro_item_mat_danos=mdet.nro_item  -- reempplaza a sc.numero_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago \n --and oc.nro_siniestro=a.per_int_sinies\n--and oc.nro_siniestro=te.dat_int_sinies\nand md.id_tercero>0\n  \n  )sr  \nleft outer join\n/***Insured loss item***/\n(select distinct l4.claim_num,p.per_int_sinies,loss_item_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_loss_item_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.loss_item_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.loss_item_num=1\n)l1\non sr.claim_num = l1.claim_num \n--and sr.per_int_rutase = l1.loss_item_id \nand sr.id_tercero = l1.id_tercero\nand sr.id_mat_danos=l1.id_mat_dano\nand sr.codigo_oficina =l1.codigo_oficina\nand sr.patente = l1.patente\nand sr.id_tercero = 0 \n\n\n--select * from cdp_dwh.dim_loss_item_t\n\n/***3rd party loss item**/\nleft outer join cdp_dwh.dim_loss_item_t l3\non sr.claim_num = l3.claim_num \nand sr.patente = l3.lic_plate_num\nand l3.src_sys_cd ='penta' \nand sr.id_tercero > 0\nand l3.loss_item_num >1\n\n\nleft outer join\n/***Insured Claimant number***/\n(select distinct l4.claim_num,p.per_int_sinies,claimant_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_claimant_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.claimant_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.claimant_num = 1\n)c1\non c1.claim_num = sr.claim_num \n--and l2.per_int_rutase = l4.claimant_id \nand sr.id_tercero = 0\nand sr.id_tercero = c1.id_tercero\nand sr.id_mat_danos=c1.id_mat_dano\nand sr.codigo_oficina =c1.codigo_oficina\nand sr.patente = c1.patente\n\n/***3rd party claimant number**/\nleft outer join \n(select claim_num, split_part(claimant_id,'-',3) as patente ,claimant_num\n,row_number() over(partition by claim_num,split_part(claimant_id,'-',3) order by claimant_num asc) as row_num\nfrom \ncdp_dwh.dim_claimant_t \nwhere src_sys_cd ='penta' \n)c3\non sr.claim_num = c3.claim_num \nand sr.patente = c3.patente \nand sr.id_tercero > 0\nand c3.claimant_num >1\nand c3.row_num = 1\nleft outer join\n(SELECT mkt_ref_code_desc as curr_cd,ref_cd from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='currency_type' and src_sys_cd='penta')X\non 4=X.ref_cd\n)b1\ngroup by b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.fecha,b1.curr_cd,b1.order_num\n)b2\ninner join\n(select distinct claim_num,claimant_num,loss_item_num,curr_code from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) driver\non b2.claim_num=driver.claim_num \nand nvl(b2.claimant_num,0)=driver.claimant_num \nand nvl(b2.loss_item_num,0)=driver.loss_item_num \nand b2.curr_cd=driver.curr_code\nand b2.row_num=1\ngroup by b2.claim_num,b2.claimant_num,b2.loss_item_num,b2.fecha,b2.curr_cd\n) src\ngroup by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date),total_order_cost\norder by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date)\n)) task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num \nand task_sub1.curr_cd=driver_sub1.curr_code\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.fecha\nand row_num =1\n) tot_order_cost_amt\non tot_order_cost_amt.claim_num=driver.claim_num\nand tot_order_cost_amt.claimant_num=driver.claimant_num\nand tot_order_cost_amt.loss_item_num=driver.loss_item_num\nand tot_order_cost_amt.curr_code=driver.curr_code\nand tot_order_cost_amt.record_eff_dtm=driver.record_eff_dtm\nand tot_order_cost_amt.row_num1=1\n\n---------------total_estimated_loss_payment_amt----------------\n\nleft outer join\n(select distinct \ncast(driver_sub1.claim_num as integer)  claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.cumulative_signups,0) total_est_loss_payment_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.FecBolFac,\n--row_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code  order by driver_sub1.record_eff_dtm DESC,task_sub1.FecBolFac DESC) as row_num1\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,cast(driver_sub1.record_eff_dtm as date)  order by task_sub1.FecBolFac DESC  ) as row_num1\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(SELECT  total_est_loss_payment_amt,claim_num,claimant_num,loss_item_num,curr_cd,FecBolFac,cumulative_signups,\n  row_number() over(partition by claim_num,claimant_num,loss_item_num,curr_cd,FecBolFac  order by ROW_NUMS DESC) as row_num\nFROM(\nselect sum(src.MtoBruto) total_est_loss_payment_amt, \nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.curr_cd,\ncast(src.FecBolFac as date) FecBolFac,\nsum(sum(src.MtoBruto)) over (partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd order by src.FecBolFac,total_est_loss_payment_amt rows unbounded preceding) as cumulative_signups,\nrow_number() over(partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.FecBolFac as date) order by src.FecBolFac desc) as row_nums\nfrom\n(select b1.MtoBruto,b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.FecBolFac,b1.curr_cd from\n(select  \nsum(est.amt) as MtoBruto,\nest.claim_num claim_num,\nest.claimant_num  claimant_num,\nest.loss_item_num  loss_item_num,\nest.curr_cd curr_cd,\ncast(nvl(est.record_eff_dtm,'2000-01-01 00:00:00') as date) FecBolFac\nfrom \n(\nselect  \ndriver.cpp_dec_monpxp as amt,\ncast(driver.cpp_int_sinies as varchar(35))claim_num,\ncast((CASE WHEN driver.cpp_tin_tiplab=2 THEN 1\nWHEN driver.cpp_tin_tiplab=1 THEN 3\nELSE (cpp_tin_tiplab + 2) END) AS INTEGER)  claimant_num,\ncast((CASE WHEN driver.cpp_tin_tiplab=2 THEN 1\nWHEN driver.cpp_tin_tiplab=1 THEN 3\nELSE (cpp_tin_tiplab + 2) END) AS INTEGER)  loss_item_num,\ncast(nvl(x.curr_cd,'CLP') as varchar(10))curr_cd,\ncast(driver.cpp_fec_ingres as DATE)record_eff_dtm\nfrom \n(select sum(cpp_dec_monpxp) as cpp_dec_monpxp,cpp_int_sinies,cpp_fec_ingres,cpp_tin_tiplab,cpp_tin_monpxp from cdp_ods.bd_sinie_x_sin_cabecera_perpro where \n(cpp_int_sinies not in (select distinct siniestro from cdp_ods.snsmst_sinpag_aprpagdet)) or \n(cpp_int_sinies in (select distinct siniestro from \n(select distinct sum(MtoBruto),siniestro,codcob from cdp_ods.snsmst_sinpag_aprpagdet group by siniestro,codcob having sum(MtoBruto)=0)))\ngroup by cpp_int_sinies,cpp_fec_ingres,cpp_tin_tiplab,cpp_tin_monpxp)driver\nleft join\n(SELECT distinct mkt_ref_code_desc as curr_cd,ref_cd from \ncdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='currency_type' and src_sys_cd='penta')X\non cast(DRIVER.cpp_tin_monpxp as int)=cast(X.ref_cd as int)\n)est\ngroup by claim_num,claimant_num,loss_item_num,curr_cd,FecBolFac\n)b1\ninner join\n(select distinct claim_num,claimant_num,loss_item_num,curr_code from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) driver\non b1.claim_num=driver.claim_num \nand nvl(b1.claimant_num,0)=driver.claimant_num \nand nvl(b1.loss_item_num,0)=driver.loss_item_num \nand b1.curr_cd=driver.curr_code) src\ngroup by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.FecBolFac as date),MtoBruto\norder by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.FecBolFac as date)\n)) task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num \nand task_sub1.curr_cd=driver_sub1.curr_code\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.FecBolFac\nand row_num =1\n) est_loss_payment_amt\non est_loss_payment_amt.claim_num=driver.claim_num\nand est_loss_payment_amt.claimant_num=driver.claimant_num\nand est_loss_payment_amt.loss_item_num=driver.loss_item_num\nand est_loss_payment_amt.curr_code=driver.curr_code\nand est_loss_payment_amt.record_eff_dtm=driver.record_eff_dtm\nand est_loss_payment_amt.row_num1=1\n\n-------total_reserve_amt--------\n\n\nleft outer join\n(\nselect distinct \ncast(driver_sub1.claim_num as integer)  claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.total_reserve_amt,0) total_reserve_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.fecha,\n--row_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code  order by driver_sub1.record_eff_dtm DESC,task_sub1.fecha DESC) as row_num1\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,cast(driver_sub1.record_eff_dtm as date)  order by task_sub1.fecha DESC  ) as row_nums\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(select sum(b1.reserve_amt) total_reserve_amt,b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.fecha,b1.curr_cd from\n(\nselect \nCAST(gst.Siniestro AS VARCHAR(35)) as claim_num,\ncase \nwhen gst.tipoliquabogado=1\nthen ((nvl(gst.RetensionSinXL,0)-nvl(gst.ProvRetTotal,0)) + nvl(gst.ProvCedFac,0)  + nvl(gst.ProvCedQP,0) + nvl(gst.ProvCedExd,0) + nvl(gst.ProvRetTotal,0)+nvl(gst.ProvOtros,0))  \nwhen gst.tipoliquabogado<>1 or gst.tipoliquabogado is null\nthen ((nvl(gst.RetensionSinXL,0)-nvl(gst.ProvRetTotal,0)) + nvl(gst.ProvCedFac,0)  + nvl(gst.ProvCedQP,0) + nvl(gst.ProvCedExd,0) + nvl(gst.ProvRetTotal,0)+nvl(gst.ProvOtros,0))\nelse null end as reserve_amt, \nCAST((case when gst.tipoliquabogado = 1 then 3\nwhen  gst.tipoliquabogado =2 then 1 else null end) AS INTEGER)  claimant_num,\nCAST((case when gst.tipoliquabogado = 1 then 3\nwhen  gst.tipoliquabogado = 2 then 1 else null end) AS INTEGER) as loss_item_num,\ncast(A.curr_cd as varchar(10)) curr_cd,\ncast(cast(case when AnoContable is null then '1990' else cast(AnoContable as varchar(4)) end ||\ncase when mescontable is null then '01' else (case when length (cast(MesContable as varchar(2)))=1 then '0'|| cast(MesContable as varchar(2)) else  cast(MesContable as varchar(2)) end) end||\ncast('01' as varchar(2)) as varchar(10)) as date) fecha\nfrom cdp_ods.gstmst_gst_provision gst \nleft join \n(SELECT distinct mkt_ref_code_desc as curr_cd,ref_cd from \ncdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='currency_type' and src_sys_cd='penta')A\non 4=A.ref_cd\n)b1\ngroup by b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.fecha,b1.curr_cd)task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num \nand task_sub1.curr_cd=driver_sub1.curr_code\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.fecha\n)tot_reserv_amt\non tot_reserv_amt.claim_num=driver.claim_num\nand tot_reserv_amt.claimant_num=driver.claimant_num\nand tot_reserv_amt.loss_item_num=driver.loss_item_num\nand tot_reserv_amt.curr_code=driver.curr_code\nand tot_reserv_amt.record_eff_dtm=driver.record_eff_dtm\nand tot_reserv_amt.row_nums=1\n\n---total_loss_payment_amt-------\n\n\nleft outer join\n(select distinct \ncast(driver_sub1.claim_num as integer)  claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.cumulative_signups,0) total_loss_payment_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.FecBolFac,\n--row_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code  order by driver_sub1.record_eff_dtm DESC,task_sub1.FecBolFac DESC) as row_num1\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,cast(driver_sub1.record_eff_dtm as date)  order by task_sub1.FecBolFac DESC  ) as row_num1\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(SELECT  total_loss_payment_amt,claim_num,claimant_num,loss_item_num,curr_cd,FecBolFac,cumulative_signups,\n  row_number() over(partition by claim_num,claimant_num,loss_item_num,curr_cd,FecBolFac  order by ROW_NUMS DESC) as row_num\nFROM(\nselect sum(src.MtoBruto) total_loss_payment_amt, \nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.curr_cd,\ncast(src.FecBolFac as date) FecBolFac,\nsum(sum(src.MtoBruto)) over (partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd order by src.FecBolFac,total_loss_payment_amt rows unbounded preceding) as cumulative_signups,\nrow_number() over(partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.FecBolFac as date) order by src.FecBolFac desc) as row_nums\nfrom\n(select b1.MtoBruto,b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.FecBolFac,b1.curr_cd from\n(select  \ndriver.MtoBruto as MtoBruto,\ncast(driver.siniestro as varchar(35))claim_num,\ncast((CASE WHEN driver.codcob=1 THEN nvl(ci.claimant_num,0) \nWHEN driver.codcob=2 THEN nvl(ct.claimant_num,3)\nELSE 0 END) AS INTEGER)  claimant_num,\ncast((CASE WHEN driver.codcob=1 THEN nvl(li.loss_item_num,0) \nWHEN driver.codcob=2 THEN nvl(lt.loss_item_num,3) \nELSE 0 END) AS INTEGER)  loss_item_num,\ncast(x.curr_cd as varchar(10))curr_cd,\ncast(nvl(driver.FecBolFac,'2000-01-01 00:00:00') as date) FecBolFac\nfrom \n(\nselect  sum(MtoBruto) MtoBruto,\nsiniestro,FecBolFac,CodCob,CodMonPag from cdp_ods.snsmst_sinpag_aprpagdet \nwhere siniestro<>0 and CodCob=1 group by siniestro,FecBolFac,CodCob,CodMonPag\nunion\nselect  sum(MtoBruto) MtoBruto,siniestro,FecBolFac,CodCob,CodMonPag from cdp_ods.snsmst_sinpag_aprpagdet \nwhere siniestro<>0 and CodCob=2 group by siniestro,FecBolFac,CodCob,CodMonPag\n)driver\n\nLEFT JOIN \n(SELECT DISTINCT b.codcob,A.claim_num,A.claimant_num FROM cdp_dwh.dim_claimant_t a\nINNER JOIN cdp_ods.snsmst_sinpag_aprpagdet b\nON A.claim_num=b.Siniestro \nand a.claimant_id=b.rutdest\nWHERE A.src_sys_cd='penta' and a.insured_ind='S'and b.codcob=1\n) ci\nON ci.claim_num=driver.Siniestro \nLEFT JOIN\n(SELECT DISTINCT b.codcob,A.claim_num,A.loss_item_num FROM cdp_dwh.dim_loss_item_t A\nINNER JOIN cdp_ods.snsmst_sinpag_aprpagdet b\nON A.claim_num=b.Siniestro\nand cast(nvl(a.loss_item_id,'0') as varchar(35))=cast(b.rutdest as varchar(35))\nWHERE A.src_sys_cd='penta' and a.insured_ind='S' and b.codcob=1\n)li\nON li.claim_num=driver.Siniestro \nLEFT JOIN \n(SELECT DISTINCT b.codcob,A.claim_num,A.claimant_num FROM cdp_dwh.dim_claimant_t a\nINNER JOIN cdp_ods.snsmst_sinpag_aprpagdet b\nON A.claim_num=b.Siniestro \nand a.claimant_id=b.rutdest\nWHERE A.src_sys_cd='penta' and a.insured_ind='N' and b.codcob=2\n) ct\nON ct.claim_num=driver.Siniestro \nLEFT JOIN\n(SELECT DISTINCT b.codcob,A.claim_num,A.loss_item_num FROM cdp_dwh.dim_loss_item_t A\nINNER JOIN cdp_ods.snsmst_sinpag_aprpagdet b\nON A.claim_num=b.Siniestro\nand cast(nvl(a.loss_item_id,'0') as varchar(35))=cast(b.rutdest as varchar(35))\nWHERE A.src_sys_cd='penta' and a.insured_ind='N' and b.codcob=2\n)lt\nON lt.claim_num=driver.Siniestro\nleft join \n(SELECT distinct mkt_ref_code_desc as curr_cd,ref_cd from \ncdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='currency_type' and src_sys_cd='penta')X\non driver.CodMonPag=X.ref_cd\n)b1\n\ninner join\n(select distinct claim_num,claimant_num,loss_item_num,curr_code from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) driver\non b1.claim_num=driver.claim_num \nand nvl(b1.claimant_num,0)=driver.claimant_num \nand nvl(b1.loss_item_num,0)=driver.loss_item_num \nand b1.curr_cd=driver.curr_code) src\ngroup by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.FecBolFac as date),MtoBruto\norder by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.FecBolFac as date)\n)) task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num \nand task_sub1.curr_cd=driver_sub1.curr_code\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.FecBolFac\nand row_num =1\n) loss_paymant_amt\non loss_paymant_amt.claim_num=driver.claim_num\nand loss_paymant_amt.claimant_num=driver.claimant_num\nand loss_paymant_amt.loss_item_num=driver.loss_item_num\nand loss_paymant_amt.curr_code=driver.curr_code\nand loss_paymant_amt.record_eff_dtm=driver.record_eff_dtm\nand loss_paymant_amt.row_num1=1 \n\n---------total_spare_parts_amt----------\nleft outer join\n(\nSelect distinct \ndriver_sub1.claim_num  claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.cumulative_signups,0) total_spare_parts_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.fecha_creacion_orden,\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,cast(driver_sub1.record_eff_dtm as date)  order by task_sub1.fecha_creacion_orden DESC  ) as row_num1\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(SELECT total_spare_parts_amt,claim_num,claimant_num,loss_item_num,curr_code,fecha_creacion_orden,cumulative_signups,\n  row_number() over(partition by claim_num,claimant_num,loss_item_num,curr_code,fecha_creacion_orden  order by ROW_NUMS DESC) as row_num\nFROM(select sum(src.CostoRepuestos) total_spare_parts_amt, \nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.curr_code,\ncast(src.fecha_creacion_orden as date) fecha_creacion_orden,\nsum(sum(src.CostoRepuestos)) over (partition by src.claim_num,src.claimant_num,src.loss_item_num,\nsrc.curr_code order by cast(src.fecha_creacion_orden as date),total_spare_parts_amt rows unbounded preceding) as cumulative_signups\n           ,row_number() over(partition by src.claim_num,src.claimant_num,src.loss_item_num,\n                                   src.curr_code,cast(src.fecha_creacion_orden as date) order by cast(src.fecha_creacion_orden as date)  desc  ) as row_nums\nfrom(select b4.claim_num,b4.claimant_num,b4.loss_item_num ,\nsum(b4.CostoRepuestos) CostoRepuestos,\nb4.fecha_creacion_orden,\ncur_cd.curr_code\n--row_number() over(partition by b4.claim_num ,b4.claimant_num order by b4.loss_item_num desc) as row_num \nfrom\n(select\nb55.claim_num,b55.claimant_num,b55.loss_item_num,b55.CostoRepuestos,b55.fecha_creacion_orden,\nrow_number() over(partition by b55.claim_num ,b55.claimant_num,b55.order_num,fecha_creacion_orden order by b55.loss_item_num desc) as row_num \nfrom(\nselect distinct clm.claim_num,\ncase when clm.id_tercero=0 then l1.loss_item_num\n     when clm.id_tercero>0 then l3.loss_item_num else 0 end loss_item_num,\ncase when clm.id_tercero=0 then c1.claimant_num\n     when clm.id_tercero>0 then c3.claimant_num else 0 end claimant_num,\nclm.CostoRepuestos,\nclm.fecha_creacion_orden,clm.order_num from \n(\nselect sum(CostoRepuestos) CostoRepuestos,claim_num,id_tercero,patente,id_mat_danos,codigo_oficina,fecha_creacion_orden,order_num\nfrom\n(select \n sum (nvl(mdet.costo_item,0) * nvl(mdet.cantidad,1)) CostoRepuestos,\nmd.nro_siniestro claim_num,\nmd.id_tercero,\nmd.patente,\nmdet.id_mat_danos,\n    md.codigo_oficina, \n cast(nvl(mdet.fecha_modif_alta_reg,'20001-01-01 00:00:00') as date)  fecha_creacion_orden\n,codigo_orden_valorizada as order_num\nfrom \n cdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago sp ---- included as per Guillermo sheet\n--cdp_ods.bd_sinie_x_rsin_grupo_repuestos gr\nwhere\nov.situacion='V'\nand ov.nro_solicitud_pago = sp.nro_solicitud_pago                                                                                         \nand  ov.codigo_orden_valorizada = mdet.num_orden_valorizada\nand ov.id_mat_dano=mdet.id_mat_danos\nand mdet.rut_taller_reparac=mdet.codigo_proveedor\n  and ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  group by  md.nro_siniestro, md.id_tercero, md.patente, mdet.id_mat_danos, md.codigo_oficina, cast(nvl(mdet.fecha_modif_alta_reg,'20001-01-01 00:00:00') as date),codigo_orden_valorizada\n     union all\n  \n  Select\n  sum (nvl(mdet.costo_item,0) * nvl(mdet.cantidad,1)) CostoRepuestos,\n   md.nro_siniestro claim_num,\n   md.id_tercero,\n    md.patente, \n    mdet.id_mat_danos,\n    md.codigo_oficina,\n    cast(nvl(mdet.fecha_modif_alta_reg,'20001-01-01 00:00:00') as date) fecha_creacion_orden \n                ,oc.num_oc_mg as order_num \n   from \n cdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp,\ncdp_ods.bd_sinie_x_rsin_grupo_repuestos gr \nwhere \n oc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\n--and sc.numero_item=mdet.nro_item\nand sc.nro_item_mat_danos=mdet.nro_item  -- reempplaza a sc.numero_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand mdet.grupo_pieza =gr.codigo\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago \ngroup by md.nro_siniestro,md.id_tercero,md.patente, mdet.id_mat_danos,md.codigo_oficina,cast(nvl(mdet.fecha_modif_alta_reg,'20001-01-01 00:00:00') as date),num_oc_mg\n) cllm\ngroup by claim_num,id_tercero,patente,id_mat_danos,codigo_oficina,fecha_creacion_orden,order_num\n)clm\n  \nleft outer join\n/***Insured loss item***/\n(select distinct l4.claim_num,p.per_int_sinies,loss_item_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_loss_item_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.loss_item_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.loss_item_num=1\n)l1\non clm.claim_num = l1.claim_num \nand clm.id_tercero = l1.id_tercero\nand clm.id_mat_danos=l1.id_mat_dano\nand clm.codigo_oficina =l1.codigo_oficina\nand clm.patente = l1.patente\nand clm.id_tercero = 0\n\n\n/***3rd party loss item**/\nleft outer join cdp_dwh.dim_loss_item_t l3\non clm.claim_num = l3.claim_num \nand clm.patente = l3.lic_plate_num\nand l3.src_sys_cd ='penta' \nand clm.id_tercero > 0\nand l3.loss_item_num >1\n\nleft outer join\n/***Insured Claimant number***/\n(select distinct l4.claim_num,p.per_int_sinies,claimant_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_claimant_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.claimant_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.claimant_num = 1\n)c1\non c1.claim_num = clm.claim_num \nand clm.id_tercero = 0\nand clm.id_tercero = c1.id_tercero\nand clm.id_mat_danos=c1.id_mat_dano\nand clm.codigo_oficina =c1.codigo_oficina\nand clm.patente = c1.patente\n\n/***3rd party claimant number**/\nleft outer join \n(select claim_num, split_part(claimant_id,'-',3) as patente ,claimant_num\n,row_number() over(partition by claim_num,split_part(claimant_id,'-',3) order by claimant_num asc) as row_num\nfrom \ncdp_dwh.dim_claimant_t \nwhere src_sys_cd ='penta' \n)c3\non clm.claim_num = c3.claim_num \nand clm.patente = c3.patente \nand clm.id_tercero > 0\nand c3.claimant_num >1  \nand c3.row_num = 1) b55\n)b4\ninner join\n(select distinct claim_num,claimant_num,loss_item_num,curr_code from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver \nwhere curr_code='CLP' ) cur_cd\non b4.claim_num=cur_cd.claim_num \nand nvl(b4.claimant_num,0)=cur_cd.claimant_num \nand nvl(b4.loss_item_num,0)=cur_cd.loss_item_num\nand b4.row_num = 1\ngroup by  b4.claim_num,b4.claimant_num,b4.loss_item_num,b4.fecha_creacion_orden,cur_cd.curr_code\n) src \n--where src.row_num=1\ngroup by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_code,cast(src.fecha_creacion_orden as date),CostoRepuestos\norder by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_code,cast(src.fecha_creacion_orden as date)\n)) task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand task_sub1.curr_code=driver_sub1.curr_code\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.fecha_creacion_orden\nand row_num =1) spare_parts_cost_amt\non spare_parts_cost_amt.claim_num=driver.claim_num\nand spare_parts_cost_amt.claimant_num=driver.claimant_num\nand spare_parts_cost_amt.loss_item_num=driver.loss_item_num\nand spare_parts_cost_amt.curr_code=driver.curr_code\nand spare_parts_cost_amt.record_eff_dtm=driver.record_eff_dtm\nand spare_parts_cost_amt.row_num1=1\n\n-----------total_accessory_cost_amt---------------\n\nleft outer join\n(\nSelect distinct \ndriver_sub1.claim_num  claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.cumulative_signups,0) total_accessory_cost_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.recd_dt,\n--row_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,\n--driver_sub1.loss_item_num,driver_sub1.curr_code  order by driver_sub1.record_eff_dtm DESC,task_sub1.recd_dt DESC) as row_num1\n--task_sub1.ROW_NUMS,task_sub1.row_num-----testing\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,\ncast(driver_sub1.record_eff_dtm as date)  order by task_sub1.recd_dt DESC  ) as row_num1\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(SELECT total_accessory_cost_amt,claim_num,claimant_num,loss_item_num,curr_code,recd_dt,cumulative_signups,\n  row_number() over(partition by claim_num,claimant_num,loss_item_num,curr_code,cast(recd_dt as date) \n  order by ROW_NUMS DESC) as row_num\nFROM(select sum(src.tot_access_amt) total_accessory_cost_amt, \nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.curr_code,\ncast(src.recd_dt as date) recd_dt,\nsum(sum(src.tot_access_amt)) over (partition by src.claim_num,src.claimant_num,src.loss_item_num,\nsrc.curr_code order by cast(src.recd_dt as date),total_accessory_cost_amt rows unbounded preceding) as cumulative_signups\n          ,row_number() over(partition by src.claim_num,src.claimant_num,src.loss_item_num,\n                                  src.curr_code,cast(src.recd_dt as date) \n                                   order by cast(src.recd_dt as date) desc \n                                   ) as row_nums\nfrom(\n\nselect b5.claim_num,b5.claimant_num, b5.loss_item_num,b5.recd_dt,sum(b5.tot_access_amt) tot_access_amt,cur_cd1.curr_code\n--row_number() over(partition by b5.claim_num ,b5.claimant_num order by b5.loss_item_num desc) as row_num \nfrom(\nselect \nb53.claim_num,nvl(b53.claimant_num,0) claimant_num,nvl(b53.loss_item_num,0) loss_item_num,b53.recd_dt,b53.tot_access_amt, \nrow_number () over (partition by claim_num,claimant_num,order_num,recd_dt order by loss_item_num) row_num\nfrom\n(\nselect distinct clm_tot_access.claim_num claim_num,\ncase when clm_tot_access.id_tercero=0 then l7.claimant_num\n     when clm_tot_access.id_tercero>0 then l8.claimant_num else 0 end claimant_num,\n                case when clm_tot_access.id_tercero=0 then l5.loss_item_num\n     when clm_tot_access.id_tercero>0 then l6.loss_item_num else 0 end loss_item_num,              \n                clm_tot_access.recd_dt,\n                clm_tot_access.tot_access_amt,order_num from\n(select sum(tot_access_amt) tot_access_amt,claim_num,id_tercero,patente,id_mat_danos,codigo_oficina,recd_dt,order_num\nfrom\n(              \nselect distinct md.nro_siniestro claim_num,\nsum(nvl(mdet.costo_item,0) * nvl(mdet.cantidad,1)) tot_access_amt,\nmd.id_tercero,\nmd.patente,\nmdet.id_mat_danos,\nmdet.codigo_oficina,\ncast(nvl(mdet.fecha_modif_alta_reg,'20001-01-01 00:00:00') as date)  recd_dt\n,codigo_orden_valorizada as order_num\nfrom \n cdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp\nwhere\nov.situacion='V'\n  and ov.id_mat_dano=mdet.id_mat_danos \n  and ov.nro_solicitud_pago = sp.nro_solicitud_pago\n  and  ov.codigo_orden_valorizada = mdet.num_orden_valorizada\n  and ov.codigo_oficina=mdet.codigo_oficina\nand mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  and mdet.grupo_pieza like '%ACG%' \n  and mdet.rut_taller_reparac=mdet.codigo_proveedor\n-- and md.nro_siniestro in   ('40023822')\n  group by md.nro_siniestro,md.id_tercero,md.patente,mdet.id_mat_danos, mdet.codigo_oficina,cast(nvl(mdet.fecha_modif_alta_reg,'20001-01-01 00:00:00') as date),order_num\n\nunion all\n\n  Select distinct oc.nro_siniestro claim_num,\nsum(nvl(sc.costo_repuesto,0) * nvl(sc.cantidad_solicitada,1)) tot_access_amt,\n  md.id_tercero, \n  md.patente, \n  mdet.id_mat_danos, \n  mdet.codigo_oficina,\n  cast(nvl(mdet.fecha_modif_alta_reg,'20001-01-01 00:00:00') as date) recd_dt \n  ,oc.num_oc_mg as order_num  \nfrom \n cdp_ods.bd_sinie_x_rsin_oc_externa     oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\nwhere\noc.nro_solicitud_pago is not null and \n oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\n--and sc.numero_item=mdet.nro_item\nand sc.nro_item_mat_danos=mdet.nro_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand mdet.grupo_pieza like '%ACG%'\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago \n--and md.id_tercero=0 -- Insured\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\n--and md.nro_siniestro in ('40023822') -- ('15168092')\ngroup by oc.nro_siniestro,  md.id_tercero, md.patente,mdet.id_mat_danos,mdet.codigo_oficina, cast(nvl(mdet.fecha_modif_alta_reg,'20001-01-01 00:00:00') as date),order_num\n) clm\ngroup by claim_num,id_tercero,patente,id_mat_danos,codigo_oficina,recd_dt,order_num\n)clm_tot_access\n\n  left outer join\n\n/***Insured loss item***/\n(select distinct l4.claim_num,p.per_int_sinies,loss_item_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_loss_item_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.loss_item_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.loss_item_num=1\n)l5\non clm_tot_access.claim_num = l5.claim_num \n\nand clm_tot_access.id_tercero = l5.id_tercero\nand clm_tot_access.id_mat_danos=l5.id_mat_dano\nand clm_tot_access.codigo_oficina =l5.codigo_oficina\nand clm_tot_access.patente = l5.patente\nand clm_tot_access.id_tercero = 0\n\n\n\n/***3rd party loss item**/\nleft outer join cdp_dwh.dim_loss_item_t l6\non clm_tot_access.claim_num = l6.claim_num \nand clm_tot_access.patente = l6.lic_plate_num\nand l6.src_sys_cd ='penta' \nand clm_tot_access.id_tercero > 0\nand l6.loss_item_num >1\n\n\nleft outer join\n/***Insured Claimant number***/\n(select distinct l4.claim_num,p.per_int_sinies,claimant_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_claimant_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.claimant_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.claimant_num = 1\n)l7\non l7.claim_num = clm_tot_access.claim_num \nand clm_tot_access.id_tercero = 0\nand clm_tot_access.id_tercero = l7.id_tercero\nand clm_tot_access.id_mat_danos=l7.id_mat_dano\nand clm_tot_access.codigo_oficina =l7.codigo_oficina\nand clm_tot_access.patente = l7.patente\n\n/***3rd party claimant number**/\nleft outer join \n(select claim_num, split_part(claimant_id,'-',3) as patente ,claimant_num\n,row_number() over(partition by claim_num,split_part(claimant_id,'-',3) order by claimant_num asc) as row_num\nfrom \ncdp_dwh.dim_claimant_t \nwhere src_sys_cd ='penta' \n)l8\non clm_tot_access.claim_num = l8.claim_num \nand clm_tot_access.patente = l8.patente \nand clm_tot_access.id_tercero > 0\nand l8.claimant_num >1\nand l8.row_num = 1\n)b53\n) b5\ninner join\n(select distinct claim_num,claimant_num,loss_item_num,curr_code from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver \nwhere curr_code='CLP' ) cur_cd1\non b5.claim_num=cur_cd1.claim_num \nand nvl(b5.claimant_num,0)=cur_cd1.claimant_num \nand nvl(b5.loss_item_num,0)=cur_cd1.loss_item_num\nand b5.row_num = 1\ngroup by b5.claim_num,b5.claimant_num, b5.loss_item_num,b5.recd_dt,curr_code\n) src \n--where src.row_num=1\ngroup by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_code,cast(src.recd_dt as date),tot_access_amt\norder by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_code,cast(src.recd_dt as date)\n)) task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand task_sub1.curr_code=driver_sub1.curr_code\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.recd_dt\nand row_num =1\n) access_cost_amt\non access_cost_amt.claim_num=driver.claim_num\nand access_cost_amt.claimant_num=driver.claimant_num\nand access_cost_amt.loss_item_num=driver.loss_item_num\nand access_cost_amt.curr_code=driver.curr_code\nand access_cost_amt.record_eff_dtm=driver.record_eff_dtm\nand access_cost_amt.row_num1=1\n\n\n-------total_deductible_amt--------\n\nleft outer join\n(\nselect distinct \ncast(driver_sub1.claim_num as integer)  claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.cumulative_signups,0) total_deductible_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.fecha,\n--row_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code  order by driver_sub1.record_eff_dtm DESC,task_sub1.fecha DESC) as row_num1-----testing\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,cast(driver_sub1.record_eff_dtm as date)  order by task_sub1.fecha DESC  ) as row_num1\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(SELECT  total_deductible_amt,claim_num,claimant_num,loss_item_num,curr_cd,fecha,cumulative_signups,\n  row_number() over(partition by claim_num,claimant_num,loss_item_num,curr_cd,fecha  order by ROW_NUMS DESC) as row_num\nFROM(\nselect sum(src.total_deducible) total_deductible_amt, \nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.curr_cd,\ncast(src.fecha as date) fecha,\nsum(sum(src.total_deducible)) over (partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd order by src.fecha,total_deductible_amt rows unbounded preceding) as cumulative_signups,\nrow_number() over(partition by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date) order by src.fecha desc) as row_nums\nfrom\n(\nselect b2.total_deducible,b2.claim_num,b2.claimant_num,b2.loss_item_num,b2.fecha,b2.curr_cd from\n(select sum(b1.total_deducible) total_deducible,b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.fecha,b1.curr_cd from\n(select \nsr.total_deducible as total_deducible,\ncast(sr.claim_num as varchar(35)) claim_num,\nnvl(cast((case when sr.id_tercero=0 then c1.claimant_num when sr.id_tercero>0 then c3.claimant_num end) as integer),0) claimant_num,\nnvl(cast((case when sr.id_tercero=0 then l1.loss_item_num when sr.id_tercero>0 then l3.loss_item_num end) as integer),0) loss_item_num,\ncast(x.curr_cd as varchar(10)) curr_cd,\ncast(nvl(sr.recd_dt,'2000-01-01 00:00:00') as date) fecha\nfrom \n(Select  \nv.total_deducible,\na.nro_siniestro claim_num,\na.id_tercero,\na.patente,\nb.id_mat_danos,\nb.codigo_oficina,\nv.fecha_creacion_orden recd_dt\nfrom \n cdp_ods.bd_sinie_x_rsin_orden_valorizada  v,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  a,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos b\nwhere\na.id_mat_dano =b.id_mat_danos  and\na.codigo_oficina =b.codigo_oficina and \nb.codigo_oficina=v.codigo_oficina and\nb.id_mat_danos =v.id_mat_dano and \n--b.rut_taller_reparac=b.codigo_proveedor and\nv.situacion='V' and\nv.nro_solicitud_pago = sp.nro_solicitud_pago and \nv.codigo_orden_valorizada = b.num_orden_valorizada and\na.id_tercero=0 \n-- and a.nro_siniestro=@ClaimNumber\n\nunion\n\nSelect  \nv.total_deducible,\na.nro_siniestro claim_num,\na.id_tercero,\na.patente,\nb.id_mat_danos,\nb.codigo_oficina,\nv.fecha_creacion_orden recd_dt\nfrom \n cdp_ods.bd_sinie_x_rsin_orden_valorizada  v,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  a,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos b\nwhere\na.id_mat_dano =b.id_mat_danos  and\na.codigo_oficina =b.codigo_oficina and \n b.codigo_oficina=v.codigo_oficina and\nb.id_mat_danos =v.id_mat_dano and\n--b.rut_taller_reparac=b.codigo_proveedor and\nv.situacion='V' and\nv.nro_solicitud_pago = sp.nro_solicitud_pago and \nv.codigo_orden_valorizada = b.num_orden_valorizada and\na.id_tercero>0 \n-- and a.nro_siniestro=@ClaimNumber\n)sr  \nleft outer join\n/***Insured loss item***/\n(select distinct l4.claim_num,p.per_int_sinies,loss_item_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_loss_item_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.loss_item_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.loss_item_num=1\n)l1\non sr.claim_num = l1.claim_num \n--and sr.per_int_rutase = l1.loss_item_id \nand sr.id_tercero = l1.id_tercero\nand sr.id_mat_danos=l1.id_mat_dano\nand sr.codigo_oficina =l1.codigo_oficina\nand sr.patente = l1.patente\nand sr.id_tercero = 0 \n\n\n--select * from cdp_dwh.dim_loss_item_t\n\n/***3rd party loss item**/\nleft outer join cdp_dwh.dim_loss_item_t l3\non sr.claim_num = l3.claim_num \nand sr.patente = l3.lic_plate_num\nand l3.src_sys_cd ='penta' \nand sr.id_tercero > 0\nand l3.loss_item_num >1\n\n\nleft outer join\n/***Insured Claimant number***/\n(select distinct l4.claim_num,p.per_int_sinies,claimant_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_claimant_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.claimant_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.claimant_num = 1\n)c1\non c1.claim_num = sr.claim_num \n--and l2.per_int_rutase = l4.claimant_id \nand sr.id_tercero = 0\nand sr.id_tercero = c1.id_tercero\nand sr.id_mat_danos=c1.id_mat_dano\nand sr.codigo_oficina =c1.codigo_oficina\nand sr.patente = c1.patente\n\n/***3rd party claimant number**/\nleft outer join \n(select claim_num, split_part(claimant_id,'-',3) as patente ,claimant_num\n,row_number() over(partition by claim_num,split_part(claimant_id,'-',3) order by claimant_num asc) as row_num\nfrom \ncdp_dwh.dim_claimant_t \nwhere src_sys_cd ='penta' \n)c3\non sr.claim_num = c3.claim_num \nand sr.patente = c3.patente \nand sr.id_tercero > 0\nand c3.claimant_num >1\nand c3.row_num = 1\nleft outer join\n(SELECT mkt_ref_code_desc as curr_cd,ref_cd from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='currency_type' and src_sys_cd='penta')X\non 4=X.ref_cd\n)b1\ngroup by b1.claim_num,b1.claimant_num,b1.loss_item_num,b1.fecha,b1.curr_cd)b2\ninner join\n(select distinct claim_num,claimant_num,loss_item_num,curr_code from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver) driver\non b2.claim_num=driver.claim_num \nand nvl(b2.claimant_num,0)=driver.claimant_num \nand nvl(b2.loss_item_num,0)=driver.loss_item_num \nand b2.curr_cd=driver.curr_code) src\ngroup by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date),total_deducible\norder by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.fecha as date)\n)) task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num \nand task_sub1.curr_cd=driver_sub1.curr_code\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.fecha\nand row_num =1\n) total_dudct_amt\non total_dudct_amt.claim_num=driver.claim_num\nand total_dudct_amt.claimant_num=driver.claimant_num\nand total_dudct_amt.loss_item_num=driver.loss_item_num\nand total_dudct_amt.curr_code=driver.curr_code\nand total_dudct_amt.record_eff_dtm=driver.record_eff_dtm\nand total_dudct_amt.row_num1=1\n\n-------------------total_recover_amt-------\n\nleft outer join\n(select distinct \nCAST(driver_sub1.claim_num AS INTEGER) claim_num,\ndriver_sub1.claimant_num  claimant_num,\ndriver_sub1.loss_item_num  loss_item_num,\ndriver_sub1.curr_code  curr_code,\nnvl(task_sub1.cumulative_signups,0) total_recov_amt,\ndriver_sub1.record_eff_dtm record_eff_dtm,\ntask_sub1.sal_fec_fecha_ingreso,\n--row_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code order by driver_sub1.record_eff_dtm DESC,task_sub1.sal_fec_fecha_ingreso DESC) as row_num1---testing\nrow_number() over(partition by driver_sub1.claim_num,driver_sub1.claimant_num,driver_sub1.loss_item_num,driver_sub1.curr_code,cast(driver_sub1.record_eff_dtm as date)  order by task_sub1.sal_fec_fecha_ingreso DESC  ) as row_num1\nFROM cdp_stg_dwh.stg_fact_loss_history_t_penta_driver driver_sub1\ninner join\n(SELECT total_recov_amt,claim_num,claimant_num,loss_item_num,curr_cd,sal_fec_fecha_ingreso,cumulative_signups,\n  row_number() over(partition by claim_num,claimant_num,loss_item_num,curr_cd,sal_fec_fecha_ingreso  order by ROW_NUMS DESC) as row_num\nFROM\n(select sum(src.SAL_MON_MONTO_CIR_MP) total_recov_amt, \nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.curr_cd,\ncast(src.sal_fec_fecha_ingreso as date) sal_fec_fecha_ingreso,\nsum(sum(src.SAL_MON_MONTO_CIR_MP)) over (partition by src.claim_num,src.curr_cd order by src.sal_fec_fecha_ingreso,total_recov_amt rows unbounded preceding) as cumulative_signups,\nrow_number() over(partition by src.claim_num,src.curr_cd,cast(src.sal_fec_fecha_ingreso as date) order by src.sal_fec_fecha_ingreso desc) as row_nums\nfrom\n(select b3.SAL_MON_MONTO_CIR_MP,b3.claim_num,b3.claimant_num,b3.loss_item_num,b3.sal_fec_fecha_ingreso,b3.curr_cd from\n(select SAL_MON_MONTO_CIR_MP,\ncast(driver.SAL_INT_SINIESTRO as varchar(35))claim_num,\ncast(1 AS INTEGER )claimant_num,\ncast(1 AS INTEGER )loss_item_num,\ncast(x.curr_cd as varchar(10))curr_cd,\ncast(nvl(driver.SAL_FEC_FECHA_INGRESO ,'2000-01-01 00:00:00')as DATE)sal_fec_fecha_ingreso\nfrom (select sum(SAL_MON_MONTO_CIR_MP) SAL_MON_MONTO_CIR_MP,SAL_INT_SINIESTRO,SAL_TIN_COD_MONEDA_MP,SAL_FEC_FECHA_INGRESO \nfrom cdp_ods.bd_sinie_x_cir_salvataje_recupero where SAL_INT_SINIESTRO<>0 and SAL_TIN_ESTADO <> 5\ngroup by SAL_INT_SINIESTRO,SAL_TIN_COD_MONEDA_MP,SAL_FEC_FECHA_INGRESO)driver\nleft join\n(SELECT distinct mkt_ref_code_desc as curr_cd,ref_cd from \ncdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='currency_type' and src_sys_cd='penta')X\non DRIVER.SAL_TIN_COD_MONEDA_MP=X.ref_cd \n)b3\ninner join\n(select distinct claim_num,claimant_num,loss_item_num,curr_code from cdp_stg_dwh.stg_fact_loss_history_t_penta_driver)driver\non b3.claim_num=driver.claim_num \nand nvl(b3.claimant_num,0)=driver.claimant_num \nand nvl(b3.loss_item_num,0)=driver.loss_item_num\nand b3.curr_cd=driver.curr_code) src\ngroup by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.sal_fec_fecha_ingreso as date),SAL_MON_MONTO_CIR_MP\norder by src.claim_num,src.claimant_num,src.loss_item_num,src.curr_cd,cast(src.sal_fec_fecha_ingreso as date)\n)) task_sub1\non task_sub1.claim_num = driver_sub1.claim_num\nand nvl(task_sub1.claimant_num,0) =driver_sub1.claimant_num\nand task_sub1.curr_cd=driver_sub1.curr_code\nand nvl(task_sub1.loss_item_num,0) =driver_sub1.loss_item_num\nand cast(driver_sub1.record_eff_dtm as date)>=task_sub1.sal_fec_fecha_ingreso\nand row_num =1\n) tot_recv_amt\non tot_recv_amt.claim_num=driver.claim_num\nand tot_recv_amt.claimant_num=driver.claimant_num\nand tot_recv_amt.loss_item_num=driver.loss_item_num\nand tot_recv_amt.curr_code=driver.curr_code\nand tot_recv_amt.record_eff_dtm=driver.record_eff_dtm\nand tot_recv_amt.row_num1=1\n\nLEFT JOIN (SELECT 1 as DUMMY, max(fact_loss_key) AS MAX_SID from cdp_dwh.fact_loss_history_t) LKP\nON LKP.DUMMY=1\norder by driver.claim_num,driver.claimant_num,driver.curr_code, driver.record_eff_dtm"
    },
    {
        "type": "customQuery",
        "path": "content.transformations[1].dataAdapter.object.customQuery",
        "value": "select fact_loss_key,src_sys_cd,claim_num,claimant_num,loss_item_num,curr_cd,rec_check_sum ,rec_eff_dtm from cdp_dwh.fact_loss_history_t\nwhere ltst_rec_ind ='Y' and src_sys_cd = 'penta'\nORDER BY src_sys_cd,claim_num,claimant_num,loss_item_num,curr_cd,fact_loss_key"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[12].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.fact_loss_history_t\nwhere src_sys_cd='penta';\ncommit;"
    }
]