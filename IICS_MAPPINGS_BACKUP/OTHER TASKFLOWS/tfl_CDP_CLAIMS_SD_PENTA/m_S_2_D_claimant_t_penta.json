[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "SELECT  \n(SRC1.MAX_SID+SRC1.num) as dim_claimant_key,\nSRC1.claim_num,\nSRC1.claimant_name,\nSRC1.claimant_id,\nSRC1.claimant_num,\nSRC1.insured_indicator as insured_ind,\nSRC1.at_fault as at_fault_ind,\nSRC1.create_dtm as src_sys_crt_dtm,\nSRC1.communa_cd as claimant_loc_comuna_cd,\nSRC1.communa_loc_name claimant_loc_comuna_name,\nSRC1.country_cd as cntry_cd,\nSRC1.country_name as cntry_name,\nSRC1.src_sys_cd,\nSRC1.rut_invol as claimant_rut_num,\nSRC1.legal_defense_indicator as lgl_defense_ind,\nSRC1.legal_recovery_indicator as lgl_recov_ind,\nSRC1.dim_region_key,\nSRC1.actv_rec_ind,\nSRC1.audit_id as etl_audit_id,\nSRC1.rec_crt_dtm,\nSRC1.rec_updt_dtm,\nSRC1.claimant_type_cd,\nSRC1.claimant_type_desc,\nSRC1.material_recovery_indicator as material_recov_ind,\nnvl(SRC1.location_region_cd,'0') as claimant_loc_region_cd \nfrom\n(\nselect\nROW_NUMBER() over (PARTITION BY claim_num , claimant_id,claimant_num  order by claim_num) as row_nums, \nrow_number() over (order by claim_num) num, \n1 as dummy,\nSRC.claim_num,\nSRC.claimant_name,\nSRC.claimant_id, \nSRC.claimant_num, \nSRC.insured_indicator,\nSRC.at_fault,  \nSRC.create_dtm,\nSRC.communa_cd , \nSRC.communa_loc_name, \nSRC.country_cd, \nSRC.country_name, \nSRC.src_sys_cd,\nSRC.rut_invol,\nSRC.legal_defense_indicator,\nSRC.legal_recovery_indicator,\n'Y' as actv_rec_ind,\nSRC.dim_region_key  , \nca.etl_audit_id as audit_id,\nCURRENT_DATE as rec_crt_dtm,\nCURRENT_DATE as rec_updt_dtm,\nSRC.claimant_type_cd, \nSRC.claimant_type_desc, \nSRC.material_recovery_indicator,\nSRC.location_region_cd,\nNVL(TGT.MAX_SID,0) as MAX_SID\nfrom\n(SELECT \nat_fault,\nlegal_recovery_indicator , \nmaterial_recovery_indicator, \nlegal_defense_indicator, \nclaim_num , \nclaimant_id, \nclaimant_num , \nclaimant_name , \nrut_invol , \ncountry_cd  , \ncountry_name  , \ncommuna_cd  , \ncommuna_loc_name ,\ndim_region_key  ,  \nclaimant_type_cd    , \nclaimant_type_desc , \ninsured_indicator , \ninsured_identifier , \ncreate_dtm,\nsrc_sys_cd,\nlocation_region_cd,\nDUMMY\nFROM \n(\nSELECT   \nCAST(drvr.at_fault_ind AS VARCHAR(100))  AS at_fault,\nCASE WHEN drvr.claimant_type_code = '1' AND ins_def_ind.def_ind IS NOT NULL  THEN ins_def_ind.def_ind \nWHEN drvr.claimant_type_code > '1' AND  tparty_def_ind.tparty_ind IS NOT NULL  THEN tparty_def_ind.tparty_ind\nELSE 'N' END AS legal_defense_indicator,\n\nCASE WHEN drvr.claimant_type_code = '1' AND mat_recov_ind_insured.def_ind IS NOT NULL THEN mat_recov_ind_insured.def_ind \nWHEN drvr.claimant_type_code > '1' THEN NULL\nELSE 'N' END AS material_recovery_indicator,\n\nCASE WHEN drvr.claimant_type_code = '1' AND legal_recov_ind_insured.def_ind IS NOT NULL THEN legal_recov_ind_insured.def_ind \nWHEN drvr.claimant_type_code > '1' AND legal_recov_ind_tparty.tparty_ind IS NOT NULL THEN legal_recov_ind_tparty.tparty_ind\nELSE 'N' END AS legal_recovery_indicator,\n\nCAST(drvr.clm_num as VARCHAR(100))     AS claim_num , \nCAST(drvr.claimant_identifier as VARCHAR(100)) AS claimant_id  , ( \nCASE \nWHEN (drvr.claimant_type_code = '1')  THEN 1 \nWHEN (drvr.claimant_type_code = '3')  THEN CAST(drvr.cnt as INTEGER) + 2\nWHEN (drvr.claimant_type_code = '2 ') THEN 2 \nELSE 0 \nEND) AS claimant_num , \nCAST(translate(drvr.claimant_name,'#','') as VARCHAR(100))    AS claimant_name ,  --modified as part of DID_238\nCAST(drvr.claimant_rut_num  as VARCHAR(100)) AS  rut_invol , \n'152'  AS  country_cd  , \n'CHILE'  AS  country_name  , \nCOALESCE(CAST(communa.mkt_ref_code AS VARCHAR(20)), CAST(penta_comuna.comuna_cd AS VARCHAR(20))) AS communa_cd ,\nCOALESCE(CAST(communa.mkt_ref_code_desc AS VARCHAR(20)), CAST(communa.ref_desc AS VARCHAR(20))) AS  communa_loc_name,            \nCoalesce(rt1.dim_region_key, 0)      AS   dim_region_key  , \nCAST(drvr.claimant_type_code AS VARCHAR(100)) AS  claimant_type_cd    , \nCAST(drvr.claimant_type_desc AS VARCHAR(200)) AS claimant_type_desc , ( \nCASE \nWHEN clm.per_int_rutase <> 0 AND drvr.claimant_type_code=1  THEN 'S' \nELSE 'N' \nEND) AS insured_indicator , ( \nCASE \nWHEN clm.per_int_rutase <> 0  AND drvr.claimant_type_code=1  THEN CAST(clm.per_int_rutase AS VARCHAR(200))\nELSE '0' \nEND) AS insured_identifier, \nper_fec_ingres AS create_dtm,\n'penta'  AS\nsrc_sys_cd ,\n( CASE \nWHEN  drvr.claimant_type_code=1  THEN Coalesce(cast(mv.mkt_ref_code as varchar(20)), cast(region.reg_cd as varchar(20)))\nELSE '0' \nEND) AS location_region_cd ,\n1 as DUMMY,\nROW_NUMBER() over (PARTITION BY claim_num , claimant_id  order by claimant_num ) as rnk1                  \nFROM  ( \nSELECT per_int_sinies AS clm_num, \nCAST(per_int_rutase AS VARCHAR(100)) AS claimant_identifier, \nper_cha_nomase AS claimant_name, \nper_int_rutase AS claimant_rut_num, \n'1'            AS claimant_type_code, \n'Asegurado'    AS claimant_type_desc, \n''             AS at_fault_ind, \n--Rank() over (PARTITION BY per_int_sinies ORDER BY per_int_rutase DESC) AS RNK,\n1 as cnt                           \nFROM   cdp_ods.bd_sinie_x_sin_perfil \nUNION \nSELECT t.ter_int_sinies AS clm_num, \nCAST(t.ter_int_sinies || DECODE (TRIM(t.ter_nro_correlativo),null,'','-'||t.ter_nro_correlativo) || DECODE(t.ter_cha_patent,'','','-'||t.ter_cha_patent) AS VARCHAR(100))  AS claimant_identifier, \nltrim(rtrim(t.ter_cha_nombre)) \n|| ' ' \n|| t.ter_cha_apepat \n|| ' ' \n|| t.ter_cha_apemat AS claimant_name, \nt.ter_int_rut AS claimant_rut_num, \n'3'           AS claimant_type_code, \n'Tercero'     AS claimant_type_desc, \n''            AS at_fault_ind, \n-- Rank() over (PARTITION BY t.ter_int_sinies ORDER BY t.ter_int_rut DESC) AS RNK,\n--ROW_NUMBER() over (PARTITION BY t.ter_int_sinies, t.ter_int_rut ORDER BY t.ter_int_sinies, t.ter_nro_correlativo, t.ter_int_rut ) as cnt \nt.ter_nro_correlativo as cnt \nFROM   cdp_ods.bd_sinie_x_sin_tercer t \nUNION \nSELECT con_int_sinies   AS clm_num, \nCAST(c.con_int_licenc AS VARCHAR(100)) AS claimant_identifier, \nc.con_cha_nombre \n|| ' ' \n|| c.con_cha_apepat \n|| ' ' \n|| c.con_cha_apemat AS claimant_name, \nc.con_int_licenc  AS claimant_rut_num, \n'2'   AS claimant_type_code, \n'Conductor'  AS claimant_type_desc, \n''    AS at_fault_ind,\n--Rank() over (PARTITION BY c.con_int_sinies ORDER BY c.con_int_licenc DESC) AS RNK,\n2 as cnt   \nFROM   cdp_ods.bd_sinie_x_sin_conduc c) AS drvr \nleft join cdp_ods.bd_sinie_x_sin_perfil clm \nON        clm. per_int_sinies = drvr.clm_num \nleft join \n( \nSELECT distinct  'S' AS def_ind, \na.per_int_sinies AS clm_num ,\n'1' as claimant_type_code\nFROM   cdp_ods.grlmst_gen_indicador g, \ncdp_ods.bd_sinie_x_sin_danos_propios dp, \ncdp_ods.bd_sinie_x_sin_liqabo l, \ncdp_ods.bd_sinie_x_sin_perfil a \nWHERE  g.ind_tipo = 811 \nAND    isnull(a.dap_tin_estado,0) = g.ind_indica \nAND    l.lab_int_rut=dp.dap_int_rutliq \nAND    dp.dap_int_sinies=a.per_int_sinies \nAND    l.lab_sma_tipo=1) AS ins_def_ind \nON ins_def_ind.clm_num = drvr.clm_num \nAND ins_def_ind.claimant_type_code=drvr.claimant_type_code\nleft join \n( \nSELECT  distinct 'S' AS tparty_ind, \nt.ter_int_sinies AS clm_num \nFROM   cdp_ods.grlmst_gen_indicador g, \ncdp_ods.bd_sinie_x_sin_tercer t, \ncdp_ods.bd_sinie_x_sin_danos_tercero dp, \ncdp_ods.bd_sinie_x_sin_liqabo l \nWHERE  g.ind_tipo = 811 \nAND  isnull(t.ter_tin_indresponsa,0) = g.ind_indica \nAND  t.ter_tin_indresponsa=1   /*Modified to 1  from 2 as part of dexon ticket 91702 */ \nAND  dp.dat_int_sinies=t.ter_int_sinies \nAND  l.lab_int_rut=dp.dat_int_rutabo -- changing to rutabo \nAND  l.lab_sma_tipo=1) tparty_def_ind \nON   tparty_def_ind.clm_num = drvr.clm_num\nAND  drvr.claimant_type_code >'1'\nleft join \n( \nSELECT distinct  'S' AS def_ind, \na.per_int_sinies AS clm_num ,\n'1' as claimant_type_code\nFROM   cdp_ods.grlmst_gen_indicador g, \ncdp_ods.bd_sinie_x_sin_danos_propios dp, \ncdp_ods.bd_sinie_x_sin_liqabo l, \ncdp_ods.bd_sinie_x_sin_perfil a \nWHERE  g.ind_tipo = 811 \nAND    isnull(a.dap_tin_estado,0) = g.ind_indica \nAND    l.lab_int_rut=dp.dap_int_rutliq \nAND    dp.dap_int_sinies=a.per_int_sinies \nAND    l.lab_sma_tipo=1) AS legal_recov_ind_insured \nON legal_recov_ind_insured.clm_num = drvr.clm_num \nAND legal_recov_ind_insured.claimant_type_code=drvr.claimant_type_code\nleft join \n( \nSELECT  distinct 'S' AS tparty_ind, \nt.ter_int_sinies AS clm_num \nFROM   cdp_ods.grlmst_gen_indicador g, \ncdp_ods.bd_sinie_x_sin_tercer t, \ncdp_ods.bd_sinie_x_sin_danos_tercero dp, \ncdp_ods.bd_sinie_x_sin_liqabo l \nWHERE  g.ind_tipo = 811 \nAND  isnull(t.ter_tin_indresponsa,0) = g.ind_indica \nAND  t.ter_tin_indresponsa=2  \nAND  dp.dat_int_sinies=t.ter_int_sinies \nAND  l.lab_int_rut=dp.dat_int_rutabo -- changing to rutabo \nAND  l.lab_sma_tipo=1) legal_recov_ind_tparty \nON   legal_recov_ind_tparty.clm_num = drvr.clm_num\nAND  drvr.claimant_type_code >'1'\nleft join \n(SELECT DISTINCT 'S' AS def_ind, \nz.per_int_sinies AS clm_num ,\n'1' as claimant_type_code\nFROM   (SELECT per_int_sinies, \nRank() \nover ( \nPARTITION BY per_int_sinies \nORDER BY per_int_rutase DESC) AS RNK \nFROM   cdp_ods.bd_sinie_x_sin_perfil) z, \ncdp_ods.bd_sinie_x_snsrec_recuperosdst a, \ncdp_ods.bd_sinie_x_cir_salvataje_recupero b, \ncdp_ods.bd_sinie_x_cir_concepto_propiedad c, \ncdp_ods.prdcdg_prd_plncobertura d \n WHERE  a.siniestro = z.per_int_sinies \nAND b.sal_int_siniestro = siniestro \nAND c.cod_tin_clasifica = b.sal_tin_clasificacion \nAND b.sal_tin_cobertura = d.idcobertura \nAND d.idramo = 9 \nAND d.codigo_ramo_fecu IN ( 9, 10 ) \nAND z.rnk = 1 )mat_recov_ind_insured\nON mat_recov_ind_insured.clm_num = drvr.clm_num\nAND mat_recov_ind_insured.claimant_type_code=drvr.claimant_type_code\n/*LEFT JOIN \n(SELECT DISTINCT NULL AS def_ind, \nter_int_sinies AS clm_num \n FROM (SELECT ter_int_sinies, \nRank() \nover ( \nPARTITION BY ter_int_sinies \nORDER BY ter_int_rut DESC) AS RNK \nFROM   cdp_ods.bd_sinie_x_sin_tercer) z, \ncdp_ods.bd_sinie_x_snsrec_recuperosdst a, \ncdp_ods.bd_sinie_x_cir_salvataje_recupero b, \ncdp_ods.bd_sinie_x_cir_concepto_propiedad c, \ncdp_ods.prdcdg_prd_plncobertura d \nWHERE  a.siniestro = z.ter_int_sinies \nAND b.sal_int_siniestro = siniestro \nAND c.cod_tin_clasifica = b.sal_tin_clasificacion \nAND b.sal_tin_cobertura = d.idcobertura \nAND d.idramo = 9 \nAND codigo_ramo_fecu IN ( 20 ) --Tercero RC \nAND cod_concepto_grupal = 2 \nAND z.rnk = 1)  mat_recov_ind_tparty\nON mat_recov_ind_tparty.clm_num = drvr.clm_num\nAND  drvr.claimant_type_code >'1'*/ /*Commenting as part of Dexon Ticket 91702 and mapping sheet version 4.90 to populate null for third party*/\nleft join \n(\nselect  distinct ite_sma_comuna as comuna_cd, per_int_sinies as clm_num, '1' as ttype, CAST(per_int_rutase AS VARCHAR(100)) as clm_id\nfrom cdp_ods.bd_sinie_x_sin_perfil,  cdp_ods.bd_produ_x_pro_item\nWHERE\nper_int_poliza = ite_int_poliza AND\nper_sma_item=ite_sma_item  \nUNION \nSELECT ter_sma_comuna as comuna_cd, ter_int_sinies as clm_num , '3' as ttype, CAST(ter_int_sinies || DECODE (TRIM(ter_nro_correlativo),null,'','-'||ter_nro_correlativo) || DECODE(ter_cha_patent,'','','-'||ter_cha_patent) AS VARCHAR(100)) as clm_id\nfrom  cdp_ods.bd_sinie_x_sin_tercer) penta_comuna \non penta_comuna.clm_num = drvr.clm_num and penta_comuna.ttype = drvr.claimant_type_code \nand penta_comuna.clm_id = drvr.claimant_identifier\nleft join  cdp_stg_dwh.STG_TREF_CODE_MAP_VARIANT communa on communa.ref_cd = penta_comuna.comuna_cd\nand communa.src_sys_cd = 'penta' AND communa.ref_type_cd = 'comuna'\nleft join \n(\nSelect  \ndistinct ite_tin_region as reg_cd,  per_int_sinies as clm_num\nfrom cdp_ods.bd_produ_x_pro_item, cdp_ods.bd_sinie_x_sin_perfil\nwhere per_int_poliza = ite_int_poliza AND  per_sma_item=ite_sma_item \n) region on region.clm_num = clm.per_int_sinies     \nleft join  cdp_stg_dwh.STG_TREF_CODE_MAP_VARIANT mv on mv.ref_cd = region.reg_cd\nand mv.src_sys_cd = 'penta' AND mv.ref_type_cd = 'region'   \nleft join cdp_dwh.DIM_REGION_T rt1 \nON rt1.region_cd = nvl(mv.mkt_ref_code,cast(region.reg_cd as varchar(20))) \n--where drvr.rnk=1  \n)where rnk1=1  \n)SRC \nLEFT JOIN (SELECT 1 as DUMMY, MAX(dim_claimant_key) AS MAX_SID from cdp_dwh.dim_claimant_t) TGT\non SRC.dummy=TGT.dummy \nleft join \n(\nselect distinct etl_audit_id, 1 as dummy from cdp_dwh.dim_claim_analyst_t where src_sys_cd='penta') ca \non src.dummy =ca.dummy \n) SRC1"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.dim_claimant_t where src_sys_cd='penta';\ncommit;"
    }
]