[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "SELECT  \n(SRC1.MAX_SID+SRC1.num) as dim_product_plan_hierarchy_key,\nSRC1.product_cd,\nSRC1.product_desc,\nSRC1.plan_cd,\nSRC1.plan_desc,\nSRC1.src_sys_cd,\nSRC1.lob_cd,\nSRC1.actv_product_ind,\nSRC1.actv_plan_ind,\nSRC1.plan_start_dt,\nSRC1.plan_end_dt,\nSRC1.model_cd,\nSRC1.insurance_type_cd,\nSRC1.package_cd,\nSRC1.rec_crt_dtm,\nSRC1.rec_updt_dtm,\nSRC1.actv_rec_ind\nfrom\n(\nselect\nsrc_sub.src_sys_cd,\nsrc_sub.product_cd,\nsrc_sub.product_desc,\nsrc_sub.plan_cd,\nsrc_sub.plan_desc,\nsrc_sub.lob_cd,\nsrc_sub.actv_plan_ind,\nsrc_sub.plan_start_dt,\nsrc_sub.plan_end_dt,\nsrc_sub.model_cd,\nsrc_sub.insurance_type_cd,\nsrc_sub.package_cd,\nsrc_sub.actv_product_ind,\nsrc_sub.rec_crt_dtm,\nsrc_sub.rec_updt_dtm,\nsrc_sub.actv_rec_ind,\nNVL(src_sub.MAX_SID,0) as max_sid,\nrow_number() over (order by src_sub.src_sys_cd,src_sub.product_cd,src_sub.plan_cd,src_sub.lob_cd) num\nfrom\n(\nselect\nsrc.product_cd,\nCAST(b.ref_desc as VARCHAR(255)) as product_desc,\nsrc.plan_cd,\nCAST(c.ref_desc as VARCHAR(255)) as plan_desc,\nsrc.src_sys_cd,\nsrc.lob_cd,\nsrc.actv_product_ind,\nsrc.actv_plan_ind,\nsrc.plan_start_dt,\nsrc.plan_end_dt,\nsrc.model_cd,\nsrc.insurance_type_cd,\nsrc.package_cd,\nsrc.rec_crt_dtm,\nsrc.rec_updt_dtm,\nsrc.actv_rec_ind,\nnvl(LKP_MAX_KEY.MAX_SID,0) as max_sid,\nrow_number()over(partition by src.src_sys_cd,src.product_cd,src.plan_cd,src.lob_cd order by src.rec_updt_dtm desc,src.plan_cd,src.product_cd,src.lob_cd) as row_cnt\nfrom\n(\nselect \ndistinct  \nCAST(pro.idProducto as VARCHAR(10)) as product_cd,\nCAST(pln.idPlan as VARCHAR(10)) as plan_cd,\n'Y' as actv_rec_ind,\nCAST('penta' AS VARCHAR(10)) as src_sys_cd,\nCAST(pro.idRamo as VARCHAR(10)) as lob_cd,\nCAST (pro.Estado as CHAR(1)) as actv_product_ind,\nCAST (pln.EstadoPlan as CHAR(1)) as actv_plan_ind,\nCAST(pln.fecha_inicio_vigencia as DATE) as plan_start_dt,\nCAST(pln.fecha_termino_vigencia as DATE) as plan_end_dt,\nCAST(null as varchar(80)) model_cd,\nCAST(null as varchar(80))insurance_type_cd,\nCAST(null as varchar(80)) package_cd,\nCURRENT_DATE as rec_crt_dtm,\nCURRENT_DATE as rec_updt_dtm,\n1 as dummy\nfrom cdp_ods.prdcdg_prd_plnproducto pro\ninner join cdp_ods.PrdCdg_prd_plnPlan pln\non pro.idRamo=pln.idRamo\nand pro.idProducto=pln.idProducto\n) src  \nleft join\n(select ref_cd,ref_desc from cdp_stg_dwh.stg_tref_code_map_variant where src_sys_cd='penta' and ref_type_cd='product_cd')b\non\ncast(src.lob_cd||'|'||src.product_cd as varchar(20))=b.ref_cd\nleft join\n(select ref_cd,ref_desc from cdp_stg_dwh.stg_tref_code_map_variant where src_sys_cd='penta' and ref_type_cd='plan_cd')c\non\ncast(src.lob_cd||'|'||src.product_cd||'|'||src.plan_cd  as varchar(20))=c.ref_cd\nleft outer join\n(select 1 dummy,max(dim_prd_pln_hrchy_key) max_sid  from  cdp_dwh.dim_prd_pln_hrchy_t ) LKP_MAX_KEY\non src.dummy=LKP_MAX_KEY.dummy ) src_sub\nwhere row_cnt = 1 and product_cd is not null and plan_cd is not null and lob_cd is not null \n)SRC1"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.dim_prd_pln_hrchy_t\nwhere src_sys_cd='penta'"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "update cdp_dwh.dim_claim_t\nset dim_prd_pln_hrchy_key = HIERAR_KEY_UPD.dim_prd_pln_hrchy_key\nfrom \n  (\n    select \n      distinct dpln.dim_prd_pln_hrchy_key, prd_cd, pln_cd, lob_cd ,cast(tper.per_int_poliza as integer) as policy_id,\n            cast(tper.per_int_poliza as varchar(35)) as policy_num, cast(tper.per_int_sinies as varchar(35)) as claim_num  \n    from\n      cdp_dwh.dim_claim_t dclm\n      left outer join cdp_ods.bd_sinie_x_sin_perfil tper\n        on dclm.claim_num = tper.per_int_sinies\n      left outer join cdp_ods.bd_produ_x_pro_item tite\n        on tper.per_int_poliza = tite.ite_int_poliza\n        and tper.per_sma_item = tite.ite_sma_item\n      left outer join cdp_dwh.dim_prd_pln_hrchy_t dpln\n        on tite.ite_sma_ramo = dpln.lob_cd\n        and tite.ite_sma_subramo = dpln.prd_cd\n        and tite.ite_int_prodplan = dpln.pln_cd\n    where\n      dclm.src_sys_cd='penta'\n  ) HIERAR_KEY_UPD JOIN\nCDP_DWH.DIM_CLAIM_T CLAIM\nON CLAIM.CLAIM_NUM = HIERAR_KEY_UPD.claim_num\nAND CLAIM.policy_id = HIERAR_KEY_UPD.policy_id\nAND CLAIM.policy_num = HIERAR_KEY_UPD.policy_num\nAND src_sys_cd='penta'; /*Added as part of DID-229.*/\n\nCOMMIT;\n"
    }
]