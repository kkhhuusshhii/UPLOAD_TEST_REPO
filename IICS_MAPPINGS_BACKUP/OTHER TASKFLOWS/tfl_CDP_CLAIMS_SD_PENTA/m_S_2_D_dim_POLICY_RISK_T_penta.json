[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select \ndistinct\n(SRC1.MAXSID+SRC1.num) as dim_risk_key,\nSRC1.policy_item_id,\nSRC1.risk_id,\nSRC1.address_desc,\nSRC1.src_sys_cd,\nSRC1.comuna_cd,\nSRC1.comuna_name,\nSRC1.region_cd,\nSRC1.region_name,\nSRC1.risk_type_cd,\nSRC1.risk_type_desc,\nSRC1.occupation_cd,\nSRC1.occupation_desc,\nSRC1.gender_cd,\nSRC1.gender_desc,\ncast(SRC1.birth_date as DATE) as birth_date ,\nSRC1.veh_usage_type_cd,\nSRC1.veh_usage_type_desc,\nSRC1.veh_usage_subtype_cd,\nSRC1.veh_usage_subtype_desc,\nSRC1.veh_make,\nSRC1.veh_model,\nSRC1.veh_yr,\nSRC1.veh_color,\nSRC1.registration_num,\nSRC1.registration_type_cd,\nSRC1.veh_registration_type_desc,\nSRC1.vin_num,\nSRC1.engine_num,\nSRC1.mv_id,\nSRC1.veh_type_cd,\nSRC1.veh_type_desc,\nSRC1.postal_cd,\nSRC1.person_at_risk_name,\nSRC1.person_at_risk_rut_num,\nSRC1.city_cd,\nSRC1.city_name,\nSRC1.person_at_risk_qty,\nSRC1.insured_material_use_type_cd,\nSRC1.insured_material_type_desc,\nSRC1.apartment_num,\nSRC1.street_num,\nSRC1.rec_crt_dtm,\nSRC1.rec_updt_dtm,\nSRC1.actv_rec_ind,\nSRC1.audit_id \nFROM \n(\nselect distinct\nrow_number() over (partition by src.policy_item_id order by src.policy_item_id desc) as row_cnt,\nrow_number() over (order by src.policy_item_id) num,\n1 as dummy,\ntrim(src.policy_item_id) as policy_item_id,\ntrim(src.risk_id) as risk_id ,\ntrim(src.address_desc) as address_desc ,\ntrim(src.src_sys_cd) as src_sys_cd ,\ntrim(src.comuna_cd) as comuna_cd ,\ntrim(src.comuna_name) as comuna_name,\ntrim(src.region_cd) as region_cd,\ntrim(src.region_name) as region_name ,\ntrim(src.risk_type_cd) as risk_type_cd,\ntrim(src.risk_type_desc) as risk_type_desc ,\ntrim(src.occupation_cd) as occupation_cd,\ntrim(src.occupation_desc) as occupation_desc,\ntrim(src.gender_cd) as gender_cd ,\ntrim(src.gender_desc) as gender_desc,\ntrim(src.birth_date) as birth_date ,\ntrim(src.veh_usage_type_cd) as veh_usage_type_cd ,\ntrim(src.veh_usage_type_desc) as veh_usage_type_desc ,\ntrim(src.veh_usage_subtype_cd) as veh_usage_subtype_cd,\ntrim(src.veh_usage_subtype_desc) as veh_usage_subtype_desc ,\ntrim(src.veh_make) as veh_make ,\ntrim(src.veh_model) as veh_model,\ntrim(src.veh_yr) as veh_yr ,\ntrim(src.veh_color) as veh_color,\ntrim(src.registration_num) as registration_num,\ntrim(src.registration_type_cd) as registration_type_cd ,\ntrim(src.veh_registration_type_desc) as veh_registration_type_desc,\ntrim(src.vin_num) as vin_num,\ntrim(src.engine_num) as engine_num,\ntrim(src.mv_id) as mv_id,\ntrim(src.veh_type_cd) as veh_type_cd,\ntrim(src.veh_type_desc) as veh_type_desc,\ntrim(src.postal_cd) as postal_cd ,\ntrim(src.person_at_risk_name) as person_at_risk_name,\ntrim(src.person_at_risk_rut_num) as person_at_risk_rut_num,\ntrim(src.city_cd) as city_cd,\ntrim(src.city_name) as city_name,\ntrim(src.person_at_risk_qty) as person_at_risk_qty,\ntrim(src.insured_material_use_type_cd) as insured_material_use_type_cd ,\ntrim(src.insured_material_type_desc) as insured_material_type_desc,\ntrim(src.apartment_num) as apartment_num ,\ntrim(src.street_num) as street_num,\ncurrent_date as rec_crt_dtm ,\ncurrent_date as rec_updt_dtm,\n'Y' as actv_rec_ind,\nba.etl_audit_id as audit_id,\nnvl(LKP_MAXSID.MAX_SID,0) as MAXSID\nfrom \n(\nselect \nt.ite_int_poliza||'-'||t.ite_sma_item as policy_item_id,\n'0' as risk_id,\n1 as dummy,\ncase when t.ite_sma_ramo = 1 then i.inc_cha_calle\nwhen t.ite_sma_ramo = 9 then NULL\nwhen t.ite_sma_ramo in (8,46) then a.ame_cha_calle\nwhen t.ite_sma_ramo=23 then NULL\nend as address_desc,\n\n'penta' as src_sys_cd,\n\ncase when t.ite_sma_ramo = 1 then i.inc_sma_comuna\nwhen t.ite_sma_ramo = 9 then NULL\nwhen t.ite_sma_ramo in (8,46) then a.ame_sma_comuna\nwhen t.ite_sma_ramo=23 then NULL\nend as comuna_cd,\n\ncase when t.ite_sma_ramo = 1 then cast(NVL(RD1.mkt_ref_code_desc,RD1.ref_desc) as varchar(80)) \nwhen  t.ite_sma_ramo in (8,46) then cast(NVL(RD2.mkt_ref_code_desc,RD2.ref_desc)as varchar(80)) else null \nend as comuna_name,\n\ncase when t.ite_sma_ramo = 1 then i.inc_tin_region\nwhen t.ite_sma_ramo = 9 then NULL\nwhen t.ite_sma_ramo in (8,46) then a.ame_tin_region\nwhen t.ite_sma_ramo=23 then NULL\nend as region_cd,\n\n\ncase when t.ite_sma_ramo = 1 then cast(NVL(RD3.mkt_ref_code_desc,RD3.ref_desc) as varchar(80)) \nwhen  t.ite_sma_ramo in (8,46) then cast(NVL(RD4.mkt_ref_code_desc,RD4.ref_desc)as varchar(80)) else null \nend as region_name,\n\ncase when t.ite_sma_ramo = 1 then 2\nwhen t.ite_sma_ramo = 9 then 5\nwhen t.ite_sma_ramo in (8,46) then 3\nwhen t.ite_sma_ramo = 23 then 1\nwhen t.ite_sma_ramo = 44 then 2\nwhen t.ite_sma_ramo  not in (44,23,1,8,46,9) then 4\nelse null end as risk_type_cd,\n\ncast(NVL(RD5.mkt_ref_code_desc,RD5.ref_desc)as varchar(80)) as risk_type_desc,\n\ncase when t.ite_sma_ramo = 23 \nthen a11.ac1_cha_actpri end as occupation_cd,\n\ncast(NVL(RD6.mkt_ref_code_desc,RD6.ref_desc)as varchar(80)) as occupation_desc,\n\nnull as gender_cd,\nnull as gender_desc,\ncast(null as DATE) as birth_date,\n--cast(current_date as date) as birth_date,\nnull as veh_usage_type_cd,\nnull as veh_usage_type_desc,\nv.veh_tin_usoveh as veh_usage_subtype_cd,\ncast(NVL(RD7.mkt_ref_code_desc,RD7.ref_desc)as varchar(80)) as veh_usage_subtype_desc,\n\ncase when t.ite_sma_ramo = 9 then v.veh_tin_marca\nwhen t.ite_sma_ramo = 23 then pol.asi_tin_marca\nelse null end as veh_make,\n\nNULL as veh_model, -- change later\n\n--case when t.ite_sma_ramo = 9 then v.veh_tin_modelo\n--when t.ite_sma_ramo = 23 then pol.asi_cha_modelo\n--else null end as veh_model, -- compatibility issue\n\ncase when t.ite_sma_ramo = 9 then v.veh_sma_anofac end  as veh_yr,\n\nnull as veh_color,\nnull as registration_num,\nnull as registration_type_cd,\nnull as veh_registration_type_desc,\n\ncase when t.ite_sma_ramo = 9 then v.veh_cha_paten\nwhen t.ite_sma_ramo = 23 then pol.asi_cha_patent\nelse null end as vin_num,\n\ncase when t.ite_sma_ramo = 9 then trim(v.veh_cha_motor) end as engine_num,\n\nt.ite_int_endoso as mv_id,\ncase when t.ite_sma_ramo = 9 then v.veh_tin_tipveh end as veh_type_cd,\n\ncast(NVL(RD8.mkt_ref_code_desc,RD8.ref_desc)as varchar(80)) as veh_type_desc,\n\nNULL as postal_cd,\n\ncase when t.ite_sma_ramo = 23 then pol.ac2_cha_nombre end as person_at_risk_name,\nNULL as person_at_risk_rut_num, -- temporary. Need to change later\nNULL as city_cd,\nNULL as city_name,\ncase when t.ite_sma_ramo = 23 then pol.asi_sma_correl else 1 end as person_at_risk_qty, \ncast(i.inc_int_usodes as varchar(10)) as insured_material_use_type_cd,  \ncast(NVL(RD9.mkt_ref_code_desc,RD9.ref_desc)as varchar(255)) as insured_material_type_desc,  \ncase when t.ite_sma_ramo = 1 then i.inc_cha_depto\nwhen t.ite_sma_ramo=44 then a.ame_cha_depto\nelse null end as apartment_num,\ncase when t.ite_sma_ramo = 1 then i.inc_cha_numero\nwhen t.ite_sma_ramo=44 then a.ame_cha_numero\nelse null end as street_num,\n\ncurrent_date as rec_crt_dtm,\ncurrent_date as rec_updt_dtm\n\nfrom \ncdp_ods.bd_produ_x_pro_item t\n\nleft join \ncdp_ods.bd_produ_x_pro_incendio i\non t.ite_int_poliza=i.inc_int_poliza\nand t.ite_sma_item=i.inc_sma_item  --ite_sma_ramo = 1 \n\nleft join \ncdp_ods.bd_produ_x_pro_vehiculo v \non v.veh_int_poliza = t.ite_int_poliza \nand t.ite_sma_item = v.veh_sma_item --ite_sma_ramo = 9 \n\nleft join\ncdp_ods.bd_produ_x_pro_america_hogar a\non t.ite_int_poliza = a.ame_int_poliza \nand t.ite_sma_item = a.ame_sma_item --ite_sma_ramo in (8,46)\n\nleft join cdp_ods.bd_produ_x_pro_acciper1 a11 \n on a11.ac1_int_poliza = t.ite_int_poliza \n and a11.ac1_sma_item =t.ite_sma_item -- for occupation_cd, need to confirm.\n\n\nleft join \n\n(select a5.ite_int_poliza,a5.ite_sma_item,a5.int_poliza,a5.sma_item,a5.asi_tin_marca,a5.asi_cha_modelo\n,a5.asi_cha_patent,a5.ac2_cha_nombre,a5.asi_sma_correl\nfrom \n(select distinct t.ite_int_poliza,a1.ac1_int_poliza as int_poliza,t.ite_sma_item,a1.ac1_sma_item as sma_item, cast(null as smallint) as asi_tin_marca\n,cast(null as varchar(60)) as asi_cha_modelo, cast(null as varchar(18)) as asi_cha_patent,cast(null as varchar(90)) as ac2_cha_nombre,cast(null as smallint) as asi_sma_correl\n from cdp_ods.bd_produ_x_pro_item t \n left join cdp_ods.bd_produ_x_pro_acciper1 a1 \n on a1.ac1_int_poliza = t.ite_int_poliza \n and a1.ac1_sma_item =t.ite_sma_item \nUNION\nselect distinct t.ite_int_poliza,a2.ac2_int_poliza as int_poliza ,t.ite_sma_item,a2.ac2_sma_item as sma_item, cast(null as smallint) as asi_tin_marca\n,cast(null as varchar(60)) as asi_cha_modelo, cast(null as varchar(18)) as asi_cha_patent, a2.ac2_cha_nombre as ac2_cha_nombre,cast(null as smallint) as asi_sma_correl\nfrom cdp_ods.bd_produ_x_pro_item t \nleft join cdp_ods.bd_produ_x_pro_acciper2 a2 \non a2.ac2_int_poliza = t.ite_int_poliza \nand a2.ac2_sma_item = t.ite_sma_item \nUNION\nselect distinct t.ite_int_poliza,asi.asi_int_poliza as int_poliza,t.ite_sma_item,asi.asi_sma_item as sma_item,asi.asi_tin_marca as asi_tin_marca\n,asi.asi_cha_modelo as asi_cha_modelo,asi.asi_cha_patent as asi_cha_patent,cast(null as varchar(90)) as ac2_cha_nombre,asi.asi_sma_correl as asi_sma_correl\nfrom cdp_ods.bd_produ_x_pro_item t \nleft join cdp_ods.bd_produ_x_pro_asiento asi \non asi.asi_int_poliza = t.ite_int_poliza \nand asi.asi_sma_item = t.ite_sma_item)a5)pol --pro.ite_sma_ramo=23\n\non t.ite_int_poliza=pol.ite_int_poliza\nand t.ite_sma_item=pol.ite_sma_item\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='comuna' and src_sys_cd = 'penta')RD1\non trim(RD1.ref_cd)=trim(cast(cast(i.inc_sma_comuna as integer) as varchar(20))) -- ite_sma_ramo = 1 \n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='comuna' and src_sys_cd = 'penta')RD2\non trim(RD2.ref_cd)=trim(cast(cast(a.ame_sma_comuna as integer) as varchar(20))) --ite_sma_ramo in (8,46)\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='region' and src_sys_cd = 'penta')RD3\non trim(RD3.ref_cd)=trim(cast(cast(i.inc_tin_region as integer) as varchar(20))) -- ite_sma_ramo = 1 \n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='region' and src_sys_cd = 'penta')RD4\non trim(RD4.ref_cd)=trim(cast(cast(a.ame_tin_region as integer) as varchar(20))) --ite_sma_ramo in (8,46)\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='insuredobject_cd' and src_sys_cd = 'penta')RD5\non trim(RD5.ref_cd)=trim(cast(cast(t.ite_sma_ramo as integer) as varchar(10)))\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='occupation_type_cd' and src_sys_cd = 'penta')RD6\non trim(RD6.ref_cd)=trim(cast(a11.ac1_cha_actpri as varchar(60)))\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='vehicle_usage_type_cd' and src_sys_cd = 'penta')RD7\non trim(RD7.ref_cd)=trim(cast(v.veh_tin_usoveh as varchar(60)))\n\nleft join \n\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='veh_type' and src_sys_cd = 'penta')RD8\non trim(RD8.ref_cd)=trim(cast(v.veh_tin_tipveh  as varchar(10)))\n\nleft join \n\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='Insured Material Use Code' and src_sys_cd = 'penta')RD9\non trim(RD9.ref_cd)=trim(cast(i.inc_int_usodes as varchar(10)))\n\n)src\nleft join\n(select 1 as dummy, max(dim_risk_key) as MAX_SID from cdp_dwh.dim_policy_risk_t) LKP_MAXSID\non src.dummy = LKP_MAXSID.dummy\nleft join \n  (\n  select distinct etl_audit_id,1 as dummy from cdp_dwh.dim_insured_t where src_sys_cd ='penta') ba \n  on src.dummy =ba.dummy\n)SRC1 \nwhere row_cnt = 1 and 1=2"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.dim_policy_risk_t where src_sys_cd='penta';\ncommit;\n\n\ninsert into cdp_dwh.dim_policy_risk_t(\ndim_risk_key,\npolicy_item_id,\nrisk_id,\naddress_desc,\nsrc_sys_cd,\ncomuna_cd,\ncomuna_name,\nregion_cd,\nregion_name,\nrisk_type_cd,\nrisk_type_desc,\noccupation_cd,\noccupation_desc,\ngender_cd,\ngender_desc,\nbirth_dt ,\nveh_usage_type_cd,\nveh_usage_type_desc,\nveh_usage_subtype_cd,\nveh_usage_subtype_desc,\nveh_make,\nveh_model,\nveh_yr,\nveh_color,\nregistration_num,\nregistration_type_cd,\nveh_registration_type_desc,\nvin_num,\nengine_num,\nmv_id,\nveh_type_cd,\nveh_type_desc,\npostal_cd,\nperson_at_risk_name,\nperson_at_risk_rut_num,\ncity_cd,\ncity_name,\nperson_at_risk_qty,\ninsured_material_use_type_cd,\ninsured_material_type_desc,\napartment_num,\nstreet_num,\nrec_crt_dtm,\nrec_updt_dtm,\nactv_rec_ind,\netl_audit_id )\nselect \ndistinct\n(SRC1.MAXSID+SRC1.num) as dim_risk_key,\nSRC1.policy_item_id,\ncast(SRC1.risk_id as integer) as risk_id,\nSRC1.address_desc,\nSRC1.src_sys_cd,\nSRC1.comuna_cd,\nSRC1.comuna_name,\nSRC1.region_cd,\nSRC1.region_name,\nSRC1.risk_type_cd,\nSRC1.risk_type_desc,\nSRC1.occupation_cd,\nSRC1.occupation_desc,\nSRC1.gender_cd,\nSRC1.gender_desc,\ncast(SRC1.birth_date as DATE) as birth_date ,\nSRC1.veh_usage_type_cd,\nSRC1.veh_usage_type_desc,\nSRC1.veh_usage_subtype_cd,\nSRC1.veh_usage_subtype_desc,\nSRC1.veh_make,\nSRC1.veh_model,\nSRC1.veh_yr,\nSRC1.veh_color,\nSRC1.registration_num,\nSRC1.registration_type_cd,\nSRC1.veh_registration_type_desc,\nSRC1.vin_num,\nSRC1.engine_num,\ncast(SRC1.mv_id as integer) as mv_id,\nSRC1.veh_type_cd,\nSRC1.veh_type_desc,\nSRC1.postal_cd,\nSRC1.person_at_risk_name,\nSRC1.person_at_risk_rut_num,\nSRC1.city_cd,\nSRC1.city_name,\ncast(SRC1.person_at_risk_qty as smallint) as person_at_risk_qty,\nSRC1.insured_material_use_type_cd,\nSRC1.insured_material_type_desc,\nSRC1.apartment_num,\nSRC1.street_num,\nSRC1.rec_crt_dtm,\nSRC1.rec_updt_dtm,\nSRC1.actv_rec_ind,\nSRC1.audit_id \nFROM \n(\nselect distinct\nrow_number() over (partition by src.policy_item_id order by src.policy_item_id desc) as row_cnt,\nrow_number() over (order by src.policy_item_id) num,\n1 as dummy,\ntrim(src.policy_item_id) as policy_item_id,\ntrim(src.risk_id) as risk_id ,\nsrc.address_desc as address_desc,\n--trim(src.address_desc) as address_desc ,\ntrim(src.src_sys_cd) as src_sys_cd ,\ntrim(src.comuna_cd) as comuna_cd ,\ntrim(src.comuna_name) as comuna_name,\ntrim(src.region_cd) as region_cd,\ntrim(src.region_name) as region_name ,\ntrim(src.risk_type_cd) as risk_type_cd,\ntrim(src.risk_type_desc) as risk_type_desc ,\ntrim(src.occupation_cd) as occupation_cd,\ntrim(src.occupation_desc) as occupation_desc,\ntrim(src.gender_cd) as gender_cd ,\ntrim(src.gender_desc) as gender_desc,\ntrim(src.birth_date) as birth_date ,\ntrim(src.veh_usage_type_cd) as veh_usage_type_cd ,\ntrim(src.veh_usage_type_desc) as veh_usage_type_desc ,\ntrim(src.veh_usage_subtype_cd) as veh_usage_subtype_cd,\ntrim(src.veh_usage_subtype_desc) as veh_usage_subtype_desc ,\ntrim(src.veh_make) as veh_make ,\ntrim(src.veh_model) as veh_model,\ntrim(src.veh_yr) as veh_yr ,\ntrim(src.veh_color) as veh_color,\ntrim(src.registration_num) as registration_num,\ntrim(src.registration_type_cd) as registration_type_cd ,\ntrim(src.veh_registration_type_desc) as veh_registration_type_desc,\ntrim(src.vin_num) as vin_num,\ntrim(src.engine_num) as engine_num,\ntrim(src.mv_id) as mv_id,\ntrim(src.veh_type_cd) as veh_type_cd,\ntrim(src.veh_type_desc) as veh_type_desc,\ntrim(src.postal_cd) as postal_cd ,\ntrim(src.person_at_risk_name) as person_at_risk_name,\ntrim(src.person_at_risk_rut_num) as person_at_risk_rut_num,\ntrim(src.city_cd) as city_cd,\ntrim(src.city_name) as city_name,\ntrim(nvl(src.person_at_risk_qty,1)) as person_at_risk_qty,\ntrim(src.insured_material_use_type_cd) as insured_material_use_type_cd ,\ntrim(src.insured_material_type_desc) as insured_material_type_desc,\ntrim(src.apartment_num) as apartment_num ,\ntrim(src.street_num) as street_num,\ncurrent_date as rec_crt_dtm ,\ncurrent_date as rec_updt_dtm,\n'Y' as actv_rec_ind,\nba.etl_audit_id as audit_id,\nnvl(LKP_MAXSID.MAX_SID,0) as MAXSID\nfrom \n(\nselect \ncast((t.ite_int_poliza||'-'||t.ite_sma_item) as varchar(35)) as policy_item_id,\n0 as risk_id,\n1 as dummy,\ncase when t.ite_sma_ramo = 1 then cast(i.inc_cha_calle as varchar(255))\nwhen t.ite_sma_ramo = 9 then NULL\nwhen t.ite_sma_ramo in (8,46) then cast(i.inc_cha_calle as varchar(255))\nwhen t.ite_sma_ramo=23 then NULL\nwhen t.ite_sma_ramo=44 then cast(a.ame_cha_calle as varchar(255))\nend as address_desc,\n\n'penta' as src_sys_cd,\n\ncase\nwhen t.ite_sma_ramo = 9 then NULL\nwhen t.ite_sma_ramo in (8,46,1) then cast(i.inc_sma_comuna as varchar(10))\nwhen t.ite_sma_ramo=23 then NULL\nwhen t.ite_sma_ramo=44 then cast(a.ame_sma_comuna as varchar(10))\nend as comuna_cd,-----fixed\n\ncase when t.ite_sma_ramo = 1 then cast(RD1.ref_desc as varchar(80)) \nwhen  t.ite_sma_ramo in (8,46) then cast(RD2.ref_desc as varchar(80)) \nwhen  t.ite_sma_ramo=44 then cast(RD10.ref_desc as varchar(80))\nelse null \nend as comuna_name,\n\ncase when t.ite_sma_ramo = 1 then cast(i.inc_tin_region as varchar(10))\nwhen t.ite_sma_ramo = 9 then NULL\nwhen t.ite_sma_ramo in (8,46) then cast(i.inc_tin_region as varchar(10))\nwhen t.ite_sma_ramo=23 then NULL\nwhen t.ite_sma_ramo=44 then cast(a.ame_tin_region as varchar(10))\nend as region_cd,\n\n\ncase when t.ite_sma_ramo = 1 then cast(RD3.ref_desc as varchar(80)) \nwhen  t.ite_sma_ramo in (8,46) then cast(RD4.ref_desc as varchar(80))\nwhen  t.ite_sma_ramo = 44 then cast(RD11.ref_desc as varchar(80)) \nelse null \nend as region_name,\n\ncase when t.ite_sma_ramo = 1 then 2\nwhen t.ite_sma_ramo = 9 then 5\nwhen t.ite_sma_ramo in (8,46) then 3\nwhen t.ite_sma_ramo = 23 then 1\nwhen t.ite_sma_ramo = 44 then 2\nwhen t.ite_sma_ramo  not in (44,23,1,8,46,9) then 4\nelse null end as risk_type_cd,\n\ncast(RD5.ref_desc as varchar(80)) as risk_type_desc,\n\ncast(null as varchar(80)) occupation_cd,\n--case when t.ite_sma_ramo = 23 \n--then cast(a11.ac1_cha_actpri as varchar(80)) end as occupation_cd,\n\n\ncase when t.ite_sma_ramo = 23 \nthen cast(pol.ac1_cha_actpri as varchar(80)) end as occupation_desc,\n\n--cast(RD6.ref_desc as varchar(80)) as occupation_desc,\n\ncast(null as varchar(10)) as gender_cd,\ncast(null as varchar(80)) as gender_desc,\ncast(null as DATE) as birth_date,\ncast(null as varchar(10)) veh_usage_type_cd,\ncast(null as varchar(80)) as veh_usage_type_desc,\ncase when t.ite_sma_ramo = 9  then cast(v.veh_tin_usoveh as varchar(10)) end as veh_usage_subtype_cd,-----fixed\n-- cast(v.veh_tin_usoveh as varchar(10)) as veh_usage_subtype_cd\ncast(RD7.ref_desc as varchar(80)) as veh_usage_subtype_desc,\n\ncase when t.ite_sma_ramo = 9 then v.veh_tin_marca\nwhen t.ite_sma_ramo = 23 then pol.asi_tin_marca\nelse null end as veh_make,\n\ncase when t.ite_sma_ramo = 9 then cast(v.veh_tin_modelo as varchar(35))\nwhen t.ite_sma_ramo = 23 then pol.asi_cha_modelo\nelse null end as veh_model, \n\ncase when t.ite_sma_ramo = 9 then RIGHT(veh_sma_anofac,4) end  as veh_yr,--------not an issue\n\ncast(null as varchar(35)) as veh_color,\ncast(null as varchar(35)) as registration_num,\ncast(null as varchar(10)) as registration_type_cd,\ncast(null as varchar(80)) as veh_registration_type_desc,\n\ncase when t.ite_sma_ramo = 9 then v.veh_cha_paten\nwhen t.ite_sma_ramo = 23 then pol.asi_cha_patent\nelse null end as vin_num,\n\ncase when t.ite_sma_ramo = 9 then trim(v.veh_cha_motor) end as engine_num,--------not an issue\n\nt.ite_int_endoso as mv_id,\ncase when t.ite_sma_ramo = 9 then v.veh_tin_tipveh end as veh_type_cd,------not an issue\n\ncast(RD8.ref_desc as varchar(80)) as veh_type_desc,\n\nNULL as postal_cd,\n\ncase when t.ite_sma_ramo = 23 then pol.ac2_cha_nombre end as person_at_risk_name,\n--NULL as person_at_risk_rut_num, -- temporary. Need to change later\ncast((pol.ac2_int_rut||trim(pol.ac2_cha_dvrut)) as varchar(35)) as person_at_risk_rut_num,\nNULL as city_cd,\nNULL as city_name,\ncase when t.ite_sma_ramo = 23 then pol.asi_sma_correl else 1 end as person_at_risk_qty, --fixed\ncast(i.inc_int_usodes as varchar(10)) as insured_material_use_type_cd,  \ncast(RD9.ref_desc as varchar(255)) as insured_material_type_desc,  \ncase when t.ite_sma_ramo = 1 then cast(i.inc_cha_depto as varchar(10))\nwhen t.ite_sma_ramo=44 then cast(a.ame_cha_depto as varchar(10))\nelse null end as apartment_num,\ncase when t.ite_sma_ramo = 1 then cast(i.inc_cha_numero as varchar(10))\nwhen t.ite_sma_ramo=44 then cast(a.ame_cha_numero as varchar(10))\nelse null end as street_num,\n\ncurrent_date as rec_crt_dtm,\ncurrent_date as rec_updt_dtm\n\nfrom \ncdp_ods.bd_produ_x_pro_item t\n\nleft join \ncdp_ods.bd_produ_x_pro_incendio i\non t.ite_int_poliza=i.inc_int_poliza\nand t.ite_sma_item=i.inc_sma_item  --ite_sma_ramo = 1,(8,46) \n\nleft join \ncdp_ods.bd_produ_x_pro_vehiculo v \non v.veh_int_poliza = t.ite_int_poliza \nand t.ite_sma_item = v.veh_sma_item --ite_sma_ramo = 9 \n\nleft join\ncdp_ods.bd_produ_x_pro_america_hogar a\non t.ite_int_poliza = a.ame_int_poliza \nand t.ite_sma_item = a.ame_sma_item --ite_sma_ramo in 44\n\nleft join cdp_ods.bd_produ_x_pro_acciper1 a11 \n on a11.ac1_int_poliza = t.ite_int_poliza \n and a11.ac1_sma_item =t.ite_sma_item -- for occupation_cd, need to confirm.\n\n\nleft join \n\n(select distinct a5.ite_int_poliza,a5.ite_sma_item,\n--a5.int_poliza,\n--a5.sma_item,\na5.asi_tin_marca,a5.asi_cha_modelo\n,a5.asi_cha_patent,a5.ac2_cha_nombre,a5.asi_sma_correl,a5.ac2_int_rut,a5.ac2_cha_dvrut,a5.ac1_cha_actpri\nfrom \n(/*select distinct t.ite_int_poliza,\na1.ac1_int_poliza as int_poliza,\nt.ite_sma_item,\na1.ac1_sma_item as sma_item, \ncast(null as smallint) as asi_tin_marca\n,cast(null as varchar(60)) as asi_cha_modelo, \ncast(null as varchar(18)) as asi_cha_patent,\ncast(null as varchar(90)) as ac2_cha_nombre,\ncast(null as smallint) as asi_sma_correl,\ncast (null as integer) as ac2_int_rut, \ncast(null as varchar(3)) as ac2_cha_dvrut\nfrom cdp_ods.bd_produ_x_pro_item t \n left join cdp_ods.bd_produ_x_pro_acciper1 a1 \n on a1.ac1_int_poliza = t.ite_int_poliza \n and a1.ac1_sma_item =t.ite_sma_item \nUNION\nselect distinct t.ite_int_poliza,\na2.ac2_int_poliza as int_poliza ,\nt.ite_sma_item,\na2.ac2_sma_item as sma_item,\ncast(null as smallint) as asi_tin_marca\n,cast(null as varchar(60)) as asi_cha_modelo,\ncast(null as varchar(18)) as asi_cha_patent, \n a2.ac2_cha_nombre as ac2_cha_nombre,\ncast(null as smallint) as asi_sma_correl,\ncast(a2.ac2_int_rut as integer) as ac2_int_rut, \ncast(a2.ac2_cha_dvrut as varchar(3)) as ac2_cha_dvrut\nfrom cdp_ods.bd_produ_x_pro_item t \nleft join cdp_ods.bd_produ_x_pro_acciper2 a2 \non a2.ac2_int_poliza = t.ite_int_poliza \nand a2.ac2_sma_item = t.ite_sma_item \nUNION */\nselect distinct t.ite_int_poliza,\n--asi.asi_int_poliza as int_poliza,\nt.ite_sma_item,\n--asi.asi_sma_item as sma_item,\nasi.asi_tin_marca as asi_tin_marca\n,asi.asi_cha_modelo as asi_cha_modelo,\nasi.asi_cha_patent as asi_cha_patent,\ncast( a2.ac2_cha_nombre as varchar(90)) as ac2_cha_nombre,\nasi.asi_sma_correl as asi_sma_correl,\ncast (a2.ac2_int_rut as integer) as ac2_int_rut, \ncast(a2.ac2_cha_dvrut as varchar(3)) as ac2_cha_dvrut,\na1.ac1_cha_actpri\nfrom cdp_ods.bd_produ_x_pro_item t \nleft join cdp_ods.bd_produ_x_pro_asiento asi \non asi.asi_int_poliza = t.ite_int_poliza \nand asi.asi_sma_item = t.ite_sma_item\nleft join cdp_ods.bd_produ_x_pro_acciper1 a1 \n on a1.ac1_int_poliza = t.ite_int_poliza\nand a1.ac1_sma_item =t.ite_sma_item \n left join cdp_ods.bd_produ_x_pro_acciper2 a2 \non a2.ac2_int_poliza = t.ite_int_poliza \nand a2.ac2_sma_item = t.ite_sma_item \n)a5\n\n)pol\n\non t.ite_int_poliza=pol.ite_int_poliza\nand t.ite_sma_item=pol.ite_sma_item\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='comuna' and src_sys_cd = 'penta')RD1\non trim(RD1.ref_cd)=trim(cast(cast(i.inc_sma_comuna as integer) as varchar(20))) -- ite_sma_ramo = 1 \n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='comuna' and src_sys_cd = 'penta')RD2\non trim(RD2.ref_cd)=trim(cast(cast(i.inc_sma_comuna as integer) as varchar(20))) --ite_sma_ramo in (8,46)\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='comuna' and src_sys_cd = 'penta')RD10\non trim(RD10.ref_cd)=trim(cast(cast(a.ame_sma_comuna as integer) as varchar(20))) --ite_sma_ramo=44\n\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='region' and src_sys_cd = 'penta')RD3\non trim(RD3.ref_cd)=trim(cast(cast(i.inc_tin_region as integer) as varchar(20))) -- ite_sma_ramo = 1 \n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='region' and src_sys_cd = 'penta')RD4\non trim(RD4.ref_cd)=trim(cast(cast(i.inc_tin_region as integer) as varchar(20))) --ite_sma_ramo in (8,46)\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='region' and src_sys_cd = 'penta')RD11\non trim(RD11.ref_cd)=trim(cast(cast(a.ame_tin_region as integer) as varchar(20))) --ite_sma_ramo=44\n\n\n/*left join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='insuredobject_cd' and src_sys_cd = 'penta')RD5\non trim(RD5.ref_cd)=trim(cast(cast(t.ite_sma_ramo as integer) as varchar(10)))*/\nleft outer join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='insuredobject_cd' and src_sys_cd = 'axis')RD5\non trim(RD5.ref_cd)=(case when t.ite_sma_ramo = 1 then 2\nwhen t.ite_sma_ramo = 9 then 5\nwhen t.ite_sma_ramo in (8,46) then 3\nwhen t.ite_sma_ramo = 23 then 1\nwhen t.ite_sma_ramo = 44 then 2\nwhen t.ite_sma_ramo  not in (44,23,1,8,46,9) then 4\nend)-- as risk_type_cd\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='occupation_type_cd' and src_sys_cd = 'penta')RD6\non trim(RD6.ref_cd)=trim(cast(a11.ac1_cha_actpri as varchar(60)))\n\nleft join\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='vehicle_usage_type_cd' and src_sys_cd = 'penta')RD7\non trim(RD7.ref_cd)=(case when t.ite_sma_ramo = 9  then cast(v.veh_tin_usoveh as varchar(10)) end)\n\nleft join \n\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='veh_type' and src_sys_cd = 'penta')RD8\non trim(RD8.ref_cd)=(case when t.ite_sma_ramo = 9 then v.veh_tin_tipveh end)\n\nleft join \n\n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \nwhere ref_type_cd='insured_material_use_cd' and src_sys_cd = 'penta')RD9\non trim(RD9.ref_cd)=trim(cast(i.inc_int_usodes as varchar(10)))\n\n)src\nleft join\n(select 1 as dummy, max(dim_risk_key) as MAX_SID from cdp_dwh.dim_policy_risk_t) LKP_MAXSID\non src.dummy = LKP_MAXSID.dummy\nleft join \n  (select distinct etl_audit_id,1 as dummy from cdp_dwh.dim_insured_t where src_sys_cd ='penta') ba \n  on src.dummy =ba.dummy\n)SRC1 \nwhere row_cnt = 1"
    }
]