[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "with pro_item as (\nSELECT \nite_int_poliza, ite_sma_item, ite_fec_vighas\nFROM cdp_ods.bd_produ_x_pro_item\n)\nselect\ncast (nvl((MAX_SID+num),0) AS INTEGER) as fact_renovaciones_integrado_key,\nCAST(SRC.src_sys_cd AS VARCHAR(10)),\ncast(SRC.policy_item_id AS VARCHAR(35)),\nCAST(SRC.policy_num AS VARCHAR(35)),\nCAST(SRC.policy_exp_dt AS DATE),\nCAST(SRC. policy_status_desc AS VARCHAR(80)),\nCAST(SRC.facultativo_ind AS CHAR(1)),\nCAST(SRC.coins_type_cd AS VARCHAR(10)),\nCAST(SRC.curr_cd AS VARCHAR(10)),\nCAST(SRC.facult_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.broker_comm_amt AS NUMERIC(25,10)),\nNVL(CAST(SRC.dim_policy_key AS INT) ,0) AS dim_policy_key,\nNVL(CAST(SRC.dim_lob_key AS INT) ,0) AS dim_lob_key,\nNVL(CAST(SRC.dim_broker_key AS INT) ,0) AS dim_broker_key,\nNVL(CAST(SRC.dim_branch_office_key AS INT) ,0) AS dim_branch_office_key,\nNVL(CAST(SRC.dim_policyholder_key AS INT) ,0) AS dim_policyholder_key,\nNVL(CAST(SRC.policyholder_rut_num AS INT) ,0) AS policyholder_rut_num,\nNVL(CAST(SRC.dim_prd_pln_hrchy_key AS INT) ,0) AS dim_prd_pln_hrchy_key,\nNVL(CAST(SRC.dim_insured_key AS INT) ,0) AS dim_insured_key,\nNVL(CAST(SRC.insured_rut_num AS INT) ,0) AS insured_rut_num,\nCAST(SRC.rec_crt_dtm AS DATE),\nCAST(SRC.rec_updt_dtm AS DATE),\nCAST(SRC.actv_rec_ind AS CHAR(1)),\nCAST(SRC.etl_audit_id AS INTEGER),\nCAST(SRC.policy_item_num AS INTEGER),\nCAST(SRC.policy_issue_dt AS DATE),\nCAST(SRC.policy_eff_dt AS DATE),\ncast(src.acc_year as varchar(4)),\ncast(src.acc_month as varchar(2)),\ncast(src.agreement as INTEGER),\nCASE SRC.pcount when SRC.pcount>=10 and SRC.ite_sma_ramo in (9,10) then 'SI' \n\t        when SRC.pcount<10 and SRC.ite_sma_ramo in (9,10) then 'NO'\n\t\telse '-' end as flota,\nsrc.valid_ind as valid_ind,\nsrc.document_type as document_type,\nsrc.item_renovated_ind as item_renovated_ind,\nsrc.sales_type as sales_type,\nsrc.cycle_number as cycle_number,\nsrc.cycle_state as cycle_state,\nsrc.renovation_type as renovation_type,\nsrc.item_type as item_type,\nsrc.Lob_mkt_ref_code as Lob_mkt_ref_code,\nsrc.PATENTE as PATENTE,\nCAST(SRC.gwp_amt AS NUMERIC(25,10)),\nCAST(SRC.affects_direct_premium_amt AS NUMERIC(25,10)),\nCAST(SRC.exempt_direct_premium_amt AS NUMERIC(25,10)),\nCAST(SRC.new_direct_premium_amt AS NUMERIC(25,10)),\nCAST(renewal_direct_premium_amt AS NUMERIC(25,10)),\nCAST(endorsement_direct_premium_amt AS NUMERIC(25,10)),\nSRC.mv_id,\nSRC.mv_reason_cd,\nSRC.mv_reason_desc   \nfrom \n(select\nnvl(MAX_SID,0) as MAX_SID,\nrow_number()over( order by policy_item_id ) as num,\nsrc_sys_cd,\nnvl(policy_item_id,'0') as policy_item_id,\nnvl(policy_num,'0') as policy_num,\npolicy_exp_dt,\npolicy_status_desc ,\nfacultativo_ind,\ncoins_type_cd,\ncurr_cd,\nfacult_prem_amt,\ngwp_amt ,\nbroker_comm_amt ,\ndim_lob_key,\ndim_policy_key,\ndim_broker_key,\ndim_branch_office_key,\ndim_policyholder_key,\npolicyholder_rut_num,\ndim_prd_pln_hrchy_key ,\ndim_insured_key,\ninsured_rut_num,\nrec_crt_dtm,\nrec_updt_dtm,\n'Y' AS actv_rec_ind,\nca.etl_audit_id AS etl_audit_id,\npolicy_item_num,\npolicy_issue_dt ,\npolicy_eff_dt ,\nacc_year,\nacc_month,\nagreement,\npcount,\nite_sma_ramo,\ncase when policy_exp_dt>=sysdate then 'SI' else 'NO' end as valid_ind,\nNVL(doc_type,'Endoso') as document_type,\ncase when ite_sma_ramo = 17 then 'NO'\nWHEN  Items_siguientes>0 then 'SI' else 'NO'end as item_renovated_ind,\ncase when document_type='Propuesta' \nthen \n\tcase when item_renovated_ind='SI' then 'Renovacion' \n\telse 'Venta Nueva'\nend\nelse 'Endoso'\nend as sales_type,\nnull as cycle_number,\nnull as cycle_state,\nnull as renovation_type,\nitem_type,\nLob_mkt_ref_code,\nPATENTE,\npro_dec_afecia as affects_direct_premium_amt,\npro_dec_execia as exempt_direct_premium_amt,\ncase when sales_type='Venta Nueva' then gwp_amt else 0 end as new_direct_premium_amt,\ncase when sales_type='Renovacion' then gwp_amt else 0 end as renewal_direct_premium_amt,\ncase when sales_type='Endoso' then gwp_amt else 0 end as endorsement_direct_premium_amt,\n--ROW_NUMBER()OVER(PARTITION BY policy_item_id,src_sys_cd ORDER BY mv_eff_dt DESC)  rnk  \nnull as mv_id,\nnull as mv_reason_cd,\nnull as mv_reason_desc\n                           \nfrom \n(select \n'penta' as src_sys_cd, \ncast((pr.pro_int_poliza||'-'||pr.pro_sma_item) as varchar(35)) AS policy_item_id,\npr.pro_int_poliza AS policy_num,\nmva.mkt_ref_code as curr_cd,\np.pol_tin_tippar as coins_type_cd,\np.pol_int_cartera as agreement,\nt.ite_fec_ingres as policy_issue_dt,\nt.ite_fec_vigdes as policy_eff_dt,\nt.ite_fec_vighas as policy_exp_dt,\nnull as policy_status_desc,\nl.dim_lob_key as dim_lob_key,\npo.dim_policy_key as dim_policy_key,\nbo.dim_branch_office_key as dim_branch_office_key,\ndim_broker.dim_broker_key as dim_broker_key,\nh.dim_policyholder_key dim_policyholder_key,\nh.policyholder_rut_num as policyholder_rut_num,\ni.dim_insured_key dim_insured_key,\ni.insured_rut_num as insured_rut_num,\npph.dim_prd_pln_hrchy_key as dim_prd_pln_hrchy_key,\n--case when fa.PrimaFacultativa > 0 then 'Y' else 'N' end as facultativo_ind,\ncase when NVL(mdis.facult_prem_amt,0) <> 0 then 'Y' else 'N' end as facultativo_ind,\nmdis.facult_prem_amt as facult_prem_amt,\n(pr.pro_dec_afecia + pr.pro_dec_execia) as gwp_amt,\n((pr.pro_dec_comisi/100)* (pr.pro_dec_afecia + pr.pro_dec_execia)) as broker_comm_amt,\npr.pro_fec_vigdes mv_eff_dt,\npr.pro_sma_item as  policy_item_num,\nCURRENT_DATE as rec_crt_dtm,\nCURRENT_DATE as rec_updt_dtm,\n1 as dummy,\ncase when t.ite_sma_ramo = 17 or t.ite_sma_item=0 then 'No Renovables'\n\t when item_count.Items < 10 and t.ite_sma_ramo in (9,10) then 'No Flota'\n\t else 'Otros'\nend as item_type,\nmktrefcd.Lob_mkt_ref_code,\nT2.VEH_CHA_PATEN AS PATENTE,\ncase when pr.pro_sma_item > 0 and pr.pro_int_endoso=0 then 'Propuesta'\n\t\twhen pr.pro_sma_item > 0 and pr.pro_int_endoso<>0 then 'Endoso'\nEND as doc_type,\npr.pro_sma_anocon as acc_year,\nRIGHT(0 || pr.pro_tin_mescon, 2)  as acc_month,\npr.pro_dec_afecia as pro_dec_afecia,\npr.pro_dec_execia as pro_dec_execia,\nt.ite_sma_ramo as ramo\nfrom cdp_ods.bd_produ_x_pro_prodmes pr\nleft join\ncdp_ods.bd_produ_x_pro_item t\non pr.pro_int_poliza = t.ite_int_poliza and pr.pro_sma_item = t.ite_sma_item\nleft outer join cdp_ods.bd_produ_x_pro_poliza  p \non pr.pro_int_poliza = p.pol_int_poliza\nLEFT OUTER JOIN \n(select ite_int_poliza, count(ite_sma_item) as Items from cdp_ods.bd_produ_x_pro_item group by ite_int_poliza) item_count\non pr.pro_int_poliza=item_count.ite_int_poliza\nLEFT OUTER JOIN\n(select ref_cd,mkt_ref_code as Lob_mkt_ref_code  \nfrom cdp_stg_dwh.stg_tref_code_map_variant\nwhere  src_sys_cd = 'penta' and  ref_type_cd ='lob') mktrefcd\non t.ite_sma_ramo = mktrefcd.ref_cd\nleft outer join cdp_ods.bd_produ_x_pro_vehiculo T2\non T2.VEH_INT_POLIZA=t.ite_int_poliza and T2.VEH_SMA_ITEM=t.ite_sma_item and t.ite_sma_ramo in (9,10)\nleft outer join\n(select round(sum(case dis_tin_tipoDistribucion when 1 then dis_dec_primaCesion else 0 end),4)PrimaFacultativa,\npro_int_poliza,pro_sma_item,pro_sma_tipo \nfrom (select * from (select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,\npro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) ps \nleft outer join\ncdp_ods.RsgDst_Sdr_MovimientosDistribucion mov\non ps.pro_int_poliza=mov.dis_int_nroPoliza and ps.pro_sma_item=mov.dis_int_nroItem\nand ps.pro_sma_tipo = mov.dis_int_tipoendoso\nGROUP BY pro_int_poliza,pro_Sma_item,\npro_sma_tipo) fa\non pr.pro_int_poliza=fa.pro_int_poliza and pr.pro_sma_item=fa.pro_sma_item \nand pr.pro_sma_tipo = fa.pro_sma_tipo\n\n/*left outer join\n(select pro_tin_moneda,pro_int_poliza,pro_sma_item,\npro_sma_tipo from (select * from\n (select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,\n pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p)a where rnk=1 ) ps \nleft outer join cdp_ods.RsgDst_Sdr_MovimientosDistribucion mov\non ps.pro_int_poliza=mov.dis_int_nroPoliza and ps.pro_sma_item=mov.dis_int_nroItem\nand ps.pro_sma_tipo = mov.dis_int_tipoendoso\n GROUP BY pro_int_poliza,pro_Sma_item,\n pro_tin_moneda,pro_sma_tipo) cu\non pr.pro_int_poliza=cu.pro_int_poliza and pr.pro_sma_item=cu.pro_sma_item  \nand pr.pro_sma_tipo =cu.pro_sma_tipo\nleft outer join cdp_stg_dwh.stg_tref_code_map_variant mva\non mva.ref_type_cd='currency_type' and mva.src_sys_cd = 'penta' and cu.pro_tin_moneda=mva.ref_cd */\n\nleft outer join cdp_stg_dwh.stg_tref_code_map_variant mva\n  on mva.ref_type_cd = 'currency_type' \n  and mva.src_sys_cd = 'penta' \n  and pr.pro_tin_moneda = mva.ref_cd\n\nleft outer join\n( \nSELECT broker.dim_broker_key,p.pol_int_poliza as pol_int_poliza   from cdp_ods.bd_produ_x_pro_poliza p \ninner join cdp_ods.AgtMst_GrlAgt_Agentes a on a.Agt_Rut = p.pol_int_rutcor \nleft join cdp_dwh.dim_broker_t broker ON (a.Agt_Rut || a.Agt_DigVer) = broker.broker_rut_num and src_sys_cd in ( 'axis', 'penta')\n )dim_broker\nON p.pol_int_poliza=dim_broker.pol_int_poliza \n\nleft outer join cdp_dwh.dim_lob_t l\non pr.pro_tin_ramo = l.lob_cd and l.src_sys_cd='penta'\nleft outer join cdp_dwh.dim_policy_t po on pr.pro_int_poliza = po.policy_id and po.src_sys_cd='penta'\n\n/*left outer join\n(select distinct ref_cd,pro_int_poliza,pro_sma_item from (select * from\n (select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item, pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) pr1 left outer join cdp_stg_dwh.stg_tref_code_map_variant mv\non ref_type_cd='branch_office' and src_sys_cd = 'penta' and pr1.pro_tin_oficin=mv.ref_cd ) br \non br.pro_int_poliza=pr.pro_int_poliza and br.pro_sma_item=pr.pro_sma_item\nleft outer join cdp_dwh.dim_branch_office_t bo on br.ref_cd = bo.branch_office_id and bo.src_sys_cd='penta'*/\n\nLeft outer join cdp_dwh.dim_branch_office_t bo \n  on pr.pro_tin_oficin = bo.branch_office_id \n  and bo.src_sys_cd = 'penta'\n\n\nleft outer join cdp_dwh.dim_policyholder_t h\non h.policyholder_id=pr.pro_int_poliza and h.src_sys_cd='penta'\nleft outer join cdp_dwh.dim_insured_t i\non cast((pr.pro_int_poliza||'-'||pr.pro_sma_item) as varchar(35)) =i.insured_id and i.src_sys_cd='penta'\nleft outer join\ncdp_dwh.dim_prd_pln_hrchy_t pph on pr.pro_sma_subramo=pph.prd_cd\nand pr.pro_int_ProdPlan=pph.pln_cd and pr.pro_tin_ramo=pph.lob_cd and pph.src_sys_cd='penta'\nleft outer join cdp_stg_dwh.stg_tref_code_map_variant stg1 on stg1.src_sys_cd='penta' and stg1.ref_type_cd='movement_cd' and \ncast(cast(pr.pro_sma_tipo as integer) as varchar(20))=stg1.ref_cd\nleft outer join\n(\nselect \npro.pro_int_poliza,pro.pro_sma_item,\npro.pro_sma_tipo\n from (select * from \n(select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item, pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) pro \nleft outer join cdp_ods.bd_produ_x_pro_poliza  p \non pro.pro_int_poliza = p.pol_int_poliza \n)pct\non pr.pro_int_poliza=pct.pro_int_poliza and pr.pro_sma_item=pct.pro_sma_item  \nand pr.pro_sma_tipo = pct.pro_sma_tipo\n/*left outer join \n(\nselect \nround(sum(case dis_tin_tipoDistribucion when 4 then dis_dec_primaCesion else 0 end),4)  as  facult_prem_amt,\npro_int_poliza,\npro_sma_item,\npro_sma_anocon,pro_tin_mescon,\npro_sma_tipo\nfrom (select * from(select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,\npro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p\n) a \nwhere rnk =1) prd\nleft outer join cdp_ods.RsgDst_Sdr_MovimientosDistribucion mo\non prd.pro_int_poliza=mo.dis_int_nroPoliza and prd.pro_sma_item=mo.dis_int_nroItem\nand pro_sma_anocon  =  cast(dis_int_periodocontable/100 as  integer)  \nand pro_tin_mescon = (dis_int_periodocontable - ( cast(dis_int_periodocontable/100 as  integer) * 100))\nand prd.pro_sma_tipo = mo.dis_int_tipoendoso \nGROUP BY pro_int_poliza,pro_sma_item,pro_sma_anocon,pro_tin_mescon,pro_sma_tipo\n)amt\non pr.pro_int_poliza= amt.pro_int_poliza and pr.pro_sma_item=amt.pro_sma_item \nand pr.pro_sma_tipo = amt.pro_sma_tipo and pr.pro_sma_anocon=amt.pro_sma_anocon and pr.pro_tin_mescon=amt.pro_tin_mescon*/\n\nleft outer join ( \n  select\n    dis_int_nropoliza,\n    dis_int_nroitem,\n    dis_int_nroendoso,\n    dis_int_tipoendoso,\n    round(sum(case dis_tin_tipoDistribucion when 1 then dis_dec_primaCesion else 0 end),4) as facult_prem_amt\n  from\n    cdp_ods.RsgDst_Sdr_MovimientosDistribucion \n  group by \n    dis_int_nropoliza,\n    dis_int_nroitem,\n    dis_int_nroendoso,\n    dis_int_tipoendoso\n  ) mdis\n    on pr.pro_int_poliza = mdis.dis_int_nropoliza\n    and pr.pro_sma_item = mdis.dis_int_nroitem\n    and pr.pro_int_endoso = mdis.dis_int_nroendoso\n    and pr.pro_sma_tipo = mdis.dis_int_tipoendoso\n) src1\nleft outer join \n  (  select distinct etl_audit_id, 1 as dummy from cdp_dwh.dim_prd_pln_hrchy_t where src_sys_cd='penta') ca \n  on src1.dummy =ca.dummy \n  \nleft outer join\n(select 1 as dummy, max(fact_renovaciones_integrado_key) as MAX_SID from cdp_dwh.fact_renovaciones_integrado_t) LKP_MAXSID\non src1.dummy = LKP_MAXSID.dummy\nleft outer join \n(select ite_int_poliza, ite_sma_ramo, count(*) as pcount \nfrom cdp_ods.bd_produ_x_pro_item\ngroup by ite_int_poliza, ite_sma_ramo) pol_count\non pol_count.ite_int_poliza=src1.policy_num\nand pol_count.ite_sma_ramo=src1.ramo\n\nleft outer join\n(\nselect ite_int_poliza,ite_sma_ramo as ite_sma_ramo1,count(Id_item) as Items_siguientes from (\nselect item.ite_int_poliza as ite_int_poliza ,count_ramo.ite_sma_ramo as ite_sma_ramo, item.Id_item as Id_item \nfrom \n(\nselect ite_int_poliza,(ite_int_poliza||'-'||ite_sma_item) as Id_item\nfrom pro_item\n--where trunc(date_part(year,ite_fec_vighas))>2014\n) item\nleft outer join \n(\nSELECT ite_int_poliza, ite_sma_ramo, Count(ite_sma_item) as Items\nFROM cdp_ods.bd_produ_x_pro_item\n--WHERE trim(date_part(year,ite_fec_vighas))>2010\nGroup By ite_int_poliza, ite_sma_ramo\n) count_ramo\non item.ite_int_poliza=count_ramo.ite_int_poliza\n--where ((count_ramo.ite_sma_ramo=6 and count_ramo.Items>=10) or count_ramo.ite_sma_ramo<>6)\nwhere ((count_ramo.ite_sma_ramo = 9 and count_ramo.Items>=10) or count_ramo.ite_sma_ramo  <> 9)\n)\ngroup by ite_int_poliza,ite_sma_ramo1\n) item_reno\non src1.policy_num=item_reno.ite_int_poliza\nand src1.ramo=item_reno.ite_sma_ramo1\n)SRC\nwhere --rnk=1 and \npolicy_item_id is not null and agreement is not null"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.temp_fact_renovaciones_integrado_t where src_sys_cd='penta'"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.oprRuntimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "update cdp_dwh.temp_fact_renovaciones_integrado_t \nset coins_type_cd='8' \nwhere src_sys_cd='penta'\nand coins_type_cd='2'"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "update cdp_dwh.temp_fact_renovaciones_integrado_t \nset coins_type_cd='8' \nwhere src_sys_cd='penta'\nand coins_type_cd='2'"
    }
]