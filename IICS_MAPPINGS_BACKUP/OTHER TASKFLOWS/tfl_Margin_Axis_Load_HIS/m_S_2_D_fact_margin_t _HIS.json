[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "SELECT \nCAST(LKP.fact_margin_key AS INTEGER),\nCAST(SRC.src_sys_cd AS VARCHAR(10)),\nCAST(SRC.year_number AS Char(4)),\nCAST(SRC.month_number AS Char(2)),\nCAST(CAST(SRC.policy_num AS INTEGER) AS VARCHAR(35)),\nCAST(CAST(SRC.policy_item_id AS INTEGER) AS VARCHAR(35)),\nCAST(SRC.policy_item_num AS INTEGER),\nCAST(SRC.dim_broker_key AS INTEGER),\nCAST(SRC.broker_rut_num AS VARCHAR(35)),\nCAST(SRC.agreement AS VARCHAR(90)),\nCAST(SRC.dim_prd_pln_hrchy_key AS INTEGER),\nCAST(CAST(SRC.prd_cd AS INTEGER) AS VARCHAR(10)),\nCAST(SRC.prd_desc AS VARCHAR(100)),\nCAST(SRC.dim_lob_key AS INTEGER),\nCAST(SRC.lob_cd AS VARCHAR(10)),\nCAST(SRC.lob_desc AS VARCHAR(100)),\nCAST(SRC.dim_branch_office_key AS INTEGER),\nCAST(SRC.branch_office_cd AS VARCHAR(10)),\nCAST(SRC.branch_office_name AS VARCHAR(100)),\nCAST(rlshp_key AS INTEGER) AS rlshp_key,\nCAST(Executive_rut AS VARCHAR(50)) AS Executive_rut,\nCAST(SRC.Executive_name AS VARCHAR(100)),\nCAST(SRC.dim_policyholder_key AS INTEGER),\nCAST(SRC.dim_insured_key AS INTEGER),\nCAST(SRC.gwp_amt AS NUMERIC(25,10)),\nCAST(SRC.cwp_amt AS NUMERIC(25,10)),\n--CAST(SRC.nwp_amt AS NUMERIC(25,10)),\nCAST(SRC.actual_provision_adjusted_retained_premium_amt AS NUMERIC(25,10)),\nCAST(SRC.previous_provision_adjusted_retained_premium_amt AS NUMERIC(25,10)),\nCAST(SRC.provision_adjusted_retained_premium_amt AS NUMERIC(25,10)),\n--CAST(SRC.gained_premium_retained_amt AS NUMERIC(25,10)),\nCAST(SRC.retained_claims_payments_amt AS NUMERIC(25,10)),\nCAST(SRC.retained_recovered_claims_amt AS NUMERIC(25,10)),\nCAST(SRC.actual_retained_adjusted_reserve_claims_amt AS NUMERIC(25,10)),\nCAST(SRC.previous_retained_adjusted_reserve_claims_amt AS NUMERIC(25,10)),\nCAST(SRC.retained_adjusted_reserve_claims_amt AS NUMERIC(25,10)),\nCAST(SRC.broker_commission_amt AS NUMERIC(25,10)),\nCAST(SRC.reinsurance_discount_amt AS NUMERIC(25,10)),\nCAST(SRC.retail_comission AS NUMERIC(25,10)),\nCAST(SRC.curr_cd AS VARCHAR(10))\nFROM\n\n(\nSELECT \n'axis' AS src_sys_cd,\nMASTER.year_number as year_number,\nMASTER.month_number as month_number,\nSEGUROS.npoliza AS policy_num,\nMASTER.sseguro AS policy_item_id,\nSEGUROS.ncertif AS policy_item_num,\nNVL(BROKER.dim_broker_key,0) AS dim_broker_key,\nPERSONAS.NNUMNIF AS broker_rut_num,\nSTG_REFERENCE.ref_cd AS agreement,\nNVL(PRD_PLN_HRCHY.dim_prd_pln_hrchy_key,0) AS dim_prd_pln_hrchy_key,\nSEGUROS.sproduc AS prd_cd,\nPRD_PLN_HRCHY.prd_desc AS prd_desc,\nNVL(LOB.dim_lob_key,0) AS dim_lob_key,\nSEGUROS.cramo AS lob_cd,\nLOB.lob_desc AS lob_desc,\nNVL(BRANCH_OFFICE.dim_branch_office_key,0) AS dim_branch_office_key,\nLTRIM(RIGHT(SEGUROS.cagente,3),0) AS branch_office_cd,\nBRANCH_OFFICE.branch_office_name as branch_office_name,\nNVL(BROKER.broker_branch_rlshp_key,0) AS rlshp_key,\nSALES_EXEC.EXECUTIVE_RUT AS Executive_rut,\nSALES_EXEC.Executive_name AS Executive_name,\nPOL_HOLD.dim_policyholder_key AS dim_policyholder_key,\nINSURED.dim_insured_key AS dim_insured_key,\nMASTER.gwp_amt,\nMASTER.cwp_amt,\n--MASTER.nwp_amt,\nMASTER.actual_provision_adjusted_retained_premium_amt AS actual_provision_adjusted_retained_premium_amt,\nMASTER.previous_provision_adjusted_retained_premium_amt AS previous_provision_adjusted_retained_premium_amt,\nNVL(MASTER.provision_adjusted_retained_premium_amt,0) AS provision_adjusted_retained_premium_amt,\n--MASTER.gained_premium_retained_amt,\nMASTER.retained_claims_payments_amt,\nMASTER.retained_recovered_claims_amt,\nMASTER.actual_retained_adjusted_reserve_claims_amt,\nMASTER.previous_retained_adjusted_reserve_claims_amt,\nMASTER.retained_adjusted_reserve_claims_amt,\nMASTER.broker_commission_amt,\nMASTER.reinsurance_discount_amt,\nNVL(CESIONESREA.retail_comission,0) AS retail_comission,\nMASTER.curr_cd as curr_cd,\n1 AS DUMMY\n\nFROM \n(\t\t\nSELECT  CAST(DRIVER.SSEGURO AS INTEGER) AS sseguro,\n        DRIVER.YEAR_NUMBER AS year_number,\n        DRIVER.MONTH_NUMBER AS month_number,\n        nvl(sum(DRIVER.gwp_amt),0) as gwp_amt,\n        nvl(sum(DRIVER.cwp_amt),0) as cwp_amt,\n        nvl(sum(DRIVER.retained_claims_payments_amt),0) as retained_claims_payments_amt,\n        nvl(sum(DRIVER.retained_recovered_claims_amt),0) as retained_recovered_claims_amt,\n\t\tnvl(sum(DRIVER.actual_retained_adjusted_reserve_claims_amt),0) as actual_retained_adjusted_reserve_claims_amt,\n\t\tnvl(sum(DRIVER.previous_retained_adjusted_reserve_claims_amt),0) as previous_retained_adjusted_reserve_claims_amt,\n        nvl(sum(DRIVER.retained_adjusted_reserve_claims_amt),0) as retained_adjusted_reserve_claims_amt,\n\t    nvl(sum(DRIVER.broker_commission_amt),0) as broker_commission_amt,\n        nvl(sum(DRIVER.reinsurance_discount_amt),0) as reinsurance_discount_amt,\n\t\tnvl(sum(DRIVER.actual_provision_adjusted_retained_premium_amt),0) as actual_provision_adjusted_retained_premium_amt,\n\t\tnvl(sum(DRIVER.previous_provision_adjusted_retained_premium_amt),0) as previous_provision_adjusted_retained_premium_amt,\n        nvl(sum(DRIVER.provision_adjusted_retained_premium_amt),0) AS provision_adjusted_retained_premium_amt,\n\t\tMAX(DRIVER.CURR_CD) AS curr_cd\nFROM (\nSELECT CAST(SSEGURO AS INTEGER) AS sseguro,\n\t   SUBSTRING(fconta,1,4) as year_number,\n\t   SUBSTRING(fconta,6,2) as month_number,\n\t   SUM(prima_tarifa) AS gwp_amt,\n\t   MAX(0) AS cwp_amt,\n\t   --gwp_amt - cwp_amt AS nwp_amt, --Need to calclate on PowerBI \n\t   --nwp_amt + provision_adjusted_retained_premium_amt AS gained_premium_retained_amt, --Need to calculate on PowerBI\n\t   MAX(0) AS retained_claims_payments_amt,\n\t   MAX(0) AS retained_recovered_claims_amt,\n\t   MAX(0) AS actual_retained_adjusted_reserve_claims_amt,\n\t   MAX(0) AS previous_retained_adjusted_reserve_claims_amt,\n\t   MAX(0) AS retained_adjusted_reserve_claims_amt,\n\t   SUM( -1 * (CAST (COMISION AS NUMERIC(25,10)))) AS broker_commission_amt,\n\t   MAX(0) AS reinsurance_discount_amt,\n\t   MAX(0) AS actual_provision_adjusted_retained_premium_amt,\n\t   MAX(0) AS previous_provision_adjusted_retained_premium_amt,\t   \n\t   MAX(0) AS provision_adjusted_retained_premium_amt,\n\t   cmonseg AS curr_cd\n\nFROM cdp_ods.sisaxis_HIS_CUADRE02\nGROUP BY sseguro,year_number,month_number,curr_cd\nUNION\nSELECT CAST(PRD_NRO_SOL AS INTEGER)AS sseguro, \n\t   SUBSTRING(PRD_FEC_CON,1,4) as year_number,\n\t   SUBSTRING(PRD_FEC_CON,5,2) as month_number,\n\t   MAX(0) AS gwp_amt,\n\t   SUM((-1 * PRD_MTO_PRI_CED_DIR)) AS cwp_amt,\n\t   --gwp_amt - cwp_amt AS nwp_amt, --Need to calclate on PowerBI \n\t   --nwp_amt + provision_adjusted_retained_premium_amt AS gained_premium_retained_amt, --Need to calculate on PowerBI\n\t   MAX(0) AS retained_claims_payments_amt,\n\t   MAX(0) AS retained_recovered_claims_amt,\n\t   MAX(0) AS actual_retained_adjusted_reserve_claims_amt,\n\t   MAX(0) AS previous_retained_adjusted_reserve_claims_amt,\n\t   MAX(0) AS retained_adjusted_reserve_claims_amt,\n\t   MAX(0) AS broker_commission_amt,\n\t   SUM(PRD_MTO_DES_RES_DIR) AS reinsurance_discount_amt,\n\t   MAX(0) AS actual_provision_adjusted_retained_premium_amt,\n\t   MAX(0) AS previous_provision_adjusted_retained_premium_amt,\t   \n\t   MAX(0) AS provision_adjusted_retained_premium_amt,\n\t   DECODE(prd_mnd,'12','CLF','2','USD','3','UD','7','EUR','1','CLP') AS CURR_CD\n\nFROM cdp_ods.sisfin11_IFA_REASEGURO\nGROUP BY sseguro,year_number,month_number,curr_cd\nUNION\n(\nSELECT \tCAST(NVL(MASTER_SIN_CIEMEN_TBL.SSEGURO,RARCA_2.SSEGURO) AS INTEGER) as SSEGURO,\n\t\tNVL(MASTER_SIN_CIEMEN_TBL.YEAR_NUMBER,SUBSTRING(RARCA_2.da2,1,4)) as year_number,\n\t\tNVL(MASTER_SIN_CIEMEN_TBL.MONTH_NUMBER,SUBSTRING(RARCA_2.da2,6,2)) as month_number,\n\t\tMAX(0) AS gwp_amt,\n\t\tMAX(0) AS cwp_amt,\n\t\t--NWP_AMT,\n\t\t--gained_premium_retained_amt,\n\t\tNVL(SUM(retained_claims_payments_amt),0) AS retained_claims_payments_amt,\n\t\tNVL(SUM(retained_recovered_claims_amt),0) AS retained_recovered_claims_amt,\n\t\tNVL(SUM(NVL(retained_adjusted_reserve_claims_amt_1,0)),0) AS actual_retained_adjusted_reserve_claims_amt,\n\t\tNVL(SUM(NVL(retained_adjusted_reserve_claims_amt_2,0)),0) AS previous_retained_adjusted_reserve_claims_amt,\n\t\tNVL(SUM(NVL(retained_adjusted_reserve_claims_amt_1,0)-NVL(retained_adjusted_reserve_claims_amt_2,0)),0) AS retained_adjusted_reserve_claims_amt,\n\t\tMAX(0) AS broker_commission_amt,\n\t\tMAX(0) AS reinsurance_discount_amt,\n\t\tMAX(0) AS actual_provision_adjusted_retained_premium_amt,\n\t    MAX(0) AS previous_provision_adjusted_retained_premium_amt,\n\t\tMAX(0) AS provision_adjusted_retained_premium_amt,\n\t\tNVL(MASTER_SIN_CIEMEN_TBL.curr_cd,RARCA_2.curr_cd) as curr_cd\nFROM (\n(\nSELECT \tCIE_sseguro as sseguro,\n\t\tSUBSTRING(CIE_PER_CON,1,4) as year_number,\n\t\tSUBSTRING(CIE_PER_CON,5,2) as month_number,\n\t\tcie_mon_seg AS curr_cd\nFROM cdp_ods.siscierres_sin_ciemen_tbl\nWHERE CIE_TIP_PRO IN (1,2,3) AND CIE_EST_PROCESO = 1 --CDP-2224\nGROUP BY sseguro,year_number,month_number,curr_cd) MASTER_SIN_CIEMEN_TBL\nLEFT JOIN (\nSELECT \tCIE_sseguro as sseguro,\n\t\tSUBSTRING(CIE_PER_CON,1,4) as year_number,\n\t\tSUBSTRING(CIE_PER_CON,5,2) as month_number,\n\t\tcie_mon_seg AS curr_cd,\n\t\t----truncate operation used for 128 bit numeric data overflow (multiplication)\n\t\tSUM((-1 *  (CAST(CIE_MTO_MO as NUMERIC (25,10)) * (CAST(CIE_POR_RET_CNT as NUMERIC(25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * (CAST(CIE_POR_RET_DIR as NUMERIC (25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * (CAST(CIE_POR_RET_74 as NUMERIC(25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T1 as NUMERIC(25,10)),0)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T2 as NUMERIC(25,10)),0)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T3 as NUMERIC(25,10)),0)) / 100))))\n\t\tAS retained_claims_payments_amt\nFROM cdp_ods.siscierres_sin_ciemen_tbl\nWHERE CIE_TIP_PRO = 1 and CIE_EST_PROCESO = 1\nGROUP BY sseguro,year_number,month_number,curr_cd) RCPA\nON MASTER_SIN_CIEMEN_TBL.sseguro = RCPA.sseguro\nAND MASTER_SIN_CIEMEN_TBL.year_number = RCPA.year_number\nAND MASTER_SIN_CIEMEN_TBL.month_number = RCPA.month_number\nLEFT JOIN (\nSELECT \tCIE_sseguro as sseguro,\n\t\tSUBSTRING(CIE_PER_CON,1,4) as year_number,\n\t\tSUBSTRING(CIE_PER_CON,5,2) as month_number,\n\t\tcie_mon_seg AS curr_cd,\n\t\tSUM((CAST(CIE_MTO_MO as NUMERIC (25,10)) * (CAST(CIE_POR_RET_CNT as NUMERIC(25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * (CAST(CIE_POR_RET_DIR as NUMERIC (25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * (CAST(CIE_POR_RET_74 as NUMERIC(25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T1 as NUMERIC(25,10)),0)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T2 as NUMERIC(25,10)),0)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T3 as NUMERIC(25,10)),0)) / 100)))\n\t\tAS retained_recovered_claims_amt\nFROM cdp_ods.siscierres_sin_ciemen_tbl\nWHERE CIE_TIP_PRO = 2 and CIE_EST_PROCESO = 1\nGROUP BY sseguro,year_number,month_number,curr_cd) RRCA\t\nON MASTER_SIN_CIEMEN_TBL.sseguro = RRCA.sseguro\nAND MASTER_SIN_CIEMEN_TBL.year_number = RRCA.year_number\nAND MASTER_SIN_CIEMEN_TBL.month_number = RRCA.month_number\n\nLEFT JOIN (\nSELECT \tCIE_sseguro as sseguro,\n\t\tSUBSTRING(CIE_PER_CON,1,4) as year_number,\n\t\tSUBSTRING(CIE_PER_CON,5,2) as month_number,\n\t\tcie_mon_seg AS curr_cd,\n\t\tNVL(-1*SUM((CAST(CIE_MTO_MO as NUMERIC (25,10)) * (CAST(CIE_POR_RET_CNT as NUMERIC(25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * (CAST(CIE_POR_RET_DIR as NUMERIC (25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * (CAST(CIE_POR_RET_74 as NUMERIC(25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T1 as NUMERIC(25,10)),0)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T2 as NUMERIC(25,10)),0)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T3 as NUMERIC(25,10)),0)) / 100))) ,0)\n\t\tAS retained_adjusted_reserve_claims_amt_1\nFROM cdp_ods.siscierres_sin_ciemen_tbl\nWHERE CIE_TIP_PRO = 3 and CIE_EST_PROCESO = 1\nGROUP BY sseguro,year_number,month_number,curr_cd) RARCA_1\t\nON MASTER_SIN_CIEMEN_TBL.sseguro = RARCA_1.sseguro\nAND MASTER_SIN_CIEMEN_TBL.year_number = RARCA_1.year_number\nAND MASTER_SIN_CIEMEN_TBL.month_number = RARCA_1.month_number\nFULL JOIN (\nSELECT \tCIE_sseguro as sseguro,\n                to_date(cie_per_con,'yyyymmdd') as da,\n                dateadd(month,1,da) as da2,\n\t\tSUBSTRING(da2,1,4) as year_number,\n\t\tSUBSTRING(da2,6,2) as month_number,\n\t\tcie_mon_seg AS curr_cd,\n\t\tNVL(-1*SUM((CAST(CIE_MTO_MO as NUMERIC (25,10)) * (CAST(CIE_POR_RET_CNT as NUMERIC(25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * (CAST(CIE_POR_RET_DIR as NUMERIC (25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * (CAST(CIE_POR_RET_74 as NUMERIC(25,10)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T1 as NUMERIC(25,10)),0)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T2 as NUMERIC(25,10)),0)) / 100) +\n\t\tCAST(CIE_MTO_MO as NUMERIC(25,10)) * ((ISNULL(CAST(CIE_PRET_SHORTFALL_T3 as NUMERIC(25,10)),0)) / 100))) ,0) \n\t\tAS retained_adjusted_reserve_claims_amt_2\nFROM cdp_ods.siscierres_sin_ciemen_tbl\nWHERE CIE_TIP_PRO = 3 and CIE_EST_PROCESO = 1\nAND DA2 < DATE_TRUNC('month',CURRENT_DATE) \nGROUP BY sseguro,year_number,month_number,curr_cd,cie_per_con) RARCA_2\t\nON MASTER_SIN_CIEMEN_TBL.sseguro = RARCA_2.sseguro\nAND MASTER_SIN_CIEMEN_TBL.year_number = RARCA_2.year_number\nAND MASTER_SIN_CIEMEN_TBL.month_number = RARCA_2.month_number\n\n\n\n) \nGROUP BY MASTER_SIN_CIEMEN_TBL.sseguro,MASTER_SIN_CIEMEN_TBL.year_number,MASTER_SIN_CIEMEN_TBL.month_number,MASTER_SIN_CIEMEN_TBL.curr_cd,\nRARCA_2.sseguro,RARCA_2.curr_cd,RARCA_2.da2\n\n\n)\n\nUNION\nSELECT cast(CIRI_SSEGURO as NUMERIC(25,10)) as sseguro,\n\t   SUBSTRING(CIRI_PERCON,1,4) AS year_number,\n\t   SUBSTRING(CIRI_PERCON,5,2) AS month_number,\n\t   MAX(0) AS gwp_amt,\n\t   MAX(0) AS cwp_amt,\n\t   --gwp_amt - cwp_amt AS nwp_amt, --Need to calclate on PowerBI \n\t   --nwp_amt + provision_adjusted_retained_premium_amt AS gained_premium_retained_amt, --Need to calculate on PowerBI\n\t   MAX(0) AS retained_claims_payments_amt,\n\t   MAX(0) AS retained_recovered_claims_amt,\n\t   MAX(0) AS actual_retained_adjusted_reserve_claims_amt,\n\t   MAX(0) AS previous_retained_adjusted_reserve_claims_amt,\n\t   MAX(0) AS retained_adjusted_reserve_claims_amt,\n\t   MAX(0) AS broker_commission_amt,\n\t   MAX(0) AS reinsurance_discount_amt,\n\t   MAX(0) AS actual_provision_adjusted_retained_premium_amt,\n\t   MAX(0) AS previous_provision_adjusted_retained_premium_amt,\n\t   MAX(0) AS provision_adjusted_retained_premium_amt,\n\t   ciri_cmonseg AS curr_cd       \t\nFROM cdp_ods.siscierres_ciet_reserva_ifrs\nGROUP BY sseguro,year_number,month_number,curr_cd\n \nUNION\n(\nSELECT \tcast(NVL(MASTER_CIET_HIS_RESERVA_IFRS.SSEGURO,PREV.SSEGURO) as NUMERIC(25,10)) AS SSEGURO,\n\t\tNVL(MASTER_CIET_HIS_RESERVA_IFRS.YEAR_NUMBER,SUBSTRING(PREV.da2,1,4)) AS YEAR_NUMBER,\n\t\tNVL(MASTER_CIET_HIS_RESERVA_IFRS.MONTH_NUMBER,SUBSTRING(PREV.da2,6,2)) AS MONTH_NUMBER,\n\t\tMAX(0) AS GWP_AMT,\n\t\tMAX(0) AS CWP_AMT,\n\t\tMAX(0) AS retained_claims_payments_amt,\n\t    MAX(0) AS retained_recovered_claims_amt,\n\t    MAX(0) AS retained_adjusted_reserve_claims_amt,\n\t\tMAX(0) AS actual_retained_adjusted_reserve_claims_amt,\n\t    MAX(0) AS previous_retained_adjusted_reserve_claims_amt,\n\t    MAX(0) AS broker_commission_amt,\n\t    MAX(0) AS reinsurance_discount_amt,\n\t\tNVL(SUM(NVL(provision_adjusted_retained_premium_amt1,0))) AS actual_provision_adjusted_retained_premium_amt,\n\t\tNVL(SUM(NVL(provision_adjusted_retained_premium_amt2,0)),0) AS previous_provision_adjusted_retained_premium_amt,\n\t\tNVL(SUM(NVL(provision_adjusted_retained_premium_amt1,0)-NVL(provision_adjusted_retained_premium_amt2,0)),0) AS provision_adjusted_retained_premium_amt,\n\t\tNVL(MASTER_CIET_HIS_RESERVA_IFRS.CURR_CD,PREV.CURR_CD) AS CURR_CD\n\t\t\nFROM (\n(SELECT CIRI_sseguro AS sseguro, \n\t    SUBSTRING(CIRI_PERCON,1,4) AS year_number,\n\t    SUBSTRING(CIRI_PERCON,5,2) AS month_number,\n\t    CIRI_CMONSEG AS CURR_CD\nFROM cdp_ods.siscierres_ciet_his_reserva_ifrs\n\nGROUP BY sseguro,year_number,month_number,curr_cd) MASTER_CIET_HIS_RESERVA_IFRS\nLEFT JOIN (\n\tSELECT CIRI_sseguro AS sseguro, \n\t    SUBSTRING(CIRI_PERCON,1,4) AS year_number,\n\t    SUBSTRING(CIRI_PERCON,5,2) AS month_number,\n\t    CIRI_CMONSEG AS CURR_CD,\n        NVL(SUM((-1 * CAST(ciri_ireserva_ret AS NUMERIC(25,10)))),0) AS provision_adjusted_retained_premium_amt1\n\tFROM cdp_ods.siscierres_ciet_his_reserva_ifrs\n\tGROUP BY sseguro,year_number,month_number,curr_cd) ACTUAL\nON MASTER_CIET_HIS_RESERVA_IFRS.sseguro = ACTUAL.sseguro\nAND MASTER_CIET_HIS_RESERVA_IFRS.year_number = ACTUAL.year_number\nAND MASTER_CIET_HIS_RESERVA_IFRS.month_number = ACTUAL.month_number\nFULL JOIN (\n\tSELECT CIRI_sseguro AS sseguro,\n\t\tto_date(ciri_percon,'yyyymm') as da,\n                dateadd(month,1,da) as da2,\n\t\tSUBSTRING(da2,1,4) as year_number,\n\t\tSUBSTRING(da2,6,2) as month_number,\n\t    CIRI_CMONSEG AS CURR_CD,\n        NVL(SUM((-1 * CAST(ciri_ireserva_ret AS NUMERIC(25,10)))),0) AS provision_adjusted_retained_premium_amt2 \n\tFROM cdp_ods.siscierres_ciet_his_reserva_ifrs\n\tWHERE DA2 < DATE_TRUNC('month',CURRENT_DATE)\n\tGROUP BY sseguro,year_number,month_number,curr_cd,CIRI_PERCON) PREV\nON MASTER_CIET_HIS_RESERVA_IFRS.sseguro = PREV.sseguro\nAND MASTER_CIET_HIS_RESERVA_IFRS.year_number = PREV.year_number\nAND MASTER_CIET_HIS_RESERVA_IFRS.month_number = PREV.month_number)\nGROUP BY MASTER_CIET_HIS_RESERVA_IFRS.SSEGURO,MASTER_CIET_HIS_RESERVA_IFRS.YEAR_NUMBER,MASTER_CIET_HIS_RESERVA_IFRS.MONTH_NUMBER,MASTER_CIET_HIS_RESERVA_IFRS.CURR_CD,PREV.SSEGURO,PREV.CURR_CD,PREV.da2\n) \n) DRIVER\nWHERE year_number > '2014'\nGROUP BY DRIVER.SSEGURO,DRIVER.YEAR_NUMBER,DRIVER.MONTH_NUMBER,DRIVER.CURR_CD\n) MASTER\n\nLEFT JOIN\n\n(SELECT DISTINCT SSEGURO,\n\t\tNPOLIZA,\n\t\tNCERTIF,\n\t\tsproduc,\n\t\tCRAMO,\n\t\tCAGENTE,\n\t\tCAGRSEG,\n\t\tCMONSEG AS curr_cd\n\t\tFROM cdp_ods.sisaxis_seguros) AS SEGUROS\n\nON MASTER.sseguro = SEGUROS.sseguro\t\t\n\n--seguros-agentes-personas\t\t\nLEFT JOIN\n(SELECT DISTINCT CAGENTE, NNUMNIF FROM cdp_ods.sisaxis_personas PERSONAS1\nLEFT JOIN cdp_ods.sisaxis_agentes AGENTES1\nON PERSONAS1.SPERSON = AGENTES1.SPERSON\n) AS PERSONAS\nON SEGUROS.CAGENTE = PERSONAS.CAGENTE\n\nLEFT JOIN\n(SELECT DISTINCT REF_CD, REF_DESC, RNK from \n(\nselect REF_CD, REF_DESC, ROW_number() over (partition by REF_CD order by ref_rec_eff_dtm DESC) as rnk from\ncdp_stg_dwh.stg_tref_code_map_variant where src_sys_cd='axis' and ref_type_cd in ('agreement','contract_num')\n) STG_REFERENCE1\nWHERE STG_REFERENCE1.RNK = 1 ) STG_REFERENCE\nON SEGUROS.CAGRSEG = STG_REFERENCE.ref_cd\n\nLEFT JOIN \n(SELECT SSEGURO,SUBSTRING(FCONTAB,1,4) AS YEAR_NUMBER, SUBSTRING(FCONTAB,6,2) AS MONTH_NUMBER,\nCASE WHEN SUM(DECODE(CTRAMO,18,ICESMON,0)) >= 0 then (-1*SUM(DECODE(CTRAMO,18,ICESMON,0)))\nelse SUM(DECODE(CTRAMO,18,ICESMON,0)) end AS retail_comission  FROM cdp_ods.sisaxis_cesionesrea\nGROUP BY sseguro,year_number,month_number) CESIONESREA\nON MASTER.sseguro = CESIONESREA.sseguro\nAND MASTER.YEAR_NUMBER = CESIONESREA.YEAR_NUMBER\nAND MASTER.MONTH_NUMBER  = CESIONESREA.MONTH_NUMBER  \n\n--BROKER AND BROKER_BRANCH_RELATIONSHIP KEY\nLEFT JOIN \n(SELECT DISTINCT BRKR.dim_broker_key,AA.sseguro,AA.broker_branch_rlshp_key FROM\n(SELECT DISTINCT BRKR_RLSHP.entity_rut_num,BRKR_RLSHP.broker_branch_rlshp_key, SEG.sseguro\nFROM (select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\nINNER JOIN cdp_dwh.broker_branch_rlshp_t BRKR_RLSHP\nON SEG.cagente=BRKR_RLSHP.rlshp_src_id\nAND BRKR_RLSHP.entity_type_cd=4\nAND BRKR_RLSHP.src_sys_cd='axis')AA\nINNER JOIN cdp_dwh.dim_broker_t BRKR   \nON AA.entity_rut_num=BRKR.broker_id\nAND BRKR.src_sys_cd='axis'\n) BROKER\nON BROKER.sseguro=MASTER.sseguro\n\n--PRD PLAN HIERARCHY KEY\nLEFT JOIN (\nSELECT DISTINCT PLAN_HIRE.dim_prd_pln_hrchy_key, PLAN_HIRE.prd_desc, SEG.sseguro FROM\n(select * from cdp_ods.sisaxis_seguros WHERE ncertif > 0) SEG\nINNER JOIN cdp_dwh.dim_prd_pln_hrchy_t PLAN_HIRE\nON PLAN_HIRE.prd_cd=CAST(CAST(SEG.sproduc AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.lob_cd=CAST(CAST(SEG.cramo AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.pln_cd=CAST(CAST(SEG.cactivi AS INTEGER) AS VARCHAR(10))\nAND PLAN_HIRE.src_sys_cd='axis'\n)PRD_PLN_HRCHY\nON PRD_PLN_HRCHY.sseguro=MASTER.sseguro\n\n--LOB KEY\nLEFT JOIN (\nSELECT DISTINCT dim_lob_key,lob_cd,lob_desc, src_sys_cd  \nfrom cdp_dwh.dim_lob_t) LOB \nON CAST(CAST (SEGUROS.CRAMO  AS INTEGER) AS VARCHAR(10)) =LOB.lob_cd  \nAND LOB.src_sys_cd='axis'\n\n--BRANCH OFFICE KEY\nLEFT JOIN (\nSELECT DISTINCT dim_branch_office_key,branch_office_cd, branch_office_name, src_sys_cd \nfrom cdp_dwh.dim_branch_office_t) BRANCH_OFFICE\nON LTRIM(RIGHT(SEGUROS.cagente,3),0)=LTRIM(BRANCH_OFFICE.branch_office_cd,0)  /*LTRIM has been handled to remove leading zero from both join condition to get a exact match*/ \nAND BRANCH_OFFICE.src_sys_cd='axis'\n\n\n--SALES_EXEC\n\nLEFT  JOIN\n(select DISTINCT seg.sseguro, a.cagente cagente, \n                               e.cod_eje cejecut,  \n                               dim.broker_branch_rlshp_key rlshp_key, ---- row  47 mapping\n                               p.nnumnif Executive_rut, ---row 46   mapping\n                               decode(nvl(p.tnombre,'*'),'*',p.tapelli,p.tapelli||', '||p.tnombre) Executive_name ---- row  48 mapping\nfrom    cdp_ods.sisaxis_agentes a, \n        (select   r.cod_corr, cod_eje,decode(estado,'V','true','false') activo\n         from     cdp_ods.sisaxis_rel_corr_eje r\n         where    cod_rel =(select max(cod_rel) from cdp_ods.sisaxis_rel_corr_eje where cod_corr=r.cod_corr)) e,\n        cdp_ods.sisaxis_seguros seg,\n        cdp_ods.sisaxis_agentes ex,\n        cdp_ods.sisaxis_personas p,\n        cdp_dwh.broker_branch_rlshp_t dim\nwhere   a.ctipage=4\nand     a.cagente=e.cod_corr(+)\nand    seg.cagente = a.cagente\nand ex.cagente = e.cod_eje \nand ex.ctipage = 5\nand ex.sperson = p.sperson\nand ex.cagente = dim.RLSHP_SRC_ID\n) SALES_EXEC\nON MASTER.SSEGURO = SALES_EXEC.SSEGURO\n\n--ADDED ON 26-05-2020 FOR CHANGE REQUEST \n--POLICY HOLDER\nLEFT JOIN\n(SELECT DISTINCT dim.dim_policyholder_key dim_policyholder_key,TOMA.sseguro sseguro\nFROM  cdp_ods.sisaxis_tomadores TOMA\nINNER JOIN cdp_dwh.dim_policyholder_t dim\nON cast(cast(TOMA.SPERSON as integer)||'-'||cast(nvl(TOMA.CDOMICI,0) as integer) as varchar(35))=dim.policyholder_id\nAND dim.src_sys_cd='axis'\n)POL_HOLD\nON MASTER.sseguro=POL_HOLD.sseguro\n\n--ADDED ON 26-05-2020 FOR CHANGE REQUEST\n--INSURED\n\nLEFT JOIN\n(SELECT DISTINCT dim.dim_insured_key,AA.sseguro  from \n(select \n    sseguro, \n    sperson,\n    coalesce(CAST (cdomici AS INTEGER), 0) as cdomici,\n    row_number() over( partition by sseguro order by nmovima,nriesgo desc,norden desc ) rowindex\n  from \n    cdp_ods.sisaxis_asegurados tase \n  where \n    ffecfin is null \n)AA\ninner join cdp_dwh.dim_insured_t dim\n      on AA.sperson = dim.insured_id\n      and AA.cdomici = dim.address_id\n      and dim.src_sys_cd = 'axis'\n\t  and AA.rowindex = 1\n)INSURED\nON MASTER.SSEGURO=INSURED.sseguro\n\n) SRC \n\n--FETCHING MAX INCREMENTAL KEY\nLEFT JOIN ( SELECT 1 AS DUMMY, MAX(fact_margin_key) as fact_margin_key FROM cdp_dwh.fact_margin_t) LKP\nON SRC.DUMMY = LKP.DUMMY ;"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "DELETE FROM CDP_DWH.FACT_MARGIN_T WHERE SRC_SYS_CD = 'axis' ;"
    }
]