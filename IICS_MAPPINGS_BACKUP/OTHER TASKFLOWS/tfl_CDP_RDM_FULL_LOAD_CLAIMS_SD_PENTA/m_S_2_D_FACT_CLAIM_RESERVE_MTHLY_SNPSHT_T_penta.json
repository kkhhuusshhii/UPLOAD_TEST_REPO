[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select \n(SRC1.MAXSID+SRC1.num) as fact_reserve_activity_key,\nSRC1.src_sys_cd,\nSRC1.claim_num,\nSRC1.claimant_num,\nSRC1.loss_item_num,\nSRC1.lob_cd,\nSRC1.cov_cd,\nSRC1.acct_dt,\nSRC1.reserve_amt,\nSRC1.ceded_reserve_amt,\nSRC1.retained_reserve_amt,\nSRC1.reserve_amt_curr_cd,\nSRC1.coinsurance_reserve_amt,\nSRC1.dim_claim_key,\nSRC1.dim_claim_status_key,\nSRC1.dim_claim_type_key,\nSRC1.dim_branch_office_key,\nSRC1.dim_claimant_key,\nSRC1.dim_loss_item_key,\nSRC1.dim_lob_key,\nSRC1.dim_cov_key,\nSRC1.rec_crt_dtm,\nSRC1.rec_updt_dtm,\nSRC1.actv_rec_ind,\nSRC1.audit_id\nfrom \n(\nselect\ndistinct \nrow_number() over (partition by src.claim_num,src.claimant_num,src.loss_item_num, \nsrc.lob_cd,src.cov_cd,src.acct_dt order by src.rec_crt_dtm desc) as row_cnt,\nrow_number() over (order by claim_num) num, \n1 as dummy,\nsrc.src_sys_cd,\nsrc.claim_num,\nsrc.claimant_num,\nsrc.loss_item_num,\nsrc.lob_cd,\nsrc.cov_cd,\nsrc.acct_dt,\nsrc.reserve_amt,\nsrc.ceded_reserve_amt,\nsrc.retained_reserve_amt,\nsrc.reserve_amt_curr_cd,\nsrc.coinsurance_reserve_amt,\nsrc.dim_claim_key,\nsrc.dim_claim_status_key,\nsrc.dim_claim_type_key,\nsrc.dim_branch_office_key,\nsrc.dim_claimant_key,\nsrc.dim_loss_item_key,\nsrc.dim_lob_key,\nsrc.dim_cov_key,\nCURRENT_DATE as rec_crt_dtm,\nCURRENT_DATE as rec_updt_dtm,\n'Y' as actv_rec_ind,\nba.etl_audit_id as audit_id,\nnvl(LKP_MAXSID.MAX_SID,0) as MAXSID\nfrom \n(\nselect\ndistinct \ncast (kk.claim_num as varchar(35)),\ncast (kk.claimant_num as integer),\ncast(kk.loss_item_num as integer),\ncast(kk.lob_cd as varchar(10)),\ncast(kk.cov_cd as varchar(10)),\nkk.acct_dt,\ncast(kk.reserve_amt as numeric(25,10)),\ncast (kk.ceded_reserve_amt as numeric(25,10)),\ncast(kk.retained_reserve_amt as numeric(25,10)),\ncast(kk.reserve_amt_curr_cd as varchar(10)),\ncast(kk.coinsurance_reserve_amt as numeric(25,10)),\ncast(nvl(kk.dim_claim_key,0) as integer) as dim_claim_key,\ncast (nvl(kk.dim_claim_status_key,0) as integer) as dim_claim_status_key,\ncast(nvl(kk.dim_claim_type_key,0) as integer) as dim_claim_type_key,\ncast(nvl(kk.dim_branch_office_key,0) as integer) as dim_branch_office_key,\ncast (nvl(hh.dim_claimant_key,0) as integer) as dim_claimant_key,\ncast(nvl(mm.dim_loss_item_key,0)as integer) as dim_loss_item_key,\ncast(nvl(kk.dim_lob_key,0) as integer) as dim_lob_key,\ncast(kk.dim_cov_key as integer) as dim_cov_key,\ncast (kk.src_sys_cd as varchar(10)),\nkk.rec_crt_dtm,\nkk.dummy\nfrom \n(\nselect\ndistinct \ngst.Siniestro as claim_num,\ncase \nwhen gst.tipoliquabogado = 1 then 3\nwhen  gst.tipoliquabogado =2 then 1 \nelse null end as claimant_num,\ncase\nwhen gst.tipoliquabogado = 1 then 3\nwhen  gst.tipoliquabogado = 2 then 1 \nelse null\nend as loss_item_num,\ngg.lob_cd as lob_cd,\n0 as cov_cd,\ncast(cast(cast(AnoContable as varchar(4))||case when length (cast(MesContable as varchar(2)))=1 then '0'|| cast(MesContable as varchar(2)) else  cast(MesContable as varchar(2)) end||cast('01' as varchar(2)) as varchar(10)) as date) as acct_dt,\ncase \nwhen gst.tipoliquabogado=1\nthen ((nvl(gst.RetensionSinXL,0)-nvl(gst.ProvRetTotal,0)) + nvl(gst.ProvCedFac,0)  + nvl(gst.ProvCedQP,0) + nvl(gst.ProvCedExd,0) + nvl(gst.ProvRetTotal,0)+nvl(gst.ProvOtros,0))  \nwhen gst.tipoliquabogado<>1 or gst.tipoliquabogado is null\nthen ((nvl(gst.RetensionSinXL,0)-nvl(gst.ProvRetTotal,0)) + nvl(gst.ProvCedFac,0)  + nvl(gst.ProvCedQP,0) + nvl(gst.ProvCedExd,0) + nvl(gst.ProvRetTotal,0)+nvl(gst.ProvOtros,0))\nelse null end as reserve_amt, -- CDP 157 \n\ncase when gst.tipoliquabogado = 1 then\n((nvl(gst.RetensionSinXL,0)-nvl(gst.ProvRetTotal,0)) + nvl(gst.ProvCedFac,0)  + nvl(gst.ProvCedQP,0) + nvl(gst.ProvCedExd,0) )  \nwhen gst.tipoliquabogado<>1 or gst.tipoliquabogado is null then \n((nvl(gst.RetensionSinXL,0)-nvl(gst.ProvRetTotal,0)) + nvl(gst.ProvCedFac,0)  + nvl(gst.ProvCedQP,0) + nvl(gst.ProvCedExd,0)) \nelse null  \n end as ceded_reserve_amt, -- CDP 157\n \ncase when gst.tipoliquabogado = 1 then\nnvl(gst.ProvRetTotal,0) \nwhen  gst.tipoliquabogado<>1 or gst.tipoliquabogado is null\nthen nvl(gst.ProvRetTotal,0) \nelse null end  as retained_reserve_amt, -- CDP 157\n\n'CLP' as reserve_amt_curr_cd,\n\ncase when gst.tipoliquabogado = 1 then (nvl(ProvOtros,0))  \nwhen gst.tipoliquabogado<>1 or gst.tipoliquabogado is null then (nvl(ProvOtros,0))  \nelse null \nend  as coinsurance_reserve_amt, -- CDP 157\n\na.dim_claim_key as dim_claim_key,\ncase when gst.TipoLiquAbogado=1 then cc.dim_claim_status_key \nwhen gst.TipoLiquAbogado=2 then ee.dim_claim_status_key\nelse null end as dim_claim_status_key,\ncase when gst.TipoLiquAbogado in (1,2) then dd.dim_claim_type_key \nelse null end as dim_claim_type_key,\nb.dim_branch_office_key as dim_branch_office_key,\ngg.dim_lob_key as dim_lob_key,\n'0' as dim_cov_key,\ncast('penta' as varchar(10)) as src_sys_cd,\ngst.fecsiniestro as rec_crt_dtm,\n1 as dummy\nfrom  cdp_ods.gstmst_gst_provision gst\nleft join cdp_ods.bd_sinie_x_sin_perfil aa\non gst.Siniestro=aa.per_int_sinies\nleft join \n( select dim_claim_key, claim_num from cdp_dwh.dim_claim_t where src_sys_cd='penta') a\non a.claim_num=gst.Siniestro\nleft join \n(select dim_branch_office_key, branch_office_cd,branch_office_id from cdp_dwh.dim_branch_office_t where src_sys_cd='penta') b\non b.branch_office_id=gst.oficina --Updated the branch office from cd to id\nleft join  \n(select dim_claim_status_key,claim_status_cd, src_sys_cd from cdp_dwh.dim_claim_status_t  where src_sys_cd='penta') cc\non aa.dap_tin_estado=cc.claim_status_cd\nleft join \n(select dim_claim_status_key,claim_status_cd, src_sys_cd from cdp_dwh.dim_claim_status_t where src_sys_cd='penta') ee\non aa.dat_tin_estado=ee.claim_status_cd\nleft join \ncdp_ods.grlmst_gen_indicador ff\non aa.per_tin_tiposiniestro =ff.ind_indica \nand ff.ind_tipo=705\nleft join \n(select claim_type_cd, src_sys_cd, dim_claim_type_key from  cdp_dwh.dim_claim_type_t where src_sys_cd='penta') dd\non aa.per_tin_tiposiniestro=dd.claim_type_cd\nleft join \n(select lob_cd, dim_lob_key from cdp_dwh.dim_lob_t where src_sys_cd='penta') gg\non gst.Ramo=gg.lob_cd\n) kk\nleft join\n(select claim_num, claimant_num, dim_claimant_key,claimant_id from cdp_dwh.dim_claimant_t where src_sys_cd='penta') hh\non hh.claim_num=kk.claim_num\nand hh.claimant_num=kk.claimant_num --CDP 153\nleft join \n(select dim_loss_item_key, claim_num, loss_item_num, loss_item_id from cdp_dwh.dim_loss_item_t where src_sys_cd='penta') mm\non mm.claim_num=kk.claim_num\nand mm.loss_item_num=kk.loss_item_num  --CDP 153\nleft join\n(select b.per_int_rutase,p.Siniestro from cdp_ods.GstMst_Gst_Provision p, \n                        cdp_ods.bd_sinie_x_sin_perfil b \n                        where p.Siniestro=b.per_int_sinies \n                        and p.Tipoliquabogado =2) bp \n                        on hh.claimant_id=bp.per_int_rutase\n                        and mm.loss_item_id=bp.per_int_rutase\n                        and bp.Siniestro=kk.claim_num           --CDP 153\n                        \n)\nsrc\nleft join\n(select 1 as dummy, max(fact_reserve_activity_key) as MAX_SID from cdp_dwh.fact_claim_reserve_mthly_snpsht_t) LKP_MAXSID\non src.dummy = LKP_MAXSID.dummy\nleft join \n  (\n  select distinct etl_audit_id,1 as dummy from cdp_dwh.dim_branch_office_t where src_sys_cd ='penta' ) ba \n  on src.dummy =ba.dummy \n)SRC1 \nwhere row_cnt = 1"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.fact_claim_reserve_mthly_snpsht_t where src_sys_cd='penta';\ncommit;"
    }
]