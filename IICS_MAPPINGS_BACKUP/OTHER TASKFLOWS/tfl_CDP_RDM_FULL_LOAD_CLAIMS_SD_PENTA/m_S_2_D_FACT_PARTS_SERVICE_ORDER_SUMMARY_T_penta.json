[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select src_query.*, ref_data_type.ref_desc as order_type_desc, ref_data_status.ref_desc as order_status_desc\nfrom\n(\nselect\nclaim_num,\nclaimant_num,\nloss_item_num,\norder_num,\nadj_num,\nappraiser_estimated_amt,\ncoverage_type_cd,\ndim_cov_key,\ndim_bdshp_key,\ndim_claim_type_key,\ndim_claim_key,\ndim_Spare_Parts_Analyst_key,\ndim_claimant_key,\ndim_claim_adjuster_key,\ndim_loss_item_key,\ndim_parts_provdr_key,\nestimated_order_completion_dt,\n--order_awarded_count,(CDP migration)\norder_close_dt,\norder_creation_dt,\norder_issue_dt,\norder_paid_dt,\norder_status_cd,\norder_type_cd,\nquot_dt,\ntotal_order_cost_amt,\ntotal_accessory_cost_amt,\ntotal_adjustment_amt,\ntotal_discount_amt,\ntotal_labor_cost_amt,\ntotal_spare_parts_amount,\nclaim_closed_dt,\ntotal_parts_qty,\ntotal_tax_amt,\nvehicle_discharged_dt,\nvehicle_received_dt,\ntotal_awarded_adj_count,\ndim_branch_office_key,\norder_paid_ind,\norder_cost_curr_cd,\nadjuster_assign_dt,\n--order_type_desc,\n--order_status_desc,\ntotal_adj_count,\n--order_count,--(CDP migration)\nsrc_sys_cd,\n--actv_rec_ind,\nMAX_SID\n\nFROM\n(\nselect \nnvl(src.claim_num,'0') as claim_num ,\nnvl(src.claimant_num,0)  claimant_num,\nnvl(src.loss_item_num,0) as loss_item_num,\nnvl(src.order_num,'0') as order_num,\n0 as adj_num,\ncase when appraiser_amt_thirdparty_1.appraiser_amt_thirdparty_1 <>0 and src.id_tercero>0 then appraiser_amt_thirdparty_1.appraiser_amt_thirdparty_1 \n     when appraiser_amt_thirdparty_2.appraiser_amt_thirdparty_2 <>0 and src.id_tercero>0 then appraiser_amt_thirdparty_2.appraiser_amt_thirdparty_2 \n     when appraiser_amt_insured_1.appraiser_amt_insured_1 <>0 and src.id_tercero=0 then appraiser_amt_insured_1.appraiser_amt_insured_1\n     when appraiser_amt_insured_2.appraiser_amt_insured_2 <>0 and src.id_tercero=0 then appraiser_amt_insured_2.appraiser_amt_insured_2 end as appraiser_estimated_amt,\nNULL as coverage_type_cd,\n0 as dim_cov_key,\nnvl(dim_bdshp_key.dim_bdshp_key,0) dim_bdshp_key,\nnvl(dim_claim_type_key.dim_claim_type_key,0) dim_claim_type_key,\nnvl(dim_claim_key.dim_claim_key,0) dim_claim_key,\n0 as dim_Spare_Parts_Analyst_key,\nnvl(src.dim_claimant_key,0) dim_claimant_key,\nnvl(liquidator_assignment_date.dim_claim_adjuster_key,0) dim_claim_adjuster_key,\nnvl(src.dim_loss_item_key,0) dim_loss_item_key,\nnvl(dim_parts_provdr_key.dim_parts_provdr_key,0) dim_parts_provdr_key,\ncast(null as date) estimated_order_completion_dt,\nliquidator_assignment_date.liquidator_assignment_date AS adjuster_assign_dt,\ncast(null as date) order_approval_dt,\ncast(1 as integer) order_awarded_count,\ncast(null as date) order_close_dt,\ncast(src.order_creation_dt as date) order_creation_dt,\ncast(src.order_creation_dt as date) order_issue_dt,\ncast(src.order_paid_date as date) order_paid_dt,\ncast(src.order_status_code as varchar(10)) order_status_cd,\ncast(src.order_type_code as varchar(10)) order_type_cd,\ncast(Quotation_creation_date.Quotation_creation_date as date) quot_dt,\ncast(null as date) repair_completion_dt,\ncast(case when src.id_tercero=0 then nvl(accessory_cost_valorizada_insured.accessory_cost_valorizada,0) + nvl(accessory_cost_ocexterna_insured.accessory_cost_ocexterna ,0) \n     when src.id_tercero>0 then nvl(accessory_cost_valorizada_third_party.accessory_cost_valorizada,0) + nvl(accessory_cost_ocexterna_third_party.accessory_cost_ocexterna ,0) \n     else 0\n     end as numeric(21,4)) total_accessory_cost_amt,\ncast(null as numeric(21,4)) total_adjustment_amt,\ncast(src.total_discount_amt as numeric(21,4)) total_discount_amt,\ncast(null as numeric(21,4)) total_labor_cost_amt,\ncast(total_spare_parts_amount.total_spare_parts_amount as numeric(21,4)) total_spare_parts_amount,\ncast(claim_close_Date.claim_close_Date as date) claim_closed_dt,\ncast(null as integer) total_labor_hours_qty,\ncast(src.total_order_cost_amt as numeric(21,4))  total_order_cost_amt,\ncast(case when total_parts_quantity.total_parts_quantity>32767 \n     then 32767 \n     else total_parts_quantity.total_parts_quantity end as integer) total_parts_qty,\ncast(src.total_tax_amt as numeric(21,4)) total_tax_amt,\ncast(null as date) vehicle_discharged_dt,\ncast(null as date) vehicle_received_dt,\ncast(0 as smallint) total_awarded_adj_count,\ncast(nvl(dim_claim_key.dim_branch_office_key,0) as integer) dim_branch_office_key,  --DID-175\ncast(nvl(src.order_paid_ind,'N') as char(10)) order_paid_ind,\ncast ('4' as varchar(10)) as order_cost_curr_cd,\ncast('' as varchar(80)) order_type_desc,\ncast('' as varchar(80)) order_status_desc, \ncast( 1 as smallint) total_adj_count,\ncast(null as integer) order_count, \n'penta' as src_sys_cd,\n'Y' as actv_rec_ind,\ncurrent_timestamp as rec_crt_dtm,\n1 dummy\n, row_number() over(partition by src.claim_num, src.order_num,src.claimant_num order by src.loss_item_num desc) as row_num\n     \nfrom\n(\n/******Main driver query*****/\nselect \nsr.claim_num,\nsr.id_mat_danos,\nsr.codigo_oficina ,\nsr.order_num,\nsr.id_tercero,\nsr.patente,\nsr.src,\ncase when sr.id_tercero>0 then 'Thirdparty' when sr.id_tercero=0 then 'Insured' end as Scenario,\ncast((case when sr.id_tercero>0 then c3.claimant_num when sr.id_tercero=0 then c1.claimant_num end) as smallint) claimant_num,\ncast((case when sr.id_tercero>0 then l3.loss_item_num when sr.id_tercero=0 then l1.loss_item_num end) as smallint) loss_item_num,\ncast((case when sr.id_tercero>0 then c3.dim_claimant_key when sr.id_tercero=0 then c1.dim_claimant_key end)as integer)  dim_claimant_key,\ncast((case when sr.id_tercero>0 then l3.dim_loss_item_key when sr.id_tercero=0 then l1.dim_loss_item_key end)  as integer) dim_loss_item_key,\ncase when sr.id_tercero>0 then 2 else 1 end as tercero_join,\nsr.total_discount_amt,\nsr.total_order_cost_amt,\nsr.total_tax_amt,\nsr.order_creation_dt,\nsr.order_status_code,\nsr.order_type_code,\nsr.order_paid_ind,\nsr.For_join\n,sr.order_paid_date          \nfrom\n\n(\n/*********DRIVER - Total 2 paths ***********/\n/****Order from Valorizada****/\nSelect distinct\nmd.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\ncodigo_orden_valorizada as order_num,\nmd.id_tercero,\nmd.patente,\nov.total_descuentos as total_discount_amt,\nov.total_pago as total_order_cost_amt,\nov.iva as total_tax_amt,\n'val' as src,\n'1' as For_join,\ncast(ov.fecha_creacion_orden as date) as order_creation_dt,\ncast(ov.estado_orden as varchar(10)) as order_status_code,\n'1' as order_type_code,\ncase when sp.estado=10 then 'S' else 'N' end as order_paid_ind\n,sp.fecha_aprobacion as order_paid_date\nfrom \ncdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago    sp,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md\nwhere ov.codigo_orden_valorizada = mdet.num_orden_valorizada\nand ov.nro_solicitud_pago = sp.nro_solicitud_pago\nand ov.situacion='V'\nand ov.id_mat_dano=mdet.id_mat_danos\nand ov.codigo_oficina=mdet.codigo_oficina\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\n-----and mdet.rut_taller_reparac=mdet.codigo_proveedor --orden_valorizada -- Removed this condition as per the Guillermo confirmation, V4.77\n  ---and mdet.tipo_detalle_rsd=2--Removed this condition as per the Guillermo confirmation on Mar-7-2019\n    --union--This part is removed based on update for data mapping sheet V4.76 by Guillermo\n  /****Order from OC*****/\n/* select distinct\nmd.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\nocr.numero_oc as order_num,\nmd.id_tercero,\nmd.patente,\n0 as total_discount_amt,\n0 as total_order_cost_amt,\n0 as total_tax_amt,\n'OC' as src,\n'0' as For_join,\ncast(null as date) as order_creation_dt,\n--cast (null as integer) as order_id,\n'' as order_status_code,\n'' as order_type_code,\n'N' as order_paid_ind\n\nfrom \n        cdp_ods.bd_sinie_x_rsin_matriz_danos    md,\n        cdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\n        cdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\n        cdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr\n               where\n        --md.nro_siniestro=@ClaimNumber\n         md.id_mat_dano=mdet.id_mat_danos\n        and md.codigo_oficina=mdet.codigo_oficina\n        and mdet.codigo_oficina=sc.codigo_oficina\n        and mdet.nro_item=sc.numero_item\n        and sc.id_mat_danos=mdet.id_mat_danos\n        and sc.codigo_oficina_oc=ocr.codigo_oficina\n        and sc.numero_oc=ocr.numero_oc\n        and mdet.tipo_detalle_rsd=2\n        and sc.fecha_aceptac_cotiz is not null\n        and md.nro_siniestro not in (select nro_siniestro from cdp_ods.bd_sinie_x_rsin_oc_externa where nro_siniestro = md.nro_siniestro)\n   */\n   /****Order from OC Externa******/\n   union\nSelect distinct\nmd.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\noc.num_oc_mg as order_num,\nmd.id_tercero,\nmd.patente,\n0 as total_discount_amt,\noc.total as total_order_cost_amt,\noc.iva as total_tax_amt,\n'OCE' as src,\n'1' as For_join,\ncast(oc.fecha as date)  as order_creation_dt,\ncast(oc.estado_oc as varchar(10)) as order_status_code,\n'3' as order_type_code,\ncase when sp.estado=10 then 'S' else 'N' end as order_paid_ind\n,sp.fecha_aprobacion as order_paid_date\nfrom \ncdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp,\ncdp_ods.bd_sinie_x_rsin_matriz_danos    md\nwhere\noc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \nand oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\nand sc.nro_item_mat_danos=mdet.nro_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor \nand sp.nro_solicitud_pago = oc.nro_solicitud_pago\nand md.id_mat_dano=mdet.id_mat_danos\nand md.codigo_oficina=mdet.codigo_oficina\nand oc.fecha<>''\n)sr\n\nleft outer join\n/***Insured loss item***/\n(select distinct l4.claim_num,p.per_int_sinies,dim_loss_item_key,loss_item_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_loss_item_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.loss_item_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.loss_item_num=1\n)l1\non sr.claim_num = l1.claim_num \n--and sr.per_int_rutase = l1.loss_item_id \nand sr.id_tercero = l1.id_tercero\nand sr.id_mat_danos=l1.id_mat_dano\nand sr.codigo_oficina =l1.codigo_oficina\nand sr.patente = l1.patente\nand sr.id_tercero = 0\n\n/***3rd party loss item**/\nleft outer join cdp_dwh.dim_loss_item_t l3\non sr.claim_num = l3.claim_num \nand sr.patente = l3.lic_plate_num\nand l3.src_sys_cd ='penta' \nand sr.id_tercero > 0\nand l3.loss_item_num >1\n\n\nleft outer join\n/***Insured Claimant number***/\n(select distinct l4.claim_num,p.per_int_sinies,dim_claimant_key,claimant_num,\nmd.id_mat_dano,\nmd.codigo_oficina ,\nmd.id_tercero,\nmd.patente\nfrom cdp_dwh.dim_claimant_t l4\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non  p.per_int_sinies = l4.claim_num \nand p.per_int_rutase = l4.claimant_id \nand l4.src_sys_cd ='penta'\ninner join cdp_ods.bd_sinie_x_rsin_matriz_danos md on\np.per_int_sinies = md.nro_siniestro\nand md.id_tercero = 0\nand l4.claimant_num = 1\n)c1\non c1.claim_num = sr.claim_num \n--and l2.per_int_rutase = l4.claimant_id \nand sr.id_tercero = 0\nand sr.id_tercero = c1.id_tercero\nand sr.id_mat_danos=c1.id_mat_dano\nand sr.codigo_oficina =c1.codigo_oficina\nand sr.patente = c1.patente\n\n/***3rd party claimant number**/\nleft outer join \n(select claim_num, split_part(claimant_id,'-',3) as patente ,dim_claimant_key,claimant_num\n,row_number() over(partition by claim_num,split_part(claimant_id,'-',3) order by claimant_num asc) as row_num\nfrom \ncdp_dwh.dim_claimant_t \nwhere src_sys_cd ='penta' \n)c3\non sr.claim_num = c3.claim_num \nand sr.patente = c3.patente \nand sr.id_tercero > 0\nand c3.claimant_num >1\nand c3.row_num = 1\n\n) SRC\n\nleft join\n/***Appraiser estimated amount******/\n--1 Insured\n(select sum(a.cpp_dec_monpxp) AS appraiser_amt_insured_2, cpp_int_sinies from cdp_ods.bd_sinie_x_sin_cabecera_perpro a \n   where a.cpp_tin_tiplab=2 group by cpp_int_sinies) appraiser_amt_insured_2\non appraiser_amt_insured_2.cpp_int_sinies = SRC.claim_num\nand SRC.id_tercero = 0 and SRC.For_join ='1'\nleft join\n(Select sum(l.MtoBruto) as appraiser_amt_insured_1,Siniestro from cdp_ods.snsmst_SinPag_AprPagDet l\nwhere l.CodCob = 1 group by l.Siniestro) appraiser_amt_insured_1\non appraiser_amt_insured_1.Siniestro = src.claim_num\nand src.id_tercero = 0 and SRC.For_join ='1'\n\n--3 Third Person\nleft join\n(select sum(a.cpp_dec_monpxp) as appraiser_amt_thirdparty_2,cpp_int_sinies from cdp_ods.bd_sinie_x_sin_cabecera_perpro a where \n   a.cpp_tin_tiplab=1 group by a.cpp_int_sinies) appraiser_amt_thirdparty_2 \non appraiser_amt_thirdparty_2.cpp_int_sinies=src.claim_num\nand src.id_tercero>0 and SRC.For_join ='1' --Tercero\nleft join\n(select sum(l.MtoBruto) as appraiser_amt_thirdparty_1, Siniestro from cdp_ods.snsmst_SinPag_AprPagDet l\nwhere l.CodCob = 2 group by Siniestro\n)appraiser_amt_thirdparty_1 on appraiser_amt_thirdparty_1.Siniestro=src.claim_num \nand src.id_tercero>0 and SRC.For_join ='1' --Tercero \n\nleft join\n/****Total accessory cost amount******/\n(\n--Orden Valorizada - insured\nselect sum(mdet.costo_item * nvl(mdet.cantidad,1)) as accessory_cost_valorizada,\nmd.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\ncodigo_orden_valorizada as order_num,\ncase when md.id_tercero>0 then 2 else 1 end as id_tercero\nfrom \ncdp_ods.bd_sinie_x_rsin_orden_valorizada ov,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos md,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago sp\nwhere\nov.situacion='V'\n  and ov.codigo_orden_valorizada = mdet.num_orden_valorizada\n  and ov.nro_solicitud_pago = sp.nro_solicitud_pago\n  and ov.id_mat_dano=mdet.id_mat_danos\n  and ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  and mdet.grupo_pieza like '%ACG%'\n  and md.id_tercero=0\n  and mdet.rut_taller_reparac=mdet.codigo_proveedor \n  group by 2,3,4,5,6\n  ) accessory_cost_valorizada_insured\n  on accessory_cost_valorizada_insured.claim_num= src.claim_num\n  and accessory_cost_valorizada_insured.id_mat_danos=src.id_mat_danos\n  and accessory_cost_valorizada_insured.codigo_oficina=src.codigo_oficina\n  and accessory_cost_valorizada_insured.order_num=src.order_num\n  and accessory_cost_valorizada_insured.id_tercero = src.tercero_join\n  and SRC.For_join ='1'\n  \n  left join\n  (\n--Orden Valorizada - third party\nselect  \nsum(mdet.costo_item * nvl(mdet.cantidad,1)) as accessory_cost_valorizada,\nmd.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\ncodigo_orden_valorizada as order_num,\nmd.patente,\ncase when md.id_tercero>0 then 2 else 1 end as id_tercero\nfrom \ncdp_ods.bd_sinie_x_rsin_orden_valorizada  ov,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  md,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago sp\nwhere\nov.situacion='V'\n  and ov.codigo_orden_valorizada = mdet.num_orden_valorizada\n  and ov.nro_solicitud_pago = sp.nro_solicitud_pago\n  and ov.id_mat_dano=mdet.id_mat_danos\n  and ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  and mdet.grupo_pieza like '%ACG%'\n  and md.id_tercero>0\n  and mdet.rut_taller_reparac=mdet.codigo_proveedor \n  group by 2,3,4,5,6,7\n  ) accessory_cost_valorizada_third_party\n  on accessory_cost_valorizada_third_party.claim_num= src.claim_num\n  and accessory_cost_valorizada_third_party.id_mat_danos=src.id_mat_danos\n  and accessory_cost_valorizada_third_party.codigo_oficina=src.codigo_oficina\n  and accessory_cost_valorizada_third_party.order_num=src.order_num\n  and accessory_cost_valorizada_third_party.id_tercero = src.tercero_join\n  and accessory_cost_valorizada_third_party.patente =src.patente\n  and SRC.For_join ='1'\n  \nleft join (\n--Oc Externa - insured\nSelect \n  --sum(mdet.costo_item) as accessory_cost_ocexterna,--V4.76\nsum(sc.costo_repuesto * sc.cantidad_solicitada) as accessory_cost_ocexterna,\noc.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\noc.num_oc_mg as order_num,\ncase when md.id_tercero>0 then 2 else 1 end as id_tercero\nfrom \ncdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp,\ncdp_ods.bd_sinie_x_rsin_matriz_danos    md\nwhere\noc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\nand sc.nro_item_mat_danos=mdet.nro_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand mdet.grupo_pieza like '%ACG%'\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago \n and md.id_tercero=0\ngroup by 2,3,4,5,6\n) accessory_cost_ocexterna_insured\non accessory_cost_ocexterna_insured.claim_num= src.claim_num\n  and accessory_cost_ocexterna_insured.id_mat_danos=src.id_mat_danos\n  and accessory_cost_ocexterna_insured.codigo_oficina=src.codigo_oficina\n  and accessory_cost_ocexterna_insured.order_num=src.order_num\n  and accessory_cost_ocexterna_insured.id_tercero = src.tercero_join \n  and SRC.For_join ='1'\n  \n  left join (\n--Oc Externa - third party\nSelect \n  --sum(mdet.costo_item) as accessory_cost_ocexterna,--as per V4.76\nsum(sc.costo_repuesto * sc.cantidad_solicitada) as accessory_cost_ocexterna,\noc.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\noc.num_oc_mg as order_num,\nmd.patente,\ncase when md.id_tercero>0 then 2 else 1 end as id_tercero\nfrom \ncdp_ods.bd_sinie_x_rsin_oc_externa    oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos   ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago   sp,\ncdp_ods.bd_sinie_x_rsin_matriz_danos    md\nwhere oc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\nand sc.nro_item_mat_danos=mdet.nro_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand mdet.grupo_pieza like '%ACG%'\nand mdet.id_mat_danos=md.id_mat_dano\nand mdet.codigo_oficina=md.codigo_oficina\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago \n and md.id_tercero>0\ngroup by 2,3,4,5,6,7\n) accessory_cost_ocexterna_third_party\non accessory_cost_ocexterna_third_party.claim_num= src.claim_num\n  and accessory_cost_ocexterna_third_party.id_mat_danos=src.id_mat_danos\n  and accessory_cost_ocexterna_third_party.codigo_oficina=src.codigo_oficina\n  and accessory_cost_ocexterna_third_party.order_num=src.order_num\n  and accessory_cost_ocexterna_third_party.id_tercero = src.tercero_join \n  and accessory_cost_ocexterna_third_party.patente =src.patente\n  and SRC.For_join ='1'\nleft join \n  (\n  /**Total Spare parts amount*****/\nselect claim_num,id_mat_danos,codigo_oficina,order_num,id_tercero,\npatente,sum(total_spare_parts_amount) as total_spare_parts_amount\nfrom\n\n(\n  /**Valorizada***/\nSelect --distinct\nmd.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\ncodigo_orden_valorizada as order_num,\n--md.id_tercero,\ncase when md.id_tercero>0 then 2 else 1 end as id_tercero,\nmd.patente,\nsum(mdet.costo_item * nvl(mdet.cantidad,1)) as total_spare_parts_amount,\n'val' as src\nfrom \ncdp_ods.bd_sinie_x_rsin_orden_valorizada ov,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago sp,\n---cdp_ods.bd_sinie_x_rsin_grupo_repuestos gr,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_matriz_danos md\nwhere\nov.nro_solicitud_pago = sp.nro_solicitud_pago                                                                  \nand ov.situacion='V'       \nand  ov.codigo_orden_valorizada = mdet.num_orden_valorizada\n  and ov.id_mat_dano=mdet.id_mat_danos\n  and ov.codigo_oficina=mdet.codigo_oficina\n  and mdet.id_mat_danos=md.id_mat_dano\n  and mdet.codigo_oficina=md.codigo_oficina\n  and mdet.rut_taller_reparac=mdet.codigo_proveedor --orden_valorizada\n  --and mdet.tipo_detalle_rsd=2\n  --and mdet.grupo_pieza =gr.codigo\n  --and gr.codigo not in ('0228ACG  00','0228LAT  00','0228GOM  00','0228FAR  00','0228CHA  00','0228MOL  00','0228RAD  00','0228RUE  00','0228TAP  00','0228VID  00') --solo repuestos\n--and md.nro_siniestro = '15398600'\ngroup by 1,2,3,4,5,6,8\n/***OC Externa***/\nunion\n     Select \n    md.nro_siniestro as claim_num,\nmdet.id_mat_danos,\nmdet.codigo_oficina ,\noc.num_oc_mg as order_num,\n--md.id_tercero,\ncase when md.id_tercero>0 then 2 else 1 end as id_tercero,\nmd.patente ,\nsum ( mdet.costo_item  * nvl(mdet.cantidad,1)) as total_spare_parts_amount,\n--sum(((mdet.costo_item + mdet.costo_pintura + mdet.costo_montaje + mdet.monto_pago_adicional)-mdet.monto_serv_desc)) as total_spare_parts_amount,\n'OCE' as src\nfrom \ncdp_ods.bd_sinie_x_rsin_oc_externa oc,\ncdp_ods.bd_sinie_x_rsin_oc_repuestos ocr,\ncdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\ncdp_ods.bd_sinie_x_rsin_grupo_repuestos gr,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\ncdp_ods.bd_sinie_x_rsin_solicitud_pago sp,\ncdp_ods.bd_sinie_x_rsin_matriz_danos md\nwhere\noc.nro_solicitud_pago is not null\nand oc.numero_oc=ocr.numero_oc  \n and oc.codigo_oficina=ocr.codigo_oficina\nand oc.numero_oc=sc.numero_oc\nand oc.codigo_oficina=sc.codigo_oficina\nand sc.codigo_oficina=mdet.codigo_oficina\nand sc.nro_item_mat_danos=mdet.nro_item\nand sc.id_mat_danos=mdet.id_mat_danos\nand mdet.tipo_detalle_rsd=2\nand mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\nand sp.nro_solicitud_pago = oc.nro_solicitud_pago\nand md.id_mat_dano=mdet.id_mat_danos\nand md.codigo_oficina=mdet.codigo_oficina\nand mdet.grupo_pieza =gr.codigo\n---and gr.codigo not in ('0228ACG  00','0228LAT  00','0228GOM  00','0228FAR  00','0228CHA  00','0228MOL  00','0228RAD  00','0228RUE  00','0228TAP  00','0228VID  00') --solo repuestos\ngroup by 1,2,3,4,5,6,8\n)spare_parts_core_logic\ngroup by 1,2,3,4,5,6\n\n) total_spare_parts_amount\non total_spare_parts_amount.claim_num =src.claim_num\nand total_spare_parts_amount.id_mat_danos=src.id_mat_danos\nand total_spare_parts_amount.codigo_oficina=src.codigo_oficina\nand total_spare_parts_amount.order_num=src.order_num\nand total_spare_parts_amount.id_tercero=src.tercero_join\nand total_spare_parts_amount.patente=src.patente\nand SRC.For_join ='1'\n\n/****Liquidator assignment date and dim claim adjuster key****/\nleft join\n(select nro_siniestro,id_mat_danos,codigo_oficina,id_tercero,liquidator_assignment_date,dim_claim_adjuster_key,\nrow_number() over (partition by nro_siniestro,id_mat_danos,codigo_oficina,id_tercero \norder by liquidator_assignment_date asc) as row_num\nfrom\n(\nSelect distinct\ndp.dap_fec_asigna as liquidator_assignment_date,\nnro_siniestro,\nid_mat_danos,\na.codigo_oficina,\ncase when a.id_tercero>0 then 2 else 1 end as id_tercero,\ndim_claim_adjuster_key\nfrom\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos b,\ncdp_ods.bd_sinie_x_sin_danos_propios dp,\ncdp_ods.bd_sinie_x_rsin_matriz_danos a,\ncdp_dwh.dim_claim_adjuster_t dim\nWHERE\ndp.dap_int_sinies=a.nro_siniestro \n and a.id_mat_dano=b.id_mat_danos\nand a.codigo_oficina=b.codigo_oficina\nand dp.dap_int_rutliq =dim.adjuster_id\n\nunion\n--Third Party\nSelect distinct\ndt.dat_fec_asigna as liquidator_assignment_date,\nnro_siniestro,\nid_mat_danos,\na.codigo_oficina,\ncase when a.id_tercero>0 then 2 else 1 end as id_tercero,\ndim_claim_adjuster_key\nfrom\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos b,\ncdp_ods.bd_sinie_x_sin_danos_tercero dt,\ncdp_ods.bd_sinie_x_rsin_matriz_danos a,\ncdp_dwh.dim_claim_adjuster_t dim\nWHERE\na.nro_siniestro=dt.dat_int_sinies  \n and a.id_mat_dano=b.id_mat_danos\nand a.codigo_oficina=b.codigo_oficina\nand dt.dat_int_rutabo =dim.adjuster_id\n) liquidator_assignment_date_1\n)liquidator_assignment_date\non liquidator_assignment_date.nro_siniestro=src.claim_num\nand liquidator_assignment_date.id_mat_danos=src.id_mat_danos\nand liquidator_assignment_date.codigo_oficina=src.codigo_oficina\nand row_num = 1\nand SRC.For_join ='1'\n\n\n \nleft join \n(\n/***Quote creation date****/\n\nSelect\nmin(v.fecha_solicitud) as Quotation_creation_date,d.per_int_sinies, 1 as id_tercero\nfrom \n cdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion   v,\ncdp_ods.bd_sinie_x_rsin_matriz_danos   a,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  b,\ncdp_ods.bd_sinie_x_sin_perfil    d\nwhere\na.id_mat_dano =b.id_mat_danos  and\na.codigo_oficina=b.codigo_oficina and\na.nro_siniestro =d.per_int_sinies and\nb.id_mat_danos=v.id_mat_danos and\nb.codigo_oficina=v.codigo_oficina and\nb.nro_item = v.nro_item_mat_danos and --DID_162\na.id_tercero=0 \ngroup by 2,3\nunion\n--Third Party\nSelect\nmin(v.fecha_solicitud) as Quotation_creation_date,d.per_int_sinies, 2 as id_tercero\nfrom \n cdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion   v,\ncdp_ods.bd_sinie_x_rsin_matriz_danos   a,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos  b,\ncdp_ods.bd_sinie_x_sin_perfil    d\nwhere\na.id_mat_dano =b.id_mat_danos  and\na.codigo_oficina=b.codigo_oficina and\na.nro_siniestro =d.per_int_sinies and\nb.id_mat_danos=v.id_mat_danos and\nb.codigo_oficina=v.codigo_oficina and\nb.nro_item = v.nro_item_mat_danos and --DID_162\na.id_tercero>0 \n group by 2,3 \n ) Quotation_creation_date\non Quotation_creation_date.per_int_sinies=src.claim_num\nand Quotation_creation_date.id_tercero = src.tercero_join\nand SRC.For_join ='1'\n\n/****Claim close date****/\nleft join\n( -- Insured\n\nselect distinct\nFechaEstado as claim_close_Date,1 as id_tercero, Siniestro as claim_num,\nrow_number() over (partition by siniestro order by Correlativo desc) as row_num\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro b \n where b.CodigoEstado in(4,9,11,12) --Cerrado\nand b.TipoDano=2 --DP\n--and Siniestro = '30138192'\nunion\n--third party\n  select distinct\nFechaEstado as claim_close_Date,2 as id_tercero, Siniestro as claim_num,\nrow_number() over (partition by siniestro order by Correlativo desc) as row_num\nfrom cdp_ods.bd_sinie_x_Sin_EstadosHisSiniestro b \n where b.CodigoEstado in(4,9,11,12) --Cerrado\nand b.TipoDano=1 --DP\n--and Siniestro = '30138192'\n) claim_close_Date\non claim_close_Date.claim_num = src.claim_num\nand claim_close_Date.id_tercero=src.tercero_join\nand claim_close_Date.row_num = 1\nand SRC.For_join ='1'\n\n/****dim body shop key*****/\nleft join\n\n\n(select distinct bs.dim_bdshp_key,\nd.rut_suc_taller,b.nro_siniestro, b.id_mat_dano, b.codigo_oficina,\ncase when b.id_tercero>0 then 2 else 1 end as tercero_join,\nrow_number() over(partition by b.nro_siniestro,b.id_mat_dano,b.codigo_oficina,tercero_join order by dim_bdshp_key desc) as row_num\nfrom\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos c,cdp_ods.bd_sinie_x_sin_perfil    a,\ncdp_ods.bd_sinie_x_rsin_matriz_danos  b,cdp_ods.bd_sinie_x_rsin_sucursal_taller d,\ncdp_dwh.dim_bdshp_t bs\nwhere \n a.per_int_sinies = b.nro_siniestro\nand b.id_mat_dano=c.id_mat_danos\nand b.codigo_oficina=c.codigo_oficina\nand c.cod_suc_taller_reparac=d.sucursal_taller\nand c.rut_taller_reparac=d.rut_suc_taller\nand d.tipo in(1,2)\nand d.rut_suc_taller=bs.bdshp_id \nand bs.src_sys_cd ='penta' \n) dim_bdshp_key\non dim_bdshp_key.nro_siniestro = src.claim_num\nand dim_bdshp_key.id_mat_dano=src.id_mat_danos\nand dim_bdshp_key.codigo_oficina=src.codigo_oficina\nand dim_bdshp_key.tercero_join=src.tercero_join\nand dim_bdshp_key.row_num = 1\nand SRC.For_join ='1'\n\nleft join\n/***dim claim key, take branch office key from this table itself***/\ncdp_dwh.dim_claim_t dim_claim_key\non src.claim_num =dim_claim_key.claim_num\nand dim_claim_key.src_sys_cd ='penta' \n\nleft join\n/***dim claim type key***/\n( select distinct per_tin_tiposiniestro,\nper_int_sinies,dim_claim_type_key\nfrom cdp_dwh.dim_claim_type_t c\ninner join cdp_ods.bd_sinie_x_sin_perfil p\non c.claim_type_cd = p.per_tin_tiposiniestro\nand c.src_sys_cd ='penta' \n)dim_claim_type_key\non dim_claim_type_key.per_int_sinies=src.claim_num\n\n/****dim parts provider key****/\nleft join\n(\nselect distinct\nd.rut_suc_taller,b.nro_siniestro,c.id_mat_danos,\nc.codigo_oficina,dim_parts_provdr_key,\ncase when b.id_tercero>0 then 2 else 1 end as tercero_join,\nd.tipo,\nrow_number() over(partition by b.nro_siniestro,id_mat_danos,c.codigo_oficina,tercero_join\norder by dim_parts_provdr_key desc) row_num\nfrom\ncdp_ods.bd_sinie_x_rsin_matriz_danos  b,\ncdp_ods.bd_sinie_x_rsin_det_matriz_danos c,\ncdp_ods.bd_sinie_x_rsin_sucursal_taller d,\ncdp_dwh.dim_parts_provdr_t dim\nwhere \n --b.nro_siniestro =@ClaimNumber\n  b.id_mat_dano=c.id_mat_danos\nand b.codigo_oficina=c.codigo_oficina\nand c.cod_suc_taller_reparac=d.sucursal_taller\nand c.rut_taller_reparac=d.rut_suc_taller\nand d.tipo in(1,3) \n and dim.provdr_id = d.rut_suc_taller\nand dim.src_sys_cd = 'penta') dim_parts_provdr_key\non dim_parts_provdr_key.nro_siniestro =src.claim_num\nand dim_parts_provdr_key.tercero_join=src.tercero_join\nand dim_parts_provdr_key.codigo_oficina=src.codigo_oficina\nand dim_parts_provdr_key.id_mat_danos=src.id_mat_danos\nand dim_parts_provdr_key.row_num = 1\n\n\nleft join\n/**Updated 171-Total parts quantity***/\n( \n  select nro_siniestro as claim_num\n  ,num_orden_valorizada as order_num\n  ,case when id_tercero > 0 then 2 else 1 end as tercero_join\n  ,sum( coalesce(cantidad,0) ) as total_parts_quantity\n  from \n    ( \n      select distinct md.nro_siniestro,mdet.num_orden_valorizada,md.id_tercero,mdet.cantidad\n      from cdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\n\t       cdp_ods.bd_sinie_x_rsin_matriz_danos md,\n           cdp_ods.bd_sinie_x_rsin_orden_valorizada ov, \n\t\t   cdp_ods.bd_sinie_x_rsin_solicitud_pago sp\n      where mdet.id_mat_danos = md.id_mat_dano\n      and   mdet.codigo_oficina = md.codigo_oficina\n      and   ov.codigo_orden_valorizada = mdet.num_orden_valorizada \n      and   ov.id_mat_dano = mdet.id_mat_danos\n      and   ov.codigo_oficina = mdet.codigo_oficina\n      and   ov.situacion='V' \n      and   ov.nro_solicitud_pago = sp.nro_solicitud_pago\n    ) tmpi\n  group by   1, 2, 3\n\n  union all \n\t\t\t\t\t\t   \n \n  select nro_siniestro as claim_num\n  ,num_oc_mg as order_num\n\t\t\t\t \n  ,case when id_tercero > 0 then 2 else 1 end as tercero_join,\n         sum( coalesce(cantidad,0)) as total_parts_quantity\n  from \n    ( \n      select distinct md.nro_siniestro,oc.num_oc_mg,md.id_tercero, mdet.cantidad\n      from cdp_ods.bd_sinie_x_rsin_det_matriz_danos mdet,\n           cdp_ods.bd_sinie_x_rsin_matriz_danos md,\n\t\t   cdp_ods.bd_sinie_x_rsin_solicitudes_cotizacion sc,\n\t\t   cdp_ods.bd_sinie_x_rsin_oc_externa oc,\n\t\t   cdp_ods.bd_sinie_x_rsin_oc_repuestos ocr,\n\t\t   cdp_ods.bd_sinie_x_rsin_solicitud_pago sp\n          where mdet.tipo_detalle_rsd=2\n          and mdet.rut_taller_reparac!=mdet.codigo_proveedor --oc_externa\n          and mdet.id_mat_danos=md.id_mat_dano\n          and mdet.codigo_oficina=md.codigo_oficina\n          and sc.codigo_oficina=mdet.codigo_oficina\n          and sc.nro_item_mat_danos=mdet.nro_item  -- reempplaza a sc.numero_item\n          and sc.id_mat_danos=mdet.id_mat_danos\n          and oc.numero_oc=sc.numero_oc\n          and oc.codigo_oficina=sc.codigo_oficina\n          and oc.nro_solicitud_pago is not null\n          and oc.fecha <> ''\n          and oc.numero_oc=ocr.numero_oc  \n          and oc.codigo_oficina=ocr.codigo_oficina\n          and sp.nro_solicitud_pago = oc.nro_solicitud_pago\n    ) tmpj\n  group by 1, 2, 3\n) total_parts_quantity\non total_parts_quantity.claim_num = src.claim_num\nand total_parts_quantity.tercero_join = src.tercero_join\nand total_parts_quantity.order_num = src.order_num\n) src\nleft outer join\n(select 1 as dummy, max(fact_parts_svc_order_key) as MAX_SID from cdp_dwh.fact_parts_svc_order_summary_t) LKP_MAXSID\non src.dummy = LKP_MAXSID.dummy\nwhere src.row_num = '1'\n) src_query\n\nleft join cdp_stg_dwh.stg_tref_code_map_variant as ref_data_status\non cast(src_query.order_status_cd as varchar) = cast(ref_data_status.ref_cd as varchar)\nand ref_data_status.ref_type_cd = 'order_status'\nand ref_data_status.src_sys_cd = 'penta' \n\nleft join cdp_stg_dwh.stg_tref_code_map_variant as ref_data_type\non cast(src_query.order_type_cd as varchar) = cast(ref_data_type.ref_cd as varchar)\nand ref_data_type.ref_type_cd = 'order_type'\nand ref_data_type.src_sys_cd = 'penta';"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.fact_parts_svc_order_summary_t\nwhere src_sys_cd='penta'"
    }
]