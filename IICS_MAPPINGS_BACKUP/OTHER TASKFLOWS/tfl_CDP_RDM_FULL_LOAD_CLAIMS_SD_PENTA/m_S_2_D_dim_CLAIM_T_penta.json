[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select\n(SRC1.MAXSID+SRC1.num) as dim_claim_key,\nSRC1.src_sys_cd,\nNVL(SRC1.claim_num,'0') AS claim_num,\nNVL(SRC1.policy_num,'0') AS policy_num,\nSRC1.claim_status_cd,\nSRC1.fnol_dt,\nSRC1.incident_dt,\n--SRC1.claim_type_cd, --Commented based on BA-2 change\nSRC1.dim_claim_type_key,\nSRC1.cause_of_loss_cd,\nSRC1.incident_comuna_cd,\nNVL(SRC1.insured_item_num,0) AS insured_item_num,\nSRC1.dim_branch_office_key,\nNVL(SRC1.policy_id,0) AS policy_id,\nSRC1.fnol_channel_cd,\nSRC1.fnol_channel_desc,\nSRC1.dim_region_key,\nNVL(SRC1.claim_id,0) AS claim_id ,\nNVL(SRC1.insured_item_id,0) AS insured_item_id ,\nSRC1.incident_comuna_name,\nSRC1.cause_of_loss_desc,\n--SRC1.src_rec_crt_dtm,   /*Commented as part of sprint 3 on 18/2/2019*/\nSRC1.actv_rec_ind,\nSRC1.audit_id,\nSRC1.rec_crt_dtm,\nSRC1.rec_updt_dtm,\nSRC1.incident_region_code,\nSRC1.dim_lob_key, --Added as part of BA-2 change\nSRC1.cat_event_cd,\nSRC1.cat_event_type_desc,\nSRC1.cat_event_name,\nSRC1.src_sys_entry_dt,\t\t\t/*Added as part of sprint 3 on 18/2/2019*/\nSRC1.agreement\t\t\t\t\t--Groupo Integrado changes for Penta\nfrom\n(\nselect\nrow_number() over (partition by src.claim_id order by src.per_fec_denunc desc) as row_cnt,\nrow_number() over (order by claim_num) num, \n1 as dummy, \nsrc.src_sys_cd,\nsrc.claim_num,\nsrc.policy_num,\nsrc.claim_status_cd,\nsrc.fnol_dt,\nsrc.incident_dt,\n--src.claim_type_cd, --Commented based on BA-2 change\nsrc.dim_claim_type_key,\nsrc.cause_of_loss_cd,\nsrc.incident_comuna_cd,\nsrc.insured_item_num,\nsrc.dim_branch_office_key,\nsrc.policy_id,\nsrc.fnol_channel_cd,\nsrc.fnol_channel_desc,\nsrc.dim_region_key,\nsrc.claim_id,\nsrc.insured_item_id,\nsrc.incident_comuna_name,\nsrc.cause_of_loss_desc,\nsrc.per_fec_denunc as src_rec_crt_dtm,\n'Y' as actv_rec_ind,\nba.etl_audit_id as audit_id,\nCURRENT_DATE as rec_crt_dtm,\nCURRENT_DATE as rec_updt_dtm,\nsrc.incident_region_code,\nsrc.dim_lob_key, --Added as part of BA-2 change\nsrc.cat_event_cd,\nsrc.cat_event_type_desc,\nsrc.cat_event_name,\nsrc.src_sys_entry_dt,      /*Added as part of sprint 3 on 18/2/2019*/\nnvl(LKP_MAXSID.MAX_SID,0) as MAXSID,\nsrc.agreement\t\t\t\t--Groupo Integrado changes for Penta\nfrom\n(\nselect \ndistinct \ncast('penta' as varchar(10)) as src_sys_cd,\ncast(sin_perfil.per_int_sinies as integer) as claim_id,\ncast(sin_perfil.per_int_sinies as varchar(35)) as claim_num,\ncast(NVL(NVL(cat_event.mkt_ref_code,CAST(sin_perfil.per_tin_tiposiniestro AS VARCHAR(10))),'') as varchar(10)) as cat_event_cd,\ncast(NVL(NVL(cat_event.mkt_ref_code_desc,cat_event.ref_desc),'') as varchar(200)) as cat_event_name,\ncast('' as varchar(80)) as cat_event_type_desc,\ncast('' as varchar(20)) as cause_of_loss_cd,\ncast('' as varchar(80)) as cause_of_loss_desc,\ncast(NVL(NVL(claim_status.mkt_ref_code,CAST(sin_perfil.per_tin_estado AS VARCHAR(10))),'') as varchar(10)) as claim_status_cd,\ncast(dim_claim_status.dim_claim_status_key as integer) as dim_claim_status_key,\n--CAST(sin_perfil.per_tin_tiposiniestro AS VARCHAR(10)) claim_type_cd, --Commented based on BA-2 change\ncast(dim_claim_type.dim_claim_type_key as integer) as dim_claim_type_key,\n--cast(NVL(NVL(incident_comun.mkt_ref_code,cast(sin_perfil.per_sma_comunalugar as varchar (10))),'') as varchar(10)) as incident_comuna_cd,\ncast(NVL(NVL(incident_comun.mkt_ref_code, 'P' || cast(sin_perfil.per_sma_comunalugar as varchar (9))),'') as varchar(10)) as incident_comuna_cd,\ncast(NVL(NVL(incident_comun.mkt_ref_code_desc,incident_comun.ref_desc),'') as varchar(100)) as incident_comuna_name,\n--cast(NVL(NVL(incident_region.mkt_ref_code,cast(pro_oficinas.ofi_tin_codreg as varchar(10))),'') as varchar(10)) as incident_region_code,\ncast(NVL(incident_region.mkt_ref_code,'') as varchar(10)) as incident_region_code,\ncast(drg1.dim_region_key as integer) as dim_region_key,\nCASE  WHEN (substring(sin_perfil.per_cha_denpresencial,1,1)='1') THEN  '3' \n           WHEN  (sin_perfil.per_tin_rutusuario=sin_perfil.per_tin_rutusr_ingreso) THEN '1'\n           ELSE\n           '2'\n           END as fnol_channel_cd,\nCASE  WHEN (substring(sin_perfil.per_cha_denpresencial,1,1)='1') THEN  'Presencial' \n           WHEN  (sin_perfil.per_tin_rutusuario=sin_perfil.per_tin_rutusr_ingreso) THEN 'Web'\n           ELSE\n           'Call Center'\n           END as fnol_channel_desc,\nsin_perfil.per_fec_denunc as fnol_dt,\nsin_perfil.per_fec_sinies as incident_dt,\ncast(sin_perfil.per_tin_ramo as varchar(10)) as line_of_business_cd,\ncast(dim_lob.dim_lob_key as integer) as dim_lob_key, --Added as part of BA-2 change\ncast(NVL(NVL(branch_office.mkt_ref_code,cast(sin_perfil.per_tin_oficin as varchar(10))),'') as varchar(10)) as branch_office_cd,\ncast(dim_branch_office.dim_branch_office_key as integer) as dim_branch_office_key,\ncast(sin_perfil.per_int_poliza as varchar(35)) as policy_num, \ncast(sin_perfil.per_int_poliza as integer) as policy_id,\ncast(sin_perfil.per_sma_item as integer) as insured_item_num,\ncast(sin_perfil.per_sma_item as integer) as insured_item_id,\nsin_perfil.per_fec_denunc,\nsin_perfil.per_fec_ingres as src_sys_entry_dt, /*Added as part of sprint 3 on 18/2/2019*/\n1 as dummy,\ncast(pro_poliza.pol_int_cartera as integer) as agreement\t\t\t\t\t\t\t--Groupo Integrado changes for Penta\nfrom cdp_ods.bd_sinie_x_sin_perfil sin_perfil\n--For DID-020\nleft join \n(select trcc.codcomcia,trcc.cod_region,row_number() over(partition by codcomcia order by cod_region) as rowindex\n from cdp_ods.grlmst_regioncomunaciudad trcc\n where trcc.codcomcia is not null) trc1\n on sin_perfil.per_sma_comunalugar = trc1.codcomcia\n and trc1.rowindex = 1\n left join\n (select ref_cd,ref_desc, mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \n  where ref_type_cd='comuna' and src_sys_cd = 'penta') incident_comun\n -- on CAST(cast(trc1.codcomcia as INT) AS varchar(20))=incident_comun.ref_cd\n  on CAST(cast(sin_perfil.per_sma_comunalugar as INT) AS varchar(20))=incident_comun.ref_cd\n left join \n (select ref_cd,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant \n  where ref_type_cd='region' and src_sys_cd = 'penta') incident_region\n  on CAST(cast(trc1.cod_region as INT) AS varchar(20))  = incident_region.ref_cd\n left join\n (select dreg.region_cd,dreg.dim_region_key\n  from cdp_dwh.dim_region_t dreg ) drg1\n on incident_region.mkt_ref_code = drg1.region_cd\n--Added for DID-020\n\nleft join \n(select ref_cd,mkt_ref_code,ref_desc,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='cat_event' and src_sys_cd = 'penta')cat_event\non cast(sin_perfil.per_tin_tiposiniestro as varchar(10))=cat_event.ref_cd\nleft join \n(select ref_cd,mkt_ref_code,ref_desc,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='claim_status' and src_sys_cd = 'penta')claim_status\non CAST(cast(sin_perfil.per_tin_estado as INT) AS VARCHAR(20))=claim_status.ref_cd\nleft join \n(select dim_claim_status_key,claim_status_cd from cdp_dwh.dim_claim_status_t where src_sys_cd='penta') dim_claim_status\non  cast(sin_perfil.per_tin_estado as varchar(10)) = dim_claim_status.claim_status_cd\n/*left join  --Commented based on BA-2 change\n(select ref_cd,mkt_ref_code,ref_desc,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='claim_type' and src_sys_cd = 'penta')claim_type\non CAST(cast(sin_perfil.per_tin_tiposiniestro as INT) AS VARCHAR(20))=claim_type.ref_cd*/\nleft join \n(select dim_claim_type_key,claim_type_cd from cdp_dwh.dim_claim_type_t where src_sys_cd='penta') dim_claim_type\non cast(sin_perfil.per_tin_tiposiniestro as varchar(10)) = dim_claim_type.claim_type_cd\n/*left join \n(select ref_cd,ref_desc,mkt_ref_code,mkt_ref_code_desc from cdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='comuna' and src_sys_cd = 'penta') incident_comun_2\non cast(sin_perfil.per_sma_comunalugar as varchar (10))=incident_comun_2.ref_cd\nleft join\n(select distinct ofi_tin_codreg,ofi_tin_codigo from cdp_ods.prdcdg_pro_oficinas) pro_oficinas\non sin_perfil.per_tin_oficin = pro_oficinas.ofi_tin_codigo\nleft join \n(select ref_cd,mkt_ref_code from cdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='region' and src_sys_cd = 'penta') region\non cast(pro_oficinas.ofi_tin_codreg as varchar(10)) = region.ref_cd\nleft join cdp_dwh.dim_region_t dim_region\non NVL(region.mkt_ref_code,cast(pro_oficinas.ofi_tin_codreg as varchar(10))) = dim_region.region_cd */\nleft join \n(select ref_cd,mkt_ref_code from cdp_stg_dwh.stg_tref_code_map_variant where ref_type_cd='branch_office' and src_sys_cd = 'penta') branch_office\non cast(sin_perfil.per_tin_oficin as varchar(10))=branch_office.ref_cd\nleft join \n(select dim_branch_office_key,branch_office_cd from cdp_dwh.dim_branch_office_t where src_sys_cd='penta') dim_branch_office\non nvl(branch_office.mkt_ref_code,cast(sin_perfil.per_tin_oficin as varchar(10))) = dim_branch_office.branch_office_cd\nleft join --Added as part of BA-2 change\n(select dim_lob_key,lob_cd from cdp_dwh.dim_lob_t where src_sys_cd ='penta') dim_lob\non cast(sin_perfil.per_tin_ramo as varchar(10))=dim_lob.lob_cd\n--Groupo Integrado changes start for Penta\nleft join\n(select distinct pol_int_poliza, pol_int_cartera, pol_int_rutcor, pol_int_rutcon from cdp_ods.bd_produ_x_pro_poliza) pro_poliza\non pro_poliza.pol_int_poliza=sin_perfil.per_int_poliza\nleft join\n(select max(dim_policyholder_key) as dim_policyholder_key, \npolicyholder_rut_num \nfrom cdp_dwh.dim_policyholder_t \nwhere src_sys_cd='penta' \ngroup by policyholder_rut_num) dim_polhold\non pro_poliza.pol_int_rutcon=dim_polhold.policyholder_rut_num\nleft join\n(select distinct dim_broker_key, broker_rut_num from cdp_dwh.dim_broker_t) dim_broker\non pro_poliza.pol_int_rutcor=left(dim_broker.broker_rut_num ,(length(dim_broker.broker_rut_num )-1))\nleft join\n(select distinct ite_int_poliza, ite_sma_item, ite_sma_ramo, ite_sma_subramo, ite_int_prodplan from cdp_ods.bd_produ_x_pro_item) pro_item\non pro_item.ite_int_poliza=sin_perfil.per_int_poliza and pro_item.ite_sma_item=sin_perfil.per_sma_item\nleft join\n(select distinct prd_cd, pln_cd, lob_cd, dim_prd_pln_hrchy_key from cdp_dwh.dim_prd_pln_hrchy_t where src_sys_cd='penta') dim_pphrchy\non dim_pphrchy.prd_cd=pro_item.ite_sma_ramo and dim_pphrchy.pln_cd=pro_item.ite_sma_subramo and dim_pphrchy.lob_cd=pro_item.ite_int_prodplan\n--Groupo Integrado changes end for Penta\n) src\nleft join\n(select 1 as dummy, max(dim_claim_key) as MAX_SID from cdp_dwh.dim_claim_t) LKP_MAXSID\non src.dummy = LKP_MAXSID.dummy\nleft join \n  (\n  select distinct etl_audit_id, 1 as dummy from cdp_dwh.dim_CLAIMANT_t where src_sys_cd='penta' ) ba \n  on src.dummy =ba.dummy \n) SRC1\nwhere row_cnt = 1"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.dim_claim_t where src_sys_cd='penta';\ncommit;"
    }
]