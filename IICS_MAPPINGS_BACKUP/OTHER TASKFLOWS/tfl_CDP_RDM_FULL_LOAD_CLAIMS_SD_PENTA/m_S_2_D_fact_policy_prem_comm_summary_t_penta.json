[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select \ncast (nvl((MAX_SID+num),0) AS INTEGER) as fact_policy_item_mv_key,\nCAST(SRC.src_sys_cd AS VARCHAR(10)),\ncast(SRC.policy_item_id AS VARCHAR(35)),\nCAST(SRC.mv_id AS INTEGER),\nCAST(SRC.policy_num AS VARCHAR(35)),\nCAST(SRC.policy_exp_dt AS DATE),\nCAST(SRC.policy_status_cd AS VARCHAR(10)) ,\nCAST(SRC. policy_status_desc AS VARCHAR(80)),\nCAST(SRC.cancel_dt AS VARCHAR(50)),\nCAST(SRC.cancel_type AS VARCHAR(50)),\nCAST(SRC.cancel_reason_cd AS VARCHAR(10)) ,\nCAST(SRC.cancel_reason_desc AS  VARCHAR(80)),\nCAST(SRC.facultativo_ind AS CHAR(1)),\nCAST(SRC.coins_type_cd AS VARCHAR(10)),\nCAST(SRC.coins_pct AS NUMERIC(8,4)),\nCAST(SRC.coins_amt AS NUMERIC(25,10)),\nCAST(SRC.curr_cd AS VARCHAR(10)),\nCAST(SRC.mv_reason_cd AS VARCHAR(10)) ,\nCAST(SRC.mv_reason_desc AS VARCHAR(80)),\nCAST(SRC.item_eff_dt AS DATE),/**ADDED FOR DID236**/\nCAST(SRC.item_exp_dt AS DATE),/**ADDED FOR DID236**/\nCAST(SRC.fronting_policy_ind AS CHAR(1)),\nCAST(SRC.ceded_share_part_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.surplus_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.facult_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.retained_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.direct_retained_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.prem_retained_74_amt AS NUMERIC(25,10)),\nCAST(SRC.retained_share_part_prem_amt  AS NUMERIC(25,10)),\nCAST(SRC.remarque_comm_amt AS NUMERIC(25,10)),\nCAST(SRC.liberty_reins_optional_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.nwp_amt AS NUMERIC(25,10)),\nCAST(SRC.cwp_amt AS NUMERIC(25,10)),\nCAST(SRC.gwp_amt AS NUMERIC(25,10)),\nCAST(SRC.endorsement_prem_amt AS NUMERIC(25,10)),\nCAST(SRC.broker_comm_amt AS NUMERIC(25,10)),\nNVL(CAST(SRC.dim_policy_key AS INT) ,0) AS dim_policy_key,\nNVL(CAST(SRC.dim_lob_key AS INT) ,0) AS dim_lob_key,\nNVL(CAST(SRC.dim_broker_key AS INT) ,0) AS dim_broker_key,\nNVL(CAST(SRC.dim_branch_office_key AS INT) ,0) AS dim_branch_office_key,\nNVL(CAST(SRC.dim_policyholder_key AS INT) ,0) AS dim_policyholder_key,\nNVL(CAST(SRC.dim_risk_key AS INT) ,0) AS dim_risk_key,\nNVL(CAST(SRC.dim_prd_pln_hrchy_key AS INT) ,0) AS dim_prd_pln_hrchy_key,\nNVL(CAST(SRC.dim_insured_key AS INT) ,0) AS dim_insured_key,\nCAST(SRC.rec_crt_dtm AS DATE),\nCAST(SRC.rec_updt_dtm AS DATE),\nCAST(SRC.actv_rec_ind AS CHAR(1)),\nCAST(SRC.etl_audit_id AS INTEGER),\n--CAST(SRC.policy_item_num AS NUMERIC(25,10)),\nCAST(SRC.policy_item_num AS INTEGER),\nCAST(SRC.broker_branch_rlshp_id AS VARCHAR(24)) ,\nCAST(SRC.policy_issue_dt AS DATE),\nCAST(SRC.mv_dt AS DATE),\nCAST(SRC.policy_eff_dt AS DATE),\ncast(src.acc_year as varchar(4)),\ncast(src.acct_mth as varchar(2)),\ncast(src.agreement as INTEGER),\nCAST(SRC.surplus_ceded_prem_amt AS NUMERIC(25,10)),\nCASE SRC.pcount when SRC.pcount>=10 and SRC.ite_sma_ramo in (9,10) then 'SI' \n\t        when SRC.pcount<10 and SRC.ite_sma_ramo in (9,10) then 'NO'\n\t\telse '-' end as flota,\t\t\t\t/* added for groupo integrado */\nCAST(case when acct_yr > policy_yr  then acct_yr || acct_mth \n     when acct_yr = policy_yr  then case when acct_mth > policy_mnth then acct_yr || acct_mth\n                                        else policy_yr || policy_mnth \n                                        end\n     else policy_yr || policy_mnth \n     end AS INTEGER) as usgaap_period, -- Added for Sales by USGAAP Penta\ncast((acc_month || '-' || '15' || '-' || acc_year) as timestamp)  as acct_dt,\ncast(mov_eff_dt AS DATE),/**ADDED FOR DID236**/\ncast((acc_month || '-' || '15' || '-' || acc_year) as DATE) as mov_acc_dt/**ADDED FOR DID236**/\nfrom \n(select\nMAX_SID,\nrow_number()over( order by policy_item_id,mv_id,mv_reason_cd,src_sys_cd ) as num,\nsrc_sys_cd,\nnvl(policy_item_id,'0') as policy_item_id,\nnvl(mv_id,0) as mv_id,\nnvl(policy_num,'0') as policy_num,\npolicy_exp_dt,\npolicy_status_cd,\npolicy_status_desc ,\ncancel_dt,\ncancel_type ,\ncancel_reason_cd,\ncancel_reason_desc ,\nfacultativo_ind,\ncoins_type_cd,\ncoins_pct,\ncast(src1.gwp_amt * (src1.coins_pct /100) AS NUMERIC(25,10))  as coins_amt,\ncurr_cd,\nnvl(mv_reason_cd,'0') as mv_reason_cd,\nmv_reason_desc,\nitem_eff_dt,/**ADDED FOR DID236**/\nitem_exp_dt,/**ADDED FOR DID236**/\ncase when (nullif(facult_prem_amt,0)/nullif(gwp_amt,0)) >= 0.90 then 'Y' else 'N' end as fronting_policy_ind,\nceded_share_part_prem_amt,\nsurplus_prem_amt,\nfacult_prem_amt,\nretained_prem_amt,\ndirect_retained_prem_amt,\nprem_retained_74_amt,\nretained_share_part_prem_amt,\nremarque_comm_amt,\nliberty_reins_optional_prem_amt,\nnwp_amt  ,\ncwp_amt ,\ngwp_amt ,\nendorsement_prem_amt,\nbroker_comm_amt ,\ndim_policy_key,\ndim_lob_key,\ndim_broker_key,\ndim_branch_office_key,\ndim_policyholder_key,\ndim_risk_key,\ndim_prd_pln_hrchy_key ,\ndim_insured_key,\nrec_crt_dtm,\nrec_updt_dtm,\n'Y' AS actv_rec_ind,\nca.etl_audit_id AS etl_audit_id,\npolicy_item_num,\nbroker_branch_rlshp_id ,\npolicy_issue_dt ,\nmv_dt,\npolicy_eff_dt ,\nacc_year,\nacc_month,\nsurplus_ceded_prem_amt,\nagreement,\npcount,                                         /* added for groupo integrado */\nite_sma_ramo,\t\t\t\t\t/* added for groupo integrado */\nROW_NUMBER()OVER(PARTITION BY policy_item_id,mv_id,mv_reason_cd,src_sys_cd ORDER BY item_eff_dt DESC)  rnk ,\nCAST(EXTRACT(YEAR FROM policy_eff_dt) AS INTEGER) as policy_yr,\nCAST(RIGHT(0 || EXTRACT(MONTH FROM policy_eff_dt),2) AS VARCHAR(10)) as policy_mnth,\nCAST(acc_year AS INTEGER) as acct_yr,\nCAST(RIGHT(0 || acc_month, 2) AS VARCHAR(10)) as acct_mth,\nmov_eff_dt         /**ADDED FOR DID236**/                               \nfrom \n(select distinct\n'penta' as src_sys_cd, \ncast((pr.pro_int_poliza||'-'||pr.pro_sma_item) as varchar(35)) AS policy_item_id,\npr.pro_int_endoso mv_id,\npr.pro_int_poliza AS policy_num,\nmva.mkt_ref_code as curr_cd,\np.pol_tin_tippar as coins_type_cd,\np.pol_int_cartera as agreement,\npct.coins_pct,\n--case when pct.pol_tin_tippar = 0 then 0 when pct.pol_tin_tippar in (1,2) then pct.pat_dec_porcen_amt else 0 end as coins_pct,\n--case when pct.pol_tin_tippar = 0 then pct.pro_dec_porcen when pct.pol_tin_tippar in (1,2) then pct.pat_dec_porcen_amt else null end as coins_pct,\nt.ite_fec_ingres as policy_issue_dt,\nt.ite_fec_vigdes as policy_eff_dt,\nt.ite_fec_vighas as policy_exp_dt,\nnull as policy_status_cd,\nnull as policy_status_desc,\nl.dim_lob_key as dim_lob_key,\npo.dim_policy_key as dim_policy_key,\nbo.dim_branch_office_key as dim_branch_office_key,\ndim_broker.dim_broker_key as dim_broker_key,\nr.dim_risk_key dim_risk_key,\nh.dim_policyholder_key dim_policyholder_key,\ni.dim_insured_key dim_insured_key,\npph.dim_prd_pln_hrchy_key as dim_prd_pln_hrchy_key,\ncase when pr.pro_sma_tipo between 200 and 399 and Pro_fec_vighas = pro_fec_vigdes then pr.pro_sma_tipo else null end as cancel_reason_cd,\ncase when pr.pro_sma_tipo between 200 and 399 and Pro_fec_vighas = pro_fec_vigdes then stg1.ref_desc else null end as cancel_reason_desc,\ncase when pr.pro_sma_tipo between 200 and 399 and Pro_fec_vighas = pro_fec_vigdes then pr.pro_fec_ingres else null end as cancel_dt,\ncase when fa.PrimaFacultativa > 0 then 'Y' else 'N' end as facultativo_ind,\n---stg2.ref_cd as mv_reason_cd,\ncast(cast(pr.pro_sma_tipo as integer) as varchar(20)) as mv_reason_cd,\nstg2.ref_desc as mv_reason_desc,\ncase when pr.pro_sma_tipo between 300 and 399 and Pro_fec_vighas = pro_fec_vigdes then 'Cancelaci\u00c3\u00b3n'\nwhen pr.pro_sma_tipo  between 200 and 299 and Pro_fec_vighas = pro_fec_vigdes then 'Anulaci\u00c3\u00b3n' else null end cancel_type,\namt.ceded_share_part_prem_amt as  ceded_share_part_prem_amt,\namt.surplus_prem_amt as surplus_prem_amt,\namt.facult_prem_amt facult_prem_amt,\namt.retained_prem_amt as retained_prem_amt,\namt.direct_retained_prem_amt  direct_retained_prem_amt,\nnull as prem_retained_74_amt,\namt.retained_share_part_prem_amt retained_share_part_prem_amt,\nnull as remarque_comm_amt,\nnull as liberty_reins_optional_prem_amt,\namt.nwp_amt as nwp_amt,\namt.cwp_amt as cwp_amt,\n(pr.pro_dec_afecta + pr.pro_dec_exenta) as gwp_amt,\n((pr.pro_dec_comisi/100)* (pr.pro_dec_afecta + pr.pro_dec_exenta)) as broker_comm_amt,\nnull as endorsement_prem_amt,\npr.pro_fec_ingres  mv_dt,\npr.pro_fec_vigdes item_eff_dt, /**ADDED FOR DID236**/\npr.pro_fec_vighas item_exp_dt, /**ADDED FOR DID236**/\n'0' as  broker_branch_rlshp_id,\npr.pro_sma_item as  policy_item_num,\nCURRENT_DATE as rec_crt_dtm,\nCURRENT_DATE as rec_updt_dtm,\n1 as dummy,\npr.pro_sma_anocon as acc_year,\npr.pro_tin_mescon as acc_month,\namt.surplus_ceded_prem_amt,\npr.pro_fec_ingres as mov_eff_dt /**ADDED FOR DID236**/\nfrom cdp_ods.bd_produ_x_pro_prodmes pr\nleft join\ncdp_ods.bd_produ_x_pro_item t\non pr.pro_int_poliza = t.ite_int_poliza and pr.pro_sma_item = t.ite_sma_item\nleft outer join cdp_ods.bd_produ_x_pro_poliza  p \n--on t.ite_int_poliza = p.pol_int_poliza -- Changed as per CDP 460\non pr.pro_int_poliza = p.pol_int_poliza\nleft outer join\n(select round(sum(case dis_tin_tipoDistribucion when 1 then dis_dec_primaCesion else 0 end),4)PrimaFacultativa,\npro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo from (select * from (select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) ps \nleft outer join\ncdp_ods.RsgDst_Sdr_MovimientosDistribucion mov\non ps.pro_int_poliza=mov.dis_int_nroPoliza and ps.pro_sma_item=mov.dis_int_nroItem\nand ps.pro_int_endoso = mov.dis_int_nroEndoso \nand ps.pro_sma_tipo = mov.dis_int_tipoendoso\nGROUP BY pro_int_poliza,pro_Sma_item,pro_int_endoso,pro_sma_tipo) fa\non pr.pro_int_poliza=fa.pro_int_poliza and pr.pro_sma_item=fa.pro_sma_item and pr.pro_int_endoso=fa.pro_int_endoso\nand pr.pro_sma_tipo = fa.pro_sma_tipo\nleft outer join\n(select pro_tin_moneda,pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo from (select * from\n (select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p)a where rnk=1 ) ps \nleft outer join cdp_ods.RsgDst_Sdr_MovimientosDistribucion mov\non ps.pro_int_poliza=mov.dis_int_nroPoliza and ps.pro_sma_item=mov.dis_int_nroItem\nand ps.pro_int_endoso = mov.dis_int_nroEndoso\nand ps.pro_sma_tipo = mov.dis_int_tipoendoso\n GROUP BY pro_int_poliza,pro_Sma_item,pro_int_endoso,pro_tin_moneda,pro_sma_tipo) cu\non pr.pro_int_poliza=cu.pro_int_poliza and pr.pro_sma_item=cu.pro_sma_item and pr.pro_int_endoso=cu.pro_int_endoso  \nand pr.pro_sma_tipo =cu.pro_sma_tipo\nleft outer join cdp_stg_dwh.stg_tref_code_map_variant mva\non mva.ref_type_cd='currency_type' and mva.src_sys_cd = 'penta' and cu.pro_tin_moneda=mva.ref_cd \nleft outer join\n( \nSELECT broker.dim_broker_key,p.pol_int_poliza as pol_int_poliza   from cdp_ods.bd_produ_x_pro_poliza p \ninner join cdp_ods.AgtMst_GrlAgt_Agentes a on a.Agt_Rut = p.pol_int_rutcor \nleft join cdp_dwh.dim_broker_t broker ON (a.Agt_Rut || a.Agt_DigVer) = broker.broker_rut_num\n)dim_broker\nON p.pol_int_poliza=dim_broker.pol_int_poliza \nleft outer join cdp_dwh.dim_lob_t l\non pr.pro_tin_ramo = l.lob_cd and l.src_sys_cd='penta'\nleft outer join cdp_dwh.dim_policy_t po on pr.pro_int_poliza = po.policy_id and po.src_sys_cd='penta'\nleft outer join\n(select distinct ref_cd,pro_int_poliza,pro_sma_item from (select * from\n (select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) pr1 left outer join cdp_stg_dwh.stg_tref_code_map_variant mv\non ref_type_cd='branch_office' and src_sys_cd = 'penta' and pr1.pro_tin_oficin=mv.ref_cd ) br \non br.pro_int_poliza=pr.pro_int_poliza and br.pro_sma_item=pr.pro_sma_item\nleft outer join cdp_dwh.dim_branch_office_t bo on br.ref_cd = bo.branch_office_id and bo.src_sys_cd='penta'\nleft outer join cdp_dwh.dim_policy_risk_t r\non cast((pr.pro_int_poliza||'-'||pr.pro_sma_item) as varchar(35)) =r.policy_item_id and r.src_sys_cd='penta'\nleft outer join cdp_dwh.dim_policyholder_t h\non h.policyholder_id=pr.pro_int_poliza and h.src_sys_cd='penta'\nleft outer join cdp_dwh.dim_insured_t i\non cast((pr.pro_int_poliza||'-'||pr.pro_sma_item) as varchar(35)) =i.insured_id and i.src_sys_cd='penta'\nleft outer join\ncdp_dwh.dim_prd_pln_hrchy_t pph on pr.pro_sma_subramo=pph.prd_cd\nand pr.pro_int_ProdPlan=pph.pln_cd and pr.pro_tin_ramo=pph.lob_cd and pph.src_sys_cd='penta'\nleft outer join cdp_stg_dwh.stg_tref_code_map_variant stg1 on stg1.src_sys_cd='penta' and stg1.ref_type_cd='movement_cd' and \n cast(cast(pr.pro_sma_tipo as integer) as varchar(20))=stg1.ref_cd\nleft outer join cdp_stg_dwh.stg_tref_code_map_variant stg2 on stg2.src_sys_cd='penta' and stg2.ref_type_cd='movement_cd' and \ncast(cast(pr.pro_sma_tipo as integer) as varchar(20))=stg2.ref_cd\nleft outer join\n/*(select p.pol_tin_tippar, pro.pro_dec_porcen,pa.pat_dec_porcen,sum(pat_dec_porcen) pat_dec_porcen_amt,pro.pro_int_poliza,pro.pro_sma_item,\npro.pro_int_endoso,pro.pro_sma_tipo from (select * from \n(select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) pro left outer join cdp_ods.bd_produ_x_pro_participacion pa\non pro.pro_int_poliza = pa.pat_int_poliza and pro.pro_sma_item = pa.pat_sma_item \n--left outer join cdp_ods.bd_produ_x_pro_item t on pro.pro_int_poliza = t.ite_int_poliza and pro.pro_sma_item = t.ite_sma_item -- NOT Required\nleft outer join cdp_ods.bd_produ_x_pro_poliza  p \non pro.pro_int_poliza = p.pol_int_poliza \ngroup by p.pol_tin_tippar, pro.pro_dec_porcen,pa.pat_dec_porcen,pro.pro_int_poliza,pro.pro_sma_item,pro.pro_int_endoso,pro.pro_sma_tipo ) */\n\n/*(select case when p.pol_tin_tippar in (1,2) then 1 else p.pol_tin_tippar end ,\nsum(pat_dec_porcen) pat_dec_porcen_amt,pro.pro_int_poliza,\npro.pro_sma_item,\npro.pro_int_endoso,pro.pro_sma_tipo from (select * from \n(select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) pro inner join cdp_ods.bd_produ_x_pro_participacion pa\non pro.pro_int_poliza = pa.pat_int_poliza and pro.pro_sma_item = pa.pat_sma_item \n--left outer join cdp_ods.bd_produ_x_pro_item t on pro.pro_int_poliza = t.ite_int_poliza and pro.pro_sma_item = t.ite_sma_item -- NOT Required\ninner join cdp_ods.bd_produ_x_pro_poliza  p \non pro.pro_int_poliza = p.pol_int_poliza \n--where p.pol_tin_tippar in (1,2)\n---and pro_int_poliza = '10388044'\ngroup by case when p.pol_tin_tippar in (1,2) then 1 else p.pol_tin_tippar end \n,pro.pro_int_poliza,pro.pro_sma_item,pro.pro_int_endoso,pro.pro_sma_tipo)*/\n\n(\nselect case when p.pol_tin_tippar =0 then 100\n when p.pol_tin_tippar =1 then pa.pat_dec_partic\n when p.pol_tin_tippar =2 then pa1.pat_dec_porcen else 0 end coins_pct\n ,pro.pro_int_poliza,pro.pro_sma_item,\npro.pro_int_endoso,pro.pro_sma_tipo\n from (select * from \n(select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk = 1) pro \nleft outer join (select distinct pat_int_poliza,pat_sma_item,pat_dec_partic from cdp_ods.bd_produ_x_pro_participacion \nwhere pat_tin_codlid = 255)pa\non pro.pro_int_poliza = pa.pat_int_poliza and pro.pro_sma_item = pa.pat_sma_item\nleft outer join (select distinct pat_int_poliza,pat_sma_item,pat_dec_porcen from cdp_ods.bd_produ_x_pro_participacion\nwhere pat_tin_codigo = 255 )pa1\non pro.pro_int_poliza = pa1.pat_int_poliza and pro.pro_sma_item = pa1.pat_sma_item\n--left outer join cdp_ods.bd_produ_x_pro_item t on \n---pro.pro_int_poliza = t.ite_int_poliza and pro.pro_sma_item = t.ite_sma_item \nleft outer join cdp_ods.bd_produ_x_pro_poliza  p \non pro.pro_int_poliza = p.pol_int_poliza \n--group by pro.pro_int_poliza,pro.pro_sma_item,pro.pro_int_endoso,pro.pro_sma_tipo,pol_tin_tippar\n)pct\non pr.pro_int_poliza=pct.pro_int_poliza and pr.pro_sma_item=pct.pro_sma_item  and pr.pro_int_endoso=pct.pro_int_endoso\nand pr.pro_sma_tipo = pct.pro_sma_tipo\nleft outer join\n(select round(sum(case dis_int_codigoClaseContrato when 2 then dis_dec_primaCesion else 0 end),4) as ceded_share_part_prem_amt,\nround(sum(case dis_int_codigoClaseContrato when 3 then dis_dec_primaRetencion else 0 end),4) as surplus_prem_amt,\nround(sum(case dis_tin_tipoDistribucion when 1 then dis_dec_primaCesion else 0 end),4)  as  facult_prem_amt,\n(round(sum(case dis_tin_tipoDistribucion when 2 then dis_dec_primaRetencion else 0 end),4)+\nround(sum(case dis_int_codigoClaseContrato when 2 then dis_dec_primaRetencion else 0 end),4)+\nround(sum(case dis_int_codigoClaseContrato when 3 then dis_dec_primaRetencion else 0 end),4)) as retained_prem_amt,\nround(sum(case dis_tin_tipoDistribucion when 2 then dis_dec_primaRetencion else 0 end),4)  as direct_retained_prem_amt,\nround(sum(case dis_int_codigoClaseContrato when 2 then dis_dec_primaRetencion else 0 end),4) as retained_share_part_prem_amt,\n(round(sum(case dis_tin_tipoDistribucion when 2 then dis_dec_primaRetencion else 0 end),4)+\nround(sum(case dis_int_codigoClaseContrato when 2 then dis_dec_primaRetencion else 0 end),4)+\nround(sum(case dis_int_codigoClaseContrato when 3 then dis_dec_primaRetencion else 0 end),4)) as nwp_amt,\n--(round(sum(case dis_int_codigoClaseContrato when 2 then dis_dec_primaCesion else 0 end),4)\n--+ round(sum(case dis_int_codigoClaseContrato when 3 then dis_dec_primaCesion else 0 end),4)) as cwp_amt,\n/*Added as a part of DID-226*/\n(round(sum(case when dis_int_codigoclasecontrato in ( 2, 3 ) or dis_tin_tipodistribucion = 1 then dis_dec_primacesion else 0 end),4)) as cwp_amt,\nround(sum(case dis_int_codigoClaseContrato when 3 then dis_dec_primaCesion else 0 end),4) as surplus_ceded_prem_amt,\n--prd.pro_dec_afecta + prd.pro_dec_exenta as gwp_amt,\n--((prd.pro_dec_comisi/100)* (prd.pro_dec_afecta + prd.pro_dec_exenta)) as broker_comm_amt,\npro_int_poliza,pro_Sma_item,pro_int_endoso,pro_sma_tipo\nfrom (select * from(select p.*, ROW_NUMBER()OVER(PARTITION BY pro_int_poliza,pro_sma_item,pro_int_endoso,pro_sma_tipo ORDER BY pro_fec_vigdes DESC)  rnk  \nfrom cdp_ods.bd_produ_x_pro_prodmes p) a where rnk =1) prd left outer join cdp_ods.RsgDst_Sdr_MovimientosDistribucion mo\non prd.pro_int_poliza=mo.dis_int_nroPoliza and prd.pro_sma_item=mo.dis_int_nroItem\nand prd.pro_int_endoso = mo.dis_int_nroEndoso and prd.pro_sma_tipo = mo.dis_int_tipoendoso \nGROUP BY pro_int_poliza,pro_Sma_item,pro_int_endoso,pro_sma_tipo,pro_dec_afecta,pro_dec_exenta,pro_dec_comisi ) amt\non pr.pro_int_poliza= amt.pro_int_poliza and pr.pro_sma_item=amt.pro_sma_item and pr.pro_int_endoso=amt.pro_int_endoso\nand pr.pro_sma_tipo = amt.pro_sma_tipo\n\n) src1\nleft outer join \n  (  select distinct etl_audit_id, 1 as dummy from cdp_dwh.dim_prd_pln_hrchy_t where src_sys_cd='penta') ca \n  on src1.dummy =ca.dummy \nleft outer join\n(select 1 as dummy, max(fact_policy_item_mv_key) as MAX_SID from cdp_dwh.fact_policy_prem_comm_summary_t) LKP_MAXSID\non src1.dummy = LKP_MAXSID.dummy\nleft outer join \n(select ite_int_poliza, ite_sma_ramo, count(*) as pcount from cdp_ods.bd_produ_x_pro_item  /* added for groupo integrado */\n--where ite_sma_ramo in (9,10)\t\t\t\t\t\t\t\t\t\t\t\t/* added for groupo integrado */\ngroup by ite_int_poliza, ite_sma_ramo) pol_count\t\t\t\t\t\t\t/* added for groupo integrado */\non pol_count.ite_int_poliza=src1.policy_num\t\t\t\t\t\t\t\t\t/* added for groupo integrado */\n)SRC\nwhere rnk=1 and policy_item_id is not null and mv_id is not null and agreement is not null"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "DELETE FROM cdp_dwh.fact_policy_prem_comm_summary_t WHERE src_sys_cd='penta';"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[1].dataAdapter.runtimeAttributes.attributes[14]",
        "name": "Pre-sql",
        "value": "delete from cdp_dwh.fact_policy_prem_comm_summary_t  where src_sys_cd='penta';\ncommit;"
    }
]