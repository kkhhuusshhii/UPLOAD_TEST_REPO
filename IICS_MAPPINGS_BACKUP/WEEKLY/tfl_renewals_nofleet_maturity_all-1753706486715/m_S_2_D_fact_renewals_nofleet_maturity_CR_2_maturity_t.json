[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "WITH CRT1 AS\n(\nselect *,\ncase when num_renov1_temp is not null then\nrow_number() over (partition by A.key1, NUM_RENOV1_temp-to_get_num_renov ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC)\nelse null\nend as NUM_RENOV1\n from (\nselect key1, A.sseguro, fin_vig_act, ini_vig, endoso_agrup, A.COB_PLAN,  RENEWAL_CRITERION_1, previous_policy, maturity_cr.endoso_agrup_previous, A.fleet_indicator_maturity,\n\t\tCASE \n\t\tWHEN A.PATENTE IN (select excluded_patente from cdp_stg_dwh.patente_excluidos)THEN NULL\n\t\tWHEN A.COB_PLAN in (0,2) THEN NULL\n\t\t--WHEN maturity_cr.endoso_agrup_previous in ('ANULACION','CANCELACION') then 'NB'\n\t\tWHEN maturity_cr.prev_exp_dt = ini_vig THEN 'RB'\n\t\tWHEN maturity_cr.prev_exp_dt <> ini_vig THEN 'NB'\n\t\telse business_type_indicator_1 \n\t\tEND AS business_type_indicator_1_new,\n\t\t\n\t\trow_number() over (partition by A.key1 ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC) as to_get_num_renov,\n\t\tCASE WHEN BUSINESS_TYPE_INDICATOR_1_new = 'RB' THEN ROW_NUMBER()OVER(PARTITION BY A.KEY1, A.fleet_indicator_maturity, maturity_indicator, BUSINESS_TYPE_INDICATOR_1_new ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC)\n        ELSE NULL END AS NUM_RENOV1_temp\nfrom (\nselect *, LEAD(A.sseguro) OVER (partition by A.Key1 ORDER BY A.INI_VIG DESC, A.FIN_VIG_ACT DESC, A.SSEGURO DESC) AS previous_policy\nfrom (\nselect *\nfrom(\nSELECT DISTINCT A.KEY1,A.SSEGURO,A.FIN_VIG_ACT,A.INI_VIG, A.fleet_indicator_maturity, maturity_indicator, A.PATENTE, A.COB_PLAN, A.endoso_agrup,\n\t\tCASE \n\t\tWHEN A.PATENTE IN (select excluded_patente from cdp_stg_dwh.patente_excluidos)THEN NULL\n\t\tWHEN A.COB_PLAN IN (0,2) THEN NULL\n\t\tWHEN RN=1 THEN 0 \n        WHEN RN>1 AND RENEWAL_CRITERIA=1 THEN 1\n        ELSE 0 END AS RENEWAL_CRITERION_1,\n        CASE  \n\t\tWHEN A.PATENTE IN (select excluded_patente from cdp_stg_dwh.patente_excluidos)THEN NULL\n\t\tWHEN A.COB_PLAN IN (0,2) THEN NULL\n\t\tWHEN RN1=1 THEN 'NB'\n        when ini_vig=fin_vig_act  then 'NB' \n        WHEN RN1>1 AND RENEWAL_CRITERIA=1 THEN 'RB'\n        WHEN RN=1 THEN 'RB'\n        ELSE 'NB' END AS BUSINESS_TYPE_INDICATOR_1,\n        ROW_NUMBER()OVER(PARTITION BY KEY1,SSEGURO ORDER BY FIN_VIG_ACT DESC,INI_VIG DESC,BUSINESS_TYPE_INDICATOR_1)ROWNUM\nFROM(\nSELECT a.key1,a.FIN_VIG_ACT,a.ini_vig,a.sseguro,A.COB_PLAN,A.PATENTE,ROW_NUMBER()OVER(PARTITION BY A.key1, A.fleet_indicator_maturity, maturity_indicator ORDER BY A.FIN_VIG_ACT DESC,a.ini_vig desc)AS RN,\nCASE WHEN B.key1 IS NOT NULL and a.sseguro<>b.sseguro THEN 1 ELSE 0 END AS RENEWAL_CRITERIA,\n        ROW_NUMBER()OVER(PARTITION BY A.key1, A.fleet_indicator_maturity, maturity_indicator ORDER BY A.FIN_VIG_ACT asc,a.ini_vig asc, a.sseguro asc)AS RN1, A.fleet_indicator_maturity, A.endoso_agrup,\n\t\tcase when A.endoso_agrup not in ('CANCELACION','ANULACION') then 'T'\n\t\t\telse null\n\t\tend as maturity_indicator\nFROM (select base_final_liberty.COB_PLAN,PATENTE,\n        cast(sseguro as varchar(80))as sseguro,fin_vig_act,ini_vig,endoso_agrup,\n\t\tCASE \n\t\t\tWHEN cagrseg<>0 or cagrseg is not null THEN\n\t\t\tcase when (cagrseg not in (select CAST(num_convenio as varchar(8)) as num_convenio from cdp_stg_dwh.convenios_excluidos)) THEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\t\tELSE CASE WHEN count_sseguro>4 THEN 1 ELSE 0 END\n\t\tEND as fleet_indicator_maturity\t,\n\t\t------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN Fleet_indicator_maturity=0 THEN\n\t\t\t\tCASE WHEN cod_producto in (469,498,538,658,667,830,834,961,987,995) THEN 'RC_I'\n\t\t\t\t\tWHEN cod_producto in (473,764,998) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (859) THEN 'ESPECIAL'\n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS \tTIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||PATENTE as key1\n\t\t-------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_liberty\n\t\tLEFT JOIN (SELECT contratante_rut, count(sseguro) as count_sseguro FROM cdp_stg_dwh.CONTRATANTES_LIB GROUP BY contratante_rut) BFLC1\n\t\tON base_final_liberty.contratante_rut = BFLC1.contratante_rut\n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_liberty.cob_plan = dp.cob_plan\n        union all \n        select base_final_penta.COB_PLAN,PATENTE,\n        sseguro,fin_vig_act,ini_vig,endoso_agrup, flota as fleet_indicator_maturity,\n\t\t-----------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN fleet_indicator_maturity = 0 THEN \n\t\t\t\tCASE WHEN cod_producto in (70, 20020, 20022, 20024, 20026, 20034, 20123, 20150, 20151, 20152, 20153, 20154, 20158, 20175, 20176, 20193, 20392) THEN 'RC_I'   \n\t\t\t\t\tWHEN cod_producto in (20043) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (55, 20076, 20077) THEN 'ESPECIAL'  \n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS TIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||PATENTE as key1\n\t\t------------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_penta\n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_penta.cob_plan = dp.cob_plan) A\nLEFT JOIN (select base_final_liberty.COB_PLAN,PATENTE,\n        cast(sseguro as varchar(80))as sseguro ,fin_vig_act,ini_vig,endoso_agrup,\n\t\tCASE \n\t\t\tWHEN cagrseg<>0 or cagrseg is not null THEN\n\t\t\tcase when (cagrseg not in (select CAST(num_convenio as varchar(8)) as num_convenio from cdp_stg_dwh.convenios_excluidos)) THEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\t\tELSE CASE WHEN count_sseguro>4 THEN 1 ELSE 0 END\n\t\tEND as fleet_indicator_maturity\t,\n\t\t------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN Fleet_indicator_maturity=0 THEN\n\t\t\t\tCASE WHEN cod_producto in (469,498,538,658,667,830,834,961,987,995) THEN 'RC_I'\n\t\t\t\t\tWHEN cod_producto in (473,764,998) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (859) THEN 'ESPECIAL'\n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS \tTIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||PATENTE as key1\n\t\t-------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_liberty\n\t\tLEFT JOIN (SELECT contratante_rut, count(sseguro) as count_sseguro FROM cdp_stg_dwh.CONTRATANTES_LIB GROUP BY contratante_rut) BFLC1\n\t\tON base_final_liberty.contratante_rut = BFLC1.contratante_rut\n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_liberty.cob_plan = dp.cob_plan\n        union all \n        select base_final_penta.COB_PLAN,PATENTE,\n        sseguro,fin_vig_act,ini_vig,endoso_agrup, flota as fleet_indicator_maturity,\n\t\t-----------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN fleet_indicator_maturity = 0 THEN \n\t\t\t\tCASE WHEN cod_producto in (70, 20020, 20022, 20024, 20026, 20034, 20123, 20150, 20151, 20152, 20153, 20154, 20158, 20175, 20176, 20193, 20392) THEN 'RC_I'   \n\t\t\t\t\tWHEN cod_producto in (20043) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (55, 20076, 20077) THEN 'ESPECIAL'  \n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS TIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||PATENTE as key1\n\t\t------------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_penta\n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_penta.cob_plan = dp.cob_plan) B\nON A.FIN_VIG_ACT=B.INI_VIG AND A.key1=B.key1\nWHERE A.key1 IS NOT NULL \nORDER BY A.FIN_VIG_ACT DESC,A.INI_VIG DESC\n)A\nORDER BY FIN_VIG_ACT DESC, SSEGURO DESC\n)A\nWHERE ROWNUM=1 ORDER BY FIN_VIG_ACT DESC, SSEGURO DESC\n)A)A\nleft join\n(\nselect distinct(cast(sseguro as varchar)), endoso_agrup as endoso_agrup_previous, fin_vig_act as prev_exp_dt\nfrom cdp_dwh.base_final_liberty\nunion all\nselect sseguro, endoso_agrup as endoso_agrup_previous, fin_vig_act as prev_exp_dt\nfrom cdp_dwh.base_final_penta\n)maturity_cr\non maturity_cr.sseguro = cast(A.previous_policy as varchar)\n)A\norder by ini_vig desc, fin_vig_act desc, A.sseguro desc\n),\nCRT2 AS\n(\nselect *,\ncase when num_renov2_temp is not null then\nrow_number() over (partition by A.key2, NUM_RENOV2_temp-to_get_num_renov ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC)\nelse null\nend as NUM_RENOV2\nfrom (\nselect key2, A.sseguro, fin_vig_act, ini_vig,  A.COB_PLAN, RENEWAL_CRITERION_2, previous_policy, maturity_cr.endoso_agrup_previous, A.fleet_indicator_maturity,\nCASE \n\t\tWHEN A.COB_PLAN in (0,2) THEN NULL\n\t\tWHEN A.NUM_MOTOR is null or A.NUM_MOTOR in (',','S/CHASSIS','S/CHASIS','S/Chasis') THEN NULL\n\t\t--WHEN maturity_cr.endoso_agrup_previous in ('ANULACION','CANCELACION') then 'NB'\n\t\tWHEN maturity_cr.prev_exp_dt = ini_vig THEN 'RB'\n\t\tWHEN maturity_cr.prev_exp_dt <> ini_vig THEN 'NB'\n\t\telse business_type_indicator_2 \n\t\tEND AS business_type_indicator_2_new,\n\n\t\trow_number() over (partition by A.key2 ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC) as to_get_num_renov,\n\t\t\n\t\tCASE WHEN BUSINESS_TYPE_INDICATOR_2_new = 'RB' THEN ROW_NUMBER()OVER(PARTITION BY A.KEY2, A.fleet_indicator_maturity, maturity_indicator, BUSINESS_TYPE_INDICATOR_2_new ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC) \n        ELSE NULL END AS NUM_RENOV2_temp\nfrom(\nselect *, LEAD(A.sseguro) OVER (partition by A.Key2 ORDER BY A.INI_VIG DESC, A.FIN_VIG_ACT DESC, A.SSEGURO DESC) AS previous_policy\nfrom (\nselect *\nfrom(\nSELECT DISTINCT A.key2,A.SSEGURO,A.FIN_VIG_ACT,A.INI_VIG, A.fleet_indicator_maturity, maturity_indicator, A.NUM_MOTOR, A.COB_PLAN,\n\t\tCASE \n\t\tWHEN A.COB_PLAN IN (0,2) THEN NULL\n\t\tWHEN A.NUM_MOTOR is null or A.NUM_MOTOR in (',','S/CHASSIS','S/CHASIS','S/Chasis') THEN NULL\n\t\tWHEN RN=1 THEN 0 \n        WHEN RN>1 AND RENEWAL_CRITERIA=1 THEN 1\n        ELSE 0 END AS RENEWAL_CRITERION_2,\n        CASE \n\t\tWHEN A.COB_PLAN IN (0,2) THEN NULL\n\t\tWHEN A.NUM_MOTOR is null or A.NUM_MOTOR in (',','S/CHASSIS','S/CHASIS','S/Chasis') THEN NULL\n\t\tWHEN RN1=1 THEN 'NB' \n        when ini_vig=fin_vig_act  then 'NB'\n        WHEN RN1>1 AND RENEWAL_CRITERIA=1 THEN 'RB'\n        WHEN RN=1 THEN 'RB'\n        ELSE 'NB' END AS BUSINESS_TYPE_INDICATOR_2,\n        ROW_NUMBER()OVER(PARTITION BY key2,SSEGURO ORDER BY FIN_VIG_ACT DESC,INI_VIG DESC,BUSINESS_TYPE_INDICATOR_2)ROWNUM\nFROM(\nSELECT a.key2,a.FIN_VIG_ACT,a.ini_vig,a.sseguro,A.COB_PLAN, ROW_NUMBER()OVER(PARTITION BY A.key2, A.fleet_indicator_maturity, maturity_indicator ORDER BY A.FIN_VIG_ACT DESC,a.ini_vig desc)AS RN,\nCASE WHEN B.key2 IS NOT NULL and a.sseguro<>b.sseguro THEN 1 ELSE 0 END AS RENEWAL_CRITERIA,\n        ROW_NUMBER()OVER(PARTITION BY A.key2, A.fleet_indicator_maturity, maturity_indicator ORDER BY A.FIN_VIG_ACT asc,a.ini_vig asc, a.sseguro asc)AS RN1, A.fleet_indicator_maturity,\n\t\tcase when A.endoso_agrup not in ('CANCELACION','ANULACION') then 'T'\n\t\t\telse null\n\t\tend as maturity_indicator, A.NUM_MOTOR\nFROM (select base_final_liberty.COB_PLAN,\n        cast(sseguro as varchar(80))as sseguro,fin_vig_act,ini_vig,endoso_agrup, NUM_MOTOR,\n\t\tCASE \n\t\t\tWHEN cagrseg<>0 or cagrseg is not null THEN\n\t\t\tcase when (cagrseg not in (select CAST(num_convenio as varchar(8)) as num_convenio from cdp_stg_dwh.convenios_excluidos)) THEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\t\tELSE CASE WHEN count_sseguro>4 THEN 1 ELSE 0 END\n\t\tEND as fleet_indicator_maturity\t,\n\t\t------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN Fleet_indicator_maturity=0 THEN\n\t\t\t\tCASE WHEN cod_producto in (469,498,538,658,667,830,834,961,987,995) THEN 'RC_I'\n\t\t\t\t\tWHEN cod_producto in (473,764,998) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (859) THEN 'ESPECIAL'\n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS \tTIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||NUM_MOTOR as key2\n\t\t-------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_liberty \n\t\tLEFT JOIN (SELECT contratante_rut, count(sseguro) as count_sseguro FROM cdp_stg_dwh.CONTRATANTES_LIB GROUP BY contratante_rut) BFLC1\n\t\tON base_final_liberty.contratante_rut = BFLC1.contratante_rut\n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_liberty.cob_plan = dp.cob_plan\n        union all \n        select base_final_penta.COB_PLAN,\n        sseguro,fin_vig_act,ini_vig,endoso_agrup, NUM_MOTOR, flota as fleet_indicator_maturity,\n\t\t-----------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN fleet_indicator_maturity = 0 THEN \n\t\t\t\tCASE WHEN cod_producto in (70, 20020, 20022, 20024, 20026, 20034, 20123, 20150, 20151, 20152, 20153, 20154, 20158, 20175, 20176, 20193, 20392) THEN 'RC_I'   \n\t\t\t\t\tWHEN cod_producto in (20043) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (55, 20076, 20077) THEN 'ESPECIAL'  \n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS TIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||NUM_MOTOR as key2\n\t\t------------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_penta \n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_penta.cob_plan = dp.cob_plan) A\nLEFT JOIN (select base_final_liberty.COB_PLAN,\n        cast(sseguro as varchar(80))as sseguro,fin_vig_act,ini_vig,endoso_agrup, NUM_MOTOR,\n\t\tCASE \n\t\t\tWHEN cagrseg<>0 or cagrseg is not null THEN\n\t\t\tcase when (cagrseg not in (select CAST(num_convenio as varchar(8)) as num_convenio from cdp_stg_dwh.convenios_excluidos)) THEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\t\tELSE CASE WHEN count_sseguro>4 THEN 1 ELSE 0 END\n\t\tEND as fleet_indicator_maturity\t,\n\t\t------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN Fleet_indicator_maturity=0 THEN\n\t\t\t\tCASE WHEN cod_producto in (469,498,538,658,667,830,834,961,987,995) THEN 'RC_I'\n\t\t\t\t\tWHEN cod_producto in (473,764,998) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (859) THEN 'ESPECIAL'\n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS \tTIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||NUM_MOTOR as key2\n\t\t-------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_liberty \n\t\tLEFT JOIN (SELECT contratante_rut, count(sseguro) as count_sseguro FROM cdp_stg_dwh.CONTRATANTES_LIB GROUP BY contratante_rut) BFLC1\n\t\tON base_final_liberty.contratante_rut = BFLC1.contratante_rut\n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_liberty.cob_plan = dp.cob_plan\n        union all \n        select base_final_penta.COB_PLAN,\n        sseguro,fin_vig_act,ini_vig,endoso_agrup, NUM_MOTOR, flota as fleet_indicator_maturity,\n\t\t-----------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN fleet_indicator_maturity = 0 THEN \n\t\t\t\tCASE WHEN cod_producto in (70, 20020, 20022, 20024, 20026, 20034, 20123, 20150, 20151, 20152, 20153, 20154, 20158, 20175, 20176, 20193, 20392) THEN 'RC_I'   \n\t\t\t\t\tWHEN cod_producto in (20043) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (55, 20076, 20077) THEN 'ESPECIAL'  \n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS TIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||NUM_MOTOR as key2\n\t\t------------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_penta \n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_penta.cob_plan = dp.cob_plan) B\nON A.FIN_VIG_ACT=B.INI_VIG AND A.key2=B.key2\nWHERE A.key2 IS NOT NULL and A.NUM_MOTOR is not null and A.NUM_MOTOR not in(',','.','S/CHASSIS','S/CHASIS','S/Chasis')\nORDER BY A.FIN_VIG_ACT DESC,A.INI_VIG DESC\n)A\nORDER BY FIN_VIG_ACT DESC, SSEGURO DESC\n)A\nWHERE ROWNUM=1 ORDER BY FIN_VIG_ACT DESC, SSEGURO DESC\n)A)A\n\nleft join\n(\nselect distinct(cast(sseguro as varchar)), endoso_agrup as endoso_agrup_previous, fin_vig_act as prev_exp_dt\nfrom cdp_dwh.base_final_liberty\nunion all\nselect sseguro, endoso_agrup as endoso_agrup_previous, fin_vig_act as prev_exp_dt\nfrom cdp_dwh.base_final_penta\n)maturity_cr\non maturity_cr.sseguro = cast(A.previous_policy as varchar)\n)A\norder by ini_vig desc, fin_vig_act desc, A.sseguro desc\n),\nCRT3 AS\n(\nselect *,\ncase when num_renov3_temp is not null then\nrow_number() over (partition by A.key3, NUM_RENOV3_temp-to_get_num_renov ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC)\nelse null\nend as NUM_RENOV3\n from (\nselect key3, A.sseguro, fin_vig_act, ini_vig,  A.COB_PLAN, RENEWAL_CRITERION_3, previous_policy, maturity_cr.endoso_agrup_previous, A.fleet_indicator_maturity, A.NRO_MASIVO,\n\t\t\n\t\tCASE\n\t\tWHEN A.COB_PLAN in (0,2) THEN NULL\n\t\tWHEN A.NRO_MASIVO=0 or A.NRO_MASIVO is null then NULL\n\t\t--WHEN maturity_cr.endoso_agrup_previous in ('ANULACION','CANCELACION') then 'NB'\n\t\tWHEN maturity_cr.prev_exp_dt = ini_vig THEN 'RB'\n\t\tWHEN maturity_cr.prev_exp_dt <> ini_vig THEN 'NB'\n\t\telse business_type_indicator_3 \n\t\tEND AS business_type_indicator_3_new,\n\t\t\n\t\trow_number() over (partition by A.key3 ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC) as to_get_num_renov,\n\t\t\n\t\tCASE WHEN BUSINESS_TYPE_INDICATOR_3_new = 'RB' THEN ROW_NUMBER()OVER(PARTITION BY A.KEY3, A.fleet_indicator_maturity, maturity_indicator, BUSINESS_TYPE_INDICATOR_3_new ORDER BY A.INI_VIG ASC, A.FIN_VIG_ACT ASC, A.SSEGURO ASC)\n        ELSE NULL END AS NUM_RENOV3_temp\nfrom(\nselect *, LEAD(A.sseguro) OVER (partition by A.Key3 ORDER BY A.INI_VIG DESC, A.FIN_VIG_ACT DESC, A.SSEGURO DESC) AS previous_policy\n\nfrom (\nselect *\nfrom(\nSELECT DISTINCT A.key3,A.SSEGURO,A.FIN_VIG_ACT,A.INI_VIG, A.fleet_indicator_maturity, maturity_indicator, A.NRO_MASIVO, A.COB_PLAN,\n\t\tCASE\n\t\tWHEN A.COB_PLAN IN (0,2) THEN NULL\n\t\tWHEN A.NRO_MASIVO=0 or A.NRO_MASIVO is null then NULL\n\t\tWHEN RN=1 THEN 0 \n        WHEN RN>1 AND RENEWAL_CRITERIA=1 THEN 1\n        ELSE 0 END AS RENEWAL_CRITERION_3,\n        CASE \n\t\tWHEN A.COB_PLAN IN (0,2) THEN NULL\n\t\tWHEN A.NRO_MASIVO=0 or A.NRO_MASIVO is null then NULL\n\t\tWHEN RN1=1 THEN 'NB' \n        when ini_vig=fin_vig_act  then 'NB'\n        WHEN RN1>1 AND RENEWAL_CRITERIA=1 THEN 'RB'\n        WHEN RN=1 THEN 'RB'\n        ELSE 'NB' END AS BUSINESS_TYPE_INDICATOR_3,\n        ROW_NUMBER()OVER(PARTITION BY key3,SSEGURO ORDER BY FIN_VIG_ACT DESC,INI_VIG DESC,BUSINESS_TYPE_INDICATOR_3)ROWNUM\nFROM(\nSELECT a.key3,a.FIN_VIG_ACT,a.ini_vig,a.sseguro,A.COB_PLAN, ROW_NUMBER()OVER(PARTITION BY A.key3, A.fleet_indicator_maturity, maturity_indicator ORDER BY A.FIN_VIG_ACT DESC,a.ini_vig desc)AS RN,\nCASE WHEN B.key3 IS NOT NULL and B.NRO_MASIVO <> '' and a.sseguro<>b.sseguro THEN 1 ELSE 0 END AS RENEWAL_CRITERIA,\n        ROW_NUMBER()OVER(PARTITION BY A.key3, A.fleet_indicator_maturity, maturity_indicator ORDER BY A.FIN_VIG_ACT asc,a.ini_vig asc, a.sseguro asc)AS RN1, A.fleet_indicator_maturity,\n\t\tcase when A.endoso_agrup not in ('CANCELACION','ANULACION') then 'T'\n\t\t\telse null\n\t\tend as maturity_indicator, A.NRO_MASIVO\nFROM (select base_final_liberty.COB_PLAN,NRO_MASIVO,\n        cast(sseguro as varchar(80))as sseguro ,fin_vig_act,ini_vig,endoso_agrup,\n\t\tCASE \n\t\t\tWHEN cagrseg<>0 or cagrseg is not null THEN\n\t\t\tcase when (cagrseg not in (select CAST(num_convenio as varchar(8)) as num_convenio from cdp_stg_dwh.convenios_excluidos)) THEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\t\tELSE CASE WHEN count_sseguro>4 THEN 1 ELSE 0 END\n\t\tEND as fleet_indicator_maturity\t,\n\t\t------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN Fleet_indicator_maturity=0 THEN\n\t\t\t\tCASE WHEN cod_producto in (469,498,538,658,667,830,834,961,987,995) THEN 'RC_I'\n\t\t\t\t\tWHEN cod_producto in (473,764,998) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (859) THEN 'ESPECIAL'\n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS \tTIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||NRO_MASIVO as key3\n\t\t-------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_liberty \n\t\tLEFT JOIN (SELECT contratante_rut, count(sseguro) as count_sseguro FROM cdp_stg_dwh.CONTRATANTES_LIB GROUP BY contratante_rut) BFLC1\n\t\tON base_final_liberty.contratante_rut = BFLC1.contratante_rut\n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_liberty.cob_plan = dp.cob_plan\n        union all\n        select base_final_penta.COB_PLAN,NRO_MASIVO,\n        sseguro,fin_vig_act,ini_vig,endoso_agrup, flota as fleet_indicator_maturity,\n\t\t-----------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN fleet_indicator_maturity = 0 THEN \n\t\t\t\tCASE WHEN cod_producto in (70, 20020, 20022, 20024, 20026, 20034, 20123, 20150, 20151, 20152, 20153, 20154, 20158, 20175, 20176, 20193, 20392) THEN 'RC_I'   \n\t\t\t\t\tWHEN cod_producto in (20043) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (55, 20076, 20077) THEN 'ESPECIAL'  \n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS TIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||NRO_MASIVO as key3\n\t\t------------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_penta \n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_penta.cob_plan = dp.cob_plan) A\nLEFT JOIN (select base_final_liberty.COB_PLAN,NRO_MASIVO,\n        cast(sseguro as varchar(80))as sseguro,fin_vig_act,ini_vig,endoso_agrup,\n\t\tCASE \n\t\t\tWHEN cagrseg<>0 or cagrseg is not null THEN\n\t\t\tcase when (cagrseg not in (select CAST(num_convenio as varchar(8)) as num_convenio from cdp_stg_dwh.convenios_excluidos)) THEN 1\n\t\t\tELSE 0\n\t\t\tEND\n\t\t\tELSE CASE WHEN count_sseguro>4 THEN 1 ELSE 0 END\n\t\tEND as fleet_indicator_maturity\t,\n\t\t------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN Fleet_indicator_maturity=0 THEN\n\t\t\t\tCASE WHEN cod_producto in (469,498,538,658,667,830,834,961,987,995) THEN 'RC_I'\n\t\t\t\t\tWHEN cod_producto in (473,764,998) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (859) THEN 'ESPECIAL'\n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS \tTIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||NRO_MASIVO as key3\n\t\t-------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_liberty \n\t\tLEFT JOIN (SELECT contratante_rut, count(sseguro) as count_sseguro FROM cdp_stg_dwh.CONTRATANTES_LIB GROUP BY contratante_rut) BFLC1\n\t\tON base_final_liberty.contratante_rut = BFLC1.contratante_rut\n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_liberty.cob_plan = dp.cob_plan\n        union all\n        select base_final_penta.COB_PLAN,NRO_MASIVO,\n        sseguro,fin_vig_act,ini_vig,endoso_agrup,  flota as fleet_indicator_maturity,\n\t\t-----------------------------------------------------------------------\n\t\tCASE WHEN fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\t\tWHEN fleet_indicator_maturity = 0 THEN \n\t\t\t\tCASE WHEN cod_producto in (70, 20020, 20022, 20024, 20026, 20034, 20123, 20150, 20151, 20152, 20153, 20154, 20158, 20175, 20176, 20193, 20392) THEN 'RC_I'   \n\t\t\t\t\tWHEN cod_producto in (20043) THEN 'RC_E'\n\t\t\t\t\tWHEN cod_producto in (55, 20076, 20077) THEN 'ESPECIAL'  \n\t\t\t\t\tELSE dp.TIPO_PLAN\n\t\t\t\tEND\n\t\tEND AS TIPO_PLAN_updt, ASEGURADO_RUT||CORREDOR_RUT||TIPO_PLAN_updt||NRO_MASIVO as key3\n\t\t------------------------------------------------------------------------\n\t\tfrom cdp_dwh.base_final_penta \n\t\tLEFT JOIN cdp_stg_dwh.desc_plan as dp\n\t\ton base_final_penta.cob_plan = dp.cob_plan) B\nON A.FIN_VIG_ACT=B.INI_VIG AND A.key3=B.key3\nWHERE A.key3 IS NOT NULL and A.NRO_MASIVO <> '' and A.NRO_MASIVO <> 0 and A.NRO_MASIVO is not null\nORDER BY A.FIN_VIG_ACT DESC,A.INI_VIG DESC\n)A\nORDER BY FIN_VIG_ACT DESC, SSEGURO DESC\n)A\nWHERE ROWNUM=1 ORDER BY FIN_VIG_ACT DESC, SSEGURO DESC\n)A)A\nleft join\n(\nselect distinct(cast(sseguro as varchar)), endoso_agrup as endoso_agrup_previous, fin_vig_act as prev_exp_dt\nfrom cdp_dwh.base_final_liberty\nunion all\nselect sseguro, endoso_agrup as endoso_agrup_previous, fin_vig_act as prev_exp_dt\nfrom cdp_dwh.base_final_penta\n)maturity_cr\non maturity_cr.sseguro = cast(A.previous_policy as varchar)\n)A\norder by ini_vig desc, fin_vig_act desc, A.sseguro desc\n)\n\n\nselect src_sys_cd,\n       policy_item_id,\n       policy_num,\n       policy_item_num,\n       lob_cd,\n       branch_office_cd,\n       insured_rut_num,\n       policy_issue_dt,\n       policy_ori_exp_dt,\n       policy_act_exp_dt,\n       effective_days,\n       SUBSCRIBED_DAYS,\n       veh_make,\n       veh_model,\n       veh_class_cd,\n\t   Use,\n\t   veh_year,\n\t   lic_plate_num,\n\t   veh_type_cd,\n\t   veh_type_desc,\n\t   veh_motor_num,\n\t   broker_rut_num,\n\t   Massive_Number,\n\t   prd_cd,\n\t   pln_cd,\n\t   policyholder_rut_num,\n\t   mv_id,\n\t   deductible,\n\t   Fleet_Indicator,\n\t   policy_premium_amt,\n\t   Commission_amt,\n\t   mv_reason_cd,\n\t   group_endorsements,\n\t   coverage_plan,\n\t   business_number,\n\t   premium_rate_amt,\n\t   discount_amt,\n\t   mv_reason_desc,\n\t   anulac_dt,\n\t   carpro_dt,\n\t   policy_exp_dt,\n\t   Dim_broker_key,\n\t   Dim_LOB_key,\n\t   Dim_Insured_key,\n\t   dim_policyholder_key,\n\t   src.Fleet_Indicator_Maturity,\n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL ELSE crt1.Key1 END AS Key1,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 or crt1.key1 is null THEN NULL\n\t   WHEN lic_plate_num in (select excluded_patente from cdp_stg_dwh.patente_excluidos)THEN NULL\n\t   ELSE(LAG(policy_item_id) OVER ( partition by crt1.Key1 ORDER BY policy_issue_dt DESC, policy_act_exp_dt DESC, policy_item_id DESC)) END AS SSEGURO_SIG_1,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL ELSE crt2.Key2 END AS Key2,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 or crt2.key2 is null THEN NULL\n\t   WHEN veh_motor_num is null or veh_motor_num in (',','S/CHASSIS','S/CHASIS','S/Chasis') THEN NULL\t   \n\t   ELSE(LAG(policy_item_id) OVER ( partition by crt2.Key2 ORDER BY policy_issue_dt DESC, policy_act_exp_dt DESC,  policy_item_id DESC)) END AS SSEGURO_SIG_2,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL ELSE crt3.Key3 END AS Key3,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 or crt3.key3 is null THEN NULL \n\t   WHEN massive_number='' or massive_number=0 or massive_number is null THEN NULL\n\t   ELSE (LAG(policy_item_id) OVER ( partition by crt3.Key3 ORDER BY policy_issue_dt DESC, policy_act_exp_dt DESC,  policy_item_id DESC)) END AS SSEGURO_SIG_3,\n\t   Validity_Indicator,\n\t   Renewable_Product_Indicator,\n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt1.BUSINESS_TYPE_INDICATOR_1_new \n\t\t\tELSE NULL\n\t   END AS BUSINESS_TYPE_INDICATOR_1,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt2.BUSINESS_TYPE_INDICATOR_2_new\n\t\t\tELSE NULL\n\t   END AS BUSINESS_TYPE_INDICATOR_2,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt3.BUSINESS_TYPE_INDICATOR_3_new\n\t\t\tELSE NULL \n\t   END AS BUSINESS_TYPE_INDICATOR_3,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1  THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt1.RENEWAL_CRITERION_1\n\t\t\tELSE NULL\n\t   END AS Indicator_Renewal_Criterion_1,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt1.NUM_RENOV1\n\t\t\tELSE  NULL\n\t   END AS NUM_RENOV1,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1  THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt2.RENEWAL_CRITERION_2\n\t\t\tELSE NULL  \n\t   END AS Indicator_Renewal_Criterion_2,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt2.NUM_RENOV2\n\t\t\tELSE  NULL\n\t   END AS NUM_RENOV2,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1  THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt3.RENEWAL_CRITERION_3\n\t\t\tELSE NULL \n\t   END AS Indicator_Renewal_Criterion_3,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL \n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN crt3.NUM_RENOV3\n\t\t\tELSE NULL \n\t   END AS NUM_RENOV3,\n\t   \n\t   CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL\n\t\t\tWHEN (Indicator_Renewal_Criterion_1=1) OR (Indicator_Renewal_Criterion_2=1) OR (Indicator_Renewal_Criterion_3=1)\n\t   THEN 1\n\t   WHEN Indicator_Renewal_Criterion_1 is NULL and Indicator_Renewal_Criterion_2 is NULL and Indicator_Renewal_Criterion_3 is NULL then NULL\n\t   ELSE 0\n\t   END AS final_Renewal_Indicator,\n           tmake ,\n           tmodel ,\n\t\t\n\t\t--added on 2/4/20   \n\t\tCANAL,\n\t\tCASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL ELSE indicator_policy_candidate_to_renew END AS indicator_policy_candidate_to_renew,\n\t\t\n\t\t--MAX(crt1.NUM_RENOV1,crt2.NUM_RENOV2,crt3.NUM_RENOV3) \nCASE\nwhen src.Fleet_Indicator_Maturity = 1 then NULL\nwhen NUM_RENOV1 is NULL and NUM_RENOV2 is NULL and NUM_RENOV3 is NULL THEN NULL\nelse greatest(NUM_RENOV1, NUM_RENOV2, NUM_RENOV3)\nend as NUM_RENOV_FINAL,\n\t\t\n\t\tCASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL\n\t\t\tWHEN ANUL=0 and CANCEL=0 THEN\n\t\t\t\tCASE\n\t\t\t\tWHEN BUSINESS_TYPE_INDICATOR_1 IS NULL AND BUSINESS_TYPE_INDICATOR_2 IS NULL AND BUSINESS_TYPE_INDICATOR_3 IS NULL THEN NULL\n\t\t\t\tWHEN BUSINESS_TYPE_INDICATOR_1='RB' OR BUSINESS_TYPE_INDICATOR_2='RB' OR BUSINESS_TYPE_INDICATOR_3='RB' THEN 'RB'\n\t\t\t\tELSE 'NB'\n\t\t\t\tEND\n\t\t\tELSE NULL\n\t\tEND AS FINAL_BUSINESS_TYPE_INDICATOR,\n\t\t\t\n\t\t-- CASE WHEN src.Fleet_Indicator_Maturity = 1 THEN NULL\n\t\t\t-- WHEN BUSINESS_TYPE_INDICATOR_1 is null and BUSINESS_TYPE_INDICATOR_2 is null and BUSINESS_TYPE_INDICATOR_3 is null THEN NULL\n\t\t\t-- ELSE CASE \n\t\t\t\t\t-- WHEN BUSINESS_TYPE_INDICATOR_1 = 'RB' OR BUSINESS_TYPE_INDICATOR_2 = 'RB' OR BUSINESS_TYPE_INDICATOR_3 = 'RB' THEN 'RB'\n\t\t\t\t\t-- ELSE 'NB'\n\t\t\t\t\t-- END\n\t\t\t--ELSE NULL\n\t\t-- END AS Final_Business_Type_Indicator,\n\t\t\n\t\t--addition for CR\n\t\t'T' as maturity_indicator,\n\t\t/* CASE WHEN src.Fleet_Indicator_Maturity=1 THEN 'FLOTA'\n\t\t\tWHEN src.Fleet_indicator_maturity=0 THEN\n\t\t\t\tCASE WHEN prd_cd in (469,498,538,658,667,830,834,961,987,995) THEN 'RC_I'\n\t\t\t\t\tWHEN prd_cd in (473,764,998) THEN 'RC_E'\n\t\t\t\t\tWHEN prd_cd in (859) THEN 'ESPECIAL'\n\t\t\t\t\tELSE TIPO_PLAN --SELECT TIPO_PLAN FROM cdp_stg_dwh.DESC_PLAN WHERE coverage_plan = DESC_PLAN.COB_PLAN)\n\t\t\t\t\tEND\n\t\tEND AS \tTIPO_PLAN, */\n\t\tCASE WHEN src.fleet_indicator_maturity = 1 THEN 'FLOTA'\n\t\tELSE TIPO_PLAN\n\t\tEND AS TIPO_PLAN,\n\t\t\n\t\tCASE WHEN TRUNC(DATEADD('YEAR',1,policy_issue_dt)) = policy_ori_exp_dt THEN '1 ANO'\n\t\t\tWHEN TRUNC(DATEADD('YEAR',2,policy_issue_dt)) = policy_ori_exp_dt THEN '2 ANOS'\n\t\t\tWHEN TRUNC(DATEADD('YEAR',1,policy_issue_dt)) > policy_ori_exp_dt THEN 'MENOS 1 ANO'\n\t\t\tWHEN TRUNC(DATEADD('YEAR',1,policy_issue_dt)) < policy_ori_exp_dt AND TRUNC(DATEADD('YEAR',2,policy_issue_dt)) > policy_ori_exp_dt THEN 'ENTRE 1 Y 2 ANOS'\n\t\t\tWHEN TRUNC(DATEADD('YEAR',2,policy_issue_dt)) < policy_ori_exp_dt THEN 'MAS 2 ANOS'\n\t\tEND AS DURACION_PLAN,\n\t\tORIGEN_MARCA,\n\t\tANUL,\n\t\tCANCEL,\n\t\tPRIMA_FINAL,\n\t\tSUCURSAL,\n\t\tCANT_SINIESTRO_ULT,\n\t\tINCURRIDO_RETENIDO_ULT,\n\t\tNUM_ITEMS,\n\t\tFORMA_PAGO_INI,\n\t\tFORMA_PAGO_FIN,\n\t\t--\n\t   LKP_MAX_KEY.max_sid\n\t   \nFrom\n( \nselect tmp1.*, sini.CANT_SINIESTRO_ULT, cast((iru.pagos_uf)-(iru.recuperos_uf)+(iru.provision_uf) as double precision) as INCURRIDO_RETENIDO_ULT, numitems.NUM_ITEMS\nfrom \n(    \nselect  \nORIGEN as src_sys_cd,\ncast(final_liberty.SSEGURO as varchar(80)) as\tpolicy_item_id,\nfinal_liberty.POLIZA as\tpolicy_num,\nfinal_liberty.ITEM as\tpolicy_item_num,\nCRAMO as\tlob_cd,\nID_SUCURSAL as\tbranch_office_cd,\nASEGURADO_RUT AS insured_rut_num,\ncast(final_liberty.INI_VIG as date)as\tpolicy_issue_dt,\ncast(FIN_VIG_ORIG as date)as\tpolicy_ori_exp_dt,\ncast(final_liberty.FIN_VIG_ACT as date)  as\tpolicy_act_exp_dt,\nDIAS_VIGENTE as\teffective_days,\nDIAS_SUSCRITOS as SUBSCRIBED_DAYS,\nVEH_CMARCA as veh_make,\nVEH_CMODELO as\tveh_model,\nVEH_CLASE as veh_class_cd,\nUSO as\tUse,\nVEH_ANO as\tveh_year,\nPATENTE as\tlic_plate_num,\nVEH_CTIPO as\tveh_type_cd,\nVEH_TIPO as\tveh_type_desc,\nNUM_MOTOR as\tveh_motor_num,\nfinal_liberty.CORREDOR_RUT as broker_rut_num, --added alias\nNRO_MASIVO  as\tMassive_Number,\nCOD_PRODUCTO as\tprd_cd,\nCOD_PLAN as\tpln_cd,\nfinal_liberty.CONTRATANTE_RUT as policyholder_rut_num,\ncast(num_endoso as varchar(60)) as mv_id,\nDEDUCIBLE as deductible,\nFLOTA as Fleet_Indicator,\nPRIMA as policy_premium_amt,\nCOMISION as\tCommission_amt,\nCOD_ENDOSO as mv_reason_cd,\nENDOSO_AGRUP as\tgroup_endorsements,\nfinal_liberty.COB_PLAN as\tcoverage_plan,\n0 as\tbusiness_number,\nprima_tarifa as\tpremium_rate_amt,\ndescuento as discount_amt,\ntdescrip as\tmv_reason_desc,\n\ncase \nwhen cagrseg <> 0 or cagrseg is not null\n        then case when (cagrseg not in (select CAST(num_convenio as varchar(8)) as num_convenio from cdp_stg_dwh.convenios_excluidos))\n                        then 1\n             else 0 end\nelse --(BFLC.cagrseg in (0, '', null)) (BFLC.cagrseg = 0 or BFLC.cagrseg is null) and  1305349\n        case when (count_sseguro > 4)\n                then 1\n         else 0 end\n\t\t \nend as Fleet_Indicator_Maturity,\n\t\t\ncast(fanulac as date) as\tanulac_dt,\ncast(fcarpro as date) as\tcarpro_dt,\ncast(fvencim as date)as\tpolicy_exp_dt,\nNVL(broker1.dim_broker_key,0) as Dim_broker_key,\nlob.dim_lob_key as Dim_LOB_key,\nNVL(insured.dim_insured_key,0) as Dim_Insured_key,\nNVL(PH1.dim_policyholder_key,0) as dim_policyholder_key,\n--NVL(ASEGURADO_RUT,'') || NVL(final_liberty.CORREDOR_RUT,'') || NVL(cast(final_liberty.COB_PLAN as varchar(50)),'') || NVL(PATENTE,'') as Key1,\n--NVL(ASEGURADO_RUT,'') || NVL(final_liberty.CORREDOR_RUT,'') || NVL(cast(final_liberty.COB_PLAN as varchar(50)),'') || NVL(NUM_MOTOR,'') as Key2,\n--NVL(ASEGURADO_RUT,'') || NVL(final_liberty.CORREDOR_RUT,'') || NVL(cast(final_liberty.COB_PLAN as varchar(50)),'') || NVL(NRO_MASIVO,'') as Key3,\n--ASEGURADO_RUT || CORREDOR_RUT || COB_PLAN || PATENTE as Key1,\n--ASEGURADO_RUT || CORREDOR_RUT || COB_PLAN || NUM_MOTOR as Key2,\n--ASEGURADO_RUT || CORREDOR_RUT || COB_PLAN || NRO_MASIVO as Key3,\ncase when ( DIAS_VIGENTE >=  DIAS_SUSCRITOS)AND\n        final_liberty.FIN_VIG_ACT >=   FIN_VIG_ORIG AND\n        ENDOSO_AGRUP NOT IN ('CANCELACION', 'ANULACION') then 1\nelse 0\nend as Validity_Indicator,\ncase\nwhen cod_producto in \n\t\t(Select distinct renewable_product_indicator from cdp_stg_dwh.renewals_param_axis where renewable_product_indicator IS NOT NULL )\nthen 1 else 0\nend as Renewable_Product_Indicator,\nfinal_liberty.tmarca as tmake ,\nfinal_liberty.tmodelo as tmodel ,\n--added on 2/4/20\nCASE WHEN final_liberty.corredor_rut = clp.corredor_rut THEN clp.CANAL\nELSE 'TRADICIONAL'\nEND AS CANAL,\ncase when \t(DIAS_VIGENTE>=DIAS_SUSCRITOS) and \n\t\t\t(final_liberty.FIN_VIG_ACT >=   FIN_VIG_ORIG) and\n\t\t\tENDOSO_AGRUP NOT IN ('CANCELACION', 'ANULACION') then 1\n\telse 0\nend as indicator_policy_candidate_to_renew,\n\n---------maturity CR part------------------------------------------------------------\nCASE WHEN prd_cd in (469,498,538,658,667,830,834,961,987,995) THEN 'RC_I'   \n\tWHEN prd_cd in (473,764,998) THEN 'RC_E'          \n\tWHEN prd_cd in (859) THEN 'ESPECIAL'   \n\tELSE dp.TIPO_PLAN\nEND AS TIPO_PLAN,\nom.ORIGEN_MARCA,\nPL1.PRIMA_FINAL,\nCASE WHEN LENGTH(final_liberty.id_sucursal)=2 THEN CAST('0'||final_liberty.id_sucursal AS INTEGER)\n\tWHEN LENGTH(final_liberty.id_sucursal)=3 THEN final_liberty.id_sucursal\nEND as SUCURSAL,\nforma.FORMA_PAGO_INI,\nforma.FORMA_PAGO_FIN,\nCASE WHEN ENDOSO_AGRUP='CANCELACION' THEN 1 ELSE 0 END AS CANCEL,\nCASE WHEN ENDOSO_AGRUP='ANULACION' THEN 1 ELSE 0 END AS ANUL\n\n----------------------------------------------------------------------------------\n\nfrom cdp_dwh.base_final_liberty as final_liberty\n\nLEFT JOIN cdp_stg_dwh.canal_liberty_penta as clp\nON final_liberty.corredor_rut = clp.corredor_rut\n\nLEFT JOIN cdp_stg_dwh.origenes_marca as om\nON cast(final_liberty.veh_cmarca as integer) = om.cmarca\n\nLEFT JOIN cdp_stg_dwh.desc_plan as dp\non final_liberty.cob_plan = dp.cob_plan\n\nLEFT JOIN (SELECT contratante_rut, count(sseguro) as count_sseguro FROM cdp_stg_dwh.CONTRATANTES_LIB GROUP BY contratante_rut) BFLC1\nON final_liberty.contratante_rut = BFLC1.contratante_rut\n\nleft join cdp_dwh.dim_lob_t as lob\non final_liberty.cramo=lob.lob_cd \nand lob.src_sys_cd='axis'\n\nleft join (select broker.dim_broker_key,src_sys_cd,substring(broker.broker_rut_num,1,length(broker.broker_rut_num)-1) as broker_rut_num from cdp_dwh.dim_broker_t broker\n            inner join (select substring(broker_rut_num,1,length(broker_rut_num)-1) as broker_rut_num, max(dim_broker_key)as dim_broker_key from cdp_dwh.dim_broker_t\n                        group by substring(broker_rut_num,1,length(broker_rut_num)-1))dim\n            on broker.dim_broker_key=dim.dim_broker_key)Broker1\non final_liberty.corredor_rut = Broker1.broker_rut_num and Broker1.src_sys_cd='axis'\nleft join (SELECT DISTINCT dins.dim_insured_key,base.sseguro  from \n(select \n    sseguro, \n    sperson,\n    coalesce(CAST(cdomici AS INTEGER),0) as cdomici,\n    row_number() over( partition by sseguro order by nmovima,nriesgo desc,norden desc ) rowindex\n  from \n    cdp_ods.sisaxis_asegurados tase \n  where \n    ffecfin is null \n)AA\ninner join cdp_stg_dwh.base_lib base\n      on base.sseguro = AA.sseguro\n      and AA.rowindex = 1\nleft outer join cdp_dwh.dim_insured_t dins\n      on AA.sperson = dins.insured_id\n      and AA.cdomici = dins.address_id\n      and dins.src_sys_cd = 'axis'\n)insured\nON final_liberty.SSEGURO=insured.sseguro\nleft join \n(SELECT DISTINCT \nPOL_HOLD.dim_policyholder_key,sseguro  from \n(SELECT AA.policyholder_id, sseguro,POL_HOLD.dim_policyholder_key FROM\n(select \n    base.sseguro,\n    ttom.sperson, \n    ttom.cdomici, \n    cast(cast(ttom.sperson as decimal(11,0)) as varchar) || '-' || cast(cast(ttom.cdomici as decimal(7,0)) as varchar) as policyholder_id \n  from \n    cdp_stg_dwh.base_lib base\n    left outer join cdp_ods.sisaxis_seguros tse1\n      on base.poliza = tse1.npoliza\n      and tse1.ncertif = 0\n    left outer join cdp_ods.sisaxis_tomadores ttom \n      on tse1.sseguro = ttom.sseguro \n)AA\nINNER JOIN cdp_dwh.dim_policyholder_t POL_HOLD\nON AA.policyholder_id=POL_HOLD.policyholder_id\nAND POL_HOLD.src_sys_cd='axis'\n)POL_HOLD )PH1\nON final_liberty.SSEGURO=PH1.sseguro\n\n---------MATURITY CR PART-------------\nLEFT JOIN \n( select PL1.sseguro, \n\t\tPL1.prima as PRIMA_FINAL\nfrom cdp_stg_dwh.PRIMAS_LIB1 PL1\nINNER JOIN\n(\tSELECT\tSSEGURO,\n\t\t\tMAX(NUM_ENDOSO) AS NUM_ENDOSO\n\tFROM\tcdp_stg_dwh.PRIMAS_LIB1\n\tGROUP BY SSEGURO) T15\n\tON PL1.SSEGURO = T15.SSEGURO\nAND PL1.NUM_ENDOSO = T15.NUM_ENDOSO\n) PL1\nON final_liberty.sseguro = PL1.sseguro\n\n\n\nleft join cdp_stg_dwh.forma_pago forma\non forma.sseguro = final_liberty.sseguro\n\n)tmp1\n\nleft join\n(\nSELECT sseguro,count(distinct NSINIES) as CANT_SINIESTRO_ULT\nFROM cdp_ods.SISAXIS_SINIESTROS\n----WHERE SSEGURO =  <SSEGURO current row>\ngroup by sseguro\n)sini\non sini.sseguro = tmp1.policy_item_id\n\nleft join cdp_stg_dwh.incurrido_retenido_ult iru\non iru.cie_sseguro = cast(tmp1.policy_item_id as bigint)\n\nleft join\n(\nselect NPOLIZA, count (distinct NCERTIF) as NUM_ITEMS\nFROM cdp_ods.sisaxis_seguros\nwhere ncertif > 1\ngroup by npoliza--, ncertif\n)numitems\non tmp1.policy_num = cast(numitems.npoliza as integer)\n\n\n\n\nunion all\n\n\n\n\nselect tmp2.*, cast(abp.CANT_SINIESTRO_ULT as integer) CANT_SINIESTRO_ULT, abp.INCURRIDO_RETENIDO_ULT, numitems.NUM_ITEMS\nfrom \n(\nselect \nORIGEN as src_sys_cd,\nfinal_penta.SSEGURO as policy_item_id,\nfinal_penta.POLIZA as policy_num,\nfinal_penta.ITEM as\tpolicy_item_num,\nCRAMO as lob_cd,\nID_SUCURSAL as\tbranch_office_cd,\ncast(ASEGURADO_RUT as varchar(42)) as insured_rut_num,\ncast(final_penta. INI_VIG as date) as policy_issue_dt,\ncast(FIN_VIG_ORIG as date) as\tpolicy_ori_exp_dt,\ncast(final_penta.FIN_VIG_ACT as date) as policy_act_exp_dt,\nDIAS_VIGENTE as\teffective_days,\nDIAS_SUSCRITOS as SUBSCRIBED_DAYS,\ncast(VEH_CMARCA as varchar(15)) as veh_make,\nVEH_CMODELO as\tveh_model,\ncast(VEH_CLASE as varchar(9)) as veh_class_cd,\nUSO as\tUse,\nVEH_ANO as veh_year,\nPATENTE as lic_plate_num,\ncast(VEH_CTIPO as varchar(15))as veh_type_cd,\nVEH_TIPO as veh_type_desc,\nNUM_MOTOR as veh_motor_num,\ncast(final_penta.CORREDOR_RUT as varchar(42)) as broker_rut_num,\nNRO_MASIVO as Massive_Number,\nCOD_PRODUCTO as\tprd_cd,\nCOD_PLAN as pln_cd,\ncast(CONTRATANTE_RUT as varchar(42)) as policyholder_rut_num,\nnull as mv_id,\ncast(DEDUCIBLE as DOUBLE PRECISION) as deductible,\nFLOTA as Fleet_Indicator,\ncast(PRIMA as DOUBLE PRECISION) as\tpolicy_premium_amt,\ncast(COMISION as DOUBLE PRECISION) as\tCommission_amt,\nCOD_ENDOSO as\tmv_reason_cd,\nENDOSO_AGRUP as\tgroup_endorsements,\nfinal_penta.COB_PLAN as\tcoverage_plan,\nfinal_penta.NUM_NEG  as\tbusiness_number,\ncast (0 as DOUBLE PRECISION)  as premium_rate_amt,\ncast(0 as DOUBLE PRECISION)  as discount_amt,\nnull  as\tmv_reason_desc,\nFLOTA as Fleet_Indicator_Maturity,\ncast(null as date) as\tanulac_dt,\ncast(null as date) as\tcarpro_dt,\ncast(null as date) as policy_exp_dt,\nNVL(broker1.dim_broker_key,0) as Dim_broker_key,\nlob.dim_lob_key as Dim_LOB_key,\nNVL(ins.dim_insured_key,0) as Dim_Insured_key,\nNVL(PH1.dim_policyholder_key,0) as dim_policyholder_key,\n--NVL(cast(ASEGURADO_RUT as varchar(60)),'') || NVL(cast(final_penta.CORREDOR_RUT as varchar(60)),'') || NVL(cast(final_penta.COB_PLAN as varchar(30)),'') || NVL(PATENTE,'') as Key1,\n--NVL(cast(ASEGURADO_RUT as varchar(60)),'') || NVL(cast(final_penta.CORREDOR_RUT as varchar(60)),'') || NVL(cast(final_penta.COB_PLAN as varchar(30)),'') || NVL(NUM_MOTOR,'') as Key2,\n--NVL(cast(ASEGURADO_RUT as varchar(60)),'') || NVL(cast(final_penta.CORREDOR_RUT as varchar(60)),'') || NVL(cast(final_penta.COB_PLAN as varchar(30)),'') || NVL(NRO_MASIVO,'') as Key3,\n--ASEGURADO_RUT || CORREDOR_RUT || COB_PLAN || PATENTE as Key1,\n--ASEGURADO_RUT || CORREDOR_RUT || COB_PLAN || NUM_MOTOR as Key2,\n--ASEGURADO_RUT || CORREDOR_RUT || COB_PLAN || NRO_MASIVO as Key3,\ncase when ( DIAS_VIGENTE >=  DIAS_SUSCRITOS)AND\n        final_penta.FIN_VIG_ACT >=   FIN_VIG_ORIG AND\n        ENDOSO_AGRUP NOT IN ('CANCELACION', 'ANULACION') then 1\nelse 0\nend as Validity_Indicator,\ncase\nwhen cod_producto in (1,3,8,10,11,13,14,16,22,26,28,31,33,36,38,70,20020,20022,20024,20026,20034,20280,20285,20290,20300)\nthen 0 else 1\nend as \nRenewable_Product_Indicator,\nfinal_penta.tmarca as tmake ,\nfinal_penta.tmodelo as tmodel ,\n\n--added on 2/4/20\n\ncase when clp.canal is not null then clp.canal \n\twhen cp.canal is not null then cp.canal\n\telse 'TRADICIONAL'\nend as CANAL,\n \ncase when \t(DIAS_VIGENTE>=DIAS_SUSCRITOS) and \n\t\t\t(final_penta.FIN_VIG_ACT >=   FIN_VIG_ORIG) and\n\t\t\tENDOSO_AGRUP NOT IN ('CANCELACION', 'ANULACION') then 1\n\telse 0\nend as indicator_policy_candidate_to_renew,\nCASE WHEN prd_cd in (70, 20020, 20022, 20024, 20026, 20034, 20123, 20150, 20151, 20152, 20153, 20154, 20158, 20175, 20176, 20193, 20392) THEN 'RC_I'   \n\tWHEN prd_cd in (20043) THEN 'RC_E'   \n\tWHEN prd_cd in (55, 20076, 20077) THEN  'ESPECIAL'  \n\tELSE dp.TIPO_PLAN\nEND AS TIPO_PLAN,\nom.ORIGEN_MARCA,\ncast(replace(ppf.PRIMA_FINAL,',','.') as double precision) as PRIMA_FINAL,\nfinal_penta.id_sucursal as SUCURSAL,\npfp.FORMA_PAGO_INI,\npfp.FORMA_PAGO_FIN,\nCASE WHEN ENDOSO_AGRUP='CANCELACION' THEN 1 ELSE 0 END AS CANCEL,\nCASE WHEN ENDOSO_AGRUP='ANULACION' THEN 1 ELSE 0 END AS ANUL\n\n--\nfrom cdp_dwh.base_final_penta as final_penta\n--added on 2/4/20\nleft join cdp_stg_dwh.canal_liberty_penta as clp\non final_penta.corredor_rut = clp.corredor_rut\n\nleft join cdp_stg_dwh.canal_penta cp\non final_penta.num_neg = cp.num_neg\n\n--added for maturity CR\nLEFT JOIN cdp_stg_dwh.origenes_marca om \nON final_penta.veh_cmarca = om.cmarca\n\nLEFT JOIN cdp_stg_dwh.PENTA_PRIMAFINAL ppf\non final_penta.poliza = ppf.poliza\nand final_penta.item = ppf.item\n\n\nLEFT JOIN cdp_stg_dwh.desc_plan dp\non final_penta.cob_plan = dp.cob_plan\n\nLEFT JOIN cdp_stg_dwh.PENTA_FORMAPAGO pfp\non (pfp.POLIZA||'-'||pfp.ITEM) = final_penta.sseguro\n--\nleft join cdp_dwh.dim_lob_t as lob\non final_penta.cramo=lob.lob_cd \nand lob.src_sys_cd='penta'\nleft join cdp_dwh.dim_broker_t Broker1\non final_penta.corredor_rut = substring(broker_rut_num,1,length(broker_rut_num)-1) \nand Broker1.src_sys_cd='axis'\nleft join (select insured.dim_insured_key,src_sys_cd, insured.insured_rut_num from cdp_dwh.dim_insured_t insured\n            inner join (select insured_rut_num, max(dim_insured_key)as dim_insured_key from cdp_dwh.dim_insured_t\n                        group by insured_rut_num)dim\n            on insured.dim_insured_key=dim.dim_insured_key)ins\non final_penta.asegurado_rut = ins.insured_rut_num  and ins.src_sys_cd='penta' \n\nleft join (select PH.dim_policyholder_key,src_sys_cd, PH.policyholder_rut_num from cdp_dwh.dim_policyholder_t PH\n             inner join (select policyholder_rut_num, max(dim_policyholder_key)as dim_policyholder_key from cdp_dwh.dim_policyholder_t\n                        group by policyholder_rut_num)dim\n             on PH.dim_policyholder_key=dim.dim_policyholder_key)PH1\non final_penta.contratante_rut = PH1.policyholder_rut_num and PH1.src_sys_cd='penta'\n)tmp2\n\nleft join \n( \nselect politem, cant_siniestro_ult, incurrido_retenido_ult, count(politem) as cnt\nfrom cdp_ods.aparot_base_penta abp\ngroup by 1,2,3\n)abp on  tmp2.policy_item_id = abp.politem\n\n\nleft join\n(\nSELECT ITE_INT_POLIZA, count(distinct ITE_SMA_ITEM) NUM_ITEMS\nFROM cdp_ods.bd_produ_x_pro_item\nWHERE ITE_SMA_ITEM > 1\ngroup by ITE_INT_POLIZA\n)numitems\non numitems.ITE_INT_POLIZA = tmp2.policy_num\n\n\n)src\nleft join crt1\non src.policy_item_id=crt1.sseguro\nleft join crt2\non src.policy_item_id=crt2.sseguro\nleft join crt3\non src.policy_item_id=crt3.sseguro\nleft outer join \n(select 1 dummy,max(fact_renewals_key) max_sid  from  cdp_dwh.fact_renewals_nofleet_maturity_t_t) LKP_MAX_KEY\non LKP_MAX_KEY.dummy=1"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.oprRuntimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "TRUNCATE TABLE cdp_dwh.fact_renewals_nofleet_maturity_t_t;"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[0].dataAdapter.runtimeAttributes.attributes[9]",
        "name": "Pre-sql",
        "value": "TRUNCATE TABLE cdp_dwh.fact_renewals_nofleet_maturity_t_t;"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[2].dataAdapter.oprRuntimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "insert into cdp_dwh.fact_renewals_nofleet_maturity_t_all (select * from cdp_dwh.fact_renewals_nofleet_maturity_t_t);"
    },
    {
        "type": "pre/post-sql",
        "path": "content.transformations[2].dataAdapter.runtimeAttributes.attributes[15]",
        "name": "Post-sql",
        "value": "insert into cdp_dwh.fact_renewals_nofleet_maturity_t_all (select * from cdp_dwh.fact_renewals_nofleet_maturity_t_t);"
    }
]