[
    {
        "type": "customQuery",
        "path": "content.transformations[0].dataAdapter.object.customQuery",
        "value": "select A.*, B.items_renovados, B.prima_renovada,\nCASE \n    WHEN (B.PRIMA_RENOVADA = A.PRIMA_ANUAL  * 0.7 OR B.PRIMA_RENOVADA > A.PRIMA_ANUAL  * 0.7) THEN 'SI'\n    ELSE 'NO'\nEND AS INDICADOR_RENOVADO\nfrom\n(\nSELECT A1.*, A2.LRHist,\ncase when \nA3.cnt_num_convenio  > 0\nthen A3.cnt_num_convenio ||  ' Renovacion'\nelse ''\nend as tipo_renovacion\n\nFROM\n(\nselect\nnum_convenio||'-'||ano_mes_fin_vigencia_actual as convenio_finvig, sucursal_suscripcion, num_convenio, nombre, ano_mes_fin_vigencia_actual, \ncount(case when estado_actual = 'Vigente' then 1 end) as items_a_renovar,  --CR-2 Changes (point #1 to count only Valid)\nsum(case when estado_actual = 'Vigente' then prima_anualizada end) as prima_anual, --CR-2 change UAT support\ncase \nwhen sum(prima_ganada)=0 then 0\nelse ((sum(pagos_clf)-sum(recup_clf)+sum(provision_clf))/sum(prima_ganada))*100  end as LR\nfrom cdp_dwh.fact_renewals_fleet_policies_t\ngroup by \nsucursal_suscripcion, num_convenio, nombre, ano_mes_fin_vigencia_actual) A1\n\nleft join \n(\nselect sucursal_suscripcion, num_convenio, nombre, ano_mes_fin_vigencia_actual,\ncase \nwhen prima_ganada_hist=0 then 0\nelse \n(pagos_clf_hist-recup_clf_hist+provision_clf_hist)/ prima_ganada_hist * 100 end as lrhist from\n(select sucursal_suscripcion, num_convenio, nombre, ano_mes_fin_vigencia_actual,\n(sum(pagos_clf) over (PARTITION BY num_convenio, sucursal_suscripcion, nombre ORDER BY ano_mes_fin_vigencia_actual asc, num_convenio rows unbounded preceding )) as pagos_clf_hist,\n(sum(recup_clf) over (PARTITION BY num_convenio, sucursal_suscripcion, nombre ORDER BY ano_mes_fin_vigencia_actual asc, num_convenio rows unbounded preceding )) as recup_clf_hist,\n(sum(provision_clf) over (PARTITION BY num_convenio, sucursal_suscripcion, nombre ORDER BY ano_mes_fin_vigencia_actual asc, num_convenio rows unbounded preceding )) as provision_clf_hist,\n(sum(prima_ganada) over (PARTITION BY num_convenio, sucursal_suscripcion, nombre ORDER BY ano_mes_fin_vigencia_actual asc, num_convenio rows unbounded preceding )) as prima_ganada_hist\nfrom (\nselect\nsucursal_suscripcion, num_convenio, nombre, ano_mes_fin_vigencia_actual,\nsum(pagos_clf) as pagos_clf,\nsum(recup_clf) as recup_clf,\nsum(provision_clf) as provision_clf,\nsum(prima_ganada) as prima_ganada\nfrom cdp_dwh.fact_renewals_fleet_policies_t\nwhere \n(ano_mes_fin_vigencia_actual < cast(left(replace(current_date,'-',''),6) as integer) or ano_mes_fin_vigencia_actual = cast(left(replace(current_date,'-',''),6) as integer))\ngroup by \nsucursal_suscripcion, num_convenio, nombre,ano_mes_fin_vigencia_actual))\n) A2\non\nA1.num_convenio = A2.num_convenio and\nA1.sucursal_suscripcion = A2.sucursal_suscripcion and\nA1.nombre = A2.nombre and \nA1.ano_mes_fin_vigencia_actual = A2.ano_mes_fin_vigencia_actual\n\nleft join\n(\nselect num_convenio,ano_mes_fin_vigencia_actual,\n(LAG(cnt_num_convenio_2) OVER (PARTITION BY num_convenio ORDER BY ano_mes_fin_vigencia_actual asc)) AS cnt_num_convenio\nfrom\n(\nselect num_convenio, ano_mes_fin_vigencia_actual, count(ano_mes_fin_vigencia_actual) as cnt_num_convenio_1,\n(row_number() OVER (PARTITION BY num_convenio ORDER BY ano_mes_fin_vigencia_actual asc)) as cnt_num_convenio_2\nfrom  cdp_dwh.fact_renewals_fleet_policies_t\nwhere\nano_mes_fin_vigencia_actual < cast(left(replace(current_date,'-',''),6) as integer) \ngroup by num_convenio, ano_mes_fin_vigencia_actual)\n) A3\non\nA1.num_convenio = A3.num_convenio and \nA1.ano_mes_fin_vigencia_actual = A3.ano_mes_fin_vigencia_actual\n) A\nleft join\n(\nselect\nnum_convenio||'-'||ano_mes_inicio_vigencia as convenio_finvig, sucursal_suscripcion, num_convenio, nombre, ano_mes_inicio_vigencia, \ncount(case when estado_actual = 'Vigente' then 1 end) as items_renovados, \nsum(case when estado_actual = 'Vigente' then prima_anualizada end) as prima_renovada\nfrom cdp_dwh.fact_renewals_fleet_policies_t\ngroup by \nsucursal_suscripcion, num_convenio, nombre, ano_mes_inicio_vigencia\n) B\non \nA.num_convenio = B.num_convenio and\nA.sucursal_suscripcion = B.sucursal_suscripcion and\nA.nombre = B.nombre and\nA.ano_mes_fin_vigencia_actual = B.ano_mes_inicio_vigencia"
    }
]